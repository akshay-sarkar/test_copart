app.controller("appController",["$interpolate","$scope","$interval","$sce","$window","$compile","$filter","$locale","$timeout","$route","$cookies","config","dataServiceG2","copartUser","$location","$http","urlService","$q","$rootScope","$templateCache","appConfigService","userService","loginService","auctionsCalendarService","HttpPendingRequestsService","siteCatalyst","localStorageService","History","metaDataService","geocodingService","cmsContentService","userLocationService","searchCriteriaFactory",
"searchCriteriaConstants","accountAlertsService","constants",function AppController($interpolate,$scope,$interval,$sce,$window,$compile,$filter,$locale,$timeout,$route,$cookies,config,dataServiceG2,copartUser,$location,$http,urlService,$q,$rootScope,$templateCache,appConfigService,userService,loginService,auctionsCalendarService,HttpPendingRequestsService,siteCatalyst,localStorageService,History,metaDataService,geocodingService,cmsContentService,userLocationService,searchCriteriaFactory,searchCriteriaConstants,
accountAlertsService,constants){var log=new Logger({name:"AppController",level:config.logLevel});var self=$scope;self.$route=$route;var locale=$scope.$parent.locale;self.restoreUrl=false;self.appConfig=appConfigService.getAppConfig();var defaultBaseUrl="";var defaultBaseUrlRegEx=new RegExp(appInit.redirectUrl);var siteCode=copartUser.getUserConfig().siteCode;self.noAds=window.appInit.isTopBuyer;self.isAnonymous=userService.isAnonymous();self.localeString=appInit.localeString;self.isGlobal=appInit.appPlatform===
"gbl";self.emailRule=copartUser.getUserConfig().emailRule;self.regionCode=appInit.regionCode;self.destroyAdxSlot=false;self.cookiePolicyCountries=null;self.enableCompleteRegistration=false;var isKioskEnabledForSiteCode=siteCode=="CPRTUS"||"CPRTUK"?true:false;self.checkForMEACountryCode=function(countryCode){return countryCode=="ARE"||countryCode=="BHR"||countryCode=="OMN"};$("body").on("contentRoute",function(event,userLang,region,contentPath){var contentPathNew=region+"/"+userLang+"/"+contentPath;
if(siteCode==="DRIVUS")$location.url("/content/"+contentPathNew);else $location.url("/Content/"+contentPathNew)});$scope.$on("$locationChangeStart",function(event,next,current){try{var baseURI=document.baseURI;if(!baseURI){var baseTags=document.getElementsByTagName("base");baseURI=baseTags.length?baseTags[0].href:document.URL}var oldRoute=current.replace(baseURI,"");var nextRoute=next.replace(baseURI,"");History.secondLastRoute=_.clone(History.lastRoute);History.lastRoute=oldRoute;if(self.restoreUrl){console.log("Redirect URL\x3d"+
oldRoute);urlService.redirectUrl=oldRoute;self.restoreUrl=false}}catch(e){}});$scope.$on("$routeChangeStart",function(scope,next,current){try{if(self.destroyAdxSlot&&googletag&&_.isFunction(googletag.destroySlots))googletag.destroySlots();jQuery("#lhnHocButton").hide();jQuery("#lhnHelpOutCenter").hide();var tagsToRemove=["script[adscript\x3d'first']","link[seolanglink\x3d'lang']"];_.each(tagsToRemove,function(tag){angular.element(document.querySelectorAll(tag)).remove()});var allowAccess=next.$$route.allowAccess;
var scrollSave=current?current.$$route.scrollRestore?true:false:false;if(scrollSave){var scrollTop=window.pageYOffset!==undefined?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop;var pageName=current.$$route.scrollRestoreKey;localStorageService.set(pageName+"-scrollPosition",scrollTop);console.log("Saved scroll position:"+scrollTop)}var restoreUrl=current?current.$$route.restoreUrlOnLogin?true:false:false;var isLoginPage=$location.url().indexOf("/login")>=
0;if(restoreUrl&&isLoginPage)self.restoreUrl=true;var templateUrl=_.isFunction(next.$$route.templateUrl)?next.$$route.templateUrl(next.params):next.$$route.templateUrl;var blockAccess=next.$$route.blockAccess;var altRoute=next.$$route.altRoute;var userRoles=copartUser.config.roles;if(angular.isDefined(next.$$route.noCache)&&next.$$route.noCache==true)$templateCache.remove(next.$$route.templateUrl);$rootScope.title=metaDataService.getTitleForRoute(next.$$route,self.locale);$rootScope.description=metaDataService.getDescForRoute(next.$$route,
self.locale);if(!userService.isAnonymous()&&(next.$$route.originalPath==="/login/"||next.$$route.originalPath==="/doRegistration/"))$location.url(next.$$route.redirectAfterLoginUrl).replace();var metaDataUpdateEvent=$rootScope.$on("update-site-meta",function(event,data){$rootScope.title=metaDataService.getTitleForRoute(next.$$route,self.locale);$rootScope.description=metaDataService.getDescForRoute(next.$$route,self.locale)});if(siteCode!="CRTSUS")if(_.isEmpty(next.params)){$rootScope.languageHrefPath=
next.$$route.originalPath;$rootScope.showLanguageHref=true}else $rootScope.showLanguageHref=false;var publicUri="/public/";if(appInit.facebookUser){publicUri="/facebook/";templateUrl=templateUrl.replace("/public/","/facebook/")}if(allowAccess!=null&&_.contains(userRoles,"ROLE_ANONYMOUS")&&templateUrl&&templateUrl.indexOf(publicUri)<0&&templateUrl.indexOf("login.html")<0)next.$$route.templateUrl=templateUrl.replace("/",publicUri);else if(templateUrl)if(templateUrl.indexOf(publicUri)>-1)next.$$route.templateUrl=
templateUrl;if(allowAccess!=null&&!_.contains(allowAccess,"ROLE_ANONYMOUS")){var allowedSet=_.intersection(allowAccess,userRoles);if(allowedSet.length==0)$location.path("/accessDenied")}if(blockAccess!=null){var blockedSet=_.intersection(blockAccess,userRoles);if(blockedSet.length!=0)if(altRoute!=null)$location.path(altRoute);else $location.path("/accessDenied")}jQuery(".modal-backdrop").remove();jQuery("body").removeClass("modal-open");var baseURI=document.baseURI;if(!baseURI){var baseTags=document.getElementsByTagName("base");
baseURI=baseTags.length?baseTags[0].href:document.URL}var pathName=baseURI.replace(window.location.origin,"");if(next.baseUrl){var baseUrlRegEx=new RegExp(next.baseUrl);if(!baseUrlRegEx.test(pathName)){var baseUrl="/"+appInit.localeString+"/"+next.baseUrl;location.replace(baseUrl+$location.url())}}}catch(e){console.error(e)}});function scrollToPoint(key){try{var pageName=key;var fromShowAll=sessionStorage.getItem("fromShowAll");var scrollPosition=localStorageService.get(pageName+"-scrollPosition");
localStorageService.remove(pageName+"-scrollPosition");sessionStorage.removeItem("fromShowAll");if(scrollPosition&&!fromShowAll)setTimeout(function(){jQuery("html,body").animate({scrollTop:scrollPosition},500)},1)}catch(e){console.error(e)}}var addCanonicalTag=function(next,$location){if(next&&next.$$route&&!_.isNull(next.$$route.ignoreCanonicalRef)){var canonicalRef=cmsContentService.createCanonicalHref($location.$$path);canonicalRef=canonicalRef.endsWith("/")?canonicalRef.replace(/.$/,""):canonicalRef;
cmsContentService.setCanonicalHref(canonicalRef)}};$scope.$on("$routeChangeSuccess",function(scope,next,current){setTimeout(function(){window.scrollTo(0,0)},1);try{$rootScope.$eval(function(){addCanonicalTag(next,$location)});if(current&&current.$$route&&current.$$route.removeChatOnRouteChange)if(_.isFunction(jivo_destroy))jivo_destroy();self.loadFirstAdxScript();self.noAds=window.appInit.isTopBuyer;var pixelId=self.locale.messages["app.facebook.Pixel.ID"];var GTM_ID=self.locale.messages["app.gtm.ID"];
loadGoogleTagManager(GTM_ID);if(pixelId>0)facebookPixel(next.$$route,pixelId);if(next.$$route){var invokeSiteCatalystEvent=next.$$route.invokeSiteCatalystEvent;setTimeout(function(){window.scrollTo(0,0)},1);if(!AppUtils.isUndefined(invokeSiteCatalystEvent)){console.log("Printing the event **** "+invokeSiteCatalystEvent);siteCatalyst.executeCall(invokeSiteCatalystEvent)}var scrollRestore=next?next.$$route.scrollRestore?true:false:false;if(scrollRestore){var pageName=next.$$route.scrollRestoreKey;window.pageName=
pageName;var waitForEvent=next.$$route.scrollOnEvent;if(waitForEvent)jQuery(window).one("scrollToPoint",function(){scrollToPoint(window.pageName)});else scrollToPoint(window.pageName)}var pageName=next.$$route.pageName;if(pageName){if(next.$$route.originalPath.indexOf("/Content")==0||next.$$route.originalPath.indexOf("/content")==0)pageName=next.params.contentPath.replace(".html","").replace(/[^a-zA-Z ]/g,"-");else if(pageName=="registration");else if(pageName.indexOf("locations_")>-1){var YardDetails=
$location.url().replace("/locations/","").replace("/","");pageName+=YardDetails}else if(pageName.indexOf("lotdetail")>-1){s.products=";"+next.params.lotId.toString();s.events="prodView"}else if(pageName==="registration-thankyou"){var rgType=s.Util.getQueryParam("type");pageName=pageName+"-"+rgType}if(!AppUtils.isUndefined(next.pathParams.showAllPhotos))pageName="lotphotos";self.doTagPageView(pageName)}}}catch(e){log.error("Error in $routeChangeSuccess-\x3e "+e)}});self.loadFirstAdxScript=function(){self.destroyAdxSlot=
true;var s1=document.createElement("script");s1.type="text/javascript";var head_script_first;head_script_first='var googletag \x3d googletag || {};googletag.cmd \x3d googletag.cmd || [];(function() {var gads \x3d document.createElement("script");gads.async \x3d true;gads.type \x3d "text/javascript";var useSSL \x3d "https:" \x3d\x3d document.location.protocol;gads.src \x3d (useSSL ? "https:" : "http:") + "//www.googletagservices.com/tag/js/gpt.js";var node \x3ddocument.getElementsByTagName("script")[0];node.parentNode.insertBefore(gads, node);})();';
s1.innerHTML=head_script_first;s1.setAttribute("adscript","first");document.head.appendChild(s1)};self.userConfig=null;self.locale=null;self.ds=dataServiceG2;self.langOptions=[{name:"English",value:"en_us"},{name:"Espa√±ol",value:"es_es"},{name:"Nederlands",value:"nl_nl"}];BaseController(self,{$sce:$sce,$window:$window,$compile:$compile,$filter:$filter,$locale:$locale,$timeout:$timeout,config:config});self.getSuggestion=function(val){var deferred=$q.defer();dataServiceG2.getSuggestion(val).then(function(response){deferred.resolve(response)},
function errorCallback(response){deferred.reject("failed_to_get_suggestions_appcontroller");log.error("Error for getSuggestion returned in appcontroller"+response)});return deferred.promise};self.goToSellerLogin=function(){$window.location.href=appConfigService.getEnvConfigProps().sellerLoginURL};self.mobileShow=$window.innerWidth<479?true:false;self.changeTimezone=function(saveNewTimeZone){if(saveNewTimeZone==false){self.userConfig.selectedTimezone=self.userConfig.currentTimezone;self.userConfig.timeInTimezonePicker=
self.userConfig.currentTime}else{copartUser.changeTimezone(saveNewTimeZone);if(saveNewTimeZone)dataServiceG2.updateUserConfig(userService.userConfig,$route).then(function(data){auctionsCalendarService.getAuctionsCalender(true).then(function(){$route.reload()})})}};self.refreshAndGetUser=function(){self.userConfig=copartUser.refreshAndGetUser()};self.changePopupLanguage=function(selectedLang){self.selectedLang=selectedLang};self.showSelectUrl=function(mySelecturl){$window.location.href=mySelecturl};
var isSitesDefaultLangSelected=function(selectedLang){var siteDefaultLang=userService.userConfig.defaultDisplayPref.selectedLang;return selectedLang==siteDefaultLang};self.changeLanguage=function(selectedLang){self.locale=self.localeModal;var data=userService.userConfig;copartUser.updateLanguage(selectedLang);dataServiceG2.updateUserConfig(data).then(function(){var port=$location.port();var newURL=port!=undefined&&port!=null?$location.host()+":"+port:$location.host();newURL=$location.$$protocol+"://"+
newURL;newURL=newURL+copartUser.getLocationUrlWithLocale($location.url());$window.location.href=newURL})};self.routeReload=function(path){var url=$location.path();if(path==url)$route.reload()};self.driverSeatReload=function(path){angular.forEach(searchCriteriaConstants,function(value,key){if(key!="lotSearch")searchCriteriaFactory.getSearchCriteria(searchCriteriaConstants[key]).reset()});var url=$location.path();if(path==url){if($location.search().searchCriteria)$location.search("searchCriteria",null);
$route.reload()}};self.closeUnauthorizedModalAndReload=function(){$window.location.href=$location.path()};self.openLink=function($event){var link=$($event.target).find("a").attr("href");if(!_.isEmpty(link))window.open(link,"_blank");$("#lang").val(userService.userConfig.siteCode)};self.redirectURL=function(url){$location.url(url)};self.doTagPageView=function(pageName){try{if(window.location.hash!="#data\x3drefresh"){var prefix="";if(userService.isAnonymous())prefix="public:";else prefix="member:";
s.pageName=prefix+pageName;s.server=window.location.hostname;s.channel="public";s.pageType="";lm.Omniture.PageName=s.pageName;s.prop1=s.pageName;if(window.location.href)s.pageURL=window.location.href;s.t();lm.Omniture.ClearVars()}else window.location.hash=""}catch(e){log.error("Site Catalyst call unsuccessful",e)}};self.submitFeedBack=function(feedback){dataServiceG2.postFeedback(feedback,function(response){console.log("Thankyou! Feedback sent !")});$("#feedback").modal("hide")};var fetchTitleDescription=
function(){var parentFragmentId="Content/US/EN/Title-Description";cmsContentService.getFragmentContent(parentFragmentId).then(function(titleDescription){if(typeof titleDescription==="object"&&titleDescription!==null){try{var titleDescriptionStr=JSON.stringify(titleDescription);self.locale.titleDescription=JSON.parse(titleDescriptionStr)}catch(e){self.locale.titleDescription={};log.error("Error fetching titles and description",e)}metaDataService.refresh(self.locale)}else log.error("Invalid title/description fetched from CMS.")})};
var updateLanguageTags=function(){var languageMeta=self.locale.messages["app.meta.language"];if(languageMeta)$rootScope.languageMeta=languageMeta};var initializeCLDR=function(){try{var cldrData=eval(g2cldr);Globalize.load(cldrData);var thisLocale=config.locale.territory&&config.locale.territory!=""?self.locale.lang+"-"+config.locale.territory:self.locale.lang;Globalize.locale(thisLocale);app.globalizeNumberFormatter=Globalize.numberFormatter();self.locale.cldrData=cldrData;if(app.globalizeNumberFormatterPromise)app.globalizeNumberFormatterPromise.resolve(app.globalizeNumberFormatter)}catch(e){log.error("Error initializing teh CLDR")}};
self.init=function(){log.info("Loading {} {} - please wait ...",config.appName,config.appRelease);log.debug("Application config\x3d{}",JSON.stringify(config));self.userConfig=copartUser.config;self.selectedLang=self.userConfig.selectedLang;self.locale=dataServiceG2.getLocale();self.localeModal=self.locale;self.country="";initializeCLDR();dataServiceG2.getQuickPickCounts("HOME");if(self.userConfig.selectedLang==null)self.userConfig.selectedLang="en";if(self.timeZones==null)self.timeZones=moment.tz.names();
globalLicenceCategory=self.userConfig.licenceCategory;dataServiceG2.getEnvConfigProps(function(evnConfigPropertiesData){appConfigService.setEnvConfigProps(new EnvConfigProps(evnConfigPropertiesData));self.cookiePolicyCountries=evnConfigPropertiesData.countryCodesToShowCookiePolicy;self.isKioskBidTurnedOff=evnConfigPropertiesData.kiosk?evnConfigPropertiesData.kiosk.kioskBidTurnedOff:false});appConfigService.getLocationsListBySite(function(response){self.tempLocations=response;self.yardLocations=_.filter(self.tempLocations,
function(item){if(item.yardName.charAt(0)!="*")return item})});fetchTitleDescription();updateLanguageTags();if(!userService.isAnonymous())accountAlertsService.getAccountAlerts()};self.init();copartUser.initializeTime();$interval(copartUser.updateTime,1E4);self.zipCodeError=false;self.locationError=false;self.nearestLocationModal={};$scope.$watch(function(){return accountAlertsService.getAlerts()},function(newAlerts){if(newAlerts&&newAlerts.length>0)self.enableCompleteRegistration=!accountAlertsService.isActionCompleteForActivity(constants.REGISTRATION_USER_ACTIVITY,
constants.ALERT_TYPE_STATUS.missingAccInfo)||!accountAlertsService.isActionCompleteForActivity(constants.REGISTRATION_USER_ACTIVITY,constants.ALERT_TYPE_STATUS.pendingMemPayment)});self.getSearchCriteriaForSearchByZip=function(retData,miles){var zipObject={};_.defaults(zipObject,{latitude:"*",longitude:"*",miles:9999});zipObject.latitude=retData.latitude;zipObject.longitude=retData.longitude;if(miles)zipObject.miles=miles;var zipQuery=$interpolate("{!geofilt pt\x3d{{latitude}},{{longitude}} sfield\x3dyard_location d\x3d{{miles}}}")(zipObject);
var data={query:["*"],filter:{MISC:[encodeURIComponent(zipQuery)]},sort:["geodist() asc"],rawParams:{sfield:"yard_location",pt:zipObject.latitude+","+zipObject.longitude}};return data};self.lookForNearestLocation=function(modal){self.zipCodeError=false;self.locationError=false;if(modal.zip)geocodingService.getCoordinatesForZip(modal.zip,function(retData){if(retData.status==-1){self.resetLocationForm();document.getElementById("PostalCode1").value="";return}var data=self.getSearchCriteriaForSearchByZip(retData,
self.miles);dataServiceG2.getNearestLocationDetail(data,function(response){self.yardDetails=response.data;auctionsCalendarService.auctionByYard(self.yardDetails.yardNumber).then(function(data){self.yardDetails.nextAuction=data.currentSaleTimeEpoch});modal.foundLocation=true})});else if(modal.yardLocation)dataServiceG2.getLocationDetail(modal.yardLocation,function(response){self.yardDetails=response.data;auctionsCalendarService.auctionByYard(self.yardDetails.yardNumber).then(function(data){self.yardDetails.nextAuction=
data.currentSaleTimeEpoch});modal.foundLocation=true});else{self.zipCodeError=true;self.locationError=true}};self.resetLocationForm=function(){self.nearestLocationModal.foundLocation=false;self.nearestLocationModal.zip="";self.nearestLocationModal.yardLocation=""};self.payAllUK=function(fromRequest){if(copartUser.getUserConfig().siteCode=="CPRTMEA")$window.location.href="./makePayment";else{var requestParam={};requestParam.GATEWAY_URL_KEY="PAY_ALL_UK";dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==
1)$window.location.href=response.data.pciURL.trim();else log.error("Error in Gateway")})}};self.doLogout=function(){if(isKioskEnabledForSiteCode&&copartUser.getUserConfig().isKioskBidder)$("#kiosksignout").modal("show");else $window.location.href="/doLogout.html"};self.addClassToModal=function(){$timeout(function(){angular.element(document.querySelector(".modal-backdrop")).addClass("add-white-backdrop")},0)};var contentPage;$.bbq.pushState=function(pageObject){console.log("Page number-"+pageObject.page);
contentPage=pageObject.page;$location.search("page",pageObject.page);$timeout(function(){$rootScope.$digest()},0)};$.bbq.getState=function(stateParam){var ret=$location.search()[stateParam];return ret}}]);app.getControllerScope=function(scope){while(!AppUtils.isUndefined(scope)&&AppUtils.isUndefined(scope.ds))scope=scope.$parent;return scope};"use strict";
app.service("loginService",["$http","dataServiceG2","$rootScope","$location","urlService","$window","functionQueueService","siteCatalyst","localStorageService","appConfigService","copartUser","userService","constants",function($http,dataServiceG2,$rootScope,$location,urlService,$window,functionQueueService,siteCatalyst,localStorageService,appConfigService,copartUser,userService,constants){var self=this;var thisLocale=dataServiceG2.getLocale();self.appConfig=appConfigService.getAppConfig();var isGlobal=
appInit.appPlatform==="gbl";self.emailRule=copartUser.getUserConfig().emailRule;var statusEnum={ERROR:"ERROR",SUCCESS:"SUCCESS",PASSWORD_EXPIRED:"PASSWORD_EXPIRED",FORGET_PASSWORD:"FORGET_PASSWORD",ACCOUNT_VOIDED:"ACCOUNT_VOIDED",ACCOUNT_SUSPENDED:"ACCOUNT_SUSPENDED",UPDATE_BROKER_BIDDER_EMAIL:"UPDATE_BROKER_BIDDER_EMAIL",ACCOUNT_LOCKED:"ACCOUNT_LOCKED",BAD_CREDENTIALS:"BAD_CREDENTIALS",TERMS_AND_CONDITIONS_FAILED:"TERMS_AND_CONDITIONS_FAILED",ACCOUNT_LAPSED:"ACCOUNT_LAPSED",MULTIPLE_ACCOUNTS_WITH_SAME_EMAIL_ID:"MULTIPLE_ACCOUNTS_WITH_SAME_EMAIL_ID",
BIDDER_ACCOUNT_VACANT_LOGIN_FAILURE:"BIDDER_ACCOUNT_VACANT_LOGIN_FAILURE"};self.loginAlerts=[];self.accountType="0";self.preLoginFunction=null;var passwordRulePref=copartUser.getUserConfig().displayPref.passwordRule||{};var currentPasswordMinLength=passwordRulePref.currentPasswordMinLength?passwordRulePref.currentPasswordMinLength:constants.PASSWORD_MIN_LENGTH;var maxLength=passwordRulePref.maxLength?passwordRulePref.maxLength:constants.PASSWORD_MAX_LENGTH;self.submitForm=function(action,form,isFirstTime,
isKiosk){if(form.accountType!=1)if(validateForm(form)){form.accountTypeValue=form.accountType;if(self.preLoginFunction&&jQuery.isFunction(self.preLoginFunction)){self.preLoginFunction();self.preLoginFunction=null}$("#password").attr("disabled","disabled");var loginUrl=action+(userService.userConfig.mobileAppUser?"?MobileAppUser\x3dtrue":"");dataServiceG2.performLogin(loginUrl,form,function(data){$("#password").removeAttr("disabled");if(data.data.result=="updateBrokerBidderEmail")$window.location.href=
urlService.updateBrokerBidderEmail;else if(data.data.result=="success"){functionQueueService.executeQueue();copartOmnitureCallOne("doTagLoginSuccess",form.username);var username=form.rememberme?form.username:"";localStorageService.cookie.set("username",username,365);if(isKiosk||data.data.isKioskBidder)$window.location.href="/kiosklotSearchResults";else $window.location.href=_.isEmpty($rootScope.storeUserURl)?urlService.redirectUrl:$rootScope.storeUserURl}else switch(data.data.error){case statusEnum.PASSWORD_EXPIRED:if(isGlobal)var pwdExipredMsg=
thisLocale.messages["app.login.label.passwordExpired"];else var pwdExipredMsg=thisLocale.messages["app.login.label.passwordExpired1"]+"\x3ca href\x3d'#forgotuserid' data-toggle\x3d'modal' data-uname\x3d'loginRestPassword' ng-click\x3d'openForgotPassword();'\x3e"+thisLocale.messages["app.label.dashboard.pwdexpire3"]+"\x3c/a\x3e "+thisLocale.messages["app.login.label.passwordExpired2"];addLoginAlerts("danger",pwdExipredMsg,isFirstTime);break;case statusEnum.FORGET_PASSWORD:$window.location.href=urlService.forgetPassword;
break;case statusEnum.ACCOUNT_SUSPENDED:addLoginAlerts("danger",thisLocale.messages["app.errorMessage.suspended.buyer"],isFirstTime);break;case statusEnum.ACCOUNT_LAPSED:addLoginAlerts("danger",thisLocale.messages["app.errorMessage.lapsed.buyer"],isFirstTime);break;case statusEnum.ERROR:addLoginAlerts("danger",thisLocale.messages["app.login.label.internalServerError"],isFirstTime);break;case statusEnum.ACCOUNT_LOCKED:var lockMsg=thisLocale.messages["app.login.label.accountLocked"]+"\x3ca ng-click\x3d'openForgotPassword();'\x3e"+
thisLocale.messages["app.label.dashboard.pwdexpire3"]+"\x3c/a\x3e "+thisLocale.messages["app.login.label.accountLocked2"];addLoginAlerts("danger",lockMsg,isFirstTime);break;case statusEnum.MULTIPLE_ACCOUNTS_WITH_SAME_EMAIL_ID:addLoginAlerts("danger",thisLocale.messages["app.error.label.MULTIPLE_ACCOUNTS_WITH_SAME_EMAIL_ID"],isFirstTime);break;case statusEnum.BIDDER_ACCOUNT_VACANT_LOGIN_FAILURE:addLoginAlerts("danger",thisLocale.messages["app.login.label.bidderAccountVacantLogin"],isFirstTime);break;
case statusEnum.BAD_CREDENTIALS:addLoginAlerts("danger",thisLocale.messages["app.login.label.badCredentials"],isFirstTime);break}},function(data){if(data!=undefined&&data!=null){var dbMessage=data.message;if(dbMessage!=undefined&&dbMessage!=null)if(dbMessage.indexOf("BadCredentialsException">-1)){var userMessage=dbMessage.substring(dbMessage.indexOf(":"),dbMessage.length);addLoginAlerts("danger","Unable to continue."+userMessage,isFirstTime)}}else addLoginAlerts("danger","Unable to continue. The following error needs to be corrected:The User ID or password provided is incorrect",
isFirstTime)});return true}else{if(isFirstTime)$window.location.href="/tempPasswordExpired";return false}};var validateForm=function(form){var username=form.username;var password=form.password;self.resetLoginErrors();if(form.userUId)return true;if(/\s/.test(username)){addLoginAlerts("danger","Spaces are not allowed in User ID");return false}if(isDecimalIfNumber(username)){addLoginAlerts("danger","Decimals are not allowed in User ID");return false}if(!username||0===username.length){addLoginAlerts("danger",
thisLocale.messages["app.login.label.emailOrUserId"]);return false}if(!password||0===password.length){addLoginAlerts("danger","Password is required");return false}if(!username&&!password){addLoginAlerts("danger","Unable to continue. The following error needs to be corrected:The User ID or password provided is incorrect");return false}if(!username||username.length>self.emailRule.maxLength){addLoginAlerts("danger","Unable to continue. The following error needs to be corrected:The User ID or password provided is incorrect");
return false}if(isNaN(username))if(!validateEmail(username)){addLoginAlerts("danger","Unable to continue. The following error needs to be corrected:The User ID or password provided is incorrect");return false}if(password.length<currentPasswordMinLength||password.length>maxLength){addLoginAlerts("danger",thisLocale.getMessageStr("app.error.invalid.password.length",[currentPasswordMinLength,maxLength]));return false}else return true};function isDecimalIfNumber(username){if(username&&!isNaN(username)){var onlyDigitsPattern=
/^-?[0-9]+$/;if(!onlyDigitsPattern.test(username))return true}return false}self.resetPwdForm={};self.emailPassword=function(isIDProvided){if(!isIDProvided)self.resetPwdForm.showEmailRequiredError=true;else if(!isNaN(self.resetPwdForm.userIDOrEmail)||validateEmail(self.resetPwdForm.userIDOrEmail)){if(!isNaN(self.resetPwdForm.userIDOrEmail))if(self.resetPwdForm.userIDOrEmail.length>6){self.resetPwdForm.showEmailRequiredError=true;return}self.emailPasswordService(self.resetPwdForm.userIDOrEmail)}else self.resetPwdForm.showEmailRequiredError=
true};self.emailPasswordService=function(userIDOrEmail){dataServiceG2.emailPassword(userIDOrEmail,function(response){if(response.returnCode==1){$("#forgotuserid").modal("hide");$("#Successforgotuserid").modal("show")}else if(response.returnCodeDesc=="InvalidUserID")self.resetPwdForm.showEmailRequiredError=true;else if(response.returnCodeDesc=="UnknownError"){$("#forgotuserid").modal("hide");$("#forgotuseridFailed").modal("show")}else{$("#forgotuserid").modal("hide");$("#forgotuseridFailed").modal("show")}})};
self.getEmailID=function(){return this.emailId};self.getSavedSecurityQuestions=function(email){if(!email){self.resetPwdForm.showEmailRequiredError=true;return}else if(!isNaN(email)||validateEmail(email)){self.emailId=email;if(!isNaN(email))if(email.length>6){self.resetPwdForm.showEmailRequiredError=true;return}self.userQuestion=[];dataServiceG2.getSavedSecurityQuestions(email,{onSuccess:function(response){if(response.returnCode==1)if(response.data.questions&&response.data.questions.length>0){self.questions=
self.appConfig.getSecurityQuestions();_.each(response.data.questions,function(selectedQuestion){_.each(self.questions,function(availableQuestion){if(availableQuestion.questionId==selectedQuestion.questionId)self.userQuestion.push(availableQuestion)})});$("#askSecurityQuestions").modal("show");$("#forgotuserid").modal("hide");$("#loginRegister").modal("hide")}else{$("#NoSecurityQuestions").modal("show");$("#forgotuserid").modal("hide");$("#loginRegister").modal("hide")}else{$("#forgotuseridFailed").modal("show");
$("#forgotuserid").modal("hide");$("#loginRegister").modal("hide")}},onFailure:function(response){}})}else self.resetPwdForm.showEmailRequiredError=true;return self.userQuestion};function validateEmail(email){var emailReg=isGlobal?/^([\w-\.√Ñ√ñ√ú·∫û√§√∂√º√ü√°√©√≠√≥√∫√Ω√±√ë√Ø√º√ú√Å√â√ç√ì√ö√ùƒÑƒÖƒÜƒáƒòƒô≈Å≈Ç≈É≈Ñ√ì√≥≈ö≈õ≈π≈∫≈ª≈º¬ø¬°]+@([\w-]+\.)+[\w-]{2,})?$/:/^([\w-\.]+@([\w-]+\.)+[\w-]{2,})?$/;if(!emailReg.test(email))return false;else return true}var addLoginAlerts=function(type,msg,isFirstTime){if(isFirstTime)$window.location.href="/tempPasswordExpired";
else self.loginAlerts.push({msg:msg,type:type})};self.resetLoginErrors=function(){self.loginAlerts.splice(0,self.loginAlerts.length)};self.closeLoginAlert=function(index){self.loginAlerts.splice(index,1)}}]);
app.controller("loginController",["$scope","$location","$filter","urlService","dataServiceG2","loginService","localStorageService","appConfigService","userService","$window","copartUser","memberChoicesService","vcRecaptchaService","$routeParams","constants",function($scope,$location,$filter,urlService,dataServiceG2,loginService,localStorageService,appConfigService,userService,$window,copartUser,memberChoicesService,vcRecaptchaService,$routeParams,constants){var self=$scope;self.isFormSubmitted=false;
var rememberedID=localStorageService.cookie.get("username");self.form={username:rememberedID};self.showSavingError=false;self.verifyResponse={};self.verifyResponse.data=[];self.errorQuestionIds=[];self.userQuestion={};self.passwordRulePref=copartUser.getUserConfig().displayPref.passwordRule||{};self.minLength=self.passwordRulePref.minLength||constants.PASSWORD_MIN_LENGTH;self.maxLength=self.passwordRulePref.maxLength?self.passwordRulePref.maxLength:constants.PASSWORD_MAX_LENGTH;var userId=$filter("sanitize_html")($location.search().existingEmail);
function init(){if($routeParams.show)jQuery("#"+$routeParams.show).modal("show")}init();self.emailRule=copartUser.getUserConfig().emailRule;if(typeof rememberedID!=="undefined"&&rememberedID!==null&&rememberedID!=="")self.form.rememberme=true;self.showError=null;self.locale=self.$parent.locale;if($location.search().accountType)self.form.accountType=$location.search().accountType;else self.form.accountType="0";if($location.search().redirectUrl)urlService.redirectUrl=decodeURIComponent($location.search().redirectUrl).replace(/[\\$@]/g,
"").split("//").join("");loginService.loginAlerts=[];self.loginAlerts=loginService.loginAlerts;self.closeLoginAlert=loginService.closeLoginAlert;self.getSavedSecurityQuestions=function(email){self.userQuestion=loginService.getSavedSecurityQuestions(email);self.resetPwdForm=loginService.resetPwdForm};self.emailPassword=function(isIDProvided){loginService.emailPassword(isIDProvided);self.resetPwdForm=loginService.resetPwdForm};self.submitForm=function(action,form,isFirstTime){self.submitted=true;loginService.submitForm(action,
form,isFirstTime,kiosk)};self.resetPwdForm=loginService.resetPwdForm;self.goToSellerLogin=function(){$window.location.href=appConfigService.getEnvConfigProps().sellerLoginURL};memberChoicesService.init();dataServiceG2.getSiteKey(function(response){self.siteKey=response.data});var token1=$location.search().token1;var token2=$location.search().token2;if(token1&&token2){var form={};form.username=token2;form.password=token1;form.accountType={};form.accountType.value="0";form.forgetPassword=true;loginService.submitForm("processLogin",
form,true,false)}self.verifyQuestions=function(isFormValid){self.isFormSubmitted=true;if(!isFormValid)return;self.errorQuestionIds=[];self.showSavingError=false;dataServiceG2.verifySecurityQuestions(self.getSecurityQuestionsPostData(self.userQuestion),{onSuccess:function(verifyResponse){self.result=verifyResponse.data;if(verifyResponse.returnCode=="1"){$("#askSecurityQuestions").modal("hide");if(verifyResponse.data.key)$location.url("/create-password?key\x3d"+verifyResponse.data.key);else self.showSavingError=
true}else if(verifyResponse.data.errorMsg)self.showSavingError=true;else _.each(verifyResponse.data,function(item){if(item.code=="3"){$("#SecurityQuestionsAccountLocked").modal("show");$("#askSecurityQuestions").modal("hide")}else self.errorQuestionIds.push(item.questionId)})},onFailure:function(verifyResponse){}})};self.getSecurityQuestionsPostData=function(questions){return{"email":loginService.getEmailID(),"questions":questions}};self.resetPassword=function(isValid,email){if(!userService.userConfig.defaultDisplayPref.hasOwnProperty("showSecurityQuestions")||
userService.userConfig.defaultDisplayPref.showSecurityQuestions)self.getSavedSecurityQuestions(email);else if(isValid)self.emailPassword(!_.isEmpty(email));else alert("It looks like there are some errors with your submission")};self.openForgotPassword=function(){$window.location.href="/login/?forgotPassword"};if(userId){$("#forgotuserid").modal("show");self.resetPwdForm.userIDOrEmail=userId}self.getResetPasswordLinkToMail=function(email){loginService.emailPasswordService(email)};$("#loginRegister").on("hidden.bs.modal",
function(){self.form.username=rememberedID||"";self.form.password=""});if($location.search().errorFailure=="forgetPass"||$location.search().forgotPassword)$("#forgotuserid").modal("show");self.isReCaptchaEnabled=function(){dataServiceG2.getEnvConfigPropsPromise().then(function(data){if(data&&data.enableReCaptcha)$("#forgotuserid").on("shown.bs.modal",function(e){if(grecaptcha)grecaptcha.reset()})})};self.isReCaptchaEnabled()}]);
app.controller("homeContentController",["$scope","$http","$timeout","$locale","dataServiceG2","searchCriteriaFactory","$location","userService","copartUser","auctionsCalendarService","urlService","metaDataService","localStorageService","searchCriteriaConstants",function($scope,$http,$timeout,$locale,dataServiceG2,searchCriteriaFactory,$location,userService,copartUser,auctionsCalendarService,urlService,metaDataService,localStorageService,searchCriteriaConstants){var self=$scope;self.quickPicks=new QuickPicks;
self.liveAuctions=0;self.pageId="HOME";var auctionsCountPromise=null;var quickPickCountUpdate=null;self.aucListLoading=false;self.todaysAuctionsList=[];self.todaysDate=new Date;self.userConfig=copartUser.getUserConfig();self.searchCriteria=searchCriteriaFactory.getSearchCriteria(searchCriteriaConstants.lotSearch);auctionsCalendarService.getAllAuctionData().then(function(data){var count=0;_.each(data.todayAuctions.liveAuctions,function(auction){if(auction.laneInfoList!=null)count=count+auction.laneInfoList.length});
self.liveAuctions=count;self.auctionList=_.clone(data.todayAuctions.liveAuctions);if(data.todayAuctions.laterAuctions.length>0)_.each(data.todayAuctions.laterAuctions,function(auctions){if(auctions.yardNumber!=770&&auctions.yardNumber!=771)self.auctionList.push(auctions)});self.aucListLoading=false});self.getAllLaneSaleListResultUrl=function(auction){return urlService.getAllLaneSaleListResultUrl(auction)};self.init=function(){self.aucListLoading=true;self.searchCriteria.reset()};self.init();self.searchQuickPicks=
function(query){var miscFilter=self.searchCriteria.getMiscFilter();miscFilter.push(query);self.searchCriteria.setMiscFilter(miscFilter);return true};$scope.$on("$destroy",function(){if(auctionsCountPromise)$timeout.cancel(auctionsCountPromise);if(quickPickCountUpdate)$timeout.cancel(quickPickCountUpdate)});self.doTagHomePageBannerZoneId=function(zoneid){var bannerTrackingInfo={};bannerTrackingInfo.memNumber=copartUser.getUserConfig().buyerNumber;bannerTrackingInfo.zoneid=zoneid;copartOmnitureCallOne("doTagHomePageBannerZoneId",
bannerTrackingInfo)}}]);
app.controller("myBidsController",["$scope","$filter","$http","$locale","$routeParams","copartUser","userService","$compile","config","$location","backToLinkService","dataServiceG2","saveLotNumbersService","auctionsCalendarService","appConfigService","localStorageService","History","dataTableConfig","watchListService","urlService","$timeout",function($scope,$filter,$http,$locale,$routeParams,copartUser,userService,$compile,config,$location,backToLinkService,dataServiceG2,saveLotNumbersService,auctionsCalendarService,
appConfigService,localStorageService,History,dataTableConfig,watchListService,urlService,$timeout){var self=$scope;self.locale=$scope.$parent.locale;var table=new ServersideDatatable_DB(saveLotNumbersService,dataTableConfig);watchListService.setWatchListDefinition($location.url());self.filterType=$routeParams.filterType;var buyerNumber=copartUser.getUserConfig().buyerNumber;self.yardDetails={};self.liveAuction=[];self.bidderList=null;self.watchList=[];self.images={};self.selectedBidder=null;self.selBidderObj=
null;self.backToLink=$location.url();backToLinkService.setBackToLink(self.backToLink);self.selectedFilterType=self.locale.messages["app.label.all.bids"];self.dateFormat=copartUser.getUserConfig().displayPref.dateFormat.toUpperCase();self.defaultTimeFormat=copartUser.getUserConfig().displayPref.timeFormat;self.auctionDateFormat=self.dateFormat+" \x3cbr\x3e "+self.defaultTimeFormat+" zz";self.selectedTimezone=copartUser.getUserConfig().selectedTimezone;self.isMakeAnOffer=false;self.loadingSearchResults=
true;var isGlobal=self.$parent.isGlobal;var currencyFilterName=isGlobal?"globalize_currency":"globalize_currency_using_code";var log=new Logger({name:"myBidsController",level:config.logLevel});self.initializeDatatable=function(id){if(!$.fn.DataTable.isDataTable(id))self.id=$(id).DataTable({"processing":true,"bPaginate":true,"deferRender":true,"pagingType":"full_numbers","ordering":true,"info":true,"lengthMenu":[[20,25,50,100],[20,25,50,100]],"aaSorting":[],"sDom":'\x3c"top"lifp\x3c"clear"\x3e\x3ert\x3c"bottom"lifp\x3c"clear"\x3e\x3e',
"columnDefs":[{className:"control",orderable:false,targets:-1},{"bSortable":false,"aTargets":["sorting_disabled"]}],"language":{"paginate":{"first":self.locale.messages["app.label.first"],"previous":self.locale.messages["app.label.previous"],"next":self.locale.messages["app.label.next"],"last":self.locale.messages["app.label.last"]},"lengthMenu":self.locale.messages["app.label.show"]+" _MENU_ "+self.locale.messages["app.label.entries"],"info":self.locale.messages["app.label.showingRecords.info"],
"emptyTable":self.locale.messages["app.myOffers.emptytable"],"searchPlaceholder":self.locale.getMessage("app.label.searchListPlaceholder"),"infoEmpty":self.locale.messages["app.label.zeroVehicleFound"],"infoFiltered":"","search":self.locale.getMessage("app.label.search")+":"}});else self.id.draw()};var myBidsPreferenceConstants={MY_BIDS_PREF_COL_STR:"myBidsPreference.columns"};var getBidderNumber=function(bidderNumber){bidderNumber=bidderNumber||self.selectedBidder||0;return bidderNumber};var showRunLightsColumn=
copartUser.hasAccessSitePref(myBidsPreferenceConstants.MY_BIDS_PREF_COL_STR,"showRunLightsColumn");var showSellerNameColumn=copartUser.hasAccessSitePref(myBidsPreferenceConstants.MY_BIDS_PREF_COL_STR,"showSellerNameColumn");var showCRGradeColumn=copartUser.hasAccessSitePref(myBidsPreferenceConstants.MY_BIDS_PREF_COL_STR,"showCRGradeColumn");var showDocTypeColumn=copartUser.hasAccessSitePref(myBidsPreferenceConstants.MY_BIDS_PREF_COL_STR,"showDocTypeColumn");var showDamageColumn=copartUser.hasAccessSitePref(myBidsPreferenceConstants.MY_BIDS_PREF_COL_STR,
"showDamageColumn");var showEstRetailValue=copartUser.hasAccessSitePref(myBidsPreferenceConstants.MY_BIDS_PREF_COL_STR,"showEstRetailValue");function checkIfFromDetails(){try{var lastRoute=History.lastRoute;if(lastRoute&&(lastRoute.indexOf("lot/")==0||lastRoute.indexOf("invoiceDetails/")==0))return true;else return false}catch(e){return false}}var state=false;var stateRestoreFromAnywhere=localStorageService.get("restore-search-state-from-anywhere");localStorageService.remove("restore-search-state-from-anywhere");
if(checkIfFromDetails()||$location.search().state=="restore"||stateRestoreFromAnywhere){state=localStorageService.get("restore-search-state");localStorageService.remove("restore-search-state");self.viewedLot=localStorageService.get("viewed-lot");localStorageService.remove("viewed-lot")}var tableId="#mybids-datatable";if(self.filterType)if(self.filterType==="Winning"||self.filterType==="NotWinning"){self.url="/data/lots/currentBids/";if(self.filterType==="Winning")self.selectedFilterType=self.locale.messages["app.label.winning"];
else self.selectedFilterType=self.locale.messages["app.label.outBid"]}else if(self.filterType==="myOffers")dataServiceG2.getMakeAnOfferItems(function(response){$scope.isMakeAnOffer=true;if(response.returnCode!=-1&&response.data.length>0){$("#makeAnOfferClientDataTable tbody").empty();$scope.makeAnOffer=response.data;_.each($scope.makeAnOffer,function(e){if(e.saleDate==null)e.saleDate=self.locale.messages["app.label.notApplicable"];else if(e.futureSale)e.saleDate=self.locale.messages["app.label.future"];
else e.saleDate=moment.utc(e.saleDate).tz(userService.userConfig.selectedTimezone).format(self.auctionDateFormat)});$timeout(function(){self.initializeDatatable("#makeAnOfferClientDataTable")},0)}else if(response.returnCode=-1)$timeout(function(){self.initializeDatatable("#makeAnOfferClientDataTable")},0)});else{if(self.filterType==="currentBids")self.selectedFilterType=self.locale.messages["bidder.grid.title.currentbid"];else self.selectedFilterType=self.locale.messages["app.label.open.items"];self.url=
"/data/lots/"+self.filterType+"/"}else{self.url="/data/lots/myBids/";self.selectedFilterType=self.locale.messages["app.label.all.bids"]}table.overrideDefaults=function(data){var filterJSONString={filters:[]};var bidStatusFilter={};var lotStatusFilter={};var bidderFilter={};if($routeParams.filterType==="Winning"){lotStatusFilter.filterBy="bidStatus";lotStatusFilter.filterValue=["HIGHBIDDER"];filterJSONString.filters.push(lotStatusFilter)}else if($routeParams.filterType==="NotWinning"){lotStatusFilter.filterBy=
"bidStatus";lotStatusFilter.filterValue=["OUTBID"];filterJSONString.filters.push(lotStatusFilter)}if(self.selectedBidder){bidderFilter.filterBy="bidderNumber";bidderFilter.filterValue=[self.selectedBidder];filterJSONString.filters.push(bidderFilter)}data.filterCriteria=JSON.stringify(filterJSONString)};self.findMake=function(make){if(!make)return make;var makeObj=_.find(self.appConfig.vehicleMakeandModels,function(obj){if(obj.type&&obj.type.trim()==make.trim())return true});return makeObj?makeObj.code.toUpperCase():
make};self.acceptOfferModal=function(makeOfferVO){self.makeOfferVO=makeOfferVO;$("#MakeAnOfferAcceptModal").modal("show")};self.acceptOffer=function(){var data={};data.lotNumber=self.makeOfferVO.lotNumber;data.offerAmt=self.makeOfferVO.minBid;data.secretKey=self.makeOfferVO.randomHash;if(self.makeOfferVO.goAppLot=="Y")data.golot=true;else if(self.makeOfferVO.goAppLot=="N")data.golot=false;data.type="ACCEPT";dataServiceG2.acceptOffer(data,function(response){var responseCode=response.returnCodeDesc;
$("#MakeAnOfferAcceptModal").modal("hide");if(response.returnCode!=-1&&responseCode==="Success"){self.makeAnOfrSuccess=true;$("#AcceptOfferResponseModal").modal("show");copartOmnitureCallMulti("doTagMyOffersAcceptOffer",[copartUser.getUserConfig().buyerNumber])}else if(response.returnCode==-1){self.makeAnOfrSuccess=false;var errorCode=response.data.errorObject.code;if(errorCode!=null){self.acceptOfrError=getMakeAnOfferErrorMessage(response.data.errorObject);$("#AcceptOfferResponseModal").modal("show")}}})};
var getMakeAnOfferErrorMessage=function(errorObj){if(!errorObj)return;var errorCode=errorObj.code?errorObj.code.trim():"";if(self.locale.messages["app.acceptOffer.error.errorcode."+errorCode])return self.locale.getMessage("app.acceptOffer.error.errorcode."+errorCode);else return errorObj.message};var getWatchListForBuyer=function(){$http({method:"GET",url:"/data/lots/watchList"}).then(function successCallback(response){self.watchList=response.data.data.watchList},function errorCallback(response){})};
if(!userService.isAnonymous())getWatchListForBuyer();self.isAlreadyAdded=watchListService.isAlreadyAdded;self.addToWatchList=watchListService.addToWatchList;self.removeFromWatchList=watchListService.removeFromWatchList;self.isWatchList=watchListService.isWatchList();self.storeNavigationInfo=function(resultIndex,totalRecords){var info={backTo:"."+$location.url(),resultIndex:resultIndex,totalRecords:totalRecords};localStorageService.set("lot-navigation-info",info);localStorageService.set("restore-search-state",
true)};var populateBidder=function(bidderNumber,bidderList){self.selBidderObj=_.find(bidderList,{bidderNumber:bidderNumber})};var getAjaxUrl=function(url){url=url||"";return url+buyerNumber+"/"+getBidderNumber()};self.loadBidsData=function(){saveLotNumbersService.clearAll();var dataTableOptions={"pageLength":20,"columnDefs":[{"targets":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17],"data":null,"defaultContent":""},{"targets":["imagePath","runLights","myMaxBid","docType"],"orderable":false},{"targets":["bidderNumber"],
"visible":self.bidderList.length>1,"searchable":false},{"targets":["runLights"],"visible":showRunLightsColumn,"searchable":showRunLightsColumn},{"targets":["sellerName"],"visible":showSellerNameColumn,"searchable":showSellerNameColumn},{"targets":["crGrade"],"visible":showCRGradeColumn,"searchable":showCRGradeColumn},{"targets":["docType"],"visible":showDocTypeColumn,"searchable":showDocTypeColumn,"orderable":false},{"targets":["damage"],"visible":showDamageColumn,"searchable":showDamageColumn},{"targets":["lotAcv"],
"visible":showEstRetailValue,"searchable":showEstRetailValue},{className:"control",orderable:false,targets:-1}],"searching":!copartUser.getUserConfig().displayPref.allowSecondarySearch,"order":[[table.getColumnIndex(["saleDate"]),"desc"]],"lengthMenu":[[20,25,50,100],[20,25,50,100]],"url":getAjaxUrl(self.url),"ajaxType":"POST","stateSave":state,"stateRetrieveFunction":function(data){self.selectedBidder=data.selectedBidder;self.bidderList=data.bidderList;populateBidder(self.selectedBidder,self.bidderList);
if(self.selectedBidder!=null)self.filterTable(self.selBidderObj)},"noResultMessage":self.locale.messages["mybids.nobidsfound"]+" \x3ca href\x3d'./Content/"+appInit.regionCode+"/"+appInit.localeString+"/Support/How-to-Buy/Place-Bids'\x3e"+self.locale.messages["mybids.learnBidding"]+"\x3c/a\x3e or \x3ca href\x3d'./vehicleFinder'\x3e "+self.locale.messages["mybids.findVehicles"]+"\x3c/a\x3e "+self.locale.messages["mybids.findVehicles.text2"],"noResultInfoMessage":self.locale.messages["app.label.zeroVehicleFound"],
"fnRowCallback":function(nRow,aData,iDisplayIndex){jQuery(".nowrap",nRow).attr("nowrap","nowrap");return nRow},"dom":'\x3c"top"lipf\x3c"clear"\x3e\x3ert\x3c"bottom"lipf\x3c"clear"\x3e\x3e',"columns":[{"mData":"imgp","render":function(data,type,row,meta){var description=row["yearOfVehicle"]+" "+row["makeOfVehicle"]+" "+row["modelOfVehicle"];var lotId=row["lotId"];var currentBid=row["currentBid"];if(row["counterBidStatus"]!="DEFAULT")currentBid=row["myBid"];var backTo=self.backToLink;var resultIndex=
meta.settings._iDisplayStart+meta.row;var totalRecords=meta.settings._iRecordsTotal;var smallImageUrl=row["imageUrl"]||"";var rowSaleDate=row["saleDate"]?row["saleDate"]:0;var dateOfSale=rowSaleDate.dateAsInt?rowSaleDate.dateAsInt:0;var futureFlag=dateOfSale===0;var currencyCode=row["yardCurrencyCode"]||"";var saleDate=row["saleDate"]?row["saleDate"].date:"";var yardNumber=row["physicalYardNumber"]||"";var awardedHighBid=row["awardedHighBid"]||"";var brand=row["brand"]||"";return"\x3cfigure\x3e"+
"\x3ca lot-id\x3d'"+lotId+"' class\x3d'imgpath cursor-pointer' "+"lot-desc\x3d'"+description+"' "+(row["saleDate"]?"auction-date\x3d'"+saleDate:" ")+"' "+"currency-code\x3d'"+currencyCode+"' "+" images\x3d'images' current-bid\x3d'"+currentBid+"' award-high-bid\x3d"+currentBid+" modal-image-viewer back-to\x3d"+backTo+" result-index\x3d"+resultIndex+" total-records\x3d"+totalRecords+" yard\x3d"+yardNumber+" auction-lane\x3d"+row["auctionLane"]+" auction-date\x3d"+row["auctionDateUtc"]+" auction-id\x3d"+
row["auctionId"]+" is-future\x3d"+futureFlag+" flag\x3d1\x3e\x3cspan class\x3d'searchiconbtn'\x3e\x3c/span\x3e"+"\x3cimg src\x3d'"+smallImageUrl+"' class\x3d'img-responsive' error-image\x3d'/images/testImages/no_photo.jpg' data-uName\x3d'imgThumbNail' /\x3e"+"\x3c/a\x3e"+"\x3cfigcaption\x3e"+"\x3cdiv class\x3d'viewallphotos'\x3e"+"\x3ca class\x3d'image_viewer_link' sso-sign-on data-url\x3d'./lot/"+lotId+"/Photos?backTo\x3d/myBids' brand\x3d"+brand+"\x3e"+self.locale.messages["counterman.searchResults.viewAllPhotos.label"]+
"\x3c/a\x3e"+"\x3c/div\x3e"+"\x3c/figcaption\x3e"+"\x3c/figure\x3e"}},{"mData":"lotId","render":function(data,type,row,meta){var lotId=row["lotId"];var resultIndex=meta.settings._iDisplayStart+meta.row;var totalRecords=meta.settings._iRecordsTotal;var brand=row["brand"]||"";saveLotNumbersService.addLotNumber(lotId);if(self.viewedLot&&self.viewedLot==lotId){self.viewedRowIndex=meta.row;self.viewedLot=null}return"\x3ca data-url\x3d'./lot/"+lotId+"' sso-sign-on brand\x3d "+brand+" ng-click\x3d'storeNavigationInfo("+
resultIndex+","+totalRecords+")'\x3e"+lotId+"\x3c/a\x3e\x3cbr/\x3e"+"\x3cbutton ng-if\x3d'"+row["isWatchable"]+"' class\x3d'black-line watch-btn' ng-hide\x3d'isAlreadyAdded("+lotId+")' ng-click\x3d'addToWatchList("+lotId+")' data-uName\x3d'watchListButton'\x3e"+self.locale.messages["app.label.watch"]+"\x3c/button\x3e"+"\x3cbutton ng-if\x3d'"+row["isWatchable"]+"' class\x3d'black-line watch-btn watched' ng-hide\x3d'!isAlreadyAdded("+lotId+")' ng-click\x3d'removeFromWatchList("+lotId+")' data-uName\x3d'watchListButton'\x3e"+
self.locale.messages["app.label.remove"]+"\x3c/button\x3e"}},{"mData":"yearOfVehicle","render":function(data,type,row){var yearOfVehicle=row["yearOfVehicle"]||"";if(row["lotIcons"]){var iconCodes=_.intersection(row["lotIcons"],self.validIconCodes);var template="\x3cspan data-uname\x3d'lotsearchLotcenturyyear'\x3e"+yearOfVehicle+"\x3c/span\x3e\x3cbr\x3e";return self.generateIconTemplate(template,iconCodes)}return yearOfVehicle}},{"mData":"makeOfVehicle","render":function(data,type,row){return row["makeOfVehicle"]}},
{"mData":"modelOfVehicle","render":function(data,type,row){return row["modelOfVehicle"]}},{"mData":"itemNumber","render":function(data,type,row){return row["itemNumber"]}},{"mData":"yardName","render":function(data,type,row){var yardNumber=row["physicalYardNumber"]||"";var yardName=row["yardName"]||"";if(yardNumber&&yardName)return"\x3ca class\x3d'cursor-pointer' data-uname\x3d'lotLocation' href\x3d'"+urlService.getLocationUrl(yardNumber)+"' target\x3d'_blank'\x3e"+yardName+"\x3c/a\x3e\x3c/td\x3e"}},
{"mData":"runLights","render":function(data,type,row){if(row["runLights"]){var template="";return self.generateRunLightTemplate(template,row["runLights"])}else return""}},{"mData":"sellerName"},{"mData":"crGrade","render":function(data,type,row){if(row["crGrade"]||row["crGrade"]==0){var html="\x3ccondition-report lot-number\x3d "+row["lotId"]+" display-name\x3d"+row["crGrade"]+" document-type\x3d'VGLK_CONDITION_REPORT'\x3e\x3c/condition-report\x3e";return html}return""}},{"mData":"auctionDateUtc",
"render":function(data,type,row){var isFuture=row["futureSale"]||false;var saleDate=row["auctionDateUtc"]?moment.utc(row["auctionDateUtc"]).tz(self.selectedTimezone).format(self.auctionDateFormat):self.locale.messages["app.label.notApplicable"];var html="\x3cul class\x3d'list-unstyled'\x3e";html+="\x3cli ng-if\x3dliveAuction["+row["lotId"]+'] class\x3d"btn btn-success"\x3e'+self.locale.messages["app.label.live.now"]+"\x3c/li\x3e";html+="\x3cli ng-if\x3d'(!liveAuction["+row["lotId"]+"] \x26\x26 "+
isFuture+")' data-uName\x3d'saleDate'\x3e"+self.locale.messages["app.label.future"]+"\x3c/li\x3e"+"\x3cli ng-if\x3d'(!liveAuction["+row["lotId"]+"] \x26\x26 "+!isFuture+")' data-uName\x3d'saleDate'\x3e"+saleDate+"\x3c/li\x3e";html+="\x3c/ul\x3e";return html}},{"mData":"odometerReading","render":function(data,type,row){if(!_.isUndefined(data)&&row["odometerType"])return $filter("globalize_number")(row["odometerReading"])+" "+row["odometerType"];else return row["odometerReading"]?$filter("globalize_number")(row["odometerReading"]):
""}},{"mData":"docType","render":function(data,type,row){return row["docType"]}},{"mData":"damageType","render":function(data,type,row){return row["damageType"]?copartUser.getUserConfig().selectedLang=="en"?row["damageType"].toTitleCase():row["damageType"]:""}},{"mData":"actualCostOfVehicle","render":function(data,type,row){var currencyCode=row["yardCurrencyCode"]||"";return $filter(currencyFilterName)(row["actualCostOfVehicle"],currencyCode)}},{"mData":"bidderNumber","sClass":"bidderNumber","render":function(data,
type,row){if(row["bidderNumber"])return row["bidderNumber"];else return}},{"mData":"bidStatusStr","render":function(data,type,row,meta){var html="\x3cul class\x3d'list-unstyled'\x3e";var lotId=row["lotId"];var resultIndex=meta.settings._iDisplayStart+meta.row;var totalRecords=meta.settings._iRecordsTotal;var brand=row["brand"]||"";var currencyCode=row["yardCurrencyCode"]||"";if(row["counterBidStatus"]=="DEFAULT")html+="\x3cli\x3e"+self.locale.messages["app.label.currentBid"]+":\x3c/li\x3e"+"\x3cli data-uname\x3d'currentBid'\x3e "+
$filter(currencyFilterName)(row["currentBid"],currencyCode)+"\x3c/li\x3e";if(row["counterBidStatus"]!="DEFAULT")html+="\x3cli\x3e"+self.locale.messages["app.label.currentBid"]+":\x3c/li\x3e"+"\x3cli data-uname\x3d'currentBid'\x3e"+$filter(currencyFilterName)(row["myBid"],currencyCode)+"\x3c/li\x3e";if(row["bidStatus"]){if(row["bidStatus"]==="HIGH_BIDDER"&&row["counterBidStatus"]!="SELLER_COUNTERED"&&row["counterBidStatus"]!="AWAITING_SELLER_RESPONSE"&&row["counterBidStatus"]!="AWAITING_APPROVAL")html+=
"\x3cli class\x3d'btn btn-success' data-uName\x3d'lotStatus'\x3e"+self.locale.messages["app.label.winning"]+"\x3c/li\x3e";if(row["bidStatus"]==="OUT_BID"&&row["counterBidStatus"]!="SELLER_COUNTERED"&&row["counterBidStatus"]!="AWAITING_SELLER_RESPONSE"&&row["counterBidStatus"]!="AWAITING_APPROVAL")html+="\x3cli class\x3d'btn btn-danger' data-uName\x3d'lotStatus'\x3e"+self.locale.messages["lotdetail.bidStatus.outBid"]+"\x3c/li\x3e"}if(row["counterBidStatus"]=="AWAITING_SELLER_RESPONSE"||row["counterBidStatus"]==
"SELLER_COUNTERED")html+="\x3cli class\x3d'btn btn-warning' data-uName\x3d'lotStatus'\x3e"+"\x3ca sso-sign-on brand\x3d"+brand+" data-url\x3d'./lot/"+lotId+"?resultIndex\x3d"+resultIndex+"\x26totalRecords\x3d"+totalRecords+"\x26backTo\x3d{{backToLink}}\x26flag\x3d1'\x3e"+self.locale.messages["lotdetail.bidStatus."+row["counterBidStatus"]]+"\x3c/a\x3e\x3c/li\x3e";else if(row["counterBidStatus"]=="AWAITING_APPROVAL")html+="\x3cli class\x3d'btn btn-warning' data-uName\x3d'lotStatus'\x3e"+self.locale.messages["lotdetail.bidStatus.AWAITING_APPROVAL"]+
"\x3c/li\x3e";html+="\x3c/ul\x3e";return html}},{"mData":"maxBid","render":function(data,type,row){var html="";var lotId=row["lotId"];var brand=row["brand"]||"";self.testCounter=0;var yardNumber=row["physicalYardNumber"]||"";var currencyCode=row["yardCurrencyCode"]||"";var auctionHostId=row["auctionHostId"]||"";var saleDate=row["saleDate"]?row["saleDate"].date:"";auctionsCalendarService.isAuctionLive(auctionHostId,row["auctionLane"],saleDate,row["auctionId"]).then(function(flag){self.liveAuction[lotId]=
flag});if(row["counterBidStatus"]!="SELLER_COUNTERED"&&row["counterBidStatus"]!="AWAITING_SELLER_RESPONSE"&&row["counterBidStatus"]!="AWAITING_APPROVAL"){html="\x3cul class\x3d'list-unstyled' ng-if\x3d'liveAuction["+lotId+"]'\x3e\x3cli\x3e";html+='\x3ca data-toggle\x3d"modal" id\x3d"join-auction-laneselector"'+' sso-sign-on data-url\x3d"./auctionDashboard?auctionDetails\x3d'+row["auctionHostId"]+"-"+row["auctionLane"]+"-"+lotId+'" class\x3d"button small blue ajax btn btn-green" brand\x3d'+brand+"\x3e"+
self.locale.messages["app.label.bidNow"]+"\x3c/a\x3e";html+="\x3c/li\x3e\x3c/ul\x3e";html+="\x3cul class\x3d'list-unstyled' ng-if\x3d'!liveAuction["+lotId+"]'\x3e";html+="\x3cli\x3e"+self.locale.messages["app.label.myMaxBid"]+":\x3c/li\x3e"+"\x3cli data-uname\x3d'maxBid'\x3e "+$filter(currencyFilterName)(row["myMaxBid"],currencyCode)+"\x3c/li\x3e"+"\x3cli\x3e\x3ca sso-sign-on data-url\x3d'./lot/"+lotId+"' class\x3d'btn btn-primary' data-uName\x3d'increaseBid' brand\x3d"+brand+"\x3e"+self.locale.messages["app.label.increaseBid"]+
"\x3c/a\x3e\x3c/li\x3e"+"\x3c/ul\x3e"}else{html+="\x3cul class\x3d'list-unstyled' ng-if\x3d'!liveAuction["+lotId+"]'\x3e";html+="\x3cli data-uname\x3d'maxBid'\x3e";if(row["currentBid"])html+=" "+$filter(currencyFilterName)(row["currentBid"],currencyCode);html+="\x3c/li\x3e"+"\x3c/ul\x3e"}return html}},{"mData":"","render":function(data,type,row){return""}}],"language":{"paginate":{"first":self.locale.messages["app.label.first"],"previous":self.locale.messages["app.label.previous"],"next":self.locale.messages["app.label.next"],
"last":self.locale.messages["app.label.last"]},"lengthMenu":self.locale.messages["app.label.show"]+" _MENU_ "+self.locale.messages["app.label.entries"],"info":self.locale.messages["app.label.showingRecords.info"],"infoFiltered":"("+self.locale.messages["app.label.filteredFrom"]+" _MAX_ "+self.locale.messages["app.label.totalEntries"]+")","searchPlaceholder":self.locale.getMessage("app.label.searchListPlaceholder"),"search":self.locale.getMessage("app.label.search")+":"}};var datatable=table.initServerSideDataTable("#serverSideDataTable",
dataTableOptions,function(){self.compileDom("#serverSideDataTable");$(window).trigger("scrollToPoint");$timeout(function(){if(self.viewedRowIndex||self.viewedRowIndex==0){jQuery("#serverSideDataTable"+" tbody tr").eq(self.viewedRowIndex).addClass("bold fs12");self.viewedRowIndex=null}},0)});datatable.on("stateSaveParams.dt",function(e,settings,data){data.selectedBidder=self.selectedBidder;data.bidderList=self.bidderList});datatable.on("responsive-display.dt",function(e,datatable,row){$compile(row.child())(self)})};
dataServiceG2.getBidderStatusList(function(responseData){if(responseData.returnCode==-1)log.error("Error");else{self.bidderList=responseData.data;self.loadBidsData()}});self.filterTable=function(bidderObj){self.selectedBidder=bidderObj?bidderObj.bidderNumber:null;self.reloadTable()};self.compileDom=function(table){var $dest=jQuery(table).find("tbody");var retn=$compile($dest)($scope);self.$apply()};self.reloadTable=function(){var temptable=jQuery("#serverSideDataTable").DataTable();temptable.ajax.url(getAjaxUrl(self.url)).load()};
var highlightIcons=_.where(appConfigService.appConfig.getHighlightIcons(),{iconType:"H"});self.validIconCodes=_.pluck(highlightIcons,"iconCode");self.generateIconTemplate=function(template,iconCodes){template=template+'\x3cspan copart-vehicle-iconss class\x3d" highlighticon""\x3e ';for(var i=0;i<iconCodes.length;i++){var code=iconCodes[i];template+='\x3ca lot-highlights-tool-tip fragment-id\x3d"'+code+'" class\x3d"icon-tooltip popover-parent" data-placement\x3d"auto right" data-toggle\x3d"popover" data-container\x3d".mybids"\x3e'+
'\x3cspan class\x3d"vehicleicon"\x3e\x3cimg src\x3d"../images/global/highlightIcons-'+appInit.regionCode+'.png" class\x3d"lotIcon-'+code+' bid-icon-img"\x3e\x3c/span\x3e\x3c/a\x3e'}template=template+"\x3c/span\x3e";return template};self.generateRunLightTemplate=function(template,iconCodes){var runLightsTemplate="";var defaultRunLights=["green","red","yellow","blue"];var lotRunLights=iconCodes||[];lotRunLights=lotRunLights.toString().toLowerCase();runLightsTemplate+='\x3cspan class\x3d"float-none"\x3e';
_.each(defaultRunLights,function(code){if(lotRunLights.indexOf(code)>-1){var highLightedClass="dot";runLightsTemplate+="\x3cspan data-uname\x3d'runLights'  class\x3d'"+code.toLowerCase()+highLightedClass+" no-wrap run-highLight'\x3e\x26nbsp;\x26nbsp;\x26nbsp;\x26nbsp;\x26nbsp;\x3c/span\x3e"}});runLightsTemplate+="\x3c/span\x3e";return runLightsTemplate}}]);
app.controller("AccountInfoController",["$scope","$http","$locale","$location","$filter","$routeParams","dataServiceG2","accountInfoDataService","copartUser","accountAlertsService",function($scope,$http,$locale,$location,$filter,$routeParams,dataServiceG2,accountInfoDataService,copartUser,accountAlertsService){var self=$scope;self.locale=$scope.$parent.locale;self.activeTab=$routeParams.navMenu;self.showEdit=false;self.pendinguserActions=[];$scope.$watch(function(){return accountAlertsService.getAlerts()},
function(newAlerts){if(newAlerts){self.pendinguserActions=accountAlertsService.getPendingActionsFromUserActivity(newAlerts);console.log("pendinguserActions:: ",self.pendinguserActions)}});var init=function(){accountInfoDataService.getDepositRefundDetails().then(function(response){self.showHideDepositBalance=response})};init()}]);
app.controller("MessageSettingsController",["$scope","appConfigService","$routeParams","dataServiceG2","copartUser",function($scope,appConfigService,$routeParams,dataServiceG2,copartUser){var self=$scope;self.showSpinner=true;self.selects=[];self.locale=$scope.$parent.locale;self.allContinentsCache=[];self.countriesLocsMapCache={};self.memberEmailAddress=copartUser.getUserConfig().memberContactInfo.email;self.activeTab=$routeParams.navMenu;self.formSaveCheck=false;self.redirectURL=undefined;self.unsavedForm=
undefined;self.locationMsgFlag=false;var preferredLocationCode=copartUser.getUserConfig().preferredCountryCode!=undefined?copartUser.getUserConfig().preferredCountryCode:"usa";var memberTypeCode="WBDY";var businessTypeCode="BUTP";var vehicleTypeCode="VHTP";var vehiclePurposeCode="VPRP";var vehicleSourceCode="VSRC";var vehicleRangeCode="PROV";var copartPrimaryUseCode="PUCF";var buyerTypeCode="BYTP";var dealershipTypeCode="DTYP";var brandCode="BRND";var emailLangCode="ELNG";var locationCode="PLOC";
var offsitelot="TXTSUB";self.selChoicesDisplayName="";self.selectedBrandsDisplayName="";self.preferredLocationsLimit=copartUser.getUserConfig().displayPref.prefLocs.prefLocsLimit||5;self.getChoice=function(choiceTypeCode){return _.find(self.memberAssociatedChoices,function(choice){return choice.questionCode==choiceTypeCode})||{}};self.getHTMLElementValues=function(){self.vehicleTypes=self.getChoice(vehicleTypeCode);self.vehicleRanges=self.getChoice(vehicleRangeCode);self.vehiclePurposes=self.getChoice(vehiclePurposeCode);
self.vehicleSources=self.getChoice(vehicleSourceCode);self.copartPrimaryUses=self.getChoice(copartPrimaryUseCode);self.buyerTypes=self.getChoice(buyerTypeCode);self.dealershipTypes=self.getChoice(dealershipTypeCode);self.vehicleBrands=self.getChoice(brandCode);self.memberLocations=self.getChoice(locationCode);self.emailLanguages=self.getChoice(emailLangCode);self.offsiteLotTextSub=self.getChoice(offsitelot);if(self.emailLanguages&&self.emailLanguages.answers)_.forEach(self.emailLanguages.answers,
function(answer){if(answer.activeStatusFlag=="A")self.emailLangSelected=answer})};self.getMemberAssociatedChoices=function(){dataServiceG2.memberRegistrationChoices({onSuccess:function(response){if(response.returnCodeDesc==="Success"){self.memberAssociatedChoices=response.data||{};self.getHTMLElementValues();getDisplayNameForSelectedBrands();self.showSpinner=false;self.loadAllLocationsData()}},onFailure:function(response){self.showSpinner=false;console.log("Something went wrong in memberRegistrationChoices")}})};
self.emailLangOnSelect=function(emlang){self.populateSelection(emlang.answerCode,self.emailLanguages)};self.populateSelection=function(answerCode,choiceType){_.forEach(choiceType.answers,function(type){if(type.answerCode==answerCode)type.activeStatusFlag="A";else type.activeStatusFlag="I"})};var convertToActiveStatus=function(choiceType){_.forEach(choiceType.answers,function(type){if(type.activeStatusFlag=="E")type.activeStatusFlag="A"})};var getSelectedChoicesDisplayName=function(answers,messageKey){return _.filter(answers,
function(obj){return this.keys.indexOf(obj.activeStatusFlag)>-1},{"keys":["A","E"]}).map(function(value){return self.locale.messages[messageKey+value.answerCode]}).join()};var getDisplayNameForSelectedBrands=function(){var messageKey="member.choice.brands.";self.selectedBrandsDisplayName=getSelectedChoicesDisplayName(self.vehicleBrands.answers,messageKey)};self.checkBrandSelectBox=function($event,answer,form){self.checkBoxClicked($event,answer,form);getDisplayNameForSelectedBrands()};self.checkBoxClicked=
function($event,answer,form){form.$setDirty();var checkBox=$event.target;if(checkBox.checked)answer.activeStatusFlag="E";else answer.activeStatusFlag="I"};self.saveSettings=function(choicesArr,form){_.each(choicesArr,function(choice){convertToActiveStatus(choice)});var request={"commChoices":choicesArr};dataServiceG2.saveMessageChoices(request,{onSuccess:function(response){form.$setPristine();jQuery("#savedSettings").modal("show")},onFailure:function(response){console.log("Something went wrong")}});
var flag=true;_.each(choicesArr,function(choice){if((choice.questionCode==vehicleTypeCode||choice.questionCode==vehicleRangeCode)&&flag){copartOmnitureCallOne("doTagSaveVehicleInterest",copartUser.getUserConfig().buyerNumber);flag=false}switch(choice.questionCode){case vehiclePurposeCode:copartOmnitureCallOne("doTagSaveVehiclePurpose",copartUser.getUserConfig().buyerNumber);break;case buyerTypeCode:copartOmnitureCallOne("doTagSaveBuyerType",copartUser.getUserConfig().buyerNumber);break;case locationCode:copartOmnitureCallOne("doTagSavePreferredLocation",
copartUser.getUserConfig().buyerNumber);break;case emailLangCode:copartOmnitureCallOne("doTagSaveEmailLanguage",copartUser.getUserConfig().buyerNumber);break}})};self.countryOnChange=function(select){select.locations=self.locationsMapCache[select.selectedCountry]};self.saveLocations=function(form){var arr=[];_.forEach(self.selects,function(select){self.locationMsgFlag=false;if(select.selectedLocation){var answer={"activeStatusFlag":"A","answerCode":select.selectedLocation,"answerDescr":""};arr.push(answer)}else{self.locationMsgFlag=
true;return self.locationMsgFlag}});if(!self.locationMsgFlag){self.memberLocations.answers=arr;self.saveSettings([self.memberLocations],form)}};self.loadSavedLocations=function(){if(self.memberLocations&&self.memberLocations.answers&&self.memberLocations.answers.length>0)_.forEach(self.memberLocations.answers,function(answer){var select=self.addLocation();_.each(self.locationsMapCache,function(value,key){_.each(value,function(location){if(location.yardNumber==answer.answerCode)select.selectedCountry=
key})});select.locations=self.locationsMapCache[select.selectedCountry];select.selectedLocation=answer.answerCode!=undefined?parseInt(answer.answerCode):0});else self.addLocation()};self.buildPreferedLocations=function(response){self.locationsMapCache=response.data.countries;var countries=_.without(_.keys(self.locationsMapCache),preferredLocationCode.toLowerCase());self.countriesCache=[preferredLocationCode.toLowerCase()].concat(countries)};self.loadAllLocationsData=function(){if(_.isEmpty(self.locationsMapCache)||
_.isEmpty(self.countriesCache)){var supportedContinents=copartUser.getUserConfig().displayPref.prefLocs.prefCountires;dataServiceG2.retrieveMultipleContinentsLocationsList(supportedContinents,function(response){self.buildPreferedLocations(response);self.loadSavedLocations()})}else self.loadSavedLocations()};self.addLocation=function(){var newSelect={index:self.selects.length+1,countries:self.countriesCache,locations:self.locationsMapCache[preferredLocationCode],selectedCountry:preferredLocationCode,
selectedLocation:""};self.selects.push(newSelect);return newSelect};self.deleteSelect=function(index){self.selects.splice(index,1)};self.init=function(){self.getMemberAssociatedChoices()};self.init()}]);
app.controller("emailSubscriptionController",["$scope","$routeParams","appConfigService","dataServiceG2","copartUser","config","$filter",function($scope,$routeParams,appConfigService,dataServiceG2,copartUser,config,$filter){var self=$scope;self.unsubscribeAll=false;self.activeTab="email-subscriptions";self.showSpinner=true;var log=new Logger({name:"emailSubscriptionController",level:config.logLevel});self.memberEmailAddress=copartUser.getUserConfig().memberContactInfo.email;self.primaryphone=$filter("format_intl_phone_number")("+ "+
copartUser.getUserConfig().memberContactInfo.contactPhoneIntlDialCode+copartUser.getUserConfig().memberContactInfo.contactPhoneAreaCode+copartUser.getUserConfig().memberContactInfo.contactPhoneNumber,1);self.emailSub={vehicleAlerts:{status:"Active",emailSubscriptionName:"vehicleAlerts"},watchList:{status:"Active",emailSubscriptionName:"watchList"},specialInterests:{status:"Active",emailSubscriptionName:"specialInterests"},preferredLocations:{status:"Active",emailSubscriptionName:"preferredLocations"},
textCommunication:{status:"Active",emailSubscriptionName:"textCommunication"}};self.unsubscribeAll=false;self.unsubscribe=function(){self.unsubscribeAll=true;self.emailSub.vehicleAlerts.status="Unsubscribed";self.emailSub.watchList.status="Unsubscribed";self.emailSub.specialInterests.status="Unsubscribed";self.emailSub.preferredLocations.status="Unsubscribed";self.emailSub.textCommunication.status="Unsubscribed"};self.saveSubscriptions=function(form){copartOmnitureCallOne("doTagSaveEmailSubscription",
copartUser.getUserConfig().buyerNumber);var emailSubscriptionVO=[];_.each(self.emailSub,function(key){emailSubscriptionVO.push(key)});dataServiceG2.saveSubscriptions(emailSubscriptionVO,function(response){if(response.result){form.$setPristine();log.info("successfully saved");jQuery("#savedSettings").modal("show")}else log.info("Error occured in save Email Subscriptions")})};var init=function(){dataServiceG2.getEmailSubscriptions(function(response){var subscriptionList=response.EmailSubscriptionList;
if(subscriptionList)_.each(subscriptionList,function(list){self.emailSub[list.emailSubscriptionName].status=list.status});else log.error("error while calling getEmailSubscriptions");self.showSpinner=false})};var convertToActiveStatus=function(choiceType){_.forEach(choiceType.answers,function(type){if(type.activeStatusFlag=="E")type.activeStatusFlag="A"})};self.saveSettings=function(choicesArr,form){_.each(choicesArr,function(choice){convertToActiveStatus(choice)});var request={"commChoices":choicesArr};
dataServiceG2.saveMessageChoices(request,{onSuccess:function(response){form.$setPristine();jQuery("#savedSettings").modal("show")},onFailure:function(response){console.log("Something went wrong")}})};init()}]);
app.controller("textMessageSubscriptionController",["$scope","$routeParams","appConfigService","dataServiceG2","copartUser","config","$filter",function($scope,$routeParams,appConfigService,dataServiceG2,copartUser,config,$filter){var self=$scope;self.textSubCategories=null;self.allTextSubscriptions="";self.activeTab="text-subscriptions";self.showTextSpinner=true;var log=new Logger({name:"textMessageSubscriptionController",level:config.logLevel});self.preferredPhone=$filter("format_intl_phone_number")("+ "+
copartUser.getUserConfig().memberContactInfo.contactMobileIntlDialCode+copartUser.getUserConfig().memberContactInfo.contactMobileNoAreaCode+copartUser.getUserConfig().memberContactInfo.contactMobileNo,1);self.checkAll=function(){angular.forEach(self.textSubCategories.answers,function(item){item.activeStatusFlag="A"})};self.unCheckAll=function(){angular.forEach(self.textSubCategories.answers,function(item){item.activeStatusFlag="I"})};self.checkBoxClicked=function($event,answer,form){self.allTextSubscriptions=
"";answer.activeStatusFlag="A"};self.checkBoxUnClicked=function($event,answer,form){self.allTextSubscriptions="";answer.activeStatusFlag="I"};var getMemberRegistrationChoices=function(){dataServiceG2.memberRegistrationChoices(function(response){if(response.returnCode===1){self.memberAssociatedChoices=response.data||{};self.textSubCategories=_.find(self.memberAssociatedChoices,function(choice){return choice.questionCode=="TXTSUB"})||{}}checkIfAllTextAlertsSubscribed();self.showTextSpinner=false},function(){self.showTextSpinner=
false})};var checkIfAllTextAlertsSubscribed=function(){if(_.every(self.textSubCategories.answers,function(x){return x.activeStatusFlag=="A"}))self.allTextSubscriptions="A";else self.allTextSubscriptions="I"};var init=function(){getMemberRegistrationChoices()};self.saveSettings=function(form){var choicesArr=self.textSubCategories.answers.filter(function(value){return value.activeStatusFlag=="A"});var textChoices={};textChoices["siteCode"]=self.textSubCategories.siteCode;textChoices["questionDescr"]=
self.textSubCategories.questionDescr;textChoices["questionCode"]=self.textSubCategories.questionCode;textChoices["activeStatusFlag"]="A";textChoices["freeTextFlag"]=self.textSubCategories.freeTextFlag;textChoices["answers"]=choicesArr;var request={"commChoices":[textChoices]};dataServiceG2.saveMessageChoices(request,{onSuccess:function(response){form.$setPristine();jQuery("#savedSettings").modal("show");getMemberRegistrationChoices()},onFailure:function(response){console.log("Something went wrong")}})};
init()}]);app.controller("accountInfoFormsController",["$scope","$locale","cmsContentService",function($scope,$locale,cmsContentService){var self=$scope;self.locale=$scope.$parent.locale;var parentFragmentId="Content/US/EN/Forms/Buyer_FormsList_JSON";var fragmentId="forms_list";self.formsArray=[];var init=function(){cmsContentService.getFragmentContent(parentFragmentId).then(function(fragmentedCms){fragmentedCms=jQuery(fragmentedCms);self.formsArray=fragmentedCms[0].forms_list})};init()}]);
app.controller("AccountInfoLicenseController",["$scope","$locale","copartUtils","dataServiceG2","$sce","$timeout","licenseUploadFactory","appConfigService","accountAlertsService","constants",function($scope,$locale,copartUtils,dataServiceG2,$sce,$timeout,licenseUploadFactory,appConfigService,accountAlertsService,constants){var self=$scope;self.licenseRecords=[];self.licenseFile={};self.locale=$scope.$parent.locale;self.validFileFormats="pdf,jpg,jpeg,tif,tiff,png,gif";self.documentCategories=appConfigService.distinctDocCategories();
self.documentSubmitFailure=false;self.userSubmitted=false;self.reset=function(){$("#uploadLicenseStatus").modal("hide");$("#uploadLicenseModal").modal("hide");self.wlWaiting=false;self.message=null};self.reset();self.uploadDocumentFuncs={};self.getLicenseInfo=function(){dataServiceG2.getLicenseInfo(function(response){self.licenseRecords=response.data.licenseInfoList;_.each(self.licenseRecords,function(license){if(license.status=="ACTIVE"&&license.expires){var expires=moment(license.expires.dateAsInt,
"YYYY-MM-DD");var current=moment().startOf("day");var diff=moment.duration(expires.diff(current)).asDays();if(diff<0)license.status="EXPIRED";else if(diff<30)license.status="EXPIRED_30"}})},function(errorResponse){console.log("Error occured"+errorResponse)})};self.getLicenseInfo();self.documentSelected=function(){self.documentTypeSelected=false;if(self.inputDocumentType==null)self.inputDocumentType={}};self.uploadLicense=function(){if(_.isFunction(self.uploadDocumentFuncs.validateDocumentPayload)&&
!self.uploadDocumentFuncs.validateDocumentPayload(self.validatedFiles)){self.documentSubmitFailure=true;return}else{self.documentSubmitFailure=false;self.userSubmitted=true}if(_.isFunction(self.uploadDocumentFuncs.uploadDocuments)&&self.validatedFiles.length>0){self.userSubmitted=false;self.uploadDocumentFuncs.uploadDocuments().then(function(response){if(response=="Upload Successful!"){self.uploadStatus=true;self.validatedFiles=[];jQuery("#uploadLicenseModal").modal("hide");self.clearForm();$timeout(function(){self.getLicenseInfo();
if(!accountAlertsService.isActionCompleteForActivity(constants.REGISTRATION_USER_ACTIVITY,constants.ALERT_TYPE_STATUS.noUploadDoc))accountAlertsService.getAccountAlerts()},500)}else{self.uploadStatus=false;self.validatedFiles=[];console.log("Error occurred while uploading the license document!")}self.wlWaiting=false},function(errors){console.log("error while uploading the document :",errors);self.accountInfoSuccessHandler(response)})}else{self.message=self.locale.getMessage("app.acctInfo.uploadLicense.noFileSelected");
return false}};self.validateFile=function(){var _validFormatsArray=copartUtils.splitIntoArray(self.validFileFormats,",",true);return copartUtils.validateFile(self.licenseFile,_validFormatsArray)};self.triggerClickOnFileSelect=function(){self.message=null;$("#fileInputSelect").click()};self.clearForm=function(){self.uploadDocumentFuncs.clearForm()};self.clearAndSetValue=function(){self.licenseFile=undefined;if(_.isFunction(self.resetDocUpForm))self.resetDocUpForm();self.message=null;self.validatedFiles=
[];self.inputDocumentType=self.documentCategories[0]};self.init=function(){if(!accountAlertsService.verifyUserActionCompletedFromActivities(constants.ALERT_TYPE_STATUS.missingAccInfo))self.showDocumentsUpload=false;else self.showDocumentsUpload=true};self.init()}]);
app.controller("accountInfoChangePwdController",["$scope","$http","$locale","$routeParams","$location","$window","copartUser","dataServiceG2","constants",function($scope,$http,$locale,$routeParams,$location,$window,copartUser,dataServiceG2,constants){var self=$scope;self.accountInfoVO={};self.accountInfoVO.oldPassword;self.accountInfoVO.password;self.accountInfoVO.confirmPassword;self.isError=null;self.locale=$scope.$parent.locale;self.forgetPassword=$location.search().fp;self.passwordRule=copartUser.getUserConfig().passwordRule;
self.currentPasswordMinLength=self.passwordRule.currentPasswordMinLength?self.passwordRule.currentPasswordMinLength:constants.PASSWORD_MIN_LENGTH;self.minLength=self.passwordRule.minLength?self.passwordRule.minLength:constants.PASSWORD_MIN_LENGTH;self.maxLength=self.passwordRule.maxLength?self.passwordRule.maxLength:constants.PASSWORD_MAX_LENGTH;self.passwordPattern=self.passwordRule.pattern?self.passwordRule.pattern:constants.PATTERN;self.isValidationError=false;self.isCurrentPwdValidationError=
false;self.mismatchError=false;self.patternValidation=self.locale.getMessage("app.accountinformation.createPasswordMessage",self.minLength);self.passwordLengthMsg=self.locale.getMessage("app.accountinformation.pwd.length",self.minLength);var resetForm=function(form){self.accountInfoVO={};form.$setPristine();form.$setUntouched()};self.passwordValidate=function(changePwdFrm){var currentPassword=changePwdFrm.oldPassword.$viewValue;var newPassword=changePwdFrm.password.$viewValue;var confirmPassword=
changePwdFrm.confirmPassword.$viewValue;self.currentPwdValidation="";self.validationError="";self.mismatchError="";if(changePwdFrm.oldPassword.$error.required){self.currentPwdValidation=self.locale.messages["app.accountinformation.password.currentPwd"]+" "+self.locale.messages["app.label.error.is.required"];self.isCurrentPwdValidationError=true}else if(currentPassword.length<self.currentPasswordMinLength||currentPassword.length>self.maxLength){self.currentPwdValidation=self.locale.messages["app.accountinformation.password.invalidPwd"];
self.isCurrentPwdValidationError=true}if(changePwdFrm.password.$error.required){self.validationError=self.locale.messages["app.accountinformation.password.newPwd"]+" "+self.locale.messages["app.label.error.is.required"];self.isValidationError=true}else if(newPassword.length<self.minLength){self.validationError=self.locale.getMessage("registration.newPasswordMinLength",self.minLength);self.isValidationError=true}else if(newPassword.length>self.maxLength){self.validationError=self.locale.getMessage("registration.newPasswordMaxLength",
self.maxLength);self.isValidationError=true}if(changePwdFrm.confirmPassword.$error.required){changePwdFrm.confirmPassword.$invalid=true;self.isMismatch=true;self.mismatchError=self.locale.messages["app.accountinformation.password.confirmPwd"]+" "+self.locale.messages["app.label.error.is.required"]}else if(newPassword!=confirmPassword&&confirmPassword.length>0){changePwdFrm.confirmPassword.$invalid=true;self.isMismatch=true;self.mismatchError=self.locale.getMessage("app.accountinformation.error.confirm.mismatch")}};
self.changePassword=function(changePwdFrm,isExpired){if(self.forgetPassword==="true")self.accountInfoVO.forgetPassword=true;dataServiceG2.changePassword(self.accountInfoVO,function(response){var responseCode=response.data.data.errorMsg;var responseCodeDesc=response.data.returnCodeDesc;if(responseCode!=null&&responseCode.trim()!=""&&responseCodeDesc!=null&&responseCodeDesc.trim()!="Success"){self.isError=true;var temp=self.locale.getMessage("app.error.label."+responseCode.trim())?self.locale.getMessage("app.error.label."+
responseCode.trim()):self.locale.getMessage("app.accountinformation.error.errorcode.default");if(temp!=null&&temp!="")self.errorDesc=temp;else self.errorDesc="Unknown Error"}else{self.isError=false;self.errorDesc=self.locale.getMessage("app.info.label.SUCCESS");resetForm(self.changePwdForm);if(isExpired)if(copartUser.refreshAndGetConfig().isUpdateEmailRequired)$location.path("/updateBrokerBidderEmail");else{jQuery("#memberModal").removeClass("fade").modal("hide");$window.location.href="/dashboard"}}})};
self.cancelChangePassword=function(){$window.location.href="/logout"};self.init=function(){if($("#memberModal"))$("#memberModal").modal("show")};self.init()}]);
app.controller("accountInfoContactDetailsController",["$scope","$http","$locale","$routeParams","$location","copartUser",function($scope,$http,$locale,$routeParams,$location,copartUser){var self=$scope;self.locale=$scope.$parent.locale;self.contactInfo={};$http.get("/data/contactinfo").then(function(response){self.contactInfo=response.data},function(response){console.log("Error retrieving forms")})}]);
app.controller("accountInfoFinanceController",["$scope","$http","$locale","$routeParams","$location","copartUser","dataServiceG2","$compile","$templateRequest","cmsContentService",function($scope,$http,$locale,$routeParams,$location,copartUser,dataServiceG2,$compile,$templateRequest,cmsContentService){var self=$scope;self.locale=$scope.$parent.locale;self.accountInfoVO=new AccountInfo;self.financeVOList={};self.isError=false;self.isSuccess=false;self.errorMsg=null;self.loadingFinance=false;self.creditCardsList=
{};self.creditCardNotOnFile=undefined;self.paymentOptions=undefined;self.paymentVO={};self.paymentVO.defaultPaymentId="PAYTYPEG2M";self.countryCheck=undefined;self.paymentTypeCode=undefined;self.bidLimitInquiryObj={};self.depositTabAvailable=true;self.getFinanceInfo=function(){dataServiceG2.getFinanceInfo(function(response){if(response.returnCodeDesc=="Success"){self.financeVOList=response.data.financeList;for(var i=0;i<self.financeVOList.length;i++){self.financeVOList[i].loadingFinance=false;self.financeVOList[i].isError=
false;if(self.financeVOList[i].verifyAccount==="N")self.getAvailableBalance(self.financeVOList[i]);if(self.financeVOList[i].providerURL!==undefined&&self.financeVOList[i].providerURL!==""&&!self.financeVOList[i].providerURL.toLowerCase().startsWith("http"))self.financeVOList[i].providerURL="http://"+self.financeVOList[i].providerURL}}})};self.verifyFinanceAccount=function(){self.loadingFinance=true;self.isError=false;dataServiceG2.verifyFinanceAccount(self.accountInfoVO,function(response){if(response.returnCode==
1){var errorCode=response.data.accountInfoVO.errorCode;var validDealerFlag=response.data.accountInfoVO.validDealerFlag;if(!_.isEmpty(errorCode)||validDealerFlag=="N"){if(_.isEmpty(errorCode.trim()))self.errorMsg=self.locale.getMessage("app.acctInfo.verifyFinance.error.errorcode.common");else if(errorCode.trim()==="VA-001")self.errorMsg=self.locale.getMessage("app.acctInfo.error.errorcode."+errorCode.trim());else self.errorMsg=self.locale.getMessage("app.acctInfo.error.errorcode."+errorCode.trim())+
". "+self.locale.getMessage("app.acctInfo.verifyFinance.error.errorcode.common");self.isError=true;self.isSuccess=false}else{self.successMsg=self.locale.getMessage("app.accountInfo.success.accountVerified");self.isError=false;self.loadingFinance=false;self.isSuccess=true;if(response.data.accountInfoVO.availableCreditVO){var availableCreditVO=response.data.accountInfoVO.availableCreditVO;_.each(self.financeVOList,function(financeVO){if(financeVO.providerCode===self.accountInfoVO.funderCode){financeVO.availableBalance=
availableCreditVO.availableCredit;financeVO.currency=availableCreditVO.currency;financeVO.verifyAccount="N";financeVO.dealerID=response.data.accountInfoVO.dealerID;financeVO.date=moment().format("MM/DD/YYYY hh:mm A zz")}})}}}else{self.errorMsg=self.locale.getMessage("app.acctInfo.verifyFinance.error.errorcode.common").toString();self.isError=true;self.isSuccess=false}})};self.getAvailableBalance=function(financeVO){console.log("financeVO to get the available bal is ::",financeVO);financeVO.loadingFinance=
true;financeVO.isError=false;var accountInfoVO={funderCode:financeVO.providerCode,dealerID:financeVO.dealerID};dataServiceG2.getAvailableBalance(accountInfoVO,function(response){if(response.returnCode==1){var errorCode=response.data.accountInfoVO?response.data.accountInfoVO.errorCode:JSON.parse(response.data.errorObject).errorCode;if(errorCode!=null&&errorCode.trim()!=""){financeVO.errorMsg=self.locale.getMessage("app.acctInfo.error.errorcode."+errorCode.trim())+". "+self.locale.getMessage("app.acctInfo.verifyFinance.error.errorcode.common");
financeVO.isError=true}else{self.errorMsg="";if(response.data.accountInfoVO.availableCreditVO){var availableCreditVO=response.data.accountInfoVO.availableCreditVO;financeVO.availableBalance=availableCreditVO.availableCredit;financeVO.currency=availableCreditVO.currency}else{financeVO.availableBalance=response.data.accountInfoVO.availableBalance;financeVO.currency="USD"}financeVO.date=moment().format("MM/DD/YYYY hh:mm A zz");financeVO.isError=false}}else{financeVO.errorMsg=self.locale.getMessage("app.acctInfo.verifyFinance.error.errorcode.common");
financeVO.isError=true}financeVO.loadingFinance=false})};self.resetData=function(funderCode){self.errorMsg="";self.isError=false;self.isSuccess=false;self.accountInfoVO.dealerID="";if(funderCode){self.accountInfoVO.funderCode=funderCode;self.verifyAccountPopupTitleMsg=self.locale.getMessage("app.accountInfo.enterAcctToVerify."+funderCode.trim())}self.loadingFinance=false};self.getCreditCards=function(){dataServiceG2.getCreditCards(function(response){if(response.returnCode==1&&response.returnCodeDesc){self.creditCardsList=
response.data;if(self.creditCardsList==null||self.creditCardsList!=null&&self.creditCardsList.length==0)self.creditCardNotOnFile=self.locale.getMessage("member.pref.credit.none.onfile")}})};self.getAvailablePaymentTypes=function(){dataServiceG2.getContactInfo(function(response){self.countryCheck=response.data.contactInfoList.country});dataServiceG2.getAvailablePaymentTypes(function(response){var paymentTypesList=response.data.paymentTypesList;self.paymentVO.defaultPaymentCode=response.data.memberPaymentType.defaultPaymentCode;
self.paymentTypeCode=self.paymentVO.defaultPaymentCode;_.each(paymentTypesList,function(paymentMethod){if(paymentMethod.paymentType=="U")paymentMethod.paymentDesc=self.locale.messages["paymentDue.paymentType."+paymentMethod.paymentType]+" "+paymentMethod.buyerNumber+"-"+paymentMethod.buyerName;else paymentMethod.paymentDesc=self.locale.messages["paymentDue.paymentType."+paymentMethod.paymentType]});if(self.countryCheck=="USA"||self.countryCheck=="CAN")paymentTypesList=_.filter(paymentTypesList,function(item){return!(item.paymentType==
"G")});self.paymentOptions=paymentTypesList})};self.updateMemberPaymentType=function(){dataServiceG2.updateMemberPaymentType(self.paymentVO,function(response){var responseCode=response.data.returnCode;var responseCodeDesc=response.data.returnCodeDesc;if(responseCode!=null&&responseCode==1){self.paymentTypeCode=self.paymentVO.defaultPaymentCode;jQuery("#savedSettings").modal("show")}})};self.cancelPaymentType=function(){self.paymentVO.defaultPaymentCode=self.paymentTypeCode};self.compileCmsContent=
function(){self.contentUrl=cmsContentService.getCmsContentUrl("Content/US/EN/PaymentAndFeesDeposit");$templateRequest(self.contentUrl).then(function(html){var depositCmsPlaceHolder=angular.element(document.querySelector("#deposit .panel-body"));if(depositCmsPlaceHolder&&depositCmsPlaceHolder.length>0){var depositCmsTemplate=angular.element(html).filter("#deposit");if(depositCmsTemplate&&depositCmsTemplate.length>0){self.depositTabAvailable=true;depositCmsPlaceHolder.append(depositCmsTemplate.html());
$compile(depositCmsPlaceHolder)(self);return}}self.depositTabAvailable=false},function(error){self.depositTabAvailable=false})};self.initialize=function(){self.getCreditCards();self.getAvailablePaymentTypes();self.resetData();self.getFinanceInfo();self.compileCmsContent()}()}]);
app.controller("AccountInfoDepositRefundController",["$scope","$locale","copartUtils","dataServiceG2","accountInfoDataService",function($scope,$locale,copartUtils,dataServiceG2,accountInfoDataService){var self=$scope;self.locale=$scope.$parent.locale;self.parentScope=self.$parent.$parent;self.depositRefundSection="";self.depositRefundStatus="";self.refundHistory={};self.refundRequest=0;self.totalRefundsIssued=0;self.currencyCode="";self.selectedCreditCard={};self.requestedRefundAmount=0;self.depositRefundRequest=
{};self.wlWaiting=true;self.wlRefundWaiting=null;self.getDepositRefundTransactionHistory=function(selectedCardNo){if(selectedCardNo===undefined||selectedCardNo===null){self.formSubmitted=true;return}self.depositRefundSection="depositRefundReview";self.wlWaiting=true;dataServiceG2.getDepositRefundTransactionHistory(selectedCardNo,function(response){var successCode=response.data.returnCodeDesc;if(successCode=="Success"){self.totalRefundsIssued=0;self.refundHistory=response.data.data.refundHistory;if(self.refundHistory!=
null&&self.refundHistory!=undefined)for(var i=0;i<self.refundHistory.length;i++){self.totalRefundsIssued=self.totalRefundsIssued+self.refundHistory[i].txAmt1;self.depositRefundRequest.currencyCode=self.refundHistory[i].txCurrencyCode1}self.depositRefundRequest.selectedCreditCard=_.filter(self.creditCards,function(item){return item.cardId===selectedCardNo});self.depositRefundRequest.requestedRefundAmount=self.depositRefundRequest.selectedCreditCard[0].availableAmount}self.wlWaiting=false})};var validateAmount=
function(requestedRefundAmount){var regExp=/^[\d.]+$/;if(!regExp.test(self.depositRefundRequest.requestedRefundAmount))self.validationMessage=self.locale.getMessage("app.acctInfo.depositRefund.notValidAmount");else if(self.depositRefundRequest.requestedRefundAmount>self.depositRefundRequest.selectedCreditCard[0].availableAmount)self.validationMessage=self.locale.getMessage("app.acctInfo.depositRefund.refundLimitExceeded");else if(self.depositRefundRequest.requestedRefundAmount<0)self.validationMessage=
self.locale.getMessage("app.acctInfo.depositRefund.positiveValue");else{var max2Decimals=Math.round(self.depositRefundRequest.requestedRefundAmount*100)/100;if(self.depositRefundRequest.requestedRefundAmount!=max2Decimals)self.validationMessage=self.locale.getMessage("app.acctInfo.depositRefund.max2Decimals");else{self.validationMessage=null;return true}}};self.submitDepositRefund=function(){var requestedRefundAmount=self.depositRefundRequest.requestedRefundAmount;if(!validateAmount(requestedRefundAmount))return;
var depositRefundDTO={cardID:self.depositRefundRequest.selectedCreditCard[0].cardId,refundAmount:requestedRefundAmount};self.wlRefundWaiting=true;dataServiceG2.submitDepositRefund(depositRefundDTO,function(response){var returnCodeDesc=response.data.returnCodeDesc;if(returnCodeDesc=="Success"){self.depositRefundStatus=response.data.data.depositRefundStatus;if(self.depositRefundStatus===undefined||self.depositRefundStatus===null||self.depositRefundStatus.status==null||self.depositRefundStatus.status.trim()===
"REJECTED")self.refundStatus="errorRejected";else if(self.depositRefundStatus.status.trim()==="ACCEPTED"){self.refundStatus="success";self.depositRefundSection="depositRefundSuccess"}}else if(returnCodeDesc=="Error occured")self.refundStatus="error";accountInfoDataService.setShowHideDepositBalanceFlag("UnInitialized");self.wlRefundWaiting=false})};self.changeStep=function(){self.refundStatus=null;self.formSubmitted=false;self.validationMessage=null;self.depositRefundSection="depositRefund";self.wlWaiting=
true;accountInfoDataService.getCreditCardDetailsForDepositRefund().then(function(response){var creditCardsresult=response;_.each(creditCardsresult,function(card){if(typeof card.expiryYear!=="undefined"&&card.expiryYear.toString().length==4)card.expiryYear=card.expiryYear%100});self.creditCards=creditCardsresult;self.wlWaiting=false});if(self.depositRefundStatus.status&&self.depositRefundStatus.status.trim()==="ACCEPTED")accountInfoDataService.setRefundBalance(undefined);accountInfoDataService.getRefundBalanceAmount().then(function(response){self.refundBalance=
response})};self.changeStep();self.refundTxBlock=true;self.showHideRefundTxHistory=function(event){self.refundTxBlock=event.target.className.indexOf("collapsed")>-1};self.printRefundConfirmation=function(){window.print()}}]);
app.controller("accountMaintenanceController",["$scope","$http","$locale","$filter","$routeParams","dataServiceG2","copartUser","appConfigService","$q",function($scope,$http,$locale,$filter,$routeParams,dataServiceG2,copartUser,appConfigService,$q){var self=$scope;self.userConfig=copartUser.getUserConfig();self.emailRule=copartUser.getUserConfig().emailRule;self.accountInfoVO={};self.accountInfoEditVO={};self.locale=$scope.$parent.locale;self.bidderAccess=0;self.showEdit=false;self.errors={phoneNumber:false,
alternatePhone:false};var isGlobal=self.$parent.isGlobal;var childParam=self.childParam?true:false;self.SUBSCRIPTION_PENDING="SUBSCRIPTION_PENDING";self.UNSUBSCRIPTION_PENDING="UNSUBSCRIPTION_PENDING";var CONST_NOT_SUBSCRIBED="NOT_SUBSCRIBED";var CONST_SUBSCRIBED="SUBSCRIBED";var subscriptionStatus;self.addressCheck=false;self.saveContactInfoVO={};self.cancelTrue=false;self.loadingContact=true;self.cultureTemplateUrl="/fetchDirective.html?directive\x3daccountinfo/addressCultureTemplate";self.contactAddressCultureTemplateUrl2=
"/fetchDirective.html?directive\x3daccountinfo/contactAddressCultureTemplate2";self.emailLanguageText="";self.irelandCounties=["Co. Carlow","Co. Cavan","Co. Clare","Co. Cork","Co. Donegal","Co. Dublin","Co. Galway","Co. Kerry","Co. Kildare","Co. Kilkenny","Co. Laois","Co. Leitrim","Co. Limerick","Co. Longford","Co. Louth","Co. Mayo","Co. Meath","Co. Monaghan","Co. Offaly","Co. Roscommon","Co. Sligo","Co. Tipperary","Co. Waterford","Co. Westmeath","Co. Wexford","Co. Wicklow"];if(_.contains(copartUser.getUserConfig().roles,
"ROLE_BROKER_BIDDER"))if($routeParams.navMenu=="contactInfo")$routeParams.navMenu="bidderContactInfo";self.activeTab=$routeParams.navMenu;var cell=self.locale.getMessage("contact.label.phone.cell");var home=self.locale.getMessage("contact.label.phone.home");var work=self.locale.getMessage("contact.label.phone.work");var fax=self.locale.getMessage("contact.label.phone.fax");self.changeCountry=function(){if(self.accountInfoEditVO)self.accountInfoEditVO.mailingAddressState="";var element=$('[name\x3d"phoneNumber"]');
var countryArray=element.intlTelInput.getCountryData();var selected=$("#userCountry option:selected").text().toUpperCase();for(var i=0;i<countryArray.length;i++){var country=countryArray[i].name.toUpperCase();if(country.indexOf("(")>-1)country=country.substring(0,countryArray[i].name.indexOf("(")).trim();if(country==selected){element.intlTelInput("setCountry",countryArray[i].iso2);break}}};var getLanguageName=function(preferredLanguage){var languageName="";if(preferredLanguage)_.each(copartUser.getUserConfig().langOptions,
function(option){if(option.language&&preferredLanguage&&option.language.toUpperCase()==preferredLanguage.toUpperCase()){languageName=option.name;return true}});return languageName};self.getState=function(country,state){var deferred=$q.defer();if(country&&state){var stateObj=_.where(self.appConfig.getCountryStates(),{code:state});deferred.resolve(stateObj&&stateObj.length>0?stateObj[0].description:"")}else deferred.resolve("");return deferred.promise};self.showContactInfo=function(){dataServiceG2.getContactInfo(function(response){self.loadingContact=
true;self.accountInfoVO=response.data.contactInfoList;self.countryObj=_.where(self.appConfig.getCountries(),{code:self.accountInfoVO.country});self.getState(self.accountInfoVO.country,self.accountInfoVO.state).then(function(state){self.accountInfoVO.displayAddressState=state});self.accountInfoVO.displayAddressCountry=self.countryObj&&self.countryObj[0]&&self.countryObj[0].description?self.countryObj[0].description:"";self.countryObj1=_.where(self.appConfig.getCountries(),{code:self.accountInfoVO.mailingAddressCountry});
self.getState(self.accountInfoVO.mailingAddressCountry,self.accountInfoVO.mailingAddressState).then(function(state){self.accountInfoVO.displayMailingAddressState=state});if(!self.accountInfoVO.phoneNumber)self.accountInfoVO.phoneNumber=self.accountInfoVO.contactPhoneNumber;if(self.countryObj1.length)self.accountInfoVO.displayMailingAddressCountry=self.countryObj1[0].description;if(self.accountInfoVO.contactPhoneNumber){self.accountInfoVO.contactPhone2=self.accountInfoVO.contactPhoneNumber.substring(0,
3);self.accountInfoVO.contactPhone3=self.accountInfoVO.contactPhoneNumber.substring(3,7);self.accountInfoVO.globalPhoneNumber=self.accountInfoVO.contactPhoneNumber}if(self.accountInfoVO.altPhoneNumber){self.accountInfoVO.altPhone2=self.accountInfoVO.altPhoneNumber.substring(0,3);self.accountInfoVO.altPhone3=self.accountInfoVO.altPhoneNumber.substring(3,7);self.accountInfoVO.globalAltPhoneNumber=self.accountInfoVO.altPhoneNumber}self.accountInfoVO.confirmEmail=self.accountInfoVO.email;if(!_.isEmpty(self.accountInfoVO.mailingAddressZip2))self.accountInfoVO.mailingAddressZip1=
self.accountInfoVO.mailingAddressZip1+" "+self.accountInfoVO.mailingAddressZip2;self.accountInfoVO.mailingAddressZip1=self.accountInfoVO.mailingAddressZip1?self.accountInfoVO.mailingAddressZip1.trim():self.accountInfoVO.mailingAddressZip1;if(self.accountInfoVO.fullContactPhoneNumber)if(self.accountInfoVO.fullContactPhoneNumber.indexOf("0")==0)self.accountInfoVO.phoneNumber=self.accountInfoVO.fullContactPhoneNumber.substr(1);else self.accountInfoVO.phoneNumber=self.accountInfoVO.fullContactPhoneNumber;
if(self.accountInfoVO.fullContactMobileNo||self.accountInfoVO.fullContactMobileNo=="")if(self.accountInfoVO.fullContactMobileNo.indexOf("0")==0)self.accountInfoVO.contactMobileNo=self.accountInfoVO.fullContactMobileNo.substr(1);else self.accountInfoVO.contactMobileNo=self.accountInfoVO.fullContactMobileNo;self.phoneTypeText="";if(self.accountInfoVO.altPhoneType=="C")self.phoneTypeText=cell;else if(self.accountInfoVO.altPhoneType=="W")self.phoneTypeText=work;else if(self.accountInfoVO.altPhoneType==
"H")self.phoneTypeText=home;else if(self.accountInfoVO.altPhoneType=="F")self.phoneTypeText=fax;var taxIdObj=self.accountInfoVO.taxIds&&self.accountInfoVO.taxIds[0]?self.accountInfoVO.taxIds[0]:{};self.accountInfoVO.taxIdObj=taxIdObj;self.displayTaxId=self.accountInfoVO.taxIdNumber;self.taxCountryObj=_.where(self.appConfig.getCountryStates(),{code:self.accountInfoVO.taxIssuingCountry});if(self.taxCountryObj.length)self.accountInfoVO.taxIssuingCountry=self.taxCountryObj[0].description;self.membershipStartDate=
self.accountInfoVO.membershipStartDate;self.membershipEndDate=self.accountInfoVO.membershipEndDate;self.loadingContact=false;self.accountInfoEditVO=self.accountInfoVO;self.emailLanguageText=getLanguageName(self.accountInfoVO.emailLanguagePreference&&self.accountInfoVO.emailLanguagePreference.preferenceValue);self.accountInfoVO.emailSubscriptionCheck=self.accountInfoVO.emailSubscriptionStatus==CONST_SUBSCRIBED||self.accountInfoVO.emailSubscriptionStatus==self.SUBSCRIPTION_PENDING;if(self.accountInfoVO.emailSubscriptionStatus===
self.SUBSCRIPTION_PENDING||self.accountInfoVO.emailSubscriptionStatus===self.UNSUBSCRIPTION_PENDING)self.accountInfoVO.emailSubscriptionMsg=self.locale.getMessage("lotdetail.bidStatus.AWAITING_SELLER_RESPONSE");subscriptionStatus=self.accountInfoVO.emailSubscriptionStatus;if(!_.isEmpty(self.accountInfoVO.gender))self.gender=self.locale.getMessage("registration.gender."+self.accountInfoVO.gender.code);if(!_.isEmpty(self.accountInfoVO.dateOfBirth))self.dateOfBirth=moment(self.accountInfoVO.dateOfBirth).format("YYYY")})};
if(!childParam)self.showContactInfo();$scope.stateFilter=function(item){return item.type==="USA"||item.type==="CAN"};self.showEditContact=function(){if(self.countryObj1&&self.countryObj1[0]&&self.countryObj1[0].code)appConfigService.appConfig.getCountries().forEach(function(item){if(item.code==self.countryObj1[0].code)self.accountInfoEditVO.mailingAddressCountry=item});self.showEdit=true};self.showContact=function(){self.showEdit=false};self.saveContactInfo=function(isValid){var accountEditInfoVO=
_.clone(self.accountInfoEditVO)||{};if(self.errors.phoneNum||self.errors.altPhone)return;if(isValid&&!self.errors.specialChars){if(self.accountInfoEditVO.mailingAddressZip1!=""&&self.accountInfoEditVO.mailingAddressZip1!=undefined){self.resetMailingAddressZip(accountEditInfoVO);var maZip1=self.accountInfoEditVO.mailingAddressZip1;if(maZip1.indexOf("-")>-1){var split=maZip1.trim().split("-");accountEditInfoVO.mailingAddressZip1=split[0].trim();accountEditInfoVO.mailingAddressZip2=split[1].trim()}else if(maZip1.indexOf(" ")>
-1)accountEditInfoVO.mailingAddressZip1=maZip1;else if(maZip1.length>5){accountEditInfoVO.mailingAddressZip1=maZip1.substring(0,4);accountEditInfoVO.mailingAddressZip2=maZip1.substring(4)}else accountEditInfoVO.mailingAddressZip1=maZip1}accountEditInfoVO.mailingAddressCountry=self.accountInfoEditVO.mailingAddressCountry.code;self.getState(self.accountInfoEditVO.mailingAddressCountry,self.accountInfoEditVO.mailingAddressState).then(function(state){self.accountInfoEditVO.displayMailingAddressState=
state});if(self.accountInfoVO.emailSubscriptionCheck&&self.accountInfoVO.emailSubscriptionStatus==CONST_NOT_SUBSCRIBED)accountEditInfoVO.emailSubscriptionStatus=CONST_SUBSCRIBED;else if(!self.accountInfoVO.emailSubscriptionCheck&&self.accountInfoVO.emailSubscriptionStatus==CONST_SUBSCRIBED)accountEditInfoVO.emailSubscriptionStatus=CONST_NOT_SUBSCRIBED;self.loadingContact=true;dataServiceG2.saveContactInfo(accountEditInfoVO,function(response){var responseCode=response.data.data.errorMsg;var responseErrorCode=
null;if(!(responseCode!=null&&responseCode.trim()!="")&&response.data.data.errorObject!=null)responseErrorCode=JSON.parse(response.data.data.errorObject);if(responseCode!=null&&responseCode.trim()!=""){self.displayError=true;self.showEdit=true;var errorCode=response.data.data.errorCode;var defaultErrorMsg=self.locale.messages["app.accountinformation.error.errorcode.UnknownError"];self.errorDesc=errorCode!=null?self.locale.messages["contact.error.contact."+errorCode.trim()]||responseCode||defaultErrorMsg:
responseCode||defaultErrorMsg}else if(responseErrorCode!=null){self.displayError=true;self.showEdit=true;var errorMessage=responseErrorCode[0].message;var defaultErrorMsg=self.locale.messages["app.accountinformation.error.errorcode.UnknownError"];self.errorDesc=errorMessage||defaultErrorMsg}else{self.displayError=false;self.accountInfoVO=self.accountInfoEditVO;self.userConfig.updateContactInfo(self.accountInfoVO);if(self.accountInfoVO.altPhoneType=="C")self.phoneTypeText=cell;else if(self.accountInfoVO.altPhoneType==
"W")self.phoneTypeText=work;else if(self.accountInfoVO.altPhoneType=="H")self.phoneTypeText=home;else if(self.accountInfoVO.altPhoneType=="F")self.phoneTypeText=fax;self.accountInfoVO.mailingAddressZip1=self.accountInfoVO.mailingAddressZip1+(!_.isEmpty(self.accountInfoVO.mailingAddressZip2)?" "+self.accountInfoVO.mailingAddressZip2:"");self.errorDesc=self.locale.getMessage("contact.contact.success.message");self.showEdit=false;self.cancelTrue=false;self.emailLanguageText=getLanguageName(self.accountInfoVO.emailLanguagePreference&&
self.accountInfoVO.emailLanguagePreference.preferenceValue);if(subscriptionStatus===CONST_SUBSCRIBED&&self.accountInfoVO.emailSubscriptionStatus===CONST_NOT_SUBSCRIBED)$("#unsubscribeModel").modal("show");self.showContactInfo()}self.loadingContact=false})}else self.submitted=true};self.resetMailingAddressZip=function(accountEditInfoVO){accountEditInfoVO.mailingAddressZip1="";accountEditInfoVO.mailingAddressZip2=""};self.saveContactInfoBidder=function(){var accountVO={};accountVO["email"]=self.accountInfoVO.email;
dataServiceG2.updateContactEmail(accountVO,function(response){var responseCode=response.data.data.errorMsg;var responseCodeDesc=response.data.returnCodeDesc;if(responseCode!=null&&responseCode.trim()!=""){self.displayError=true;var temp=self.locale.getMessage("contact.error.contact."+responseCode.trim());if(temp!=null&&temp!="")self.errorDesc=temp;else self.errorDesc="Unknown Error";self.showEdit=true}else{self.displayError=false;self.errorDesc=self.locale.getMessage("contact.contact.success.message")}});
self.showEdit=false};self.checkForSpecialChars=function(){if(self.accountInfoEditVO.mailingAddressLine1==""||self.accountInfoEditVO.mailingAddressLine1==undefined)self.errors.specialChars=false;else self.errors.specialChars=!/^[a-zA-Z0-9-. ]*$/.test(self.accountInfoEditVO.mailingAddressLine1.toString())};self.cancelEdit=function(){self.showEdit=false;self.cancelTrue=true;self.errors.altPhone=false;self.errors.phoneNum=false;self.errors.altMobile=false;self.displayError=false;self.errorDesc=undefined;
self.showContactInfo()};$scope.filterValue=function($event){if(isNaN(String.fromCharCode($event.which)))$event.preventDefault()};self.isUKSite=function(){var userConfig=copartUser.getUserConfig();return userConfig.siteCode=="CPRTUK"||userConfig.siteCode=="CPRTMEA"||userConfig.siteCode=="CPRTIE"};self.isMEASite=function(){var userConfig=copartUser.getUserConfig();return userConfig.siteCode=="CPRTMEA"}}]);
app.controller("accountMaintenanceController_GLOBAL",["$scope","$controller","$q","appConfigService",function($scope,$controller,$q,appConfigService){$scope.childParam=true;$controller("accountMaintenanceController",{$scope:$scope});var self=$scope;self.getState=function(country,state){var deferred=$q.defer();appConfigService.appConfig.getStatesOfCountry(country,function(states){var stateObj=_.where(states,{code:state});deferred.resolve(stateObj&&stateObj.length>0?stateObj[0].description:"")});return deferred.promise};
self.showContactInfo()}]);
app.controller("accountInfoPreferenceController",["$scope","$http","$locale","$routeParams","$location","cmsContentService","copartUser","dataServiceG2","$filter","$timeout","$window",function($scope,$http,$locale,$routeParams,$location,cmsContentService,copartUser,dataServiceG2,$filter,$timeout,$window){var self=$scope;self.showEdit=false;self.accountPrefVO={};self.paymentOptions={};self.editPaymentOptions=null;self.locale=$scope.$parent.locale;self.inOut=true;self.loadingPreferences=true;self.editReportSales=
false;self.editMailReports=false;var defaultShippingService="COPAR";self.stateFilter=function(item){return item.type===self.accountPrefVO.mailingAddressCountry};var edit=$routeParams.edit;if(edit&&edit=="Y")self.showEdit=true;self.buyerNumber=copartUser.getUserConfig().buyerNumber;self.showEditPreference=function(){self.showEdit=true};self.hideEditPreference=function(){self.isError=false;self.errorDesc="";self.showEdit=false;self.showPreferences()};self.manageCreditCards=function(){var requestParam=
{};requestParam.GATEWAY_URL_KEY="MANAGE_CARDS";requestParam.cancelCallBackUrl="accountInformation/myPreferences";requestParam.successCallBackURL="accountInformation/myPreferences";requestParam.cookieValue=$location.path();dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==1)$window.location.href=response.data.pciURL.trim();else log.error("Error in Gateway")})},self.errors={phoneNumber:false},self.showPreferences=function(){self.loadingPreferences=true;dataServiceG2.getCreditCardList(function(response){var creditCardLength=
response.data.length;if(creditCardLength>0)self.creditCard=self.locale.getMessage("member.pref.credit.onfile");else self.creditCard=self.locale.getMessage("member.pref.credit.none.onfile")});dataServiceG2.getMemberPreferences(function(response){self.accountPrefVO=response.data.memberPreferenceList;if(self.accountPrefVO.mailTitleDocs=="Yes")self.accountPrefVO.mailDocsCheckedTrue=true;else if(self.accountPrefVO.mailTitleDocs=="No")self.accountPrefVO.mailDocsCheckedTrue=false;if(self.accountPrefVO.shippingServices&&
self.accountPrefVO.shippingServices!=defaultShippingService)self.showShippingAccNum=true;else{self.accountPrefVO.shippingServices=defaultShippingService;self.showShippingAccNum=false}self.parseShipService=_.find(self.appConfig.getShippingServices(),{code:self.accountPrefVO.shippingServices});if(self.parseShipService!=null)self.accountPrefVO.shippingServicesDesc=self.parseShipService.description;else self.accountPrefVO.shippingServicesDesc="";self.loadingPreferences=false})};var init=function(){self.showPreferences()};
init();self.contentURL=cmsContentService.getCmsContentUrl("_Forms");dataServiceG2.getAccountInfoForms(function(response){self.forms=response.data});self.checkTerms=function(){if(self.editReportSales&&titleDelivery.terms.checked==false){self.isTermsError=true;self.termsError=self.locale.getMessage("member.terms.of.service");return false}else{self.isTermsError=false;return true}};self.updateMemberPreference=function(isValid){if(!isValid)if(self.accountPrefVO.mailTitleDocs=="No")isValid=true;if(isValid){if(self.checkTerms())self.loadingPreferences=
true;if(self.isTermsError==false){self.accountPrefVO.mailingAddressLine3="";self.accountPrefVO.mailingAddressZip2="";self.accountPrefVO.defaultPaymentId="PAYTYPEG2M";self.accountPrefVO.countryExport="MEX";self.accountPrefVO.vin="";self.accountPrefVO.addressType=self.editMailReports?"Mailing":"";self.accountPrefVO.maxicanReports=self.editReportSales;dataServiceG2.updateMemberPreference(self.accountPrefVO,function(response){var responseCode=response.data.returnCode;var errorMsg=response.data.data.errorMsg;
var responseCodeDesc=response.data.returnCodeDesc;var error=response.data.data.errorObject;if(errorMsg!=null&&errorMsg.trim()!=""){self.isError=true;var temp=self.locale.getMessage("member.error.pref."+errorMsg.trim());if(temp!=null&&temp!="")self.errorDesc=temp;else self.errorDesc="Unknown Error";self.showEdit=true;self.loadingPreferences=false}else if(error!=null){self.isError=true;var temp="Combination of City, State and Zip are invalid for Mailing address.";if(temp!=null&&temp!="")self.errorDesc=
temp;else self.errorDesc="Unknown Error";self.showEdit=true;self.loadingPreferences=false}else{self.showPreferences();self.loadingPreferences=true;self.isError=false;self.errorDesc=self.locale.getMessage("member.pref.success");self.showEdit=false}})}}else self.submitted=true};self.editSettings=function(var2,var3){self.showEdit=true;self.editReportSales=var2;self.editMailReports=var3}}]);
app.controller("UpgradeMembershipController",["$scope","$http","$locale","$routeParams","$location","copartUser","dataServiceG2","$filter","$timeout","$window","openAccordionService",function($scope,$http,$locale,$routeParams,$location,copartUser,dataServiceG2,$filter,$timeout,$window,openAccordionService){var self=$scope;if($routeParams.flag=="renewal"){var requestParam={};requestParam.GATEWAY_URL_KEY="RENEWAL_FEES";requestParam.cancelCallBackUrl="logout";requestParam.successCallBackURL="dashboard";
dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==1)$window.location.href=response.data.pciURL.trim();else log.error("Error in Gateway")})}self.addBidLimitInquiryVO={};self.upgradeMember=function(fromRequest){$location.url("/accountInformation/accountSetting?accSettingUpgradeMem\x3dtrue")};self.increaseBuyingPower=function(fromRequest){self.addBidLimitInquiryVO.lotNumber=0;self.addBidLimitInquiryVO.buyingPower=0;self.addBidLimitInquiryVO.depositAmount=0;dataServiceG2.increaseBuyingPower(self.addBidLimitInquiryVO,
function(response){if(response.returnCode==1){var batchNumber=response.data.batchNumber;var requestParam={};requestParam.transactionId=batchNumber;requestParam.GATEWAY_URL_KEY="INCREASE_BUYING_POWER";if(fromRequest=="dashboard"){requestParam.cancelCallBackUrl="dashboard";requestParam.successCallBackURL="dashboard"}else if(fromRequest=="myaccount"){requestParam.cancelCallBackUrl="accountInformation/contactInfo";requestParam.successCallBackURL="accountInformation/contactInfo"}requestParam.cookieValue=
$location.path();dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==1)$window.location.href=response.data.pciURL.trim();else log.error("Error in Gateway")})}})};self.openAccordion=function(id){if(self.activeTab==="accountSetting")openAccordionService.targetAccordion(id);else{$location.url("/accountInformation/accountSetting?accSettingUpgradeMem\x3dtrue");console.log("Open ...............................")}}}]);
app.controller("lotSearchBaseController",["$filter","$scope","$location","$timeout","$route","urlService","userService","dataServiceG2","watchListService","saveSearchCriteria","$compile","$rootScope","$templateCache","$interpolate","$routeParams","searchCriteria","config","appConfigService","searchText","siteCatalyst","localStorageService","History","deviceService","metaDataService","copartUser","isValidDateFilter","lotDetailsService",function($filter,$scope,$location,$timeout,$route,urlService,userService,
dataServiceG2,watchListService,saveSearchCriteria,$compile,$rootScope,$templateCache,$interpolate,$routeParams,searchCriteria,config,appConfigService,searchText,siteCatalyst,localStorageService,History,deviceService,metaDataService,copartUser,isValidDate,lotDetailsService){var self=$scope;self.searchCriteria=searchCriteria;var log=new Logger({name:"lotSearchBaseController",level:config.logLevel});var defaultDateFormat=userService.userConfig.dateFormat.toUpperCase();var defaultTimeFormat=userService.userConfig.displayPref.timeFormat;
var auctionDateFormat=defaultDateFormat+" \x3cbr\x3e "+defaultTimeFormat+" zz";var selectedTimezone=userService.userConfig.selectedTimezone;self.showUnassignedLots=userService.userConfig.lotDetailsPreference.showUnassignedLots;self.userService=userService;self.userConfig=self.userService.userConfig;self.isUKregion=appInit.regionCode=="uk"?true:false;self.facebookUser=appInit.facebookUser;self.date=moment().tz(selectedTimezone).format("YYYY MMMM DD");self.noResults=false;self.isMobileDevice=deviceService.isMobileDevice();
self.isMobileSize=deviceService.isMobileSize();self.loadingSearchResults=true;self.errCustomColCount=false;self.query=self.searchCriteria.getQuery();self.locale=$scope.$parent.locale;self.searchName="";self.searchText=self.query;self.savedSearchCompleted=false;self.saved=false;self.selectAllChecked=false;self.isLiveAuction=$location.search().liveAuction=="true"?true:false;watchListService.setWatchListDefinition($location.url());self.isAlreadyAdded=watchListService.isAlreadyAdded;self.addToWatchList=
watchListService.addToWatchList;self.removeFromWatchList=watchListService.removeFromWatchList;self.isWatchList=watchListService.isWatchList();self.images={};var free=self.searchCriteria.isFreeForm();self.tempScope=self.$new();self.yardDetails={};self.lotsObj={};self.lots=angular.copy(self.lotsObj);if(_.isUndefined(self.query)||_.isNull(self.query)||self.query==""){self.query="*";free=false}self.successMessage=false;self.messageText="";self.watchList=[];self.isGlobal=self.$parent.isGlobal;var currencyFilterName=
self.isGlobal?"globalize_currency":"globalize_currency_using_code";var backTo=$location.url();self.backToLink=$location.url();self.urlFrom=$location.search().from;self.$watch("loadingSearchResults",function(newValue,oldValue){$timeout(function(){$(self.tableId).DataTable().columns.adjust().responsive.recalc()},0)});self.resetSearchCriteria=function(searchCriteria){self.searchCriteria=searchCriteria};self.checkIfSearchStrIsPresent=function(){try{var searchCriteriaObj=$location.search().searchCriteria?
JSON.parse($location.search().searchCriteria):self.searchCriteria.getSearchCriteriaObj();if(_.isObject(searchCriteriaObj)){saveSearchCriteria.data=searchCriteriaObj;return true}return false}catch(e){return false}};self.viewType=$location.search().viewType;self.showAllEnabled=userService.isShowAllEnabled($location.url());var showAll=self.viewType=="showAll"?true:false;self.alerts=[];self.isAlertOnModal=false;self.customizationErrors=[];var state=false;function checkIfFromLotDetails(History){try{var lastRoute=
History.lastRoute;if(lastRoute&&(lastRoute.indexOf("lot/")==0||lastRoute.indexOf("lotDetail/")==0||lastRoute.indexOf("vehicleFinderSearch/")==0||lastRoute.indexOf("compareLots/")==0))return true;else return false}catch(e){return false}}self.getSearchObject=function(ignoreSecondarySearch){if(self.queryReturnedFromServer)return{query:self.queryReturnedFromServer.query&&self.queryReturnedFromServer.query.length>0?ignoreSecondarySearch?[self.queryReturnedFromServer.query[0]]:self.queryReturnedFromServer.query:
["*:*"],filter:self.queryReturnedFromServer.filter,sort:self.queryReturnedFromServer.sort,watchListOnly:self.queryReturnedFromServer.watchListOnly,searchName:self.searchName,freeFormSearch:!!self.queryReturnedFromServer.freeFormSearch};var queryArr=[];queryArr.push(self.query);var tempFilterArray={};_.each(self.filterQueryArr,function(value,key,list){if(!_.isArray(value))tempFilterArray[key]=value.split(",");else tempFilterArray[key]=value});return{query:queryArr,filter:tempFilterArray,sort:self.sortApplied.split(","),
searchName:self.searchName,watchListOnly:self.watchListOnly,freeFormSearch:free?true:false}};self.populateMobileSortMenu=function(headers){var mobileHeaders=[];for(var i=0;i<headers.length;i++){var headerObj=$(headers[i]);if(headerObj.hasClass("sortable")){var header={};header.index=i;header.order="asc";header.displayName=headerObj[0].innerText;mobileHeaders.push(header)}}return mobileHeaders};self.clearAllCheckBoxes=function(){self.selectedLotNumbers=[];self.selectAllChecked=false;$(self.tableId+
" tbody tr").removeClass("row-selected")};self.showHideImages=function(flag){var table=$(self.tableId).DataTable();var index=self.fromDriverSeat?0:1;table.column(index).visible(flag);if(!flag)localStorageService.cookie.set(self.localSotragePropObj.cookie.showImages,false);else localStorageService.cookie.remove(self.localSotragePropObj.cookie.showImages);self.clearAllCheckBoxes()};self.searchWithSpellCheck=function(searchText){$rootScope.$broadcast("search-again",{searchText:searchText})};self.selectAll=
function(){self.selectAllChecked=!self.selectAllChecked;self.selectedLotNumbers=[];if(self.selectAllChecked&&!showAll){$(self.tableId+" tbody tr").addClass("row-selected");var boxes=jQuery(self.tableId+" tbody tr").find("input:checkbox");for(var i=0;i<boxes.length;i++){var lotNum=boxes[i].id;self.selectedLotNumbers.push(lotNum)}}else $(self.tableId+" tbody tr").removeClass("row-selected")};self.goToPage=function(pageNumber){var table=$(self.tableId).DataTable();var totalPages=table.page.info().pages;
pageNumber=pageNumber-0;if(pageNumber>0&&pageNumber<=totalPages){table.page(pageNumber-1).draw(false);self.scrollTop=true}else self.pageNumberInvalid=true};self.generateLotsByLotNumbers=function(lotNumbers){lots=[];for(var i=0;i<lotNumbers.length;i++){var lot={lotId:lotNumbers[i]};lots.push(lot)}return lots};self.setRestoreSearchFlag=function(){localStorageService.set(self.localSotragePropObj.restoreSearchState,true)};self.addAlerts=function(type,msg){self.alerts.push({msg:msg,type:type})};self.closeAlert=
function(index){self.alerts.splice(index,1);self.isAlertOnModal=false};self.generateIconTemplate=function(template,iconCodes){template=template+'\x3cspan class\x3d"highlighticon" \x3e';for(var i=0;i<iconCodes.length;i++){var code=iconCodes[i]||"";template+='\x3ca fragment-id\x3d"'+code+'" class\x3d"icon-tooltip" data-trigger\x3d"focus" data-placement\x3d"auto right" data-toggle\x3d"popover" data-container\x3d".searchresultstable"\x3e'+'\x3cspan class\x3d"vehicleicon"\x3e\x3cimg src\x3d"../images/global/highlightIcons-'+
appInit.regionCode+'.png" class\x3d"lotIcon-'+code+'"\x3e\x3c/span\x3e\x3c/a\x3e'}template=template+"\x3cspan class\x3d'go-icon' ng-if\x3d'gr'\x3e\x3cimg src\x3d'../images/GoCar-Icon.svg' class\x3d'img-responsive'\x3e\x3c/span\x3e\x3c/span\x3e";return template};self.getSortOrder=function(){var sortOrder=[];var searchPreference=copartUser.getUserConfig().defaultDisplayPref.searchPreference;if(searchPreference&&searchPreference.sortOrder)sortOrder=searchPreference.sortOrder;return sortOrder};self.storeNavigationInfo=
function(resultIndex,totalRecords,fromSearch){var info={backTo:"."+$location.url(),resultIndex:resultIndex,totalRecords:totalRecords,fromSearch:!angular.isUndefined(fromSearch)?fromSearch:true};localStorageService.set(self.localSotragePropObj.lotNavigationInfo,info);localStorageService.set(self.localSotragePropObj.restoreSearchState,true)};self.validIconCodes=_.pluck(appConfigService.appConfig.validHighlightIcons,"iconCode");self.removeCheckedFromWatchList=function(){if(!userService.isAnonymous())if(self.selectedLotNumbers.length==
self.metadata.size&&!showAll){if(self.metadata.size>100){self.addAlerts("danger",self.locale.messages["app.msg.lotsearch.add.max"]);return}var queryArr=[];queryArr.push(self.query);watchListService.removeAllFromWatchlist({query:queryArr,filter:self.filterQueryArr,sort:self.sortApplied.split(","),page:self.metadata.page,size:self.metadata.size},function(){$route.reload()})}else{if(self.selectedLotNumbers.length==0){self.addAlerts("danger",self.locale.messages["app.msg.lotsearch.please.select"]);return}if(self.selectedLotNumbers.length>
100){self.addAlerts("danger",self.locale.messages["app.msg.lotsearch.add.max"]);return}var selectedLots=self.generateLotsByLotNumbers(self.selectedLotNumbers);watchListService.removeCheckedFromWatchlist(selectedLots,function(response){self.addAlerts("success",self.locale.messages["app.msg.lotsearch.remove.watchlist"])})}};self.addCheckedToWatchList=function(){if(!userService.isAnonymous()){if(self.selectedLotNumbers.length==self.metadata.size&&!showAll){if(self.metadata.size>100){self.addAlerts("danger",
self.locale.messages["app.msg.lotsearch.add.max"]);return}var queryArr=[];queryArr.push(self.query);addAllToWatchList({query:queryArr,filter:self.filterQueryArr,sort:self.sortApplied.split(","),page:self.metadata.page,size:self.metadata.size})}else if(self.selectedLotNumbers.length==self.metadata.size&&showAll){if(self.totalRecords>100){self.addAlerts("danger",self.locale.messages["app.msg.lotsearch.add.max"]);return}var queryArr=[];queryArr.push(self.query);addAllToWatchList({query:queryArr,filter:self.filterQueryArr,
sort:self.sortApplied.split(","),page:0,size:self.totalRecords})}else{if(self.selectedLotNumbers.length==0){self.addAlerts("danger",self.locale.messages["app.msg.lotsearch.please.select"]);return}if(self.selectedLotNumbers.length>100){self.addAlerts("danger",self.locale.messages["app.msg.lotsearch.add.max"]);return}var selectedLots=self.generateLotsByLotNumbers(self.selectedLotNumbers);watchListService.addAllCheckedToWatchList(selectedLots,function(response){self.addAlerts("success",self.locale.messages["app.msg.lotsearch.add.watchlist"])},
watchListError)}for(var i in self.selectedLots)if(!AppUtils.isUndefined(self.selectedLots)&&!AppUtils.isUndefined(self.selectedLots[i].lotId)){var siteCatalystVal={};siteCatalystVal.fname="doTagWatchList";siteCatalystVal.addremove="add";siteCatalystVal.lotId=self.selectedLots[i].lotId;siteCatalyst.addToQueue("doTagWatchList",siteCatalystVal);siteCatalyst.executeCall("doTagWatchList")}}};var watchListError=function(response){if(!AppUtils.isUndefined(response.data.data))self.addAlerts("danger","Unable to add the following lots: "+
response.data.data.toString());else self.addAlerts("danger","Error occurred while adding")};var addAllToWatchList=function(data){watchListService.addAllToWatchList(data,function(response){self.addAlerts("success",self.locale.messages["app.msg.lotsearch.add.watchlist"])},watchListError)};self.generateRunLightTemplate=function(template,iconCodes){var runLightsTemplate="";var defaultRunLights=["green","red","yellow","blue"];var lotRunLights=iconCodes||[];lotRunLights=lotRunLights.toString().toLowerCase();
runLightsTemplate+='\x3cspan class\x3d"float-none"\x3e';_.each(defaultRunLights,function(code){if(lotRunLights.indexOf(code)>-1){var highLightedClass="dot";runLightsTemplate+="\x3cspan data-uname\x3d'runLights'  class\x3d'"+code.toLowerCase()+highLightedClass+" no-wrap run-highLight'\x3e\x26nbsp;\x26nbsp;\x26nbsp;\x26nbsp;\x26nbsp;\x3c/span\x3e"}});runLightsTemplate+="\x3c/span\x3e";return runLightsTemplate};self.compileCellWithUnderscore=function(template,data){var compiled=_.template(template);
return compiled(data)};self.selectedLotNumbers=[];self.ifChecked=function(lotNum,$event){var $row=$($event.target).closest("tr");var index=self.selectedLotNumbers.indexOf(lotNum);self.selectAllChecked=false;if($event.target.checked){if(index==-1)self.selectedLotNumbers.push(lotNum);$row.addClass("row-selected")}else{if(index>-1)self.selectedLotNumbers.splice(index,1);$row.removeClass("row-selected")}};self.increaseLimit=function(filter){if(filter.limit<filter.items.length)filter.limit+=10};self.moveOptionUp=
function(id){var $selected=$(id+" option:selected");if($selected.length)$selected.first().prev().before($selected)};self.moveOptionDown=function(id){var $selected=$(id+" option:selected");if($selected.length)$selected.last().next().after($selected)};self.getLot=function(lotNumber){if(self.lots!=null||!_.isEmpty(self.lots)){var lot=self.lots["lot_"+parseInt(lotNumber)];return _.isUndefined(lot)?{}:lot}return{}};self.images.getLot=self.getLot;self.exportRecordsLimit=copartUser.getUserConfig().displayPref.exportRecordsLimit||
2E3;self.showExportResultsWarningText=self.locale.getMessage("app.msg.lotsearch.export.warningModal.body",self.exportRecordsLimit);self.showExportResultsWarningModal=function(){if(userService.isAnonymous())return;$("#exportResultsWarning").modal("show")};self.formatDateTime=function(value){if(value&&value!="")return moment(value,"x").tz(selectedTimezone).format(defaultDateFormat+" "+defaultTimeFormat+" zz")};var bidFormDeregisterEvent=$rootScope.$on("registerBidForm",function(event,data){var checkObj=
_.where(self.preBidForms,{lotNum:data.lotNum});if(checkObj.length==0)self.preBidForms.push(data);else _.extend(_.findWhere(self.preBidForms,{lotNum:data.lotNum}),data)});var transformBidDataForPublic=function(obj){var dynamicLotDetailObj={};dynamicLotDetailObj.las=obj.las;dynamicLotDetailObj.lss=obj.lss;dynamicLotDetailObj.bds=obj.bds;dynamicLotDetailObj.maxBid=obj.maxBid;dynamicLotDetailObj.bnp=obj.bnp;dynamicLotDetailObj.hb=obj.hb;dynamicLotDetailObj.currentBid=obj.currentBid;return dynamicLotDetailObj};
var transformBidDataForMember=function(obj){var dynamicLotDetailObj={};dynamicLotDetailObj.las=obj.lotAuctionStatus;dynamicLotDetailObj.lss=obj.saleStatus;dynamicLotDetailObj.bds=obj.bidStatus;dynamicLotDetailObj.maxBid=obj.maxBid;dynamicLotDetailObj.bnp=obj.buyTodayBid;dynamicLotDetailObj.hb=obj.currentBid;dynamicLotDetailObj.currentBid=obj.currentBid;return dynamicLotDetailObj};var currentBidDeregisterEvent=$rootScope.$on("got-current-bid-data",function(event,data){self.lots=angular.copy(self.lotsObj);
var tempLots={};if(data.returnCode==1)tempLots=_.indexBy(data.data,"lotNumber");else if(data.returnCode==2)tempLots=data.data;else tempLots=_.indexBy(data,"ln");var isAnonymous=userService.isAnonymous();angular.forEach(tempLots,function(value,key){var dynamicLotDetailObj=isAnonymous?transformBidDataForPublic(value):transformBidDataForMember(value);self.lots["lot_"+key]=dynamicLotDetailObj})});var handleNoResults=function(event,data){var str=$location.search().query||$location.search().displayStr;
searchText.construct(str,data);self.noResults=true;if(self.urlToTrigger=="/lot/watchList")self.loadingSearchResults=false};var noRecordsDeregisterEvent=$rootScope.$on("no-records",function(event,data){handleNoResults(event,data)});var searchUnavailableEvent=$rootScope.$on("search-unavailable",function(event,data){handleNoResults(event,data);self.searchCriteria.searchUnavailable=true});var yardDetailsLoadedEvent=$rootScope.$on("yardDetailsLoaded",function(event,data){self.navigationAddress="";self.yardDetails=
data;if("IRL"==self.tempScope.yardDetails.yardCountryCode||"IRL"==self.yardDetails.yardCountryCode){self.yardDetails.yardZip="R14 YK37";self.yardDetails.yardMailingZip="R14 YK37";if(self.tempScope){self.tempScope.yardDetails.yardZip="R14 YK37";self.tempScope.yardDetails.yardMailingZip="R14 YK37"}}self.navigationAddress=(self.tempScope.yardDetails.yardAddress1||data.yardAddress1)+" "+(self.tempScope.yardDetails.yardAddress2||data.yardAddress2)+" "+(self.tempScope.yardDetails.yardCity||data.yardCity)+
" "+(self.tempScope.yardDetails.yardStateName||data.yardStateName)+" "+(self.tempScope.yardDetails.yardZip||data.yardZip);self.showZip=true;if(self.$parent.checkForMEACountryCode(self.tempScope.yardDetails.yardCountryCode)||self.$parent.checkForMEACountryCode(data.yardCountryCode)){self.showZip=false;self.navigationAddress="Copart "+(self.tempScope.yardDetails.yardCity||data.yardCity)+" "+(self.tempScope.yardDetails.yardStateName||data.yardStateName)}});var scopeRestoreEvent=$rootScope.$on("state-restore",
function(event,data){self.showImages=data.showImages;self.showHideImages(self.showImages);self.showMultiBidCheckbox=data.showMultiBidCheckbox;self.toggleMultiBid(data.showMultiBidCheckbox);self.zipcode=data.zipcode});self.cleanUp=function(){currentBidDeregisterEvent();bidFormDeregisterEvent();noRecordsDeregisterEvent();searchUnavailableEvent();yardDetailsLoadedEvent();scopeRestoreEvent();metaDataService.clearPageTags()};self.init=function(){if(self.checkIfSearchStrIsPresent()){self.fromSavedSearch=
true;if($location.search().page)$location.search("page",1)}var stateRestoreFromAnywhere=localStorageService.get(self.localSotragePropObj.restoreStateFromAnyWhere);localStorageService.remove(self.localSotragePropObj.restoreStateFromAnyWhere);if(checkIfFromLotDetails(History)||$location.search().state=="restore"||stateRestoreFromAnywhere){state=localStorageService.get(self.localSotragePropObj.restoreSearchState);self.viewedLot=localStorageService.get(self.localSotragePropObj.viewdLot);localStorageService.remove(self.localSotragePropObj.viewdLot)}localStorageService.remove(self.localSotragePropObj.restoreSearchState);
var stateStage=localStorageService.get(self.localSotragePropObj.stateStage);state=state?true:false;if(state)localStorageService.set(self.localSotragePropObj.stateStage,"1");else localStorageService.set(self.localSotragePropObj.stateStage,"0");if(!self.externalSearchCriteria){backTo=backTo+"\x26query\x3d"+self.query;self.backTolink=self.backTolink+"\x26query\x3d"+self.query}self.pageLength=localStorageService.cookie.get(self.localSotragePropObj.cookie.searchResultsPageLength);self.pageLength=self.pageLength?
self.pageLength:20;self.pageNumber=$location.search().page;if(_.isEmpty(self.pageNumber)||_.isNaN(self.pageNumber-0)||self.pageNumber<1)self.pageNumber=1;self.pageNumber=parseInt(self.pageNumber);self.iDisplayStart=(self.pageNumber-1)*self.pageLength;self.resetAndReturnSearchCriteria=function(){console.log("resetting the search criteria :");self.searchCriteria.reset();return self.searchCriteria};self.defaultDataTableOptions={"pageLength":self.pageLength,"lengthMenu":[[20,50,100],[20,50,100]],"iDisplayStart":self.iDisplayStart,
"columnDefs":self.columnDefs,"initOrder":!free?[[1,"asc"]]:[],"freeFormSearch":free?true:false,"showAll":showAll,"url":self.urlToTrigger,"containsFilters":false,"searching":!copartUser.getUserConfig().displayPref.allowSecondarySearch,"stateSave":state,"query":self.query?self.query:"*","searchCriteria":!self.externalSearchCriteria?self.resetAndReturnSearchCriteria():self.searchCriteria,"fromSavedSearch":self.fromSavedSearch?true:false,"saveSearchCriteria":self.fromSavedSearch?saveSearchCriteria:{},
"fnRowCallback":function(nRow,aData,iDisplayIndex){jQuery(".nowrap",nRow).attr("nowrap","nowrap");return nRow},"language":{"paginate":{"first":self.locale.messages["app.label.first"],"previous":self.locale.messages["app.label.previous"],"next":self.locale.messages["app.label.next"],"last":self.locale.messages["app.label.last"]},"lengthMenu":self.locale.messages["app.label.show"]+" _MENU_ "+self.locale.messages["app.label.entries"],"info":self.locale.messages["app.label.showingRecords.info"],"infoEmpty":self.locale.messages["app.label.noRecordsAvailable"],
"infoFiltered":"("+self.locale.messages["app.label.filteredFrom"]+" _MAX_ "+self.locale.messages["app.label.totalEntries"]+")","searchPlaceholder":self.locale.getMessage("bids.lotswon.label.searchListPlaceholder"),"search":self.locale.getMessage("app.label.search")+":"},"afterInit":function(datatable){jQuery("#selectAllHdr").html("\x3cdiv class\x3d'text-center'\x3e\x3cinput type\x3d'checkbox' ng-checked\x3d'selectAllChecked' ng-click\x3d'selectAll()'/\x3e\x3c/div\x3e");$compile(jQuery("#selectAllHdr"))($scope);
self.tableHeaders=self.populateMobileSortMenu(datatable.columns().header());self.$apply();if(localStorageService.get(self.localSotragePropObj.filtersHidden))$timeout(function(){if(!self.isMobileDevice)jQuery("#filter-anchor").click()},5);if(localStorageService.cookie.get(self.localSotragePropObj.cookie.showImages)==false){self.showImages=false;self.showHideImages(false)}self.buildInventory(self.filters)},"sortColumns":self.getSortOrder()}};self.buildInventory=function(filters){self.showSEOTemplate=
!$location.search().searchCriteria&&$location.url().indexOf("/quickpick")>-1;if(!self.showSEOTemplate)return;var quickPickValue=$routeParams.value;self.seoContentLotCount=self.totalRecords;try{var homeQuickPicks=dataServiceG2.quickPicks?dataServiceG2.quickPicks["HOME"]:null;if(!homeQuickPicks)dataServiceG2.getQuickPicks("HOME",function(quickPicks){homeQuickPicks=quickPicks;constructSEOMap(homeQuickPicks,quickPickValue,filters)});else constructSEOMap(homeQuickPicks,quickPickValue,filters)}catch(e){console.error(e);
self.showSEOTemplate=false}};var constructSEOMap=function(homeQuickPicks,quickPickValue,filters){var sortedModelArr=[];var sortedLocArr=[];var sortedDamageArr=[];self.inventoryMap=new Map;self.seoTemplateType=homeQuickPicks.categoryNameByUri[quickPickValue];self.seoContentFieldName=homeQuickPicks.displayNameByUri[quickPickValue];for(i=0;i<filters.length;i++){var fieldName=filters[i].name;var fieldNameItems=filters[i].items;if((fieldName!=null||fieldName!=undefined)&&fieldName=="Model"){if(fieldNameItems!=
null||fieldNameItems!=undefined){for(j=0;j<fieldNameItems.length;j++)sortedModelArr.push({"name":fieldNameItems[j].displayName,"count":fieldNameItems[j].count});sortedModelArr.sort(function(a,b){return b.count-a.count})}for(k=0;k<sortedModelArr.length;k++)self.inventoryMap.set("model"+k,sortedModelArr[k].name)}if((fieldName!=null||fieldName!=undefined)&&fieldName=="Location"){if(fieldNameItems!=null||fieldNameItems!=undefined){for(j=0;j<fieldNameItems.length;j++)sortedLocArr.push({"name":fieldNameItems[j].displayName?
fieldNameItems[j].displayName.toUpperCase():"","count":fieldNameItems[j].count});sortedLocArr.sort(function(a,b){return b.count-a.count})}for(k=0;k<sortedLocArr.length;k++)self.inventoryMap.set("location"+k,sortedLocArr[k].name)}if((fieldName!=null||fieldName!=undefined)&&fieldName=="Damage"){if(fieldNameItems!=null||fieldNameItems!=undefined){for(j=0;j<fieldNameItems.length;j++)sortedDamageArr.push({"name":fieldNameItems[j].displayName?fieldNameItems[j].displayName.toLowerCase():"","count":fieldNameItems[j].count});
sortedDamageArr.sort(function(a,b){return b.count-a.count})}for(k=0;k<sortedDamageArr.length;k++)self.inventoryMap.set("damage"+k,sortedDamageArr[k].name)}if((fieldName!=null||fieldName!=undefined)&&fieldName=="Year")if((fieldNameItems!=null||fieldNameItems!=undefined)&&fieldNameItems.length>0){self.inventoryMap.set("earliestyear",fieldNameItems[fieldNameItems.length-1].displayName);self.inventoryMap.set("latestyear",fieldNameItems[0].displayName)}if((fieldName!=null||fieldName!=undefined)&&fieldName==
"Sale Date")if((fieldNameItems!=null||fieldNameItems!=undefined)&&fieldNameItems.length>0)self.inventoryMap.set("nextsaledate",fieldNameItems[0].displayName);if((fieldName!=null||fieldName!=undefined)&&fieldName=="Ownership Doc Type")if(fieldNameItems!=null||fieldNameItems!=undefined)for(j=0;j<fieldNameItems.length;j++){if(fieldNameItems[j].displayName=="Clean Title")self.inventoryMap.set("clean",fieldNameItems[j].count);if(fieldNameItems[j].displayName=="NonRepairable")self.inventoryMap.set("nonrepairable",
fieldNameItems[j].count);if(fieldNameItems[j].displayName=="Salvage Title")self.inventoryMap.set("salvage",fieldNameItems[j].count)}}self.showSEOTemplate=self.showSEOTemplate&&self.inventoryMap.size>0};$scope.$on("$destroy",function(){self.cleanUp()});self.getLotSearchBaseHeaderColumns=function(fieldList){var userColumns={};var columns={};angular.forEach(fieldList,function(fieldid){if("imagePathSmall"==fieldid)columns["data"]={"defaultContent":"","render":function(data,type,row,meta){row=self.getDefaultRowValues(row);
row["resultIndex"]=meta.settings._iDisplayStart+meta.row;row["totalRecords"]=meta.settings._iRecordsTotal;row["backTo"]=backTo;row["header"]=self.header;var bidString=$filter(currencyFilterName)(row["hb"],row["cuc"]);var isFuture=row["adt"]=="E"?true:false;var template="\x3cdiv class\x3d'imgpath cursor-pointer' lot-id\x3d'"+row["ln"]+"' lot-desc\x3d'"+row["ld"]+"' sealed-bid\x3d'"+row["sbf"]+"' images\x3d'images' current-bid\x3d'"+row["hb"]+"' is-future\x3d'"+isFuture+"'"+"result-index\x3d'"+row["resultIndex"]+
"' total-records\x3d'"+row["totalRecords"]+"' from-search\x3dtrue "+"auction-date\x3d'"+row["ad"]+"' yard-number\x3d'"+row["ynumb"]+"' bid-string\x3d'"+bidString+"' currency-code\x3d'"+row["cuc"]+"'";if(self.facebookUser)template=template+"hide-watch-btn\x3d'true'";template=template+"\x3e\x3ca ng-click\x3d'storeNavigationInfo([[resultIndex]],[[totalRecords]],true)' data-url\x3d'./lot/[[ ln ]]/[[ ldu ]]' brand\x3d'[[ brand ]]' sso-sign-on\x3e";var siteCatVal=JSON.stringify({"fname":"doTagLotImages",
"imageNumber":"1","lotId":row["ln"].toString()});if(row["tims"]!="")template=template+"\x3cimg site-catalyst\x3d'"+siteCatVal+"'   lazy-src\x3d'"+row["tims"]+"' title\x3d'"+row.ld+"' alt\x3d'"+row.ld+"' data-uname\x3d'lotsearchLotimage' height\x3d'72' width\x3d'96'\x3e\x3c/a\x3e";else template=template+"\x3cimg site-catalyst\x3d'"+siteCatVal+"' lazy-src\x3d'images/testImages/no_photo.jpg' data-uname\x3d'lotsearchLotimage' height\x3d'72' width\x3d'96'\x3e\x3c/a\x3e";template=template+"\x3c/div\x3e\x3cdiv class\x3d'viewallphotos'\x3e\x3ca ng-click\x3d'storeNavigationInfo([[resultIndex]],[[totalRecords]],true)' sso-sign-on brand\x3d'[[ brand ]]' data-url\x3d'./lot/[[ ln ]]/Photos/[[ ldu ]]' class\x3d'image_viewer_link'\x3e"+
self.locale.messages["counterman.searchResults.viewAllPhotos.label"]+"\x3c/a\x3e\x3c/div\x3e";return self.compileCellWithUnderscore(template,row)}};else if(fieldid=="checkbox")columns["data"]={"defaultContent":"","render":function(data,type,row){row=self.getDefaultRowValues(row);var template="\x3cdiv class\x3d'text-center'\x3e"+"\x3cinput type\x3d'checkbox' class\x3d'action-item' name\x3d'lot-select' id\x3d'[[ln]]' ng-checked\x3d'selectedLotNumbers.indexOf(\"[[ln]]\")\x3e-1' ng-click\x3d\"ifChecked('[[ln]]',$event)\"/\x3e\x3cbr\x3e";
return self.compileCellWithUnderscore(template,row)}};else if(fieldid=="lotYear")columns["data"]={"defaultContent":"","render":function(data,type,row){row=self.getDefaultRowValues(row);if(row["lic"])var iconCodes=_.intersection(row["lic"],self.validIconCodes);var template="\x3cspan data-uname\x3d'lotsearchLotcenturyyear'\x3e"+row["lcy"]+"\x3c/span\x3e\x3cbr\x3e";return self.generateIconTemplate(template,iconCodes)}};else if(fieldid=="lotNumber")columns["data"]={"defaultContent":"","render":function(data,
type,row,meta){row=self.getDefaultRowValues(row);row["resultIndex"]=meta.settings._iDisplayStart+meta.row;row["totalRecords"]=meta.settings._iRecordsTotal;row["backTo"]=backTo;row["header"]=self.header;if(self.viewedLot&&self.viewedLot==row["ln"]){self.viewedRowIndex=meta.row;self.viewedLot=null}if(!self.facebookUser)var template="\x3cdiv class\x3d'ng-cloak'\x3e"+"\x3ca class\x3d'search-results' data-url\x3d'./lot/[[ ln ]]/[[ ldu ]]' brand\x3d'[[ brand ]]' sso-sign-on "+"ng-click\x3d'storeNavigationInfo([[resultIndex]],[[totalRecords]],true)' data-uname\x3d'lotsearchLotnumber'\x3e[[ ln ]]\x3c/a\x3e\x3cbr/\x3e"+
"\x3cbutton type\x3d'submit' class\x3d'black-line watch-btn' ng-hide\x3d\"isAlreadyAdded('[[ln]]')\" check-for-logged-in-user state-restore\x3d'true'"+"ng-click\x3d\"::addToWatchList('[[ln]]')\" data-uname\x3d'lotsearchWatchlot'\x3e"+self.locale.messages["app.label.watch"]+"\x3c/button\x3e"+"\x3cbutton type\x3d'submit' class\x3d'black-line watch-btn watched' ng-hide\x3d\"!isAlreadyAdded('[[ln]]')\""+"ng-click\x3d\"removeFromWatchList('[[ln]]')\" data-uname\x3d'lotsearchRemovelot'\x3e"+self.locale.messages["app.label.remove"]+
"\x3c/button\x3e"+"\x3c/div\x3e";else var template="\x3cdiv class\x3d'ng-cloak'\x3e"+"\x3ca data-url\x3d'./lot/[[ ln ]]/[[ ldu ]]' sso-sign-on brand\x3d'[[ brand ]]' target\x3d '_blank'"+"ng-click\x3d'storeNavigationInfo([[resultIndex]],[[totalRecords]],true)' data-uname\x3d'lotsearchLotnumber'\x3e[[ ln ]]\x3c/a\x3e\x3cbr/\x3e";return self.compileCellWithUnderscore(template,row)}};else if(fieldid=="auctionDateUtc")columns["data"]={"defaultContent":"","render":function(data,type,row){row=self.getDefaultRowValues(row);
var date;var template="";if(row["adt"]=="E")template="\x3cspan data-uname\x3d'lotsearchLotauctiondate' ng-if\x3d\"lots.lot_[[ln]].las!\x3d'LIVE_BIDDING'\x26\x26!isLiveAuction\"\x3eFuture\x3c/span\x3e";else{if(isValidDate(row["ad"]))date=moment.utc(row["ad"]).tz(userService.userConfig.selectedTimezone).format(auctionDateFormat);else date=self.locale.messages["lotdetail.label.saleDate.upcomingLots"];template="\x3cspan data-uname\x3d'lotsearchLotauctiondate' ng-if\x3d\"lots.lot_[[ln]].las!\x3d'LIVE_BIDDING'\x26\x26!isLiveAuction\"\x3e"+
date+"\x3c/span\x3e"}template=template+"\x3cspan data-uname\x3d'lotsearchLotauctiondate' class\x3d'btn btn-success' ng-if\x3d\"lots.lot_[[ln]].las\x3d\x3d'LIVE_BIDDING'||isLiveAuction\"\x3e"+self.locale.messages["app.label.live.now"]+"\x3c/span\x3e";return self.compileCellWithUnderscore(template,row)}};else if(fieldid=="saleDateUtc")columns["data"]={"defaultContent":"-","render":function(data,type,row){row=self.getDefaultRowValues(row);var date;if(row["ifs"])date=self.locale.messages["app.label.future"];
else if(isValidDate(row["sdu"]))date=moment.utc(row["sdu"]).tz(userService.userConfig.selectedTimezone).format(auctionDateFormat);else date=self.locale.messages["app.label.notApplicable"];var template="\x3cspan data-uname\x3d'lotsearchLotauctiondate' ng-if\x3d\"lots.lot_[[ln]].las!\x3d'LIVE_BIDDING'\x26\x26!isLiveAuction\"\x3e"+date+"\x3c/span\x3e"+"\x3cspan data-uname\x3d'lotsearchLotauctiondate' class\x3d'btn btn-success' ng-if\x3d\"lots.lot_[[ln]].las\x3d\x3d'LIVE_BIDDING'||isLiveAuction\"\x3e"+
self.locale.messages["app.label.live.now"]+"\x3c/span\x3e";return self.compileCellWithUnderscore(template,row)}};else if(fieldid=="auctionTime")columns["data"]={"defaultContent":"","render":function(data,type,row){row=self.getDefaultRowValues(row);var date=moment.utc(row["ad"]).tz(selectedTimezone).format("hh:mm A zz");return date}};else if(fieldid=="engine")columns["data"]={"defaultContent":"","render":function(data,type,row){row=self.getDefaultRowValues(row);var template="\x3cspan data-uname\x3d'lotsearchLotEngine'\x3e"+
row["egn"]+"\x3c/span\x3e\x3cbr\x3e";return template}};else if(fieldid=="saleTitleTypeDesc")columns["data"]={"defaultContent":"","render":function(data,type,row){row=self.getDefaultRowValues(row);var template="\x3cspan data-uname\x3d'lotSaleDocument'\x3e"+row["sttd"]+"\x3c/span\x3e\x3cbr\x3e";return template}};else if(fieldid=="transmissionType")columns["data"]={"defaultContent":"","render":function(data,type,row){row=self.getDefaultRowValues(row);var template="\x3cspan data-uname\x3d'transmissionType'\x3e"+
row["tmtp"]+"\x3c/span\x3e\x3cbr\x3e";return template}};else if(fieldid=="cylinders")columns["data"]={"defaultContent":"","render":function(data,type,row){row=self.getDefaultRowValues(row);var template="\x3cspan data-uname\x3d'lotsearchLotEngine'\x3e"+row["cy"]+"\x3c/span\x3e\x3cbr\x3e";return template}};else if(fieldid=="lotAcv")columns["data"]={"defaultContent":"","render":function(data,type,row){row=self.getDefaultRowValues(row);var lotAcv=row["la"]?$filter("globalize_currency_using_code")(row["la"],
row["cuc"]):"";var template="\x3cspan data-uname\x3d'lotsearchLotestimatedretailvalue'\x3e"+lotAcv+"\x3c/span\x3e";return template}};else if(fieldid=="repairCost")columns["data"]={"defaultContent":"","render":function(data,type,row){row=self.getDefaultRowValues(row);var template="\x3cspan data-uname\x3d'lotsearchLotrepaircost'\x3e"+(row["rc"]?$filter(currencyFilterName)(row["rc"],row["cuc"]):"")+"\x3c/span\x3e";return template}};else if(fieldid=="odometerReadingReceived")columns["data"]={"defaultContent":"",
"render":function(data,type,row){row=self.getDefaultRowValues(row);var template="\x3cspan data-uname\x3d'lotsearchLotodometerreading' title \x3d'"+row["ord"]+"'\x3e"+$filter("odometer_reading_display")(row["orr"],row["obc"],row["ouom"])+"\x3c/span\x3e";return template}};else if(fieldid=="vatFlagForSale")columns["data"]={"defaultContent":"","render":function(data,type,row){row=self.getDefaultRowValues(row);var vatFlag=row["vfs"]?self.locale.messages["app.label.yes"]:self.locale.messages["app.label.no"];
var template="\x3cspan data-uname\x3d'vatEligible'\x3e"+vatFlag+"\x3c/span\x3e\x3cbr\x3e";return template}};else if(fieldid=="saleYardName")columns["data"]={"defaultContent":"","render":function(data,type,row){row=self.getDefaultRowValues(row);var template="\x3cspan data-uname\x3d'saleYardName'\x3e"+row["syn"]+"\x3c/span\x3e";return template}};else if(fieldid=="runLights"){columns["data"]={"defaultContent":"","render":function(data,type,row){row=self.getDefaultRowValues(row);var template="";return self.generateRunLightTemplate(template,
row["rl"])}};$(this).addClass("runLightsColumn")}else if(fieldid=="sellerName")columns["data"]={"defaultContent":"","render":function(data,type,row){row=self.getDefaultRowValues(row);return row["snm"]}};else if(fieldid=="crGrade")columns["data"]={"defaultContent":0,"render":function(data,type,row){row=self.getDefaultRowValues(row);var crg=isNaN(row["crg"])?row["crg"]:row["crg"].toFixed(1);var html="\x3ccondition-report lot-number\x3d "+row["ln"]+" display-name\x3d"+crg+" document-type\x3d'VGLK_CONDITION_REPORT'\x3e\x3c/condition-report\x3e";
return html}};else if(fieldid=="sellerSource")columns["data"]={"defaultContent":0,"render":function(data,type,row){row=self.getDefaultRowValues(row);var template="\x3cspan data-uname\x3d'sellerSource'\x3e"+row["slrsr"]+"\x3c/span\x3e";return template}};else if(fieldid=="sellerType")columns["data"]={"defaultContent":0,"render":function(data,type,row){row=self.getDefaultRowValues(row);var template="\x3cspan data-uname\x3d'sellerType'\x3e"+row["std"]+"\x3c/span\x3e";return template}};else columns["data"]=
{"defaultContent":"","render":function(data,type,row,meta){row=self.getDefaultRowValues(row);row["resultIndex"]=meta.settings._iDisplayStart+meta.row;row["totalRecords"]=meta.settings._iRecordsTotal;row["backTo"]=backTo;row["header"]=self.header;row["isUpcomingLot"]=!isValidDate(row["ad"])?true:false;var template=$("#"+fieldid).html();if(!_.isUndefined(template)){var compiled=_.template(template);return compiled(row)}return data}};userColumns[fieldid]=columns["data"]});return userColumns};self.setSearchCriteriaObj=
function(criteria){self.searchCriteria.setSearchCriteriaObj(criteria)}}]);
app.controller("lotSearchResultsController",["$controller","$rootScope","$scope","$location","urlService","userService","dataServiceG2","miscSearchQuery","watchListService","backToLinkService","siteCatalyst","copartUser","$route","$templateCache","localStorageService","$routeParams",function($controller,$rootScope,$scope,$location,urlService,userService,dataServiceG2,searchCriteria,watchListService,backToLinkService,siteCatalyst,copartUser,$route,$templateCache,localStorageService,$routeParams){try{$controller("lotSearchBaseController",
{$scope:$scope,searchCriteria:searchCriteria});var self=$scope;self.showMultiBidCheckbox=false;self.tableId="serverSideDataTable";self.eligibleToMultiLotBid=userService.isEligibleToMultiBid($location.url());self.compareLotIdString="";self.externalSearchCriteria=$location.search().externalSearchCriteria||!_.isEmpty(searchCriteria.getMiscFilter());self.fromSavedSearch=$location.search().fromSavedSearch;var lengthOfHeaders=$("#"+self.tableId).find("th").length;self.columnDefs=[{"targets":[0,1,lengthOfHeaders-
2],"orderable":false},{"targets":[3],"orderSequence":["desc","asc"]},{targets:"no-sort",orderable:false},{"targets":[lengthOfHeaders-2],"visible":self.eligibleToMultiLotBid&&self.showMultiBidCheckbox},{className:"control",orderable:false,targets:-1},{"targets":["runLightsColumn"],"orderable":false}];self.customColumnsOptions={"length":7,"url":"/data/lotSrchDisplayPref","colMappingField":"customLotSearchColumns"};self.localSotragePropObj={"restoreStateFromAnyWhere":"restore-search-state-from-anywhere",
"restore":"restore","restoreSearchState":"restore-search-state","viewdLot":"viewed-lot","stateStage":"stateStage","lotNavigationInfo":"lot-navigation-info","filtersHidden":"filtersHidden","cookie":{"searchResultsPageLength":"searchResultsPageLength","showImages":"showImages"}};var searchTextArgs={};if($routeParams.auctionDate)searchTextArgs.auctionDate=$routeParams.auctionDate;if(searchCriteria.getDisplayStr()){self.header="Search Results for: "+searchCriteria.getDisplayStr();searchTextArgs.searchText=
searchCriteria.getDisplayStr();$rootScope.$emit("meta-args-update",searchTextArgs);searchCriteria.setDisplayStr(null)}else{searchTextArgs.searchText=self.searchText;$rootScope.$emit("meta-args-update",searchTextArgs);self.header=urlService.getHeadingForURL($location.url(),self.locale)}urlService.getSubHeaderForURL($location.url(),self.locale).then(function(subHeader){self.subHeader=subHeader});var computeUrlToTrigger=function(){if($location.url().indexOf("/watchList")!=-1)return"/lot/watchList";if($location.url().indexOf("/vehicleFinderSearch")!=
-1)return"/public/vehicleFinder/search";return"/public/lots/search"};self.getCSVUrl=function(clientCsvUrl,serverCsvUrl){if(copartUser.hasAccessSitePref("searchPreference.serverSideCsv","true"))return serverCsvUrl;else return clientCsvUrl};self.urlToTrigger=computeUrlToTrigger();if($location.url().indexOf("/watchList")!=-1){if(userService.isAnonymous()){urlService.redirectUrl=$location.path();$location.path(urlService.login)}self.csvUrl=self.getCSVUrl("/client/exportWatchlistResults","/public/exportWatchlistResults?view\x3dcsv\x26date\x3d"+
self.date);self.csvFileName="WatchList_"+self.date+".csv"}else{self.loadingSearchResults=false;self.csvUrl=self.getCSVUrl("/client/exportLotSearchResults","/public/exportLotSearchResults?view\x3dcsv\x26date\x3d"+self.date);self.csvFileName="LotSearchresults_"+self.date+".csv"}if(self.externalSearchCriteria)if(searchCriteria.getSortByZip())self.zipcode=searchCriteria.getBuyerEnteredZip();self.toggleMultiBid=function(flag){self.showMultiBidCheckbox=flag;var table=$(self.tableId).DataTable();table.column(lengthOfHeaders-
2).visible(flag);self.clearAllCheckBoxes()};self.showAll=function(){var url=$location.url();url=url.replace("saleListResult","saleListResultAll");var siteCatalystVal={};siteCatalystVal.fname="doTagViewAllLaneSalelist";siteCatalyst.addToQueue("doTagViewAllLaneSalelist",siteCatalystVal);siteCatalyst.executeCall("doTagViewAllLaneSalelist");$location.url(url)};self.showLess=function(){$location.search("viewType","showLess")};self.computeBidButtonLabel=function(auctionDate){return auctionDate?self.locale.messages["app.label.bidNow"]:
self.locale.messages["registration.label.viewLots"]};self.getHeaderColumns=function(tableId){var fieldList=[];$(tableId).find("thead tr th").each(function(i,v){fieldList.push($(this).data("fieldid"))});var userColumns=self.getLotSearchBaseHeaderColumns(fieldList,self.viewSpecificColoums);var headerColumnRenderingArr=[];angular.forEach(fieldList,function(field){headerColumnRenderingArr.push(userColumns[field])});return headerColumnRenderingArr};self.saveSearch=function(){dataServiceG2.saveSearch(self.getSearchObject(true),
function(response){if(response.data.returnCode!=-1){self.savedSearchCompleted=true;self.savedSearchError=false;self.savedSearchErrorLimit=false;self.saved=true}else if(response.data.data.errorMsg.trim()=="MBRWBCRSDS04")self.savedSearchErrorLimit=true;else self.savedSearchError=true})};self.compareLots=function(){if(self.selectedLotNumbers.length>1&&self.selectedLotNumbers.length<6){self.compareLotIdString=self.selectedLotNumbers.join(",");var url="/compareLots/"+self.compareLotIdString;backToLinkService.setBackToLink(self.backToLink);
$location.url(url)}else self.addAlerts("danger",self.locale.messages["app.alert.compareLot"])};self.resetToDefault=function(){$("#multiselect_to").empty();var defValues=[];var defValuesOrig=[];$("#multiselect_def option").each(function(){defValues.push($(this).clone())});$("#multiselect_to").html(defValues);$("#multiselect").empty();var buyerAvailValues=[];var defAvailFields=[];$("#multiselect_defAvail option").each(function(){buyerAvailValues.push($(this).clone())});$("#multiselect").html(buyerAvailValues)};
self.confirmCustomization=function(){var selectedOptions=[];var options=$("#multiselect_to option");if(options.length<(self.customColumnsOptions.length||7)){var values=$.map(options,function(option){return option.index+":"+option.value});function mapper(str){var o={};var strArr=str.split(":");o[strArr[0].trim()]=strArr[1].trim();return o}var resultArray=values.map(mapper);var colNameToMap=JSON.stringify(self.customColumnsOptions.colMappingField);var postData={};postData[self.customColumnsOptions.colMappingField]=
JSON.stringify(values);$.ajax({type:"POST",dataType:"json",contentType:"application/json; charset\x3dutf-8",url:self.customColumnsOptions.url,data:JSON.stringify(postData),success:function(result){if(result&&result.returnCode===1){$("#customize").modal("hide");$("body").removeClass("modal-open");$(".modal-backdrop").remove();var currentPageTemplate=$route.current.templateUrl;$templateCache.remove(currentPageTemplate);if(self.fromDriverSeat)$templateCache.remove("driverseat/dataTable?view\x3d"+$route.current.params.view);
localStorageService.set(self.localSotragePropObj.restoreSearchState,true);$location.search("state","restore");$route.reload()}},error:function(){}})}else{self.errCustomColCount=true;self.addAlerts("danger",self.locale.messages["app.alert.customizeResult"]);self.isAlertOnModal=true}};self.getDefaultRowValues=function(row){row=_.defaults(row,{"lotNumberStr":"13955196","ln":0,"mkn":"","lm":"","lcy":"","fv":"","la":0,"rc":0,"orr":0,"ord":"","obc":"","egn":"","cy":"","ld":"","yn":"","cuc":"","tz":"","ad":0,
"at":"00:00:00","aan":0,"hb":0,"ss":0,"bndc":"","bnp":0,"sbf":false,"ts":"0","stt":"0","td":"0","dd":"0","tims":"","lic":[],"gr":"-","dtc":"","al":"-","adt":"","ynumb":0,"phynumb":0,"bf":false,"cc":"","ymin":0,"myb":0,"lmc":"","lcc":"","sdd":"","bstl":"","ftd":"","lcd":"","ft":"","hk":false,"sn":"","kys":false,"tmtp":"","drv":"","syn":"","sttd":"","ouom":"","slrsr":"","vfs":"","egn_typ":"","brand":"","std":"","ldu":""});return row};self.getBuyerPosition=function(lotNumber){var lot=self.getLot(lotNumber);
var returnObj={};if(_.isEmpty(lot))returnObj.position="N";else if(parseInt(userService.getBuyerNumber())==lot.highBidder)returnObj.position="W";else if(lot.hasBid=="Y")returnObj.position="L";else returnObj.position="N";return returnObj};$("#multiselect").multiselect({keepRenderingSort:true});self.init();self.dataTableOptions=self.defaultDataTableOptions;if(!userService.isAnonymous()&&localStorage.getItem("addtoWatchlistLotId")){var watchListLot=JSON.parse(localStorage.getItem("addtoWatchlistLotId"));
if(watchListLot&&watchListLot.lotId&&(new Date).getTime()<watchListLot.timestamp)watchListService.addtoWatchlistAssumingLoggedInUser(watchListLot.lotId);localStorage.removeItem("addtoWatchlistLotId")}}catch(e){console.error(e);$location.url("/unknown-error")}}]);
app.controller("saleListController",["$scope","miscSearchQuery","$location","alphanumericFilter","$route","$templateCache","dataServiceG2","watchListService","$filter","$timeout","backToLinkService","userService","urlService","$rootScope","auctionsCalendarService","copartUtils","deviceService","localStorageService","History","saleListOnMessageService","copartUser",function($scope,searchCriteria,$location,alphanumericFilter,$route,$templateCache,dataServiceG2,watchListService,$filter,$timeout,backToLinkService,
userService,urlService,$rootScope,auctionsCalendarService,copartUtils,deviceService,localStorageService,History,saleListOnMessageService,copartUser){var self=$scope;self.userService=userService;self.filters=[];self.nullIncludeTags=[];self.appliedFilters=[];self.sortBy="auction_date_utc asc";self.secSortBy="auction_date_utc asc";self.watchListOnly=false;self.yardDetails={};self.images={};self.selectedLots=[];self.compareLotIdString="";self.alerts=[];self.totalRecords=0;self.showImages=true;var thumbnailLength=
5;self.urlFrom=$location.search().from;watchListService.setWatchListDefinition($location.url());self.header=urlService.getHeadingForURL($location.url(),self.locale);urlService.getSubHeaderForURL($location.url(),self.locale).then(function(subHeader){self.subHeader=subHeader});self.date=moment().format("YYYY MMMM DD");var getCSVUrl=function(clientCsvUrl,serverCsvUrl){if(copartUser.hasAccessSitePref("searchPreference.serverSideCsv","true"))return serverCsvUrl;else return clientCsvUrl};self.csvUrl=getCSVUrl("/client/exportLotSearchResults",
"/public/exportLotSearchResults?view\x3dcsv\x26date\x3d"+self.date);self.csvFileName="LotSearchresults_"+self.date+".csv";var state=false;var stateRestoreFromAnywhere=localStorageService.get("restore-search-state-from-anywhere");localStorageService.remove("restore-search-state-from-anywhere");if(checkIfFromLotDetails(History)||$location.search().state=="restore"||stateRestoreFromAnywhere){state=localStorageService.get("restore-search-state");self.viewedLot=localStorageService.get("viewed-lot");localStorageService.remove("viewed-lot")}localStorageService.remove("restore-search-state");
state=state?true:false;var stateObj={};if(state)stateObj=localStorageService.get("state-saved-sale-list");function stateRestore(){self.appliedFilters=stateObj.filters;self.secSortBy=stateObj.secSortBy;self.sortBy=stateObj.sortBy;self.watchListOnly=stateObj.watchListOnly;reloadtable()}function stateSave(){var state={filters:self.appliedFilters,secSortBy:self.secSortBy,sortBy:self.sortBy,watchListOnly:self.watchListOnly};localStorageService.set("state-saved-sale-list",state);if(!self.showImages)localStorageService.cookie.set("showImages",
self.showImages);else if(localStorageService.cookie.get("showImages"))localStorageService.cookie.remove("showImages")}var init=function(){window.addEventListener&&window.addEventListener("message",saleListOnMessageService.onMessage,false)||window.attachEvent&&window.attachEvent("onmessage",saleListOnMessageService.onMessage);if(localStorageService.cookie.get("showImages")==false)self.showImages=false;if(!_.isEmpty(stateObj))stateRestore();else{localStorageService.remove("state-saved-sale-list");$("#searchSaleslistForm").append(" \x3cinput class\x3d'hiddenFields' type\x3d'hidden' name\x3d'query' value\x3d'*'\x3e\x3cbr\x3e");
$("#searchSaleslistForm").append(" \x3cinput class\x3d'hiddenFields' type\x3d'hidden' name\x3d'sort' value\x3d'auction_date_utc asc'\x3e\x3cbr\x3e");$("#searchSaleslistForm").append(" \x3cinput class\x3d'hiddenFields' type\x3d'hidden' name\x3d'defaultSort' value\x3d'true'\x3e\x3cbr\x3e");$("#searchSaleslistForm").append(" \x3cinput class\x3d'hiddenFields' type\x3d'hidden' name\x3d'backUrl' value\x3d'"+$location.url()+"'\x3e\x3cbr\x3e");$("#searchSaleslistForm").append(" \x3cinput class\x3d'hiddenFields' type\x3d'hidden' name\x3d'hideImages' value\x3d'"+
!self.showImages+"'\x3e\x3cbr\x3e");var miscFilter=searchCriteria.getMiscFilter();if(miscFilter.length>0)for(var i=0;i<miscFilter.length;i++)$("#searchSaleslistForm").append(" \x3cinput type\x3d'hidden' class\x3d'hiddenFields' name\x3d'filter[MISC]' value\x3d'"+miscFilter[i]+"'\x3e\x3cbr\x3e");$("#searchSaleslistForm").submit()}};var addAlerts=function(type,msg){self.alerts.push({msg:msg,type:type})};self.closeAlert=function(index){self.alerts.splice(index,1);self.isAlertOnModal=false};self.showLess=
function(){var url=$location.url();url=url.replace("saleListResultAll","saleListResult");$location.url(url)};function reloadtable(){$(".hiddenFields").remove();stateSave();var appliedFilters=_.groupBy(self.appliedFilters,function(item){return item.quickPickCode});$("#searchSaleslistForm").append(" \x3cinput type\x3d'hidden'  class\x3d'hiddenFields' name\x3d'query' value\x3d'*'\x3e\x3cbr\x3e");$("#searchSaleslistForm").append(" \x3cinput type\x3d'hidden'  class\x3d'hiddenFields' name\x3d'sort[0]' value\x3d'"+
self.sortBy+"'\x3e\x3cbr\x3e");$("#searchSaleslistForm").append(" \x3cinput type\x3d'hidden'  class\x3d'hiddenFields' name\x3d'sort[1]' value\x3d'"+self.secSortBy+"'\x3e\x3cbr\x3e");$("#searchSaleslistForm").append(" \x3cinput type\x3d'hidden'  class\x3d'hiddenFields' name\x3d'watchListOnly' value\x3d'"+self.watchListOnly+"'\x3e\x3cbr\x3e");$("#searchSaleslistForm").append(" \x3cinput class\x3d'hiddenFields' type\x3d'hidden' name\x3d'backUrl' value\x3d'"+$location.url()+"'\x3e\x3cbr\x3e");$("#searchSaleslistForm").append(" \x3cinput class\x3d'hiddenFields' type\x3d'hidden' name\x3d'hideImages' value\x3d'"+
!self.showImages+"'\x3e\x3cbr\x3e");var miscFilter=searchCriteria.getMiscFilter();if(miscFilter.length>0)for(var i=0;i<miscFilter.length;i++)$("#searchSaleslistForm").append(" \x3cinput type\x3d'hidden'  class\x3d'hiddenFields' name\x3d'filter[MISC]' value\x3d'"+miscFilter[i]+"'\x3e\x3cbr\x3e");angular.forEach(appliedFilters,function(valueArr,key){for(var i=0;i<valueArr.length;i++)$("#searchSaleslistForm").append(" \x3cinput type\x3d'hidden'  class\x3d'hiddenFields' name\x3d'filter["+key+"]' value\x3d'"+
valueArr[i].query+"'\x3e\x3cbr\x3e")});$("#searchSaleslistForm").submit()}function resizeIframe(obj,frame){obj.style.height=frame.height()+30+"px"}function boldLot(iframe){if(self.viewedLot){var doc=iframe.contentDocument||iframe.contentWindow.document;doc.getElementById(self.viewedLot).parentElement.parentElement.className+=" bold";self.viewedLot=null}}self.showHideImages=function(flag){if(flag)window.frames["resultsFrame"].postMessage("showImages","*");else window.frames["resultsFrame"].postMessage("hideImages",
"*");stateSave()};var msgFunction=function(evt){console.log(evt);var message=evt.data;try{if(typeof message!=="string")return;else if(message.indexOf("salesListFrameLoaded")!=-1){var saleslistIframeTable=$("#resultsFrame").contents().find("#saleListTable");var saleslistIframe=window.frames["resultsFrame"];resizeIframe(document.getElementById("resultsFrame"),saleslistIframeTable);boldLot(document.getElementById("resultsFrame"))}else if(message.indexOf("salesListFacetsLoaded")!=-1){var saleslistIframeTable=
$("#resultsFrame").contents().find("#saleListTable");var saleslistIframe=window.frames["resultsFrame"];var facets=JSON.parse(saleslistIframe.facets);self.totalRecords=saleslistIframe.totalRecords;resizeIframe(document.getElementById("resultsFrame"),saleslistIframeTable);populateFacets(facets)}else if(message.indexOf("salesListSorted")!=-1){var saleslistIframe=window.frames["resultsFrame"];self.sortBy=saleslistIframe.sortBy;self.secSortBy=saleslistIframe.secSortBy;reloadtable()}else if(message.indexOf("openLocationsModal")!=
-1){var saleslistIframe=window.frames["resultsFrame"];var requestedYard=saleslistIframe.yard;getYardDetails(requestedYard)}else if(message.indexOf("openImagesModal")!=-1){var saleslistIframe=window.frames["resultsFrame"];var requestedImages=saleslistIframe.requestedImages;getImages(requestedImages)}else if(message.indexOf("refreshSelectedLots")!=-1){var saleslistIframe=window.frames["resultsFrame"];var lots=saleslistIframe.selectedLots;var compareLotIdString=saleslistIframe.compareLotIdString;var selectAllChecked=
saleslistIframe.selectAllChecked;refeshSelectedLots(lots,compareLotIdString,selectAllChecked)}else if(message.indexOf("addToWatchlist")!=-1){var saleslistIframe=window.frames["resultsFrame"];var lotNumber=saleslistIframe.lotNumber;addToWatchList(lotNumber)}else if(message.indexOf("removeFromWatchlist")!=-1){var saleslistIframe=window.frames["resultsFrame"];var lotNumber=saleslistIframe.lotNumber;removeFromWatchlist(lotNumber)}else if(message.indexOf("openLotDetails")!=-1){var saleslistIframe=window.frames["resultsFrame"];
var url=saleslistIframe.requestedLot;var resultIndex=saleslistIframe.resultIndex;var totalRecords=saleslistIframe.totalRecords;goToLot(url,resultIndex,totalRecords)}}catch(e){console.log("Not a Sale list event")}};saleListOnMessageService.setMsgFunction(msgFunction);init();var goToLot=function(lotUrl,resultIndex,totalRecords){var info={backTo:"."+$location.url(),resultIndex:resultIndex,totalRecords:totalRecords,fromSearch:true};localStorageService.set("lot-navigation-info",info);localStorageService.set("restore-search-state",
true);if(lotUrl.indexOf(".")==0)lotUrl=lotUrl.substring(1);$location.url(lotUrl);self.$apply()};function populateFacets(facets){self.filters=[];for(var i=0;i<facets.length;i++){var facet={};facet.name=facets[i].displayName;facet.includeTag=facets[i].includeTag;facet.quickPickCode=facets[i].quickPickCode;facet.limit=10;if(_.isUndefined(facet.includeTag)||_.isNull(facet.includeTag)||_.isEmpty(facet.includeTag.trim()))if(_.isEmpty(self.nullIncludeTags))self.nullIncludeTags.push(facet.quickPickCode);
facet.items=copartUtils.clubFacets(facets[i].facetCounts,facet.quickPickCode);facet.facetField=facets[i].facetField;self.filters.push(facet)}self.$digest()}self.setWatchListOnly=function(){self.watchListOnly=!self.watchListOnly;reloadtable()};self.applyFilter=function(item,$event){if($event.target.checked){var item={};item.id=$event.target.id;item.name=$event.target.value;item.quickPickCode=$event.target.name;item.query=$event.target.attributes.query.value;self.appliedFilters.push(item)}else removeFilter($event.target.id);
reloadtable()};self.removeFilter=function(id){removeFilter(id);reloadtable()};self.isFilterApplied=function(id){return!_.isUndefined(_.find(self.appliedFilters,function(item){return item.id==alphanumericFilter(id)}))};self.clearSectionFilters=function(filter){var sectionFilters=_.filter(self.appliedFilters,function(item){return item.quickPickCode==filter.quickPickCode});_.each(sectionFilters,function(item){removeFilter(item.id)});reloadtable()};function checkIfFromLotDetails(History){try{var lastRoute=
History.lastRoute;if(lastRoute&&(lastRoute.indexOf("lot/")==0||lastRoute.indexOf("lotDetail/")==0||lastRoute.indexOf("vehicleFinderSearch/")==0||lastRoute.indexOf("compareLots/")==0))return true;else return false}catch(e){return false}}self.clearAllFilters=function(){self.appliedFilters=[];self.watchListOnly=false;reloadtable()};function removeFilter(id){var index=_.findIndex(self.appliedFilters,function(item){return item.id==id});self.appliedFilters.splice(index,1)}self.errCustomColCount=false;self.alerts=
[];self.isAlertOnModal=false;$("#multiselect").multiselect({keepRenderingSort:true});self.resetToDefault=function(id){$("#multiselect_to").empty();var defValues=[];var defValuesOrig=[];$("#multiselect_def option").each(function(){defValues.push($(this).clone())});$("#multiselect_to").html(defValues);$("#multiselect").empty();var buyerAvailValues=[];var defAvailFields=[];$("#multiselect_defAvail option").each(function(){buyerAvailValues.push($(this).clone())});$("#multiselect").html(buyerAvailValues)};
self.confirmCustomization=function(){var selectedOptions=[];var options=$("#multiselect_to option");if(options.length<7){var values=$.map(options,function(option){return option.index+":"+option.value});function mapper(str){var o={};strArr=str.split(":");o[strArr[0].trim()]=strArr[1].trim();return o}var resultArray=values.map(mapper);var colString=JSON.stringify(values);$.ajax({type:"POST",dataType:"json",contentType:"application/json; charset\x3dutf-8",url:"/data/lotSrchDisplayPref",data:JSON.stringify({"customLotSearchColumns":colString}),
success:function(result){if(result&&result.returnCode===1){$("#customize").modal("hide");$("body").removeClass("modal-open");$(".modal-backdrop").remove();var currentPageTemplate=$route.current.templateUrl;localStorageService.set("restore-search-state",true);$location.search("state","restore");$templateCache.remove(currentPageTemplate);$route.reload()}},error:function(){}})}else{self.errCustomColCount=true;addAlerts("danger",self.locale.messages["app.alert.customizeResult"]);self.isAlertOnModal=true}};
var getYardDetails=function(requestedYard){self.yardDetails={};self.yardDetails.showInventory=true;dataServiceG2.getLocationDetail(requestedYard.yardNumber,function(response){self.yardDetails=response.data;self.yardDetails.liveAuction=requestedYard.live=="false"?false:true;if(self.yardDetails.liveAuction){self.yardDetails.auctionLane=requestedYard.lane;self.yardDetails.yardNumber=requestedYard.yardNumber}self.showZip=!self.$parent.checkForMEACountryCode(self.yardDetails.yardCountryCode);jQuery("#locationGenericModal").modal("show")})};
var getImages=function(requestedImages){self.images={};self.images.lotDesc=requestedImages.lotDesc;self.images.lotId=requestedImages.lotId;self.images.currentBid=requestedImages.currentBid;self.images.bidString=$filter("globalize_currency_using_code")(requestedImages.currentBid,requestedImages.currecyCode);self.images.resultIndex=requestedImages.resultIndex;self.images.totalRecords=requestedImages.totalRecords;self.isAlreadyAdded=watchListService.isAlreadyAdded;self.addToWatchList=watchListService.addToWatchList;
self.removeFromWatchList=watchListService.removeFromWatchList;var auctionDate=parseInt(requestedImages.auctionDate);self.images.auctionTimeLeft=auctionsCalendarService.timeToAuction(auctionDate);self.locale=self.$parent.locale;self.images.storeNavigationInfo=function(){var info={backTo:"."+$location.url(),resultIndex:self.images.resultIndex,totalRecords:self.images.totalRecords,fromSearch:true};localStorageService.set("lot-navigation-info",info)};dataServiceG2.getLotImages(requestedImages.lotId,function(response){if(response!=
null){var imagesList=response.data.data.imagesList||{};self.images.fullSizeImages=imagesList.FULL_IMAGE;self.images.thumbNailImages=imagesList.THUMBNAIL_IMAGE;if(self.images.thumbNailImages.length>10){self.images.thumbnailLength=10;thumbnailLength=10}else{self.images.thumbnailLength=5;thumbnailLength=5}$timeout(loadImageViewer,0)}})};var loadImageViewer=function(){carousel4=new ImageCarousel("#carousel4",{errorImage:"/images/testImages/no_photo.jpg",lazyInit:true,buyerNumber:userService.userConfig.buyerNumber,
lotId:self.images.lotId,thumbnailLength:thumbnailLength});carousel4.initImageViewer();jQuery("#lotImage").modal("show");jQuery(function(){var image={};image=carousel4.showStripImage(0)});carousel4.showImage=function(element){var sequence=jQuery(element).attr("data-sequence");image=carousel4.showStripImage(sequence-1)}};var refeshSelectedLots=function(lots,compareLotIdString,selectAllChecked){self.selectAllChecked=selectAllChecked;self.selectedLots=lots;self.compareLotIdString=compareLotIdString;self.$digest()};
self.compareLots=function(){if(!self.selectAllChecked)if(self.selectedLots.length>1&&self.selectedLots.length<6){var url="/compareLots/"+self.compareLotIdString;backToLinkService.setBackToLink($location.url());$location.url(url)}else addAlerts("danger",self.locale.messages["app.alert.compareLot"]);else addAlerts("danger",self.locale.messages["app.alert.compareLot"])};var addToWatchList=function(lotNumber){if(userService.isAnonymous())$("#loginRegister").modal("show");else watchListService.addToWatchList(lotNumber,
function(response){window.frames["resultsFrame"].postMessage("refreshWatchListLots","*")})};var removeFromWatchlist=function(lotNumber){watchListService.removeFromWatchList(lotNumber,function(response){window.frames["resultsFrame"].postMessage("refreshWatchListLots","*")})};function createFilterObject(){var appliedFilters=_.groupBy(self.appliedFilters,function(item){return item.quickPickCode});var tempObj={};angular.forEach(appliedFilters,function(valueArr,key){tempObj[key]=[];for(var i=0;i<valueArr.length;i++)tempObj[key].push(valueArr[i].query)});
tempObj.MISC=searchCriteria.getMiscFilter();return tempObj}self.addCheckedToWatchList=function(){if(!userService.isAnonymous())if(self.selectAllChecked){if(self.totalRecords>99){addAlerts("danger",self.locale.messages["app.msg.lotsearch.add.max"]);return}var queryArr=[];queryArr.push(self.query);addAllToWatchList({query:["*"],filter:createFilterObject(),sort:["auction_date_utc asc"],page:0,size:1E5})}else{if(self.selectedLots.length==0){addAlerts("danger",self.locale.messages["app.msg.lotsearch.please.select"]);
return}if(self.selectedLots.length>99){addAlerts("danger",self.locale.messages["app.msg.lotsearch.add.max"]);return}watchListService.addAllCheckedToWatchList(self.selectedLots,function(response){addAlerts("success",self.locale.messages["app.msg.lotsearch.add.watchlist"]);window.frames["resultsFrame"].postMessage("refreshWatchListLots","*")},watchListError)}};var watchListError=function(response){if(!AppUtils.isUndefined(response.data.data))addAlerts("danger","Unable to add the following lots: "+response.data.data.toString());
else addAlerts("danger","Error occurred while adding")};var addAllToWatchList=function(data){watchListService.addAllToWatchList(data,function(response){addAlerts("success",self.locale.messages["app.msg.lotsearch.add.watchlist"])},watchListError,function(){window.frames["resultsFrame"].postMessage("refreshWatchListLots","*")})};var yardDetailsLoadedEvent=$rootScope.$on("yardDetailsLoaded",function(event,data){self.yardDetails=data});$scope.$on("$destroy",function(){yardDetailsLoadedEvent()})}]);
app.controller("noResultsController",["$scope","$location","searchText","$rootScope","urlService","searchCriteriaFactory","searchCriteriaConstants",function($scope,$location,searchText,$rootScope,urlService,searchCriteriaFactory,searchCriteriaConstants){var self=$scope;self.searchObj=searchText.getSearch();self.searchCriteria=searchCriteriaFactory.getSearchCriteria(searchCriteriaConstants.lotSearch);self.searchUnavailable=!!self.searchCriteria.searchUnavailable;self.noResultsTemplateUrl=urlService.getNoResultsURL($location.url());
console.log(self.searchObj);self.searchWithSpellCheck=function(searchText){$rootScope.$broadcast("search-again",{searchText:searchText})}}]);app.service("searchText",[function(){var service=this;var search={};service.construct=function(text,spellChecks){search.searchText=text;search.spellChecks=spellChecks};service.getSearch=function(){var result={};result.searchText=search.searchText;result.spellChecks=search.spellChecks;_.defaults(result,{searchText:"",spellChecks:[]});return result}}]);
app.controller("compareLotsController",["$scope","$http","$location","dataServiceG2","$routeParams","$timeout","urlService","userService","config","appConfigService","backToLinkService","copartUser","localStorageService","watchListService",function($scope,$http,$location,dataServiceG2,$routeParams,$timeout,urlService,userService,config,appConfigService,backToLinkService,copartUser,localStorageService,watchListService){var self=$scope;var log=new Logger({name:"ServerSideDataTable",level:config.logLevel});
self.dateFormat=copartUser.getUserConfig().displayPref.dateFormat.toUpperCase();self.companyCode=copartUser.getUserConfig().companyCode;self.lotsToCompare=[];self.lotsToCompareIds="";self.loading=true;self.imageURL=appConfigService.getEnvConfigProps().imageBaseUrl;if(!_.isUndefined($routeParams.lotIdList)&&!_.isNull($routeParams.lotIdList)&&$routeParams.lotIdList.trim().length>0){self.lotsToCompare=$routeParams.lotIdList.split(",");self.lotsToCompareIds=$routeParams.lotIdList}self.backToLink=backToLinkService.getBackToLink();
localStorageService.set("restore-search-state",true);self.lotDetails=[];self.WatchList;self.watchListIds=[];self.isWatchList=false;self.images={};self.lotNumber;var init=function(){$(function(){$(".modal-content").draggable()});$(".carousel").each(function(){$(this).carousel({pause:true,interval:false})});if(!userService.isAnonymous()){getWatchListForBuyer();self.guestUser=false}else self.guestUser=true;self.closecount=0;self.len=self.lotsToCompare.length;dataServiceG2.getLotComparisionDetails(self.lotsToCompareIds,
lotComparisionCallBack)};var lotComparisionCallBack=function(response){if(response.data.data.lotDetails)self.lotDetails=_.values(response.data.data.lotDetails);else self.lotsNotFound=true;self.loading=false};var lotCompareBidDataCallBack=function(response){self.lotDetails=response.data.data.lotDetails;self.loading=false};var getWatchListForBuyer=function(){$http({method:"GET",url:"/data/lots/watchList"}).then(function successCallback(response){if(_.isUndefined(self.watchList))self.watchList=response.data.data.watchList;
else self.watchList=_.union(self.watchList,response.data.data.watchList)},function errorCallback(response){})};self.removeFromCompare=function(event){console.log("Removing from compare..."+event.target);var target=angular.element(event.target);if(self.len-2!=self.closecount){target.closest(".lot-compare-content").hide(1E3);self.closecount++}else $("#CompareModal").modal("show")};self.addToWatchList=function(lotNumber){if(!userService.isAnonymous())$http({method:"POST",url:"/data/lots/addToWatchList/"+
lotNumber}).then(function successCallback(response){if(response.data.returnCode==1){var item={};if(self.isWatchList){var index=_.findIndex(self.watchList,function(lot){return lot.lotId==lotNumber});self.watchList.splice(index,1)}else{item.lotId=lotNumber;self.watchList.push(item)}watchListService.addToWatchListForCompare(lotNumber)}else log.error("Failed to add lot in watch list")},function errorCallback(response){log.error("Error: Failed to add lot in watch list")})};self.removeFromWatchList=function(lotNumber){if(!userService.isAnonymous())$http({method:"POST",
url:"/data/lots/removeFromWatchList/"+lotNumber}).then(function successCallback(response){if(response.data.returnCode==1){if(self.isWatchList){var item={};item.lotId=lotNumber;self.watchList.push(item)}else{var index=_.findIndex(self.watchList,function(lot){return lot.lotId==lotNumber});self.watchList.splice(index,1)}watchListService.removeFromWatchListForCompare(lotNumber)}else log.error("Failed to removed lot from watch list")},function errorCallback(response){log.error("Error: Failed to add lot in watch list")})};
self.isAlreadyAdded=function(lotNumber){var object=_.find(self.watchList,function(item){return item.lotId==lotNumber});if(object)if(self.isWatchList)return false;else return true;else if(self.isWatchList)return true;else return false};self.showLotImages=function(lotId){console.log("Fetch lot images for..."+lotId);self.lotNumber=lotId;dataServiceG2.getLotImages($scope.lotNumber,function(response){if(response!=null){var imagesList=response.data.data.imagesList||{};self.fullSizeImages=imagesList.FULL_IMAGE;
self.thumbNailImages=imagesList.THUMBNAIL_IMAGE}});loadImageViewer()};var loadImageViewer=function(){var slider=$(".bxslider").bxSlider({mode:"horizontal",pagerCustom:"#bx-pager",nextSelector:"#lot-slider-next",prevSelector:"#lot-slider-prev",prevText:"",nextText:""});$("#lot-slider-next").click(function(){slider.goToNextSlide();return false});$("#lot-slider-prev").click(function(){slider.goToPrevSlide();return false});$(".bxslider img").wrap('\x3cspan style\x3d"display:inline-block"\x3e\x3c/span\x3e').css("display",
"block").parent().zoom({magnify:2})};$scope.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){loadImageViewer()});var highlightIcons=_.where(appConfigService.appConfig.getHighlightIcons(),{iconType:"H"});var validIconCodes=_.pluck(highlightIcons,"iconCode");self.iconCodesFilter=function(code){return validIconCodes.indexOf(code)>-1};self.getAuctionURIWithLotNumber=function(lot){return urlService.getAuctionURIWithLotNumber(lot.ynumb,lot.al,lot.ln)};self.inArray=function(item,array){return-1!==
array.indexOf(item)};init()}]);
app.controller("auctionCalendarController",["$scope","$locale","$http","$location","copartUser","copartUtils","auctionsCalendarService","dataServiceG2","userService","urlService","$compile","metaDataService",function($scope,$locale,$http,$location,copartUser,copartUtils,auctionsCalendarService,dataServiceG2,userService,urlService,$compile,metaDataService){var self=$scope;self.auctionLists=null;self.error=null;self.isAnonymous=userService.isAnonymous();self.completeAuctionsList=[];self.liveAuctionsDisplay=
[];self.closedAuctionsDisplay=[];self.laterAuctionsDisplay=[];self.allWeeksHeader=[];self.laneSelected=null;self.wlWaiting=true;self.wlSpinner=true;self.laneDetails=null;self.locationDetail=[];self.todayAuctions=[];self.yardLocationNumber=[];self.yardLocationURL="";self.auction=null;self.dateFormat=copartUser.getUserConfig().dateFormat.toUpperCase();self.siteCode=copartUser.getUserConfig().siteCode;var timeZone=self.$parent.userConfig.selectedTimezone;var time=moment.tz(auctionsCalendarService.todaysAuctionDate,
timeZone);self.offset=time.tz(timeZone).format("Z");self.abbr=time.tz(timeZone).zoneAbbr();$scope.hideTime=false;self.TimesButton=false;$scope.showText=self.locale.getMessage("app.label.auctionCalendar.showTimes");if(self.siteCode!="CRTSUS"){$scope.showText=self.locale.getMessage("app.label.auctionCalendar.hideTimes");$scope.hideTime=true}$scope.toggleTimeDisplay=function(){$scope.hideTime=!$scope.hideTime;$scope.showText=$scope.hideTime?self.locale.getMessage("app.label.auctionCalendar.hideTimes"):
self.locale.getMessage("app.label.auctionCalendar.showTimes")};function GetFullName(weekDay){var days=[self.locale.getMessage("app.label.week.day0"),self.locale.getMessage("app.label.week.day1"),self.locale.getMessage("app.label.week.day2"),self.locale.getMessage("app.label.week.day3"),self.locale.getMessage("app.label.week.day4"),self.locale.getMessage("app.label.week.day5"),self.locale.getMessage("app.label.week.day6")];var day=days[weekDay];return day}self.addDaysToDate=function(inputDate,noOfDays){var newDate=
moment(inputDate).add(noOfDays,"days").toDate();return newDate};var fetchAuctionsForDay=function(date){var auctions=_.find(self.auctionList,function(val){return val.userTZAuctionDate==date});return auctions};self.groupAuctionsIntoSevenWeeks=function(auctionsList){var subGroupArray=[];var size=7;while(auctionsList.length>0)if(auctionsList.length>=7)subGroupArray.push(auctionsList.splice(0,size));else subGroupArray.push(auctionsList.splice(0,auctionsList.length));return subGroupArray};self.createAuctionCalendar=
function(auctionsList){var startDayOfWeek=auctionsCalendarService.startDayofWeek.toDate();var auctionsForMissingDay;var auctionsListLength=auctionsList.length;var eachWeekHeader=[];for(var index=0;index<=42;index++){var nextDay=self.addDaysToDate(startDayOfWeek,index);var weekDay=moment(nextDay).day();if(index!=0&&weekDay==1){self.allWeeksHeader.push(eachWeekHeader);eachWeekHeader=[];if(index==42)break}var nextDayFormatted=moment(nextDay).format(self.dateFormat);var auctionDate={auctionDate:nextDayFormatted,
auctionDay:GetFullName(weekDay)};eachWeekHeader.push(auctionDate);var auctionsForNextDay=fetchAuctionsForDay(nextDayFormatted);if(auctionsForNextDay)self.completeAuctionsList.push(auctionsForNextDay);else{auctionsForMissingDay={};auctionsForMissingDay.userTZAuctionDate=nextDayFormatted;auctionsForMissingDay.auctionDay=GetFullName(weekDay);auctionsForMissingDay.auctions=[];self.completeAuctionsList.push(auctionsForMissingDay)}}};self.fullWeekAuctions=function(inputAuctions,weekOfAuction){var fullWeekAuctions=
[];var startDayOfWeek=weekOfAuction*7;var presentWeek=auctionsCalendarService.startDayofWeek.toDate();var closedAuctionCheck=0;self.previousDayAuctionCheck=false;for(var i=startDayOfWeek;i<startDayOfWeek+7;i++){var nextDay=self.addDaysToDate(presentWeek,i);var timeZone=copartUser.getUserConfig().selectedTimezone;var time=moment.tz(auctionsCalendarService.todaysAuctionDate,timeZone);var offset=time.tz(timeZone).format("Z");var today=auctionsCalendarService.todaysAuctionDate.utcOffset(self.offset).format(self.dateFormat);
var nextDayFormatted=moment(nextDay).format(self.dateFormat);var flag=0;for(var j=0;j<inputAuctions.length;j++)if(nextDayFormatted==inputAuctions[j].userTZAuctionDate&&moment(nextDayFormatted,self.dateFormat)>=moment(today,self.dateFormat)){flag=1;closedAuctionCheck=1;fullWeekAuctions.push(inputAuctions[j])}if(flag==0){var weekDay=moment(nextDay).day();var auction={auctions:[],auctionDay:GetFullName(weekDay),userTZAuctionDate:nextDayFormatted};fullWeekAuctions.push(auction)}}if(closedAuctionCheck==
0)self.previousDayAuctionCheck=true;return fullWeekAuctions};var init=function(data){self.liveAuctionsDisplay=_.sortBy(data.todayAuctions.liveAuctions,function(o){return o.fullTime});self.closedAuctionsDisplay=_.sortBy(data.todayAuctions.endedAuctions,function(o){return o.fullTime});self.laterAuctionsDisplay=_.sortBy(data.todayAuctions.laterAuctions,function(o){return o.fullTime});self.auctionList=_.chain(data.allList).groupBy(function(num){return num.auctionDate.dateAsInt}).map(function(value,key){return{auctionKey:key,
userTZAuctionDate:moment(new Date(key.substring(0,4),parseInt(key.substring(4,6))-1,key.substring(6,8))).format(self.dateFormat),auctionDay:GetFullName(moment(new Date(key.substring(0,4),parseInt(key.substring(4,6))-1,key.substring(6,8))).day()),auctions:value}}).value();self.createAuctionCalendar(self.auctionList);self.groupedAuctionsList=self.groupAuctionsIntoSevenWeeks(self.completeAuctionsList);self.finalGroup=[];for(var i=0;i<self.groupedAuctionsList.length;i++){var subGroup=[];for(var j=0;j<
self.groupedAuctionsList[i].length;j++)for(var k=0;k<self.groupedAuctionsList[i][j].auctions.length;k++)subGroup.push(self.groupedAuctionsList[i][j].auctions[k]);self.finalGroup.push(subGroup)}self.groupByTime=[];for(var i=0;i<self.finalGroup.length;i++){self.auctionListByTime=_.chain(self.finalGroup[i]).groupBy(function(num){return num.fullTime}).map(function(value,key){return{auctionTime:value[0].startTime,fullTime:key,auctions:value}}).value();self.newSortedTimeAuctions=_.sortBy(self.auctionListByTime,
function(o){return parseInt(o.fullTime)});self.groupByTime.push(self.newSortedTimeAuctions)}for(var i=0;i<self.groupByTime.length;i++){self.groupByTime[i].weekHeader=self.allWeeksHeader[i];for(var j=0;j<self.groupByTime[i].length;j++){self.auctionListByWeek=_.chain(self.groupByTime[i][j].auctions).groupBy(function(num){return num.auctionDate.dateAsInt}).map(function(value,key){return{userTZAuctionDate:moment(new Date(key.substring(0,4),parseInt(key.substring(4,6))-1,key.substring(6,8))).format(self.dateFormat),
auctionDay:GetFullName(moment(new Date(key.substring(0,4),parseInt(key.substring(4,6))-1,key.substring(6,8))).day()),auction:value}}).value();var weekAuctions=self.fullWeekAuctions(self.auctionListByWeek,i);if(self.previousDayAuctionCheck==true)self.groupByTime[i][j].auctionTime="0";self.groupByTime[i][j].auctions=weekAuctions}}self.wlWaiting=false;self.TimesButton=true};auctionsCalendarService.getAllAuctionData().then(function(data){init(data)});$(function(){$('[rel\x3d"popover"]').popover({container:"body",
html:true,content:function(){var clone=$($(this).data("popover-content")).clone(true).removeClass("hide");return clone}}).click(function(e){e.preventDefault()})});self.selectedLane=function(auction,laneInfo){var auctionHostId=auction.auctionHostId?auction.auctionHostId:auction.yardNumber;self.laneSelected=auctionHostId+"-"+laneInfo.lane;auction.lane=laneInfo.lane;jQuery("#liveSaleList").attr("data-url",self.redirectSaleList(auction,true));jQuery("#liveJoinAuction").attr("data-url","./auctionDashboard?auctionDetails\x3d"+
self.laneSelected);$compile(jQuery("#submitSaleAndAuction"))(self)};var readYardLocationURL=function(auction){if(auction)self.yardLocationURL=urlService.getLocationUrl(auction.locationDetailList.length>1?yardLocationNumber.yardNumber:auction.locationDetailList[0].yardNumber)};self.openModal=function(auction){self.auction=auction;self.laneDetails=auction.laneInfoList[0];jQuery("#liveSaleList").attr("brand",auction.brand);jQuery("#liveJoinAuction").attr("brand",auction.brand);self.selectedLane(auction,
self.laneDetails);readYardLocationURL(auction)};self.closeModal=function(id){copartUtils.closeModal(id)};self.validateDay=function(inputDate){var today=auctionsCalendarService.todaysAuctionDate.utcOffset(self.offset).format(self.dateFormat);if(inputDate===today)return"today";else if(moment(inputDate,self.dateFormat)<moment(today,self.dateFormat))return"past";else return"future"};self.redirectSaleList=function(auction,liveAuction){if(auction){auction.liveAuction=liveAuction;auction.from="/auctionCalendar";
return urlService.getSaleListResultUrl(auction,auction.liveAuction)}}}]);
app.controller("auctionCalendarMapController",["$scope","$locale","$http","searchCriteria","$location","auctionsCalendarService","userService","copartUser","urlService",function($scope,$locale,$http,searchCriteria,$location,auctionsCalendarService,userService,copartUser,urlService){var self=$scope;self.searchCriteria=searchCriteria;self.auction=undefined;self.laneSelected=null;self.laneDetails=null;self.liveAuctionsMap={};self.laterAuctionsMap={};self.dateFormat=copartUser.getUserConfig().dateFormat.toUpperCase();
var showVirtualSales=copartUser.getUserConfig().showVirtualSales?true:false;var modalId="map-location-modal";var openModal=function(){$("#"+modalId).modal({backdrop:false});$("#"+modalId).draggable({handle:".modal-dialog"})};var init=function(todaysAuction){self.liveAuctions=_.filter(todaysAuction.liveAuctions,function(auction){return!auction.isVirtualSale||showVirtualSales});if(self.liveAuctions)self.liveAuctions.forEach(function(auction){auction.locationDetailList.forEach(function(location){if(!self.liveAuctionsMap[location.yardNumber]){var obj=
{};obj.auctionsList=[];obj.yardDetails=location;obj.auctionsList.push(auction);self.liveAuctionsMap[location.yardNumber]=obj}else self.liveAuctionsMap[location.yardNumber].auctionsList?self.liveAuctionsMap[location.yardNumber].auctionsList.push(auction):self.liveAuctionsMap[location.yardNumber].auctionsList=[]})});self.futureAuctions=_.filter(todaysAuction.laterAuctions,function(auction){return!auction.isVirtualSale||showVirtualSales});if(self.futureAuctions)self.futureAuctions.forEach(function(auction){auction.locationDetailList.forEach(function(location){if(!self.laterAuctionsMap[location.yardNumber]){var obj=
{};obj.auctionsList=[];obj.yardDetails=location;obj.auctionsList.push(auction);self.laterAuctionsMap[location.yardNumber]=obj}else self.laterAuctionsMap[location.yardNumber].auctionsList?self.laterAuctionsMap[location.yardNumber].auctionsList.push(auction):self.liveAuctionsMap[location.yardNumber].auctionsList=[]})});for(var yardNumber in self.liveAuctionsMap)if(self.liveAuctionsMap.hasOwnProperty(yardNumber)&&self.liveAuctionsMap[yardNumber].hasOwnProperty("yardDetails")&&self.liveAuctionsMap[yardNumber].hasOwnProperty("auctionsList")&&
self.liveAuctionsMap[yardNumber].auctionsList.length>0){var date=self.liveAuctionsMap[yardNumber].auctionsList[0].auctionDate.dateAsInt.toString();self.liveAuctionsMap[yardNumber].formattedDate=moment(new Date(date.substring(0,4),date.substring(4,6)-1,date.substring(6,8))).format(self.dateFormat);createMarker(self.liveAuctionsMap[yardNumber],"../images/auctionmap-icons/green-50-smaller.png")}for(var yardNumber in self.laterAuctionsMap)if(self.laterAuctionsMap.hasOwnProperty(yardNumber)&&self.laterAuctionsMap[yardNumber].hasOwnProperty("yardDetails")&&
self.laterAuctionsMap[yardNumber].hasOwnProperty("auctionsList")&&self.laterAuctionsMap[yardNumber].auctionsList.length>0){var date=self.laterAuctionsMap[yardNumber].auctionsList[0].auctionDate.dateAsInt.toString();self.laterAuctionsMap[yardNumber].formattedDate=moment(new Date(date.substring(0,4),date.substring(4,6)-1,date.substring(6,8))).format(self.dateFormat);createMarker(self.laterAuctionsMap[yardNumber],"../images/auctionmap-icons/blue-50-smaller.png")}if(Object.getOwnPropertyNames(self.liveAuctionsMap).length>
0)self.auction=self.liveAuctionsMap[Object.keys(self.liveAuctionsMap)[0]];else if(Object.getOwnPropertyNames(self.laterAuctionsMap).length>0)self.auction=self.laterAuctionsMap[Object.keys(self.laterAuctionsMap)[0]];if(self.auction){self.laneDetails=self.auction.auctionsList[0].laneInfoList[0];self.selectedLane(self.auction.auctionsList[0],self.laneDetails)}openModal()};auctionsCalendarService.getAllAuctionData().then(function(data){init(data.todayAuctions)});var latitude=userService.userConfig.auctionMapCoordinates!=
undefined?userService.userConfig.auctionMapCoordinates.lat:30;var longitude=userService.userConfig.auctionMapCoordinates!=undefined?userService.userConfig.auctionMapCoordinates["long"]:-78;var mapCenter=new google.maps.LatLng(latitude,longitude);var mapOptions={zoom:4,center:mapCenter,mapTypeId:google.maps.MapTypeId.TERRAIN};$scope.map=new google.maps.Map(document.getElementById("mapTest"),mapOptions);$scope.markers=[];var infoWindow=new google.maps.InfoWindow;var geocoder=new google.maps.Geocoder;
var createMarker=function(yardLocation,Icon){var address=yardLocation.yardDetails.yardCity+" "+yardLocation.yardDetails.yardStateName+" "+yardLocation.yardDetails.yardZip;geocoder.geocode({"address":address},function(results,status){if(status==="OK"){var marker=new google.maps.Marker({map:$scope.map,position:results[0].geometry.location,title:yardLocation.yardDetails.yardName,icon:Icon});google.maps.event.addListener(marker,"click",function(){self.$apply(function(){self.auction=yardLocation});openModal()});
$scope.markers.push(marker)}else;})};$(window).resize(function(){var h=$(window).height(),offsetTop=60;$(".map").css("height",h-offsetTop);if($(window).width()<992)$("body").removeClass("modal-open")}).resize();$scope.openInfoWindow=function(e,selectedMarker){e.preventDefault();google.maps.event.trigger(selectedMarker,"click")};self.selectedLane=function(auction,laneInfo){var auctionHostId=auction.auctionHostId?auction.auctionHostId:auction.yardNumber;self.laneSelected=auctionHostId+"-"+laneInfo.lane;
auction.lane=laneInfo.lane};self.redirectSaleList=function(auction){if(auction)return urlService.getSaleListResultUrl(auction)};self.getBrandForAuction=function(auction){if(auction&&auction.auctionsList[0])return auction.auctionsList[0].brand}}]);
app.controller("dashBoardController2",["$rootScope","$timeout","$scope","$http","$compile","$locale","dataServiceG2","copartUser","saveSearchCriteria","$location","siteCatalyst","auctionsCalendarService","$window","localStorageService",function($rootScope,$timeout,$scope,$http,$compile,$locale,dataServiceG2,copartUser,saveSearchCriteria,$location,siteCatalyst,auctionsCalendarService,$window,localStorageService){var self=$scope;var auctionsCountPromise=null;var isGlobal=appInit.appPlatform==="gbl";
self.liveAuctions=0;self.pwdDaysToExp=copartUser.getUserConfig().pwdDaysToExp;self.isMemberGoingTobeLapsed=copartUser.getUserConfig().isMemberGoingTobeLapsed;$scope.timeInMs=0;self.accountInfoVO={};self.membershipExpiresIn=copartUser.getUserConfig().membershipExpiresIn;self.membershipExpiringSoon=copartUser.getUserConfig().membershipExpiringSoon;self.membershipNotification="";self.txtSubscribed=copartUser.getUserConfig().txtSubscribed&&!localStorageService.cookie.get("textReminder");self.portletOrder=
self.userConfig.displayPref.dashBoardDisplayOrder;self.showBuyingPower=true;arrangePortlets();angular.element(document.querySelector("#placeholder")).empty();self.onSearch=function(criteria){angular.extend(saveSearchCriteria.data,JSON.parse(criteria));$location.url("/lotSearchResults?fromSavedSearch\x3dtrue\x26searchCriteria\x3d"+criteria)};self.formatStringDate=function(date){var saleDate=moment(date,"YYYYMMDD");return saleDate.format(copartUser.getUserConfig().dateFormat.toUpperCase())};self.updateSalesCount=
function(){dataServiceG2.updateAuctionCount(function(response){if(response){var payload=response.data.data[0];if(!_.isUndefined(payload)&&!_.isNull(payload)){self.liveAuctions=payload.length;auctionsCountPromise=$timeout(function(){self.updateSalesCount()},30*1E3)}}else;})};function arrangePortlets(){if(!_.isUndefined(self.portletOrder)&&!_.isNull(self.portletOrder)&&self.portletOrder.trim().length>0){if(self.portletOrder.indexOf('"')>=0)self.portletOrder=self.portletOrder.replace(/"/g,"");var colData=
self.portletOrder.split("|");_.each(colData,function(data){if(!_.isUndefined(data)&&!_.isNull(data)&&data.trim().length>0){var colId=data.split("\x3d")[0];var colData;if(colId==="sortable-1")colData=data.split("\x3d")[1]+",banner1";else colData="banner2,"+data.split("\x3d")[1];var orderedDivArray=colData.split(",");fillColumns(colId,orderedDivArray)}})}}function fillColumns(colId,colDivArray){var colElem=angular.element(document.querySelector("#"+colId));_.each(colDivArray,function(divId){if(!_.isUndefined(divId)&&
!_.isNull(divId)&&divId.trim().length>0)if(divId!="banner2")appendPortlets(colElem,divId);else appendPortlets(colElem.parent(),divId,true)})}function appendPortlets(colElem,divId,before){var portlet=angular.element(document.querySelector("#"+divId));if(before)colElem.prepend(portlet);else colElem.append(portlet);if(divId!="banner1"||divId!="banner2")$compile(portlet)($scope);portlet.css("display","block")}auctionsCalendarService.getAllAuctionData().then(function(data){var count=0;_.each(data.todayAuctions.liveAuctions,
function(auction){if(auction.laneInfoList!=null)count=count+auction.laneInfoList.length});self.liveAuctions=count});self.request={phoneNumber:"",phoneExtension:"",intlDialCode:"",countryAreaCd:"",isoTwoCharCntryCode:"",communicationId:""};self.mobilePhone=null;self.primaryPhone=null;self.secondaryPhone=null;self.textSubscriptionNO={phoneNumber:"",phoneExtension:"",intlDialCode:"",countryAreaCd:"",isoTwoCharCntryCode:"",communicationId:""};self.responseMessage=null;self.successMessage=null;self.chosenNumber=
null;self.intlDialCode=null;self.commId=null;self.processTextSubscription=function(status){if(status!="Unsubscribed")copartUser.getUserConfig().txtSubscribed=false;dataServiceG2.updateTextSubscriptions({status:status,emailSubscriptionName:"textCommunication"},function(){jQuery("#memberTextSubscriptionModal").modal("hide")})};self.errors={phoneNumber:false};self.remindLater=function(status){localStorageService.cookie.set("textReminder",true,7)};self.updateMobileNo=function(status){if(!jQuery(".showExisting").is(":checked")&&
!jQuery(".showUpdate").is(":checked")&&!jQuery(".noThanks").is(":checked")){self.responseMessage="Please choose a valid option";return}if(jQuery(".noThanks").is(":checked"))self.processTextSubscription("NO_THANKS");else{if(jQuery(".showExisting").is(":checked"))if(jQuery(".mobilecontact").is(":checked")){self.chosenNumber=self.mobilePhone.phoneNumber;self.intlDialCode=self.mobilePhone.intlDialCode}else if(jQuery(".primarycontact").is(":checked")){self.chosenNumber=self.primaryPhone.phoneNumber;self.intlDialCode=
self.primaryPhone.intlDialCode}else if(jQuery(".secondarycontact").is(":checked")){self.chosenNumber=self.secondaryPhone.phoneNumber;self.intlDialCode=self.secondaryPhone.intlDialCode}else{self.responseMessage="Please choose a valid option";return}if(jQuery(".showUpdate").is(":checked")){if(self.errors.phoneNumber)return;jQuery("input:radio[name\x3dtextContact]").prop("checked",false);self.chosenNumber=self.textSubscriptionNO.phoneNumber;self.intlDialCode=self.textSubscriptionNO.intlDialCode}self.request.phoneNumber=
self.chosenNumber;self.request.communicationId=self.commId;self.request.intlDialCode=self.intlDialCode;dataServiceG2.updateMobileNo(self.request,function(response){if(response.returnCode==-1)self.responseMessage="Not a valid mobile number. Please try a new one.";else{copartUser.getUserConfig().txtSubscribed=false;copartUser.setTextSubscribed(false);self.responseMessage=null;self.successMessage="Mobile number has been updated successfully!!!";jQuery("#memberTextSubscriptionModal").modal("hide")}})}};
self.isTextSubscription=function(){setTimeout(function(){jQuery("#memberTextSubscriptionModal").modal({backdrop:"static",keyboard:false});jQuery(".showExisting").click(function(){jQuery("#existingNumbers").css("display","block");jQuery("#newNumber").css("display","none");jQuery(".disclaimer-message").css("display","block")});jQuery(".showUpdate").click(function(){jQuery("input:radio[name\x3dtextContact]").prop("checked",false);jQuery("#existingNumbers").css("display","none");jQuery("#newNumber").css("display",
"block");jQuery(".disclaimer-message").css("display","block")});jQuery(".noThanks").click(function(){jQuery("#existingNumbers").css("display","none");jQuery("#newNumber").css("display","none");jQuery(".disclaimer-message").css("display","none")})},100);dataServiceG2.getContactInformation(function(response){if(response.mobilePhone){self.mobilePhone=response.mobilePhone;self.commId=response.mobilePhone.communicationId}if(response.primaryPhone)self.primaryPhone=response.primaryPhone;if(response.secondaryPhone)self.secondaryPhone=
response.secondaryPhone})};self.init=function(){if(self.membershipExpiringSoon)self.membershipNotification=self.membershipExpiresIn==0?self.locale.messages["membership.renewal.expiringtoday"]:self.locale.getMessage("membership.renewal.expirymsg",self.membershipExpiresIn).toString();if($location.search().upgraded!=null&&$location.search().upgraded=="yes")siteCatalyst.callUpgradeMember($location.search().upgraded);var dragStart,itemOffset;$(".connectedSortable").sortable({connectWith:".connectedSortable",
opacity:"0.9",containment:$("#drag"),helper:"clone",revert:1E3,start:function(e,ui){console.log("start drag..",ui.placeholder);ui.placeholder.height(ui.item.height());dragStart=setInterval(function(){itemOffset=ui.item.offset().top>ui.placeholder.offset().top?ui.item.offset().top-ui.placeholder.offset().top:ui.placeholder.offset().top-ui.item.offset().top;console.log("226::",ui.item.position(),ui.placeholder.position())},100)},stop:function(event,ui){clearInterval(dragStart);if(itemOffset>600)$(this).sortable("cancel");
$(ui.item).find("h5").click();var sortorder="";$(".connectedSortable").each(function(){var itemorder=$(this).sortable("toArray");var columnId=$(this).attr("id");sortorder+=columnId+"\x3d"+itemorder.toString()+"|"});self.portletOrder=sortorder;_.debounce(saveDashboardLayout(),5E3,false)}}).disableSelection();function saveDashboardLayout(){$.ajax({type:"POST",dataType:"json",contentType:"application/json; charset\x3dutf-8",url:"/data/custDashDisplayOrder",data:JSON.stringify({"dashBoardDisplayOrder":JSON.stringify(self.portletOrder)}),
success:function(result){if(result&&result.returnCode===1)console.log("portlet order saved !")},error:function(){}})}setInterval(function(){$("#sortable-1").find(".dropdiv_table").removeClass("rightdivDroparea");$("#sortable-2").find(".dropdiv_table").addClass("rightdivDroparea")},100);$(".connectedSortable").mousedown(function(){$("body").css({"overflow":"inherit","overflow-x":"inherit"})});$(".connectedSortable").mouseup(function(){$("body").css({"overflow":"auto","overflow-x":"hidden"})});$("#static_img1").mousedown(function(e){e.preventDefault();
e.stopPropagation();return false})};self.closeAlert=function(index){self.membershipNotification=""};self.init();$scope.$on("$destroy",function(){if(auctionsCountPromise)$timeout.cancel(auctionsCountPromise)});self.openChangePasswordModal=function(){self.errorDesc="";jQuery("#memberModal").modal("show")};self.cancelChangePassword=function(){jQuery("#memberModal").modal("hide")};self.openLicenseUploadModal=function(){jQuery("#liceseuploadmodal").modal("show")};var resetForm=function(form){self.accountInfoVO=
{};form.$setPristine();form.$setUntouched()};self.changePassword=function(){dataServiceG2.changePassword(self.accountInfoVO,function(response){var responseCode=response.data.data.errorMsg;var responseCodeDesc=response.data.returnCodeDesc;if(responseCode!=null&&responseCode.trim()!=""&&responseCodeDesc!=null&&responseCodeDesc.trim()!="Success"){self.isError=true;var temp=self.locale.getMessage("app.error.label."+responseCode.trim())?self.locale.getMessage("app.error.label."+responseCode.trim()):self.locale.getMessage("app.accountinformation.error.errorcode.default");
if(temp!=null&&temp!="")self.errorDesc=temp;else self.errorDesc="Unknown Error"}else{self.isError=false;self.errorDesc=self.locale.getMessage("app.accountinformation.error.errorcode.chgPwd.SUCCESS");resetForm(self.changePwdForm);jQuery("#memberModal").removeClass("fade").modal("hide");$window.location.href="/dashboard"}})}}]);
app.controller("timeModalController",["$scope","userService",function($scope,userService){$scope.popupToggle=false;$scope.popupTimezone=false;$scope.showFlag=false;$scope.showInventory=false;angular.element("body").click(function(e){var elementClicked=$(e.target).parents("#languagehome");var timezoneClicked=$(e.target).parents("#timezonehome");var lagnZoneClicked=$(e.target).parents("#lang");var inventoryClicked=$(e.target).parents("#inventorydiv");if($scope.popupToggle){if(elementClicked.length>
0||$(e.target).hasClass("langformat_div"))$scope.popupToggle=true;else $scope.popupToggle=false;$scope.$apply()}if($scope.popupTimezone){if(timezoneClicked.length>0||$(e.target).hasClass("maintimezone_div"))$scope.popupTimezone=true;else $scope.popupTimezone=false;$scope.$apply()}if($scope.showFlag){if(lagnZoneClicked.length>0||$(e.target).hasClass("langSelectText"))$scope.showFlag=true;else $scope.showFlag=false;$scope.$apply()}if($scope.showInventory){if(elementClicked.length>0)$scope.showInventory=
true;else $scope.showInventory=false;$scope.$apply()}});$scope.togglePopup=function(e){e.stopPropagation();console.log(userService.userConfig.selectedLang);$scope.selectedLang=userService.userConfig.selectedLang;angular.element("#languagehome").css("display","block");$scope.popupToggle=!$scope.popupToggle;if($scope.popupTimezone||$scope.showFlag||$scope.showInventory){$scope.popupTimezone=false;$scope.showFlag=false;$scope.showInventory=false}};$scope.timePopup=function(e){e.stopPropagation();angular.element("#timezonehome").css("display",
"block");$scope.popupTimezone=!$scope.popupTimezone;if($scope.popupToggle||$scope.showFlag||$scope.showInventory){$scope.popupToggle=false;$scope.showFlag=false;$scope.showInventory=false}};$scope.showFlagDrop=function(e){e.stopPropagation();angular.element("#lang").css("display","block");$scope.showFlag=!$scope.showFlag;if($scope.popupTimezone||$scope.popupToggle||$scope.showInventory){$scope.popupTimezone=false;$scope.popupToggle=false;$scope.showInventory=false}};$scope.showInventorypopup=function(e){e.stopPropagation();
$scope.showInventory=!$scope.showInventory;if($scope.popupTimezone||$scope.popupToggle||$scope.showFlag){$scope.popupTimezone=false;$scope.popupToggle=false;$scope.showFlag=false}}}]);
app.controller("salesListController",["$scope","$compile","metaDataService",function($scope,$compile,metaDataService){var self=$scope;self.showLaneHighlights=function($event,saleHighlights){jQuery("#seeMore").modal("show").find(".modal-body").html(saleHighlights)};window.compileSalesList=function($el){var retn=$compile($el)($scope);self.$digest()};jQuery("#multiSelectSales :checkbox").change(function(){var list=[];jQuery("#multiSelectSales").find("input[type\x3d'checkbox']:checked").each(function(){list.push(jQuery(this).val())});
var combinedString=list.join("|");var filteredData=jQuery("#clientSideDataTable").DataTable().column(".saleTypeCol").search(combinedString,true,false).draw()});if(window.appInit.isUserAgentBOT)$("#clientSideDataTable \x3e tbody \x3e tr:first,tr:nth-child(2)").each(function(){metaDataService.prepareSEOAddrSalesList($(this).find(".saleslistSaletimeval").text(),$(this).find(".saleslistLocationval").text(),$(this).find("td.saleslistCurrentsaleval \x3e a").text(),$(this).find("td.saleslistNextsaleval \x3e a").text(),
$(this).find(".yardNumber").text(),$(this).find("td.saleslistCurrentsaleval").attr("isLiveAuction"),self.$parent.locale)})}]);
app.controller("paymentHistoryController",["$scope","$http","$location","$compile","$filter","$timeout","dataServiceG2","backToLinkService","saveLotNumbersService","paymentService","copartUser","localStorageService","History","dataTableConfig","userService",function($scope,$http,$location,$compile,$filter,$timeout,dataServiceG2,backToLinkService,saveLotNumbersService,paymentService,copartUser,localStorageService,History,dataTableConfig,userService){var self=$scope;var table=new ServersideDatatable_DB(saveLotNumbersService,
dataTableConfig);self.query=$location.search().query;self.searchText=self.query;var initBidderList=[{bidderNumber:0,displayName:"ALL"}];self.filterForm={};self.filterForm.bidder=initBidderList[0];if(_.isUndefined(self.query)||_.isNull(self.query)||self.query=="")self.query="*";self.locale=$scope.$parent.locale;self.noOfDays="30";self.siteCode=copartUser.getUserConfig().siteCode;self.selectedCurrency=copartUser.getUserConfig().currencyCode;self.unSelectedCurrency=copartUser.getUserConfig().secondaryCurrencyCode;
self.email=copartUser.getUserConfig().memberContactInfo.email;var selectedTimezone=copartUser.getUserConfig().selectedTimezone;var date=moment().tz(selectedTimezone).format("YYYY MMMM DD");self.exportFileName="PaymentsHistory_"+date+".csv";var refreshBidders=true;self.emailInvoiceStatus=[];self.transporterEmail="";self.emailTransporterMessage=null;self.emailErrorMessage=null;self.showMemberPickupStatus=copartUser.getUserConfig().defaultDisplayPref.showMemberPickupStatus||false;self.emailPDFInvoice=
function(emailInvoiceParam){emailInvoiceParam.emailAddress=self.email;dataServiceG2.emailInvoice(emailInvoiceParam,callBack=function(result){self.emailConfirmMessage=true;self.emailSend=result.returnCode==1?true:false;self.emailError=!self.emailSend},"/data/emailInvoice/pdf")};$("#emailInvoice").on("hidden.bs.modal",function(){self.emailConfirmMessage=false;self.$apply()});var saleReceipt="Sale Receipt";self.yardDetails={};self.images={};self.selectedBidderNum="0";self.paymentType="P";self.fromPaymentHistory=
true;self.showBidderColumn=false;self.backToLink=$location.url();self.saleTypeList=[];self.saleTypeSelected={};backToLinkService.setBackToLink(self.backToLink);backToLinkService.setBackToLinkText("payment.history.back.history");var defualtDateFormat=self.userConfig.displayPref.dateFormat.toUpperCase();var getBidderPaymentCounts=function(){dataServiceG2.getBidderPaymentCounts(function(responseData){self.bidderList=_.map(responseData,function(bidderInvoices){return{bidderId:bidderInvoices[0].bn,bidderName:bidderInvoices[0].bna,
invoiceCount:bidderInvoices.length,displayName:bidderInvoices[0].bn+"-"+bidderInvoices[0].bna+"("+bidderInvoices.length+")"}});self.bidderList=_.union(initBidderList,self.bidderList);self.filterForm.bidder=self.bidderList[0];jQuery("#paymentHistoryDataTable").DataTable().state.save()})};var getSaleTypes=function(){dataServiceG2.getPaymentSaleTypes(function(responseData){self.saleTypeList=responseData})};function checkIfFromDetails(){try{var lastRoute=History.lastRoute;if(lastRoute&&(lastRoute.indexOf("lot/")==
0||lastRoute.indexOf("invoiceDetails/")==0))return true;else return false}catch(e){return false}}var state=false;var stateRestoreFromAnywhere=localStorageService.get("restore-search-state-from-anywhere");localStorageService.remove("restore-search-state-from-anywhere");if(checkIfFromDetails()||$location.search().state=="restore"||stateRestoreFromAnywhere){state=localStorageService.get("restore-search-state");localStorageService.remove("restore-search-state");self.viewedLot=localStorageService.get("viewed-lot");
localStorageService.remove("viewed-lot")}saveLotNumbersService.clearAll();self.showRecords=[{desc:"Last 30 days",code:"30"},{desc:"Last 60 days",code:"60"},{desc:"Last 90 days",code:"90"},{desc:"90-180 days ago",code:"180"},{desc:"180 - 365 days ago",code:"365"}];self.swapCurrency=function(){self.unSelectedCurrency=[self.selectedCurrency,self.selectedCurrency=self.unSelectedCurrency][0];self.reloadPaymentTable(self.selectedBidderNum)};if(_.contains(self.userConfig.roles,"ROLE_BROKER"))self.showBidderColumn=
true;self.showSaleReciptColumn=false;if(self.userConfig.companyCode=="COPARTUK")self.showSaleReciptColumn=true;self.reloadPaymentTable=function(bidder){self.selectedBidderNum=bidder;var temptable=jQuery("#paymentHistoryDataTable").DataTable();if(!self.selectedBidderNum){temptable.ajax.url("/data/payments/history/0/"+self.selectedCurrency+"/"+self.noOfDays).load();self.selectedBidderNum=0}else temptable.ajax.url("/data/payments/history/"+self.selectedBidderNum+"/"+self.selectedCurrency+"/"+self.noOfDays).load()};
var dataTableOptions={"pageLength":20,"columnDefs":[{"targets":[0,1,2,3,4,5,6,7,8,9,10,11,12,13],"data":null,"defaultContent":""},{"targets":[0],"orderable":false},{"targets":["bidderId"],"visible":self.showBidderColumn,"searchable":false},{"targets":["saleReceipt"],"visible":self.showSaleReciptColumn,"searchable":false},{className:"control",orderable:false,targets:-1}],"lengthMenu":[[20,25,50,100],[20,25,50,100]],"stateSave":state,"stateRetrieveFunction":function(data){self.noOfDays=data.noOfDays;
self.selectedBidderNum=data.selectedBidderNum;self.selectedCurrency=data.selectedCurrency;if(self.selectedCurrency=="CAD")self.unSelectedCurrency="USD";else if(self.selectedCurrency=="USD")self.unSelectedCurrency="CAD";self.hideImagesFlag=data.hideImagesFlag;self.bidderList=data.bidderList;self.filterForm.bidder=_.find(self.bidderList,function(bidder){return bidder.bidderId==self.selectedBidderNum});console.log(self.filterForm.bidder);refreshBidders=false;self.reloadPaymentTable(self.selectedBidderNum)},
"url":"/data/payments/history/"+self.selectedBidderNum+"/"+self.selectedCurrency+"/"+self.noOfDays,"containsFilters":false,"bPaginate":true,"backToTop":false,"pagingType":"full_numbers","fnRowCallback":function(nRow,aData,iDisplayIndex){jQuery(".nowrap",nRow).attr("nowrap","nowrap");return nRow},"columns":[{"mData":"imgp","sClass":"compile","name":"imagePath","render":function(data,type,row,meta){var imgLink=row["imgp"];var brand=row["brand"];if(row["imgp"]&&row["imgp"].trim()!=""&&row["ln"]>0){var link;
link="\x3ca class\x3d'imgpath cursor-pointer' lot-id\x3d'"+row["ln"]+"' lot-desc\x3d'"+row["id"]+"' images\x3d'images' "+"hide-watch-btn\x3dtrue modal-image-viewer check-yard-exist\x3dtrue yard-number\x3d'"+row.yn+"'\x3e"+"\x3cspan class\x3d'searchiconbtn'\x3e\x3c/span\x3e\x3cimg alt\x3d'image' height\x3d'72' width\x3d'96' class\x3d'img-icon' src\x3d'"+row["imgp"]+"'  o-data-src\x3d '"+imgLink+"'error-image\x3d'/images/testImages/no_photo.jpg'\x3e\x3c/a\x3e\x3cbr\x3e";link+="\x3cdiv class\x3d'viewallphotos'\x3e\x3ca viewPhotos\x3d'true' ng-click\x3d\"navigateToLotDetails("+
row["yn"]+",'"+row.ln+"','"+brand+"',$event)\" class\x3d'image_viewer_link'  data-lotDesc\x3d'"+row["ln"]+"' data-lot\x3d'"+row["ln"]+"'\x3e"+self.locale.messages["counterman.searchResults.viewAllPhotos.label"]+"\x3c/a\x3e\x3c/div\x3e";return link}else return"\x3cimg alt\x3d'image' height\x3d'72' width\x3d'96' class\x3d'' src\x3d '/images/testImages/no_photo.jpg'\x3e\x3c/a\x3e"}},{"mData":"ind","render":function(data,type,row){var invoiceDate=moment(row["ind"].dateAsInt,"YYYYMMDD");return invoiceDate.format(defualtDateFormat)}},
{"mData":"bn"},{"mData":"itn","render":function(data,type,row){if(row["itn"]>0)return row["itn"];else return""}},{"mData":"ln","render":function(data,type,row,meta){if(row["ln"]==row["in"]){var lotId=row["ln"];var brand=row["brand"];if(self.viewedLot&&self.viewedLot==lotId){self.viewedRowIndex=meta.row;console.log("paymentsHistory");self.viewedLot=null}return"\x3ca ng-href\x3d'' ng-click\x3d\"navigateToLotDetails("+row["yn"]+",'"+lotId+"','"+brand+"',$event)\"\x3e"+row["ln"]+"\x3c/a\x3e"}else if(row["in"]>
0)return row["in"];else return""}},{"mData":"ly","render":function(data,type,row){if(row["ly"]>0)return row["ly"];else return""}},{"mData":"lm"},{"mData":"lom"},{"mData":"yna","render":function(data,type,row){var html="";if(row["yn"]==655||row["yn"]==700||row["yn"]==400)html=row["yna"];else html='\x3ca class\x3d"cursor-pointer" ng-href\x3d"" ng-click\x3d\'navigateToLocationDetails('+row["yn"]+")'\x3e"+row["yna"]+"\x3c/a\x3e";return html}},{"mData":"st","render":function(data,type,row){if(!_.isEmpty(row["lori"]))if(row["lori"].trim()==
"INVOICE")return"";else return row["st"];else return""}},{"mData":"id","render":function(data,type,row){var lotId=row["ln"];var brand=row["brand"];if(row["ln"]==row["in"])return"\x3ca ng-href\x3d'' ng-click\x3d\"navigateToLotDetails("+row["yn"]+",'"+lotId+"','"+brand+"',$event)\"\x3e"+row["id"]+"\x3c/a\x3e";else if(row["in"]>0)return row["id"];else return""}},{"mData":"lly","render":function(data,type,row){if(row["lly"]==0||row["lly"]=="")return"-";else{var leftYardDate=moment(row["lly"],"YYYYMMDD");
return leftYardDate.format(defualtDateFormat)}}},{"mData":"dp","render":function(data,type,row){var datePaid=moment(row["dp"].dateAsInt,"YYYYMMDD");return datePaid.format(defualtDateFormat)}},{"mData":"ia","render":function(data,type,row){var invoiceAmount=$filter("globalize_currency_using_code")(data,row["cc"],2);var invType=row["ln"]>0?"L":"M";var invoiceNumber=row["in"]==0?row["ln"]:row["in"];var invoiceURL="";if(row["pdf"]==true){var payType="P";var lotNumber=row["ln"]>0?row["ln"]:null;var isLotLeftYard=
row["lly"]==0||row["lly"]=="";invoiceURL+='\x3cspan\x3e\x3ca target\x3d"_blank" ng-href\x3d"/invoice/pdf?invoiceNumber\x3d'+invoiceNumber+"\x26paymentType\x3d"+payType+"\x26currencyCode\x3d"+row["cc"].trim()+"\x26invoiceType\x3d"+invType+"\x26lotNumber\x3d"+row["ln"]+"\x26outputType\x3dD"+"\x26secretId\x3d"+row["secretId"]+"\x26bidderNumber\x3d"+row["bn"]+' "\x3e'+invoiceAmount+"\x3c/a\x3e\x3c/span\x3e\x3cbr/\x3e"+'\x3cspan\x3e\x3ca ng-click\x3d"emailInvoiceCall('+invoiceNumber+",'"+row["secretId"]+
"','"+payType+"','"+row["cc"].trim()+"','"+invType+"',"+row["ln"]+","+row["bn"]+')" data-toggle\x3d"modal"\x3e{{locale.messages["paymentdue.label.email.invoice"]}}\x3c/a\x3e\x3c/span\x3e'+"\x3cbr/\x3e\x3cspan ng-if\x3d"+isLotLeftYard+"\x3e\x3c/span\x3e"}else if(row["iba"]&&self.userConfig.companyCode=="COPARTUK"&&row["lly"]!=0)invoiceURL='\x3ca href\x3d"./invoiceDetails/'+row["in"]+"/"+self.paymentType+"/"+row["cc"]+"/"+invType+"/"+row["ln"]+"/"+row["secretId"]+"/"+row["bn"]+'"\x3e'+invoiceAmount+
"\x3c/a\x3e";else if(row["iba"]&&self.userConfig.companyCode=="COPART")invoiceURL='\x3ca href\x3d"./invoiceDetails/'+row["in"]+"/"+self.paymentType+"/"+AppUtils.trimToNull(row["cc"])+"/"+invType+"/"+row["ln"]+"/"+row["secretId"]+"/"+row["bn"]+'"\x3e'+invoiceAmount+"\x3c/a\x3e\x3cbr/\x3e";else invoiceURL=invoiceAmount+"\x3cbr/\x3e";return invoiceURL}},{"mData":"vin","render":function(data,type,row){var vin=$filter("redactFilter")(row["vin"],"limitVIN");return vin}},{"mData":"in","render":function(data,
type,row){var invoiceNumber=row["in"]==0?row["ln"]:row["in"];var invType=row["ln"]>0?"L":"M";var invoiceURL="";var hazardousDocNotSubmitted=row["hd"];if(row["saleReceiptPDF"]==true){invoiceURL+='\x3cspan\x3e\x3ca target\x3d"_blank" ng-href\x3d"/invoice/pdf?invoiceNumber\x3d'+invoiceNumber+"\x26paymentType\x3dP\x26currencyCode\x3d"+row["cc"].trim()+"\x26invoiceType\x3dRECEIPT"+"\x26lotNumber\x3d"+row["ln"]+"\x26outputType\x3dD"+"\x26bidderNumber\x3d"+row["bn"]+"\x26secretId\x3d"+row["secretId"]+' "\x3e'+
"Sale Receipt"+"\x3c/a\x3e\x3c/span\x3e\x3cbr/\x3e"+'\x3cspan\x3e\x3ca ng-click\x3d"emailInvoiceCall('+invoiceNumber+",'"+row["secretId"]+"','"+"P"+"','"+row["cc"].trim()+"','"+invType+"',"+row["ln"]+","+row["bn"]+')" data-toggle\x3d"modal"\x3e{{locale.messages["paymentdue.label.email.invoice"]}}\x3c/a\x3e\x3c/span\x3e';return invoiceURL}else return'\x3ca href\x3d"./invoiceDetails/'+row["in"]+"/"+self.paymentType+"/"+row["cc"]+"/RECEIPT/"+row["ln"]+"\x26secretId\x3d"+row["secretId"]+'"\x3e'+saleReceipt+
"\x3c/a\x3e"}},{"mData":"buyerPickupStatus","visible":self.showMemberPickupStatus,"render":function(data,type,row){return paymentService.buildMemberPickUpStatus(row,row["yna"],row["ln"])}},{"mData":"","render":function(data,type,row){return""}}],"language":{"paginate":{"first":self.locale.messages["app.label.first"],"previous":self.locale.messages["app.label.previous"],"next":self.locale.messages["app.label.next"],"last":self.locale.messages["app.label.last"]},"lengthMenu":self.locale.messages["app.label.show"]+
" _MENU_ "+self.locale.messages["app.label.entries"],"info":self.locale.messages["app.label.showing"]+" _START_ "+self.locale.messages["app.label.to"]+" _END_ "+self.locale.messages["app.label.of"]+" _TOTAL_ "+self.locale.messages["app.label.entries"],"infoFiltered":"("+self.locale.messages["app.label.filteredFrom"]+" _MAX_ "+self.locale.messages["app.label.totalEntries"]+")","searchPlaceholder":self.locale.getMessage("app.label.searchListPlaceholder"),"search":self.locale.getMessage("app.label.search")+
":"}};var datatable=table.initServerSideDataTable("#paymentHistoryDataTable",dataTableOptions,function(){self.setTotalInvoices();self.compileDom("#paymentHistoryDataTable");$(window).trigger("scrollToPoint");if(refreshBidders)getBidderPaymentCounts();getSaleTypes();$timeout(function(){if(self.viewedRowIndex||self.viewedRowIndex==0){jQuery("#paymentHistoryDataTable"+" tbody tr").eq(self.viewedRowIndex).addClass("bold fs12");self.viewedRowIndex=null}},0)});datatable.on("stateSaveParams.dt",function(e,
settings,data){data.noOfDays=self.noOfDays;data.noOfDays=self.noOfDays;data.selectedBidderNum=self.selectedBidderNum;data.bidder=self.filterForm.bidder;data.selectedCurrency=self.selectedCurrency;data.hideImagesFlag=self.hideImagesFlag;data.bidderList=self.bidderList});self.compileDom=function(table){var $dest=jQuery(table).find("tbody");var retn=$compile($dest)($scope);self.$apply()};self.setRefreshBiddersFlag=function(flag){refreshBidders=flag};table.overrideDefaults=function(data){var filterJSONString=
{filters:[]};if(Object.keys(self.saleTypeSelected).length){var list=[];var check=true;angular.forEach(self.saleTypeSelected,function(value,key){if(key=="All"&&value)check=false;else if(value&&check)list.push(key.replace(/\s+/g,""))});if(check&&list.length>0){var jsonData={};jsonData.filterBy="saleType";jsonData.filterValue=list;filterJSONString.filters.push(jsonData)}}data.filterCriteria=JSON.stringify(filterJSONString)};self.setTotalInvoices=function(){self.totalInvoices=0;var table=jQuery("#paymentHistoryDataTable").DataTable();
self.totalInvoices=table.data().count()};self.hideImages=function(){var ttable=jQuery("#paymentHistoryDataTable").DataTable();var column=ttable.column(0);column.visible(!column.visible());var temptable=jQuery("#paymentHistoryDataTable").DataTable();if(!self.selectedBidderNum){temptable.ajax.url("/data/payments/history/0/"+self.selectedCurrency+"/"+self.noOfDays).load();self.selectedBidderNum=0}else temptable.ajax.url("/data/payments/history/"+self.selectedBidderNum+"/"+self.selectedCurrency+"/"+self.noOfDays).load()};
function storeNavigationInfo(){var info={backTo:"."+$location.url()};localStorageService.set("lot-navigation-info",info);localStorageService.set("restore-search-state",true)}self.navigateToLotDetails=paymentService.navigateToLotDetails;self.navigateToLocationDetails=paymentService.navigateToLocationDetails;self.hazardousWasteNotePopup=function(){$("#hazardousWasteNote").modal("show")};self.emailInvoiceCall=function(invoiceNumber,secretId,payType,currency,invType,lotNumber,bidderNumber){self.emailInvoiceParam=
{};self.emailInvoiceParam.invoiceNumber=invoiceNumber;self.emailInvoiceParam.paymentType=payType;self.emailInvoiceParam.currencyCode=currency;self.emailInvoiceParam.invoiceType=invType;self.emailInvoiceParam.lotNumber=lotNumber;self.emailInvoiceParam.bidderNumber=bidderNumber;self.emailInvoiceParam.secretId=secretId;$("#emailInvoice").modal("show")};self.print=function(selector){jQuery(selector).css({display:"block",height:"auto",width:"auto",top:"0",left:"0",position:"absolute"}).print()};self.openEmailGatePassToTransporterModal=
function(lotNumber,existingTransporterEmail){self.emailErrorMessage="";self.emailGatePassParam={};self.emailGatePassParam.lotNumber=lotNumber;self.transporterEmail=existingTransporterEmail;self.isOffSiteLot=false;if(_.isEmpty(self.transporterEmail))paymentService.getOffSiteLot(lotNumber).then(function(response){self.isOffSiteLot=response;$("#emailGatePassToTransporter").modal("show")});else $("#emailGatePassToTransporter").modal("show")};self.emailGatePassToTransporter=function(emailGatePassToTransporterForm){if(emailGatePassToTransporterForm.$valid){$("#emailGatePassToTransporter").modal("hide");
self.submitted=true;var emailGatePassVO={};emailGatePassVO.email=self.transporterEmail;emailGatePassVO.lot_numbers=[self.emailGatePassParam.lotNumber];dataServiceG2.sendGatePassToTransporter(emailGatePassVO,function(response){if(response.returnCode!=-1&&!_.isEmpty(response.data)){if(!_.isEmpty(response.data.status)&&response.data.status=="success"){self.emailTransporterMessage=self.locale.messages["app.label.sendGassPassToTransporter.msg.success"];$("#emailGatePassToTransporterSuccess").modal("show");
copartOmnitureCallMulti("doTagSendToTransporter",[userService.userConfig.buyerNumber])}}else if(response.returnCode==-1){self.emailTransporterMessage=response.data.errorObject.errorMessage+" "+self.locale.messages["app.label.sendGassPassToTransporter.msg.error"];$("#emailGatePassToTransporterFailure").modal("show")}else{self.emailTransporterMessage=self.locale.messages["app.label.sendGassPassToTransporter.msg.error"];$("#emailGatePassToTransporterFailure").modal("show")}},function(error){log.error("send Gatepass to Transporter Call -\x3e Failed "+
error)})}else self.emailErrorMessage=self.locale.messages["app.error.invalid.email"]};self.openCancelTransporterModal=function(lotNumber,existingTransporterEmail){self.CancelTransporterLot=lotNumber;self.transporterEmail=existingTransporterEmail;$("#cancelTransporter").modal("show")};self.cancelTransporter=function(){$("#cancelTransporter").modal("hide");self.submitted=true;var cancelTransporterVO={};cancelTransporterVO.lot_numbers=[self.CancelTransporterLot];dataServiceG2.cancelTransporter(self.CancelTransporterLot,
function(response){if(response.returnCode!=-1&&!_.isEmpty(response.data)){if(!_.isEmpty(response.data.status)&&response.data.status=="success"){self.cancelTransporterMessage=self.locale.getMessage("app.label.sendGassPassToTransporter.cancel.success",self.transporterEmail);$("#cancelTransporterSuccess").modal("show");copartOmnitureCallMulti("doTagCancelTransporter",[userService.userConfig.buyerNumber])}}else if(response.returnCode==-1){self.cancelTransporterMessage=response.data.errorObject.errorMessage+
" "+self.locale.messages["app.label.cancelTransporter.msg.error"];$("#cancelTransporterFailure").modal("show")}else{self.cancelTransporterMessage=self.locale.messages["app.label.cancelTransporter.msg.error"];$("#cancelTransporterFailure").modal("show")}},function(error){log.error("cancel Transporter Call -\x3e Failed "+error)})};self.openBuyerPickupStatusDetailsModal=function(lotNumber){var statusDetailsTable=$("#buyerPickupStatusDetailsTable").DataTable({"responsive":true,"ajax":{"type":"GET","url":"/data/buyerPickup/status/details/"+
lotNumber,"dataSrc":function(response){if(response.returnCode!=-1&&!_.isEmpty(response.data))return response.data.data}},"destroy":true,"filter":false,"info":false,"ordering":false,"stateSave":false,"paging":false,"cache":false,"deferRender":true,"columns":[{"data":"updated_at","render":function(data,type,row){return moment.utc(data).tz(userService.userConfig.selectedTimezone).format("YYYY-MM-DD hh:mm:ss a")}},{"data":"event_name"},{"data":"event_notes"}]});$("#buyerPickupStatusDetails").modal("show")}}]);
"use strict";
function ServersideDatatable_DB(saveLotNumbersService,dataTableConfig,locale){var self=this;self.selectedFilters=[];var MydataTableOptions;self.oPostData={};self.table=null;self.id="";self.staticFilteFormId="";self.detailsCookieName="toDetailServerSideCookie";self.cookieNameSuffix="cprt";self.log=new Logger({name:"ServerSide Datatable",level:"debug"});self.dataTableOptions;self.locale=locale;self.initServerSideDataTable=function(elementId,dataTableOptions,callback){self.id=elementId;dataTableOptions=
dataTableOptions?dataTableOptions:"{}";self.dataTableOptions=dataTableOptions;MydataTableOptions={"bProcessing":true,"responsive":{details:{type:"column",target:-1,renderer:function(api,rowIdx,columns){var data=$.map(columns,function(col,i){return col.hidden?'\x3cli data-dt-row\x3d"'+col.rowIndex+'" data-dt-column\x3d"'+col.columnIndex+'"\x3e'+'\x3cspan\x3e\x3cspan class\x3d"bold" data-uname\x3d"saleslistRegion"\x3e'+col.title+": "+'\x3c/span\x3e\x3cspan class\x3d"dtr-data"\x3e'+col.data+"\x3c/span\x3e\x3c/span\x3e"+
"\x3c/li\x3e":""}).join("");return data?$("\x3cul/\x3e").append(data):false}}},"autoWidth":dataTableOptions.recalculateTableWidth?false:true,"bSortClasses":!dataTableOptions.highlightColumn==false?false:true,"bServerSide":true,"jQueryUI":dataTableOptions.jQueryUI?dataTableOptions.jQueryUI:false,"columnDefs":dataTableOptions.columnDefs,"bFilter":dataTableOptions.bFilter==false?false:true,"bStateSave":true,"bPaginate":dataTableOptions.bPaginate==false?false:true,"stateLoadParams":function(oSettings,
oData){if(dataTableOptions.stateSave){dataTableOptions.stateRetrieveFunction(oData);return true}else return false},"searching":dataTableOptions.searching,"iDisplayLength":dataTableOptions.pageLength?dataTableOptions.pageLength:"10","lengthMenu":dataTableOptions.lengthMenu?dataTableOptions.lengthMenu:[[10,25,50,100],[10,25,50,100]],"iDisplayStart":0,"deferLoading":dataTableOptions.deferLoading>=0?dataTableOptions.deferLoading:null,"order":dataTableOptions.order?dataTableOptions.order:[],"language":{"processing":"\x3cimg src\x3d'/images/icons/loader.gif'style\x3d'z-index:100000;'\x3e",
"emptyTable":dataTableOptions.noResultMessage?dataTableOptions.noResultMessage:"No matching records found","infoEmpty":dataTableOptions.noResultInfoMessage?dataTableOptions.noResultInfoMessage:"Showing 0 to 0 of 0 entries","searchPlaceholder":dataTableOptions.language.searchPlaceholder?dataTableOptions.language.searchPlaceholder:"Search this list","search":dataTableOptions.language.search?dataTableOptions.language.search:"Search :","zeroRecords":dataTableOptions.noResultMessage?dataTableOptions.noResultMessage:
"No matching records found","paginate":{"first":dataTableOptions.language.paginate.first?dataTableOptions.language.paginate.first:"First","previous":dataTableOptions.language.paginate.previous?dataTableOptions.language.paginate.previous:"Previous","next":dataTableOptions.language.paginate.next?dataTableOptions.language.paginate.next:"Next","last":dataTableOptions.language.paginate.last?dataTableOptions.language.paginate.last:"Last"},"lengthMenu":dataTableOptions.language.lengthMenu?dataTableOptions.language.lengthMenu:
"Show _MENU_ entries","info":dataTableOptions.language.info?dataTableOptions.language.info:"Showing _START_ to _END_ of _TOTAL_ entries","infoFiltered":""},"ajax":{"url":dataTableOptions.url,"type":"POST","data":function(data){if(data.order[0]){data.sortOrder=data.order[0].dir;data.sortByColumnIndex=data.order[0].column;data.sortByColumn=data.columns[data.order[0].column].data}data.freshRequired=self.oPostData["REFRESH"];data.filterCriteria=dataTableOptions.containsFilters==true?dataTableOptions.customFilterCriteria?
dataTableOptions.customFilterCriteria:getFilterCriteria():"";data.readCriteriaFromSession=loadSaveState()==true?"Y":"N";data.searchText=data.search.value;if(typeof self.overrideDefaults=="function")self.overrideDefaults(data)},"error":function(jqXHR,status,errorThrown){if(jqXHR.status===499)alert(self.locale?self.locale.messages["app.label.lot.searchUnavailable"]:"Search temporarily unavailable. Please check back in a few moments.");if(jqXHR.responseText.indexOf("SessionExpiredLogin")>=0)jQuery("#sessionExpiredModal").modal({backdrop:"static",
keyboard:false});else{jQuery("#errorOccuredModal").modal({backdrop:"static",keyboard:false});self.log.error("Data table error:{} status:{}",errorThrown,status)}}},"fnInitComplete":function(oSettings,json){initSessionAndErrorDialogs();if(dataTableOptions.containsFilters)fetchFiltersData();if(dataTableOptions.containsStaticFilter)getStaticFiltersFromCookie();$(".dataTables_filter input").bind("input",function(e){this.value=this.value.replace(/[^a-z0-9-*\s]/gi,"")}).focus(function(e){e.target.placeholder=
""}).blur(function(e){e.target.placeholder=dataTableOptions.language.searchPlaceholder||"Search this list"})},"fnDrawCallback":function(o){if(callback)callback();var backToTop=dataTableOptions.backToTop==false?dataTableOptions.backToTop:true;if(backToTop){var oldStart=1;if(o._iDisplayStart!=oldStart){var targetOffset=jQuery(self.id).offset().top-300;jQuery("html,body").animate({scrollTop:targetOffset},500);oldStart=o._iDisplayStart}}},"aoColumns":dataTableOptions.columns,"fnRowCallback":dataTableOptions.fnRowCallback?
dataTableOptions.fnRowCallback:null};if(dataTableConfig){var config=dataTableConfig.getConfig();if(config.dom)MydataTableOptions.dom=config.dom;if(config.pagingType)MydataTableOptions.pagingType=config.pagingType}self.table=jQuery(self.id).on("xhr.dt",function(e,settings,json,xhr){if(json!=null&&!_.isEmpty(saveLotNumbersService))saveLotNumbersService.clearAll()}).on("processing.dt",function(e,settings,processing){var element="#paymentHistoryDataTable, #serverSideDataTable, #paymentDueDataTable";processing?
$(element).addClass("dataTable-disable"):$(element).removeClass("dataTable-disable")}).dataTable(MydataTableOptions);return self.table};function fetchFiltersData(){var url=self.oPostData["FILTERS_URL"];jQuery.ajax({url:url,data:{},type:"GET",cache:false,dataType:"html",success:function(result,status,xhr){jQuery("#filtersPlaceHolder").html(result);setUpFiltersData();jQuery("#filtersDiv").removeAttr("disabled");jQuery(".filterLoaders").remove()},error:function(xhtml,status,errorThrown){self.log.error("fetchFiltersData error:{} status:{}",
errorThrown,status)}})}function setUpFiltersData(){setUpFilterDialog();initApplyFilterButton();closeFilterDialog();getFiltersFromCookie()}self.initGotoPageButton=function(){initGotoPageClick();jQuery("#btnGotoPageServerSide").click(function(){var strGotoPage=trimWS(jQuery("#gotopage").val());var varInvalidPageNumber="Page number entered is invalid.";var integerFilter=/[^0-9]/;if(integerFilter.test(strGotoPage)||strGotoPage.length==0)showUserAlertMsg(varInvalidPageNumber);else{var oTable=jQuery("#paymentHistoryDataTable").DataTable();
var oTableInfo=oTable.page.info();var intNumberOfPages=oTableInfo.pages;var intGotoPage=parseInt(strGotoPage);if(intGotoPage>0&&intGotoPage<=intNumberOfPages){var oTablePages=jQuery("#paymentHistoryDataTable").dataTable();oTablePages.fnPageChange(intGotoPage-1);jQuery("#gotopage").val("")}else{showUserAlertMsg(varInvalidPageNumber);jQuery("#gotopage").focus()}}})};function initApplyFilterButton(){jQuery("#applyServerSideFilterButton").click(function(){filterResult();jQuery("#filterDialog").dialog("close")})}
function closeFilterDialog(){jQuery("#filterModalCloseLnkServerSide").click(function(){var columnName=jQuery("#fltrColName").val();jQuery("input[type\x3d'checkbox'][name\x3d'"+columnName+"']").prop("checked",false);jQuery("input[type\x3d'radio'][name\x3d'"+columnName+"']").prop("checked",false);for(i=0;i<selectedFilters.length;i++)if(selectedFilters[i]){jQuery("input[type\x3d'checkbox'][id\x3d'"+jQuery.trim(selectedFilters[i])+"']").prop("checked",true);jQuery("input[type\x3d'radio'][id\x3d'"+jQuery.trim(selectedFilters[i])+
"']").prop("checked",true)}jQuery("#filterDialog").dialog("close")})}function initSessionAndErrorDialogs(){jQuery("body").on("click","#reloadPageButton",function(){location.reload()});jQuery("body").on("click","#errorOccuredModal",function(){jQuery("#errorOccuredModal").modal("hide")})}function getFilterCriteria(){var filterJSONString={filters:[]};var filterSelected=false;selectedFilters.splice(0,selectedFilters.length);for(i=0;i<filtersName.length;i++){var filterName=filtersName[i].split("|");if(filterName[0]){var data=
jQuery("input[type\x3dcheckbox][name\x3d'"+filterName[0]+"']:checked").map(function(){selectedFilters.push(this.value);return this.value}).get();if(data&&data.length>0){var jsonData={};jsonData.filterBy=filterName[0];jsonData.filterValue=data;filterJSONString.filters.push(jsonData);filterSelected=true;self.displayBreadCrumbs(filterName[0],function(){reloadTable()})}else jQuery("#"+filterName[0]+"BreadCrumb").empty()}}if(selectedFilters.length==0)jQuery(".filter-wrap").hide();self.oPostData["FILTER_CRITERIA"]=
JSON.stringify(filterJSONString);return self.oPostData["FILTER_CRITERIA"]}self.sort=function(column,sortOrder){self.table.fnSort([[column,sortOrder]])};self.reload=function(){filterResult()};self.reloadFiltersAndTable=function(){var temptable=jQuery(self.id).DataTable();temptable.ajax.reload(fetchFiltersData)};function filterResult(){var temptable=jQuery(self.id).DataTable();temptable.ajax.reload()}self.saveFilterSelection=function(){if(saveFilterState){if(self.dataTableOptions.containsFilters)for(i=
0;i<filtersName.length;i++){var filterName=filtersName[i].split("|");if(filterName[0]){var data=jQuery("input[type\x3dcheckbox][name\x3d'"+filterName[0]+"']:checked").map(function(){return this.value}).get().join("|");if(data)setCookie(filterName[0]+self.cookieNameSuffix,data)}}if(self.dataTableOptions.containsStaticFilter){var formData=jQuery("#"+self.staticFilteFormId).serialize();setCookie(self.staticFilteFormId+self.cookieNameSuffix,formData)}setCookie(self.detailsCookieName+self.cookieNameSuffix,
"true")}};function loadSaveState(){if("undefined"==typeof readDataFromCookie||!readDataFromCookie)return false;var toDetail=getCookie(self.detailsCookieName+self.cookieNameSuffix);if(toDetail)return true;else return false}function getStaticFiltersFromCookie(){var formData=getCookie(self.staticFilteFormId+self.cookieNameSuffix);jQuery("#"+self.staticFilteFormId).deserialize(formData);deleteCookie(self.detailsCookieName+self.cookieNameSuffix,null);deleteCookie(self.staticFilteFormId+self.cookieNameSuffix,
null)}function getFiltersFromCookie(){if(typeof readDataFromCookie!="undefined"&&readDataFromCookie){for(var counter=0;counter<filtersName.length;counter++){var columnName=filtersName[counter].split("|");if(columnName){var data=getCookie(columnName[0]+self.cookieNameSuffix);if(data){var ids=data.split("|");if(ids.length>0){for(i=0;i<ids.length;i++){jQuery('input:checkbox[name\x3d"'+columnName[0]+'"][value\x3d"'+ids[i]+'"]').attr("checked","checked");self.displayBreadCrumbs(columnName[0],function(){reloadTable()})}jQuery("#fltrColName").val(columnName[0]);
jQuery("#fltrColIndex").val(columnName[1]);deleteCookie(columnName[0]+self.cookieNameSuffix,null)}}}}deleteCookie(self.detailsCookieName+self.cookieNameSuffix,null)}else for(var counter=0;counter<filtersName.length;counter++){var columnName=filtersName[counter].split("|");if(columnName)deleteCookie(columnName[0]+self.cookieNameSuffix,null);deleteCookie(self.detailsCookieName+self.cookieNameSuffix,null)}}self.displayBreadCrumbs=function(columnName,callback){jQuery("#"+columnName+"BreadCrumb").empty();
jQuery("input[name\x3d'"+columnName+"']:checked").each(function(){jQuery(".filter-wrap").show();jQuery("#"+columnName+"BreadCrumb").append("\x3ca class\x3d'remove-filter'  onclick\x3d'return removeFilters(\""+this.id+'",'+jQuery("#"+this.name+"ColumnValue").val()+","+callback+",this)' href\x3d'#'\x3e"+jQuery(this).next().text()+"\x3cspan class\x3d'delete-filter'\x3e\x3c/span\x3e\x3c/a\x3e")})};self.setRefresh=function(refresh){self.oPostData["REFRESH"]=refresh};self.setStaticFilteFormId=function(id){self.staticFilteFormId=
id};self.setFilterURL=function(url){self.oPostData["FILTERS_URL"]=url};self.getColumnIndex=function(columnTargets){var indexArray=[];angular.forEach(columnTargets,function(value,key){indexArray.push(jQuery("th."+value).index())});return indexArray}}var clearanceSelectedFilters;
function removeFilters(filterBy,columnIndex,callbackFunction,element){filterBy=document.getElementById(filterBy);var filterName="";if(filterBy!=undefined&&filterBy!=null){var columnFilterIndex=filterBy.value.split("_");filterName=filterBy.name;if(columnIndex=="-1")columnIndex=columnFilterIndex[1];clearanceSelectedFilters=jQuery.grep(clearanceSelectedFilters,function(value){return value!=filterBy.value})}jQuery(".filter-wrap").hide();jQuery("#filterRemovedText").hide();jQuery("input[name\x3d'"+filterBy.name+
"']:checked").each(function(){if(jQuery(this).next().text()==jQuery(element).text())jQuery(this).prop("checked",false)});selectedFilters=jQuery.grep(selectedFilters,function(value){return value!=filterBy.value});jQuery("input[type\x3dcheckbox]:checked").map(function(){showBreadCrumbs(this,columnIndex)});jQuery("input[type\x3dradio]:checked").map(function(){showBreadCrumbs(this,columnIndex)});if(callbackFunction){showBreadCrumbs(filterBy,columnIndex);callbackFunction()}else filterData(filterBy,columnIndex);
return false}
app.controller("savedSearchesController",["$scope","$http","$location","dataServiceG2","copartUser","saveSearchCriteria",function($scope,$http,$location,dataServiceG2,copartUser,saveSearchCriteria){var self=$scope;self.listOfSearches=null;self.saveSearchCriteria=saveSearchCriteria.data;var userRoles=copartUser.config.roles;if(!_.contains(userRoles,"ROLE_ANONYMOUS"))dataServiceG2.searchSavedSearches(function(result){self.listOfSearches=result.data;self.listOfSearches.sort(function(a,b){if(a.searchName.toLowerCase()<b.searchName.toLowerCase())return-1;
else if(a.searchName.toLowerCase()>b.searchName.toLowerCase())return 1;else return 0})});self.onDelete=function(id,index){dataServiceG2.deleteSavedSearch(id,function(){self.listOfSearches.splice(index,1)})},self.onSearch=function(criteria){angular.extend(saveSearchCriteria.data,JSON.parse(criteria));$location.url("/lotSearchResults?fromSavedSearch\x3dtrue\x26from\x3d/savedsearch\x26searchCriteria\x3d"+criteria)},self.onStartNewSearch=function(id){self.searchText="";$location.url("/vehicleFinder")};
self.onRegister=function(id){$location.url("/doRegistration")};self.emailSavedSearch=function(search){search.emailFlag=search.emailFlag=="Y"?"N":"Y";dataServiceG2.emailSavedSearch(search,function(response){if(response.data.returnCode==-1){search.emailFlag=search.emailFlag=="Y"?"N":"Y";$("#emailSavedSearchModal").modal()}})}}]);app.factory("saveSearchCriteria",function(){return{data:{}}});
app.controller("auctionDashboardController",["$scope","$http","$locale","$sce","$routeParams","copartUser","userService","$compile","$location",function($scope,$http,$locale,$sce,$routeParams,copartUser,userService,$compile,$location){var self=$scope;$scope.message="Look! I am an auctionDashboardController page.";self.siteCode=copartUser.getUserConfig().siteCode;self.auctionDetails=$location.search().auctionDetails;document.domain=copartUser.getUserConfig().siteDomain;$http({url:"/public/data/auctionDashboard",
method:"GET"}).success(function(response,status,headers,config){if(response.returnCode==1){document.domain=copartUser.getUserConfig().siteDomain;if(response.data.auctionDashboardURL.indexOf("?")>-1)self.auctionDashboardURL=response.data.auctionDashboardURL+"\x26siteLanguage\x3d"+userService.userConfig.selectedLang+"\x26appId\x3dg2";else self.auctionDashboardURL=response.data.auctionDashboardURL+"?siteLanguage\x3d"+userService.userConfig.selectedLang+"\x26appId\x3dg2";if(self.siteCode=="CRTSUS")self.auctionDashboardURL=
self.auctionDashboardURL+"\x26site\x3dct";if(!_.isUndefined(self.auctionDetails))self.auctionDashboardURL=self.auctionDashboardURL+"#"+self.auctionDetails;self.auctionDashboardURL=$sce.trustAsResourceUrl(self.auctionDashboardURL);self.auctionURL=self.siteCode?self.auctionDashboardURL+"\x26"+self.siteCode:self.auctionDashboardURL}else;}).error(function(response,status,headers,config){log.error("Error returned"+response)})}]);
app.controller("watchListPortletController",["$scope","$http","dataServiceG2","copartUser","urlService",function($scope,$http,dataServiceG2,copartUser,urlService){var self=$scope;self.watchList=[];self.wlWaiting=true;var CONST_LIVE_BIDDING="LIVE_BIDDING";var CONST_PRELIM_BIDDING="PRELIM_BIDDING";var CONST_NEVER_BID="NEVER_BID";self.isGlobal=self.$parent.isGlobal;self.formattedDate=function(date){if(_.isUndefined(date))return;var saleDate=moment(date,"YYYYMMDD");return saleDate.format(copartUser.getUserConfig().dateFormat.toUpperCase())};
$http.get("/data/lots/compactWatchList/").success(function(data){self.watchList=data.data.compactWatchList;updateBidBtn(self.watchList);self.wlWaiting=false});self.getAuctionURIWithLotNumber=function(lot){if(lot.auctionLane)return urlService.getAuctionURIWithLotNumber(lot.auctionHostId,lot.auctionLane,lot.lotId);return"/lot/"+lot.lotId};var computeBidButtonDisplay=function(lot){switch(lot.lotAuctionStatus){case CONST_LIVE_BIDDING:lot.btn_message=$scope.locale.messages["app.label.joinAuction"];lot.isLive=
true;break;case CONST_PRELIM_BIDDING:lot.btn_message=lot.bidStatus!==CONST_NEVER_BID?$scope.locale.messages["app.label.increaseBid"]:$scope.locale.messages["app.label.bidNow"];break;default:lot.showBtn=false;lot.btn_message=$scope.locale.messages["lotdetail.label.saleStatus."+lot.saleStatus]}};function updateBidBtn(watchlist){watchlist.forEach(function(lot){lot.showBtn=true;lot.isLive=false;computeBidButtonDisplay(lot);if(!(appInit.appPlatform=="gbl")){lot.showBtn=true;lot.btn_message=$scope.locale.messages["app.label.bidNow"]}})}
}]);app.controller("openItemsPortletController",["$scope","$http","dataServiceG2",function($scope,$http,dataServiceG2){console.log("Inside open items Portlet Controller..");var self=$scope;self.openItemsList=[];self.oiWaiting=true;self.isGlobal=self.$parent.isGlobal;dataServiceG2.getdashBoardOpenItmList(function(response){self.openItemsList=response.data.compactCurrentBids;self.oiWaiting=false})}]);
app.controller("currentBidsPortletController",["$scope","$http","dataServiceG2","auctionsCalendarService","urlService",function($scope,$http,dataServiceG2,auctionsCalendarService,urlService){console.log("Inside current Bids Portlet Controller..");var self=$scope;self.currentBidsList=[];self.cbWaiting=true;self.isGlobal=self.$parent.isGlobal;$http.get("/data/compactCurrentBids/").success(function(data){self.currentBidsList=data.data.compactCurrentBids;self.cbWaiting=false;_.each(self.currentBidsList,
function(lot){auctionsCalendarService.isAuctionLive(lot.auctionHostId,lot.auctionLane,lot.saleDate?lot.saleDate.date:"",lot.auctionId).then(function(flag){lot.isLiveFlag=flag})})});self.getAuctionURIWithLotNumber=function(lot){lot.auctionLane=lot.auctionLane||"";return urlService.getAuctionURIWithLotNumber(lot.auctionHostId,lot.auctionLane,lot.lotId)}}]);
app.controller("savedSearchesPortletController",["$scope","$http","dataServiceG2",function($scope,$http,dataServiceG2){var self=$scope;self.savedSearchesList=[];self.ssWaiting=true;$http.get("/data/compactSavedSearches/").success(function(data){self.savedSearchesList=data.data.compactSavedSearches;self.ssWaiting=false})}]);
app.controller("paymentsDuePortletController",["$scope","$http","dataServiceG2","paymentService",function($scope,$http,dataServiceG2,paymentService){console.log("Inside payments Due Portlet Controller..");var self=$scope;self.paymentsDueList=[];self.pdWaiting=true;$http.get("/data/compactPaymentsDue/").success(function(data){self.paymentsDueList=data.data.compactPaymentsDue;self.pdWaiting=false});self.navigateToLotDetails=paymentService.navigateToLotDetails;self.navigateToLocationDetails=paymentService.navigateToLocationDetails}]);
app.controller("buyingPowerController",["$scope","$http","dataServiceG2",function($scope,$http,dataServiceG2){console.log("Inside buying power Portlet Controller..");var self=$scope;self.openItemsList=[];self.oiWaiting=true;self.showBuyingPower=true;self.buyingPowerScale=[];if(_.contains(self.userConfig.roles,"ROLE_BASIC")){self.buyPowerLimit=1E3;self.buyPowerScaleLimit=5E3;self.buyPowerUsed=0;self.buyPowerAvail=Math.round(self.buyPowerLimit-self.buyPowerUsed);self.bpIndicator=Math.round(self.buyPowerLimit);
console.log("DEBUG: buying power limit %-"+self.bpIndicator);self.usedBPIndicator=0;if(self.buyPowerLimit){var n=self.buyPowerScaleLimit/10;for(var i=0;i<10;i++){var tuple=n*i;self.buyingPowerScale.push(tuple)}}console.log("DEBUG: buying power limit %-"+self.usedBPIndicator);var buyPowerPromise=$http.get("/data/buyer/buyingPower")}else self.showBuyingPower=false;if(buyPowerPromise!=undefined)buyPowerPromise.then(function(payload){if(payload.data.buyingPower){self.buyPowerLimit=payload.data.buyingPower.bidLimitAmount;
self.buyPowerUsed=payload.data.buyingPower.bidLimitAMount_Curr;if(self.buyPowerLimit){self.buyingPowerScale=[];var n=self.buyPowerLimit/10;if(self.buyPowerLimit<5E3)self.buyPowerScaleLimit=5E3;else if(self.buyPowerLimit<=1E4)self.buyPowerScaleLimit=2E4;else if(self.buyPowerLimit<=25E3)self.buyPowerScaleLimit=5E4;else if(self.buyPowerLimit<=5E4)self.buyPowerScaleLimit=75E3;else self.buyPowerScaleLimit=5E5;if(self.buyPowerLimit){var n=self.buyPowerScaleLimit/10;for(var i=1;i<11;i++){var ntuple=n*i;
var scale;if(ntuple%1E3==0)scale=ntuple/1E3+"K";else scale=(ntuple/1E3).toFixed(1)+"K";self.buyingPowerScale.push(scale)}}}self.bpIndicator=Math.round(self.buyPowerLimit/self.buyPowerScaleLimit*100);self.usedBPIndicator=Math.round(self.buyPowerUsed/self.buyPowerLimit*100);self.buyPowerAvail=Math.round(self.buyPowerLimit-self.buyPowerUsed)}console.log("buying power promise fulfilled,Size:")})}]);
app.controller("termsAndConditionsController",["$scope","$http","dataServiceG2","copartUser","$location","userService",function($scope,$http,dataServiceG2,copartUser,$location,userService){var self=$scope;self.userService=userService;self.acceptTermsAndConditions=function(){dataServiceG2.acceptTermsAndConditions(function(response){$location.path("/dashboard");var responseCode=response.data.errorMsg;var responseCodeDesc=response.returnCodeDesc;if(responseCode!=null&&responseCode.trim()!=""&&responseCodeDesc!=
null&&responseCodeDesc.trim()!="Success");})}}]);
app.controller("bidStatusLotsWonController",["$scope","$compile","dataServiceG2","$location","backToLinkService","saveLotNumbersService","appConfigService","localStorageService","History","copartUser","dataTableConfig","$filter","urlService","$timeout","invoiceService","userService",function($scope,$compile,dataServiceG2,$location,backToLinkService,saveLotNumbersService,appConfigService,localStorageService,History,copartUser,dataTableConfig,$filter,urlService,$timeout,invoiceService,userService){var self=
$scope;self.locale=$scope.$parent.locale;var table=new ServersideDatatable_DB(saveLotNumbersService,dataTableConfig,self.locale);self.bidderList=null;self.selectedBidder=null;self.yardDetails={};self.images={};self.dateFormat=copartUser.getUserConfig().dateFormat.toUpperCase();self.timeRangeSelcted=null;var url="/data/bidStatus/lotsWon";self.backToLink=$location.url();backToLinkService.setBackToLink(self.backToLink);backToLinkService.setBackToLinkText("lotswon.label.backurl.lotswon");localStorageService.set("no-navigation",
false);self.estimates={};var lotsWonPreference=copartUser.getUserConfig().displayPref.lotsWonPreference||{};var lotsWonPreferenceConstant={LOTS_WON_PREF_COL_STR:"lotsWonPreference.columns"};var isGlobal=self.$parent.isGlobal;var currencyFilterName=isGlobal?"globalize_currency":"globalize_currency_using_code";var showZipcodeColumn=copartUser.hasAccessSitePref(lotsWonPreferenceConstant.LOTS_WON_PREF_COL_STR,"showZipCodeColumn");var showBidderColumn=copartUser.hasAccessSitePref(lotsWonPreferenceConstant.LOTS_WON_PREF_COL_STR,
"showBidderColumn");var showLotLeftYardDateColumn=copartUser.hasAccessSitePref(lotsWonPreferenceConstant.LOTS_WON_PREF_COL_STR,"showLotLeftYardDateColumn");var showOdometerColumn=copartUser.hasAccessSitePref(lotsWonPreferenceConstant.LOTS_WON_PREF_COL_STR,"showOdometerColumn");var showActualCostOfVehicle=copartUser.hasAccessSitePref(lotsWonPreferenceConstant.LOTS_WON_PREF_COL_STR,"showActualCostOfVehicle");var showRunLightsColumn=copartUser.hasAccessSitePref(lotsWonPreferenceConstant.LOTS_WON_PREF_COL_STR,
"showRunLightsColumn");var showSellerNameColumn=copartUser.hasAccessSitePref(lotsWonPreferenceConstant.LOTS_WON_PREF_COL_STR,"showSellerNameColumn");var showCRGradeColumn=copartUser.hasAccessSitePref(lotsWonPreferenceConstant.LOTS_WON_PREF_COL_STR,"showCRGradeColumn");var showDocTypeColumn=copartUser.hasAccessSitePref(lotsWonPreferenceConstant.LOTS_WON_PREF_COL_STR,"showDocTypeColumn");var showDamageColumn=copartUser.hasAccessSitePref(lotsWonPreferenceConstant.LOTS_WON_PREF_COL_STR,"showDamageColumn");
var showEstRetailValue=copartUser.hasAccessSitePref(lotsWonPreferenceConstant.LOTS_WON_PREF_COL_STR,"showEstRetailValue");var showCOEColumn=copartUser.hasAccessSitePref(lotsWonPreferenceConstant.LOTS_WON_PREF_COL_STR,"showCOEStatusColumn");var showViewDocuments=copartUser.hasAccessSitePref(lotsWonPreferenceConstant.LOTS_WON_PREF_COL_STR,"showViewDocumentsColumn");var showTotal=copartUser.hasAccessSitePref(lotsWonPreferenceConstant.LOTS_WON_PREF_COL_STR,"showTotalColumn");var blockPayments=copartUser.hasAccessSitePref(lotsWonPreferenceConstant.LOTS_WON_PREF_COL_STR,
"blockPayments");var userConfig=userService.userConfig;self.coeObject={};function checkIfFromDetails(){try{var lastRoute=History.lastRoute;if(lastRoute&&(lastRoute.indexOf("lot/")==0||lastRoute.indexOf("paymentsDue/")==0))return true;else return false}catch(e){return false}}var getBidderNumber=function(bidderNumber){bidderNumber=bidderNumber||self.selectedBidder||0;return bidderNumber};var getAjaxUrl=function(url){url=url||"";return url+"/"+getBidderNumber()};self.storeNavigationInfo=function(resultIndex,
totalRecords){var info={backTo:"."+$location.url(),resultIndex:resultIndex,totalRecords:totalRecords};localStorageService.set("lot-navigation-info",info);localStorageService.set("restore-search-state",true)};var state=false;var stateRestoreFromAnywhere=localStorageService.get("restore-search-state-from-anywhere");localStorageService.remove("restore-search-state-from-anywhere");if(checkIfFromDetails()||$location.search().state=="restore"||stateRestoreFromAnywhere){state=localStorageService.get("restore-search-state");
localStorageService.remove("restore-search-state");self.viewedLot=localStorageService.get("viewed-lot");localStorageService.remove("viewed-lot")}self.internationalUser=userConfig.internationalMember;if(self.internationalUser)self.typeOfDelivery="international";else self.typeOfDelivery="domestic";self.loadDataTable=function(){saveLotNumbersService.clearAll();var dataTableOptions={"pageLength":21,"columnDefs":[{"targets":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],"data":null,"defaultContent":""},
{"targets":["imagePath","runLights","salePrice","lotswonzip","doctype","coeStatus","total"],"orderable":false},{"targets":["lotswonzip"],"visible":showZipcodeColumn,"searchable":showZipcodeColumn},{"targets":["odometer"],"visible":showOdometerColumn,"searchable":showOdometerColumn},{"targets":["leftLocationDate"],"visible":showLotLeftYardDateColumn,"searchable":showLotLeftYardDateColumn},{"targets":["bidderId"],"visible":showBidderColumn,"searchable":showBidderColumn},{"targets":["actualCostOfVehicle"],
"visible":showActualCostOfVehicle,"searchable":showActualCostOfVehicle},{"targets":["runLights"],"visible":showRunLightsColumn,"searchable":showRunLightsColumn},{"targets":["sellerName"],"visible":showSellerNameColumn,"searchable":showSellerNameColumn},{"targets":["crGrade"],"visible":showCRGradeColumn,"searchable":showCRGradeColumn},{"targets":["doctype"],"visible":showDocTypeColumn,"searchable":showDocTypeColumn,"orderable":false},{"targets":["damage"],"visible":showDamageColumn,"searchable":showDamageColumn},
{"targets":["estRetailValue"],"visible":showEstRetailValue,"searchable":showEstRetailValue},{"targets":["coeStatus"],"visible":showCOEColumn,"searchable":showCOEColumn},{"targets":["viewDocuments"],"visible":showViewDocuments,"searchable":showViewDocuments},{"targets":["total"],"visible":showTotal,"searchable":showTotal},{className:"control",orderable:false,targets:-1}],"order":[[table.getColumnIndex(["saleDate"]),"desc"]],"lengthMenu":[[20,25,50,100],[20,25,50,100]],"url":getAjaxUrl(url),"containsFilters":false,
"fnRowCallback":function(nRow,aData,iDisplayIndex){jQuery(".nowrap",nRow).attr("nowrap","nowrap");return nRow},"searching":!copartUser.getUserConfig().displayPref.allowSecondarySearch,"stateSave":state,"stateRetrieveFunction":function(data){self.selectedBidder=data.selectedBidder;self.bidderList=data.bidderList;self.showTimeRanges=data.showTimeRanges;self.timeRangeSelcted=data.timeRangeSelcted;if(self.selectedBidder!=null)self.filterTable(self.selectedBidder)},"language":{"paginate":{"first":self.locale.messages["app.label.first"],
"previous":self.locale.messages["app.label.previous"],"next":self.locale.messages["app.label.next"],"last":self.locale.messages["app.label.last"]},"lengthMenu":self.locale.messages["app.label.show"]+" _MENU_ "+self.locale.messages["app.label.entries"],"info":self.locale.messages["app.label.showingRecords.info"],"infoFiltered":"("+self.locale.messages["app.label.filteredFrom"]+" _MAX_ "+self.locale.messages["app.label.totalEntries"]+")","searchPlaceholder":self.locale.getMessage("bids.lotswon.label.searchListPlaceholder"),
"search":self.locale.getMessage("app.label.search")+":"},"noResultInfoMessage":self.locale.messages["app.label.zeroVehicleFound"],"noResultMessage":self.locale.messages["app.label.noItemsToDisplay"],"columns":[{"mData":"imgp","render":function(data,type,row,meta){var brand=row["brand"];if(!row.imageUrl||!row.imageUrl.trim())return"\x3cimg alt\x3d'image' height\x3d'72' width\x3d'96' class\x3d'' src\x3d'/images/testImages/no_photo.jpg'\x3e";var description=row["lotYear"]+" "+row["lotMake"]+" "+row["lotModel"];
var backTo=self.backToLink;var resultIndex=meta.settings._iDisplayStart+meta.row;var totalRecords=meta.settings._iRecordsTotal;var awardedHighBid=row["awardedHighBid"];var saleDate=row["saleDate"]?row["saleDate"].date:"";var imageDiv="\x3ca class\x3d'imgpath cursor-pointer' lot-id\x3d'"+row["lotNumber"]+"' lot-desc\x3d'"+description+"' images\x3d'images' award-high-bid\x3d'"+awardedHighBid+"' hide-watch-btn\x3dtrue modal-image-viewer "+" back-to\x3d"+backTo+" result-index\x3d"+resultIndex+" total-records\x3d"+
totalRecords+"  flag\x3d1 auction-date\x3d'"+saleDate+"'  \x3e"+"\x3cspan class\x3d'searchiconbtn searchiconbtnie'\x3e\x3c/span\x3e\x3cimg alt\x3d'image' height\x3d'72' width\x3d'96' class\x3d'' src\x3d'"+row["imageUrl"]+"'error-image\x3d'/images/testImages/no_photo.jpg'\x3e\x3cbr\x3e"+"\x3c/a\x3e";var viewAllPhotos="\x3cdiv class\x3d'viewallphotos'\x3e\x3ca sso-sign-on brand\x3d"+brand+" data-url\x3d'./lot/"+row["lotNumber"]+"/Photos?backTo\x3d/lotsWon' class\x3d'image_viewer_link'  data-lotDesc\x3d'"+
row["lotNumber"]+"' data-lot\x3d'"+row["lotNumber"]+"'\x3e"+self.locale.messages["counterman.searchResults.viewAllPhotos.label"]+"\x3c/a\x3e\x3c/div\x3e";var siteCatalystVal=""+"site-catalyst\x3d{'fname':'doTagDownloadAllImages','lotId':'"+row["lotNumber"].toString()+"'}";var downloadAllPhotosDiv="\x3cdiv class\x3d'viewallphotos'\x3e\x3ca ng-href\x3d'./public/data/lotImages/download/"+row["lotNumber"]+"' target\x3d'_self'"+siteCatalystVal+"\x3e"+"\x3cspan\x3e"+self.locale.messages["lotswon.searchResults.downloadAllPhotos.label"]+
"\x3c/span\x3e\x3c/a\x3e\x3c/div\x3e";imageDiv=imageDiv+viewAllPhotos;return imageDiv}},{"mData":"lotNumber","render":function(data,type,row,meta){row["backTo"]=self.backToLink;var lotId=row["lotNumber"];var resultIndex=meta.settings._iDisplayStart+meta.row;var totalRecords=meta.settings._iRecordsTotal;var brand=row["brand"];if(self.viewedLot&&self.viewedLot==lotId){self.viewedRowIndex=meta.row;self.viewedLot=null}saveLotNumbersService.addLotNumber(row["lotNumber"]);var siteCatalystVal=""+"site-catalyst\x3d{'fname':'doTagDownloadAllImages','lotId':'"+
row["lotNumber"].toString()+"'}";var downloadAllPhotosDiv="\x3cdiv class\x3d'viewallphotos'\x3e\x3ca ng-href\x3d'/public/data/lotImages/download/"+row["lotNumber"]+"' target\x3d'_self'"+siteCatalystVal+"\x3e"+"\x3cspan\x3e"+self.locale.messages["lotswon.searchResults.downloadAllPhotos.label"]+"\x3c/span\x3e\x3c/a\x3e\x3c/div\x3e";var html="\x3ca sso-sign-on brand\x3d"+brand+" data-url\x3d'/lot/"+row["lotNumber"]+"?resultIndex\x3d"+resultIndex+"\x26totalRecords\x3d"+totalRecords+"\x26backTo\x3d"+self.backToLink+
"\x26flag\x3d1'"+"ng-click\x3d'storeNavigationInfo("+resultIndex+","+totalRecords+")'\x3e"+row["lotNumber"]+"\x3c/a\x3e";if(row.imageUrl&&row.imageUrl.trim())html=html+downloadAllPhotosDiv;return html}},{"mData":"lotYear","render":function(data,type,row){self.lotyear=row["lotYear"];if(row["lotIcons"]){var iconCodes=_.intersection(row["lotIcons"],self.validIconCodes);var template="\x3cspan data-uname\x3d'lotsearchLotcenturyyear'\x3e"+row["lotYear"]+"\x3c/span\x3e\x3cbr\x3e";return self.generateIconTemplate(template,
iconCodes)}return row["lotYear"]}},{"mData":"lotMake"},{"mData":"lotModel"},{"mData":"yardName","render":function(data,type,row){var html="\x3ca class\x3d'cursor-pointer' href\x3d'"+urlService.getLocationUrl(row["yardNumber"])+"' target\x3d'_blank'\x3e"+"\x3cspan\x3e"+row["yardName"]+"\x3c/span\x3e\x3c/a\x3e";return html}},{"mData":"runLights","render":function(data,type,row){if(row["runLights"]){var template="";return self.generateRunLightTemplate(template,row["runLights"])}else return""}},{"mData":"sellerName",
"render":function(data,type,row){if(row["sellerName"])return row["sellerName"];else return""}},{"mData":"crGrade","render":function(data,type,row){var html="\x3ccondition-report lot-number\x3d "+row["lotNumber"]+" display-name\x3d"+row["crGrade"]+" document-type\x3d'VGLK_CONDITION_REPORT'\x3e\x3c/condition-report\x3e";return html}},{"mData":"vin","render":function(data,type,row){var vin=$filter("redactFilter")(row["vin"],"limitVIN","*");return vin}},{"mData":"bidderNumber"},{"mData":"saleDateStr",
"render":function(data,type,row){var saleDateFormatted=row["saleDateStr"];if(saleDateFormatted&&saleDateFormatted.dateAsInt!=0)return moment(saleDateFormatted).format(self.dateFormat)}},{"mData":"odometerReading","render":function(data,type,row){return $filter("odometer_reading_display")(parseFloat(row["odometerReading"]),"",row["odometerUOM"])}},{"mData":"lotLeftYardDate","render":function(data,type,row){var lotLeftYardDate=row["lotLeftYardDate"];if(lotLeftYardDate&&lotLeftYardDate.dateAsInt!=0){var leftFacilityDate=
moment(lotLeftYardDate.dateAsInt,"YYYYMMDD");return leftFacilityDate.format(self.dateFormat)}else return""}},{"mData":"docType"},{"mData":"damageType","render":function(data,type,row){if(row["damageType"])return row["damageType"].toTitleCase();else return""}},{"mData":"actualCostOfVehicle","render":function(data,type,row){if(row["currency"])return $filter(currencyFilterName)(row["actualCostOfVehicle"],row["currency"]["code"],2);else return row["actualCostOfVehicle"]}},{"mData":"totalAmt","render":function(data,
type,row){var html="currencyNotExist";if(!isGlobal){var paymentStatus=row["paymentStatus"]||"";if(row["currency"]){if(row["totalAmt"])html=$filter(currencyFilterName)(row["totalAmt"],row["currency"].code,2)+"\x3cbr/\x3e";if(blockPayments)html=self.locale.messages["lotswon.label.hammer.price"]+"\x3cbr/\x3e\x3cb\x3e"+html+"\x3c/b\x3e"}if(!blockPayments&&row["paymentStatus"]!="Paid")html+="\x3ca href\x3d'./paymentsDue' class\x3d'btn btn-primary'\x3e"+self.locale.messages["app.label.payNow"]+"\x3c/a\x3e";
else if(blockPayments){var paymentStatus=row["paymentStatus"];if(paymentStatus==="NotPaid")paymentStatus=self.locale.messages["lotswon.label.payment.due"];else if(paymentStatus==="Paid")paymentStatus=self.locale.messages["lotdetail.bidStatus.PAID"];html+="\x3cspan\x3e\x3cb\x3e"+paymentStatus+"\x3c/b\x3e\x3c/span\x3e"}else html+="\x3cspan\x3e"+paymentStatus+"\x3c/span\x3e"}else if(row["currency"]&&row["totalAmt"])html=$filter(currencyFilterName)(row["totalAmt"],row["currency"].code,2);return html}},
{"mData":"total","render":function(data,type,row){var html="currencyNotExist";var paymentStatus=row["paymentStatus"]||"";if(row["currency"])if(row["total"])html=$filter(currencyFilterName)(row["total"],row["currency"].code,2)+"\x3cbr/\x3e";if(blockPayments){if(paymentStatus==="NotPaid")paymentStatus=self.locale.messages["lotswon.label.payment.due"];else if(paymentStatus==="Paid")paymentStatus=self.locale.messages["lotdetail.bidStatus.PAID"];html+="\x3cspan\x3e\x3cb\x3e"+paymentStatus+"\x3c/b\x3e\x3c/span\x3e"}else html+=
"\x3cspan\x3e"+paymentStatus+"\x3c/span\x3e";return html}},{"mData":"totalAmt","render":function(data,type,row){var paymentStatus="Paid";var pdfUrl="\x3ca ng-click\x3dopenInvoiceModal("+row["lotNumber"]+",'MBRINV','lot')\x3e"+self.locale.messages["paymentDue.invoice.document"]+"\x3c/a\x3e";var gatepassUrl="\x3cbr\x3e\x3ca ng-click\x3dopenInvoiceModal("+row["lotNumber"]+",'GTPASS','lot')\x3e"+self.locale.messages["paymentDue.gatepass.document"]+"\x3c/a\x3e";pdfUrl=paymentStatus=="Paid"?pdfUrl+gatepassUrl:
pdfUrl;return pdfUrl}},{"mData":"coeStatus","render":function(data,type,row){if(row["coeStatus"]){var coe_status=row["coeStatus"];var coe_sent_date=row["coeSendDate"];var coe_received_date=row["coeReceivedDate"];var coe_reversed_date=row["coeReversedDate"];var coe_sent_date_url=row["coeSentDateUrl"];var coe_received_date_url=row["coeReceivedDateUrl"];var lotNumber=row["lotNumber"];var coeObject={"coe_status":coe_status,"coe_sent_date":coe_sent_date,"coe_received_date":coe_received_date,"coe_reversed_date":coe_reversed_date,
"coe_sent_date_url":coe_sent_date_url,"coe_received_date_url":coe_received_date_url};var coeStatusLabel=self.locale.messages["lotswon.label.coeStatus."+coe_status]||"";var coeStatusTooltipLabel=self.locale.messages["lotswon.label.coeStatus.tooltip."+coe_status]||"";var template="";if(coe_status!="UNSENT"&&coe_status!="NA")template="\x3cbr/\x3e\x3ca class\x3d'cursor-pointer wsnowrap' ng-click\x3d'openPostSaleInfo("+lotNumber+")'\x3e"+self.locale.messages["lotswon.header.label.view.coeDetails"]+"\x3c/a\x3e";
var toolTip='\x3cspan class\x3d"col1 lot-details-desc padding-right wsnowrap"\x3e'+coeStatusLabel+'\x3ca href\x3d"javascript:void(0);" style\x3d"text-decoration:none;" data-toggle\x3d"popover" data-html\x3d"true" tooltip  data-content\x3d"\x3cdiv class\x3d\'content-box\'\x3e\x3ch3 class\x3d\'bg-lblue white\'\x3e'+coeStatusLabel+"\x3c/h3\x3e\x3cp class\x3d'padding10'\x3e"+coeStatusTooltipLabel+'\x3c/p\x3e\x3c/div\x3e"\x3e \x3ci class\x3d"fa fa-question-circle"\x3e\x3c/i\x3e\x3c/a\x3e\x3c/span\x3e';
return"\x3cdiv\x3e"+toolTip+template+"\x3c/div\x3e"}else return""}},{"mData":"dp","render":function(data,type,row){return"\x3cspan  request-Type\x3d'QUOTE' lot-id\x3d'"+row["lotNumber"]+"'  estimates\x3d'estimates' lot-status\x3d'"+row["paymentStatus"]+"' transportaion-estimates\x3e"}},{"mData":"","render":function(data,type,row){return""}}]};var datatable=table.initServerSideDataTable("#serverSideDataTable",dataTableOptions,function(){self.compileDom("#serverSideDataTable");$(window).trigger("scrollToPoint");
$timeout(function(){if(self.viewedRowIndex||self.viewedRowIndex==0){jQuery("#serverSideDataTable"+" tbody tr").eq(self.viewedRowIndex).addClass("bold fs12");self.viewedRowIndex=null}},0)});datatable.on("stateSaveParams.dt",function(e,settings,data){data.selectedBidder=self.selectedBidder;data.bidderList=self.bidderList;data.showTimeRanges=self.showTimeRanges;data.timeRangeSelcted=self.timeRangeSelcted});datatable.on("responsive-display.dt",function(e,datatable,row,showHide,update){self.compileDom("#serverSideDataTable")});
dataServiceG2.getBidderStatusList(function(responseData){if(responseData.returnCode==-1)log.error("Error");else self.bidderList=responseData.data})};self.openInvoiceModal=function(invoiceNum,docType,entity){invoiceService.getInvoiceDocuments(invoiceNum,docType,entity,invoiceSuccessCallBack)};var invoiceSuccessCallBack=function(response){if(response!=null){self.invoiceDocuments=response.data||[];$("#invoiceDisplay").modal("show")}};self.compileDom=function(table){var $dest=jQuery(table).find("tbody");
var retn=$compile($dest)($scope);self.$apply()};self.filterTable=function(bidder){self.selectedBidder=bidder;console.log("calling filtering"+bidder);self.reloadTable()};self.reloadTable=function(){var temptable=jQuery("#serverSideDataTable").DataTable();temptable.ajax.url(getAjaxUrl(url)).load()};self.stateFilter=function(item){return item.type==="USA"||item.type==="CAN"};table.overrideDefaults=function(data){if(!self.timeRangeSelcted)self.timeRangeSelcted=self.showTimeRanges[0];data.fromDate=self.timeRangeSelcted.fromDate;
data.toDate=self.timeRangeSelcted.toDate;data.dateRangeStringForSolr=self.timeRangeSelcted.dateRangeStringForSolr;var filterJSONString={filters:[]};var bidderFilter={};if(self.selectedBidder){bidderFilter.filterBy="bidderNumber";bidderFilter.filterValue=[self.selectedBidder];filterJSONString.filters.push(bidderFilter)}data.filterCriteria=JSON.stringify(filterJSONString)};var highlightIcons=_.where(appConfigService.appConfig.getHighlightIcons(),{iconType:"H"});self.validIconCodes=_.pluck(highlightIcons,
"iconCode");self.generateIconTemplate=function(template,iconCodes){template=template+'\x3cspan copart-vehicle-iconss class\x3d" highlighticon"\x3e ';for(var i=0;i<iconCodes.length;i++){var code=iconCodes[i];template+='\x3ca lot-highlights-tool-tip fragment-id\x3d"'+code+'" class\x3d"icon-tooltip" data-placement\x3d"auto right" data-toggle\x3d"popover" data-container\x3d".lots-won"\x3e'+'\x3cspan class\x3d"vehicleicon"\x3e\x3cimg src\x3d"../images/global/highlightIcons-'+appInit.regionCode+'.png" class\x3d"lotIcon-'+
code+' bid-icon-img"\x3e\x3c/span\x3e\x3c/a\x3e'}template=template+"\x3c/span\x3e";return template};self.generateRunLightTemplate=function(template,iconCodes){var runLightsTemplate="";var defaultRunLights=["green","red","yellow","blue"];var lotRunLights=iconCodes||[];lotRunLights=lotRunLights.toString().toLowerCase();runLightsTemplate+='\x3cspan class\x3d"float-none"\x3e';_.each(defaultRunLights,function(code){if(lotRunLights.indexOf(code)>-1){var highLightedClass="dot";runLightsTemplate+="\x3cspan data-uname\x3d'runLights'  class\x3d'"+
code.toLowerCase()+highLightedClass+" no-wrap run-highLight'\x3e\x26nbsp;\x26nbsp;\x26nbsp;\x26nbsp;\x26nbsp;\x3c/span\x3e"}});runLightsTemplate+="\x3c/span\x3e";return runLightsTemplate};self.csvUrl=getAjaxUrl("/bidStatusLotsWon/exportCsv");var selectedTimezone=self.userConfig.selectedTimezone;var date=moment().tz(selectedTimezone).format("YYYY MMMM DD");self.exportFileName="LotsWon_"+date+".csv";self.download=function(){dataServiceG2.downloadCSV(csvUrl,null)};self.openPostSaleInfo=function(lotNumber){self.coeDetailsForLot=
{};self.loadingCOEDetails=true;var successCallBack=function(response){if(response&&response.returnCode!=-1){self.loadingCOEDetails=false;self.coeDetailsForLot=new COEModel(response.data)}};dataServiceG2.getCOEDocumentDetails(lotNumber,successCallBack);jQuery("#postSaleInformationModal").modal("show")};self.closePostSaleInfo=function(){jQuery("#postSaleInformationModal").modal("hide")}}]);
app.controller("bidStatusLotsLostController",["$scope","$compile","dataServiceG2","$location","backToLinkService","searchCriteriaFactory","saveLotNumbersService","appConfigService","localStorageService","History","dataTableConfig","$filter","copartUser","urlService","$timeout","searchCriteriaConstants",function($scope,$compile,dataServiceG2,$location,backToLinkService,searchCriteriaFactory,saveLotNumbersService,appConfigService,localStorageService,History,dataTableConfig,$filter,copartUser,urlService,
$timeout,searchCriteriaConstants){var self=$scope;var table=new ServersideDatatable_DB(saveLotNumbersService,dataTableConfig);self.searchCriteria=searchCriteriaFactory.getSearchCriteria(searchCriteriaConstants.lotSearch);self.bidderList=null;self.selectedBidder=null;self.yardDetails={};self.images={};self.dateFormat=copartUser.getUserConfig().displayPref.dateFormat.toUpperCase();self.timeRangeSelcted=null;var url="/data/bidStatus/lotsLost";self.backToLink=$location.url();var rowDataStore={};backToLinkService.setBackToLink(self.backToLink);
var selectedTimezone=copartUser.getUserConfig().selectedTimezone;self.date=moment().tz(selectedTimezone).format("YYYY MMMM DD");self.csvUrl="/lotsLost/CSVView";self.exportFileName="LotsLost_"+self.date+".csv";var lotsLostPreference=copartUser.getUserConfig().displayPref.lotsLostPreference||{};var lotsLostPreferenceConstant={LOTS_LOST_PREF_COL_STR:"lotsLostPreference.columns"};var showOdometerColumn=copartUser.hasAccessSitePref(lotsLostPreferenceConstant.LOTS_LOST_PREF_COL_STR,"showOdometerColumn");
var showVinColumn=copartUser.hasAccessSitePref(lotsLostPreferenceConstant.LOTS_LOST_PREF_COL_STR,"showVinColumn");var showRunLightsColumn=copartUser.hasAccessSitePref(lotsLostPreferenceConstant.LOTS_LOST_PREF_COL_STR,"showRunLightsColumn");var showSellerNameColumn=copartUser.hasAccessSitePref(lotsLostPreferenceConstant.LOTS_LOST_PREF_COL_STR,"showSellerNameColumn");var showCRGradeColumn=copartUser.hasAccessSitePref(lotsLostPreferenceConstant.LOTS_LOST_PREF_COL_STR,"showCRGradeColumn");var showDocTypeColumn=
copartUser.hasAccessSitePref(lotsLostPreferenceConstant.LOTS_LOST_PREF_COL_STR,"showDocTypeColumn");var showDamageColumn=copartUser.hasAccessSitePref(lotsLostPreferenceConstant.LOTS_LOST_PREF_COL_STR,"showDamageColumn");var showEstRetailValue=copartUser.hasAccessSitePref(lotsLostPreferenceConstant.LOTS_LOST_PREF_COL_STR,"showEstRetailValue");var isGlobal=self.$parent.isGlobal;var currencyFilterName=isGlobal?"globalize_currency":"globalize_currency_using_code";showOdometerColumn=lotsLostPreference.showOdometerColumn;
showVinColumn=false;function checkIfFromDetails(){try{var lastRoute=History.lastRoute;if(lastRoute&&lastRoute.indexOf("lot/")==0)return true;else return false}catch(e){return false}}var state=false;var stateRestoreFromAnywhere=localStorageService.get("restore-search-state-from-anywhere");localStorageService.remove("restore-search-state-from-anywhere");if(checkIfFromDetails()||$location.search().state=="restore"||stateRestoreFromAnywhere){state=localStorageService.get("restore-search-state");localStorageService.remove("restore-search-state");
self.viewedLot=localStorageService.get("viewed-lot");localStorageService.remove("viewed-lot")}self.storeNavigationInfo=function(resultIndex){var info={backTo:"."+$location.url(),resultIndex:resultIndex};localStorageService.set("lot-navigation-info",info);localStorageService.set("restore-search-state",true)};self.loadDataTable=function(){saveLotNumbersService.clearAll();var dataTableOptions={"pageLength":20,"columnDefs":[{"targets":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16],"data":null,"defaultContent":""},
{"targets":["imagePath","runLights","myLastBid","doctype"],"orderable":false},{"targets":["odometer"],"visible":showOdometerColumn,"searchable":showOdometerColumn},{"targets":["vin"],"visible":showVinColumn,"searchable":showVinColumn},{"targets":["runLights"],"visible":showRunLightsColumn,"searchable":showRunLightsColumn},{"targets":["sellerName"],"visible":showSellerNameColumn,"searchable":showSellerNameColumn},{"targets":["crGrade"],"visible":showCRGradeColumn,"searchable":showCRGradeColumn},{"targets":["doctype"],
"visible":showDocTypeColumn,"searchable":showDocTypeColumn,"orderable":false},{"targets":["damage"],"visible":showDamageColumn,"searchable":showDamageColumn},{"targets":["estRetailValue"],"visible":showEstRetailValue,"searchable":showEstRetailValue},{className:"control",orderable:false,targets:-1}],"order":[[table.getColumnIndex(["saleDate"]),"desc"]],"lengthMenu":[[20,25,50,100],[20,25,50,100]],"url":url,"containsFilters":false,"fnRowCallback":function(nRow,aData,iDisplayIndex){jQuery(".nowrap",
nRow).attr("nowrap","nowrap");return nRow},"stateSave":state,"searching":!copartUser.getUserConfig().displayPref.allowSecondarySearch,"stateRetrieveFunction":function(data){self.selectedBidder=data.selectedBidder;self.bidderList=data.bidderList;self.showTimeRanges=data.showTimeRanges;self.timeRangeSelcted=data.timeRangeSelcted;if(self.selectedBidder!=null)self.filterTable(self.selectedBidder)},"language":{"paginate":{"first":self.locale.messages["app.label.first"],"previous":self.locale.messages["app.label.previous"],
"next":self.locale.messages["app.label.next"],"last":self.locale.messages["app.label.last"]},"lengthMenu":self.locale.messages["app.label.show"]+" _MENU_ "+self.locale.messages["app.label.entries"],"info":self.locale.messages["app.label.showing"]+" _START_ "+self.locale.messages["app.label.to"]+" _END_ "+self.locale.messages["app.label.of"]+" _TOTAL_ "+self.locale.messages["app.label.entries"],"infoFiltered":"("+self.locale.messages["app.label.filteredFrom"]+" _MAX_ "+self.locale.messages["app.label.totalEntries"]+
")","searchPlaceholder":self.locale.getMessage("app.label.searchListPlaceholder"),"search":self.locale.getMessage("app.label.search")+":"},"noResultInfoMessage":self.locale.messages["app.label.zeroVehicleFound"],"noResultMessage":self.locale.messages["app.label.noItemsToDisplay"],"columns":[{"mData":"imgp","render":function(data,type,row,meta){var description=row["lotYear"]+" "+row["lotMake"]+" "+row["lotModel"];var backTo=self.backToLink;var resultIndex=saveLotNumbersService.getResultIndex(row.lotNumber);
var totalRecords=saveLotNumbersService.getListLength();var saleDate=row["saleDate"]?row["saleDate"].date:"";var brand=row["brand"];return"\x3ca class\x3d'imgpath cursor-pointer' lot-id\x3d'"+row["lotNumber"]+"' lot-desc\x3d'"+description+"' images\x3d'images' current-bid\x3d'"+row["myBid"]+"' hide-watch-btn\x3dtrue modal-image-viewer "+" back-to\x3d"+backTo+" result-index\x3d"+resultIndex+" auction-id\x3d"+row["auctionId"]+" total-records\x3d"+totalRecords+" flag\x3d1 auction-date\x3d'"+saleDate+
"'  \x3e"+"\x3cspan class\x3d'searchiconbtn searchiconbtnie'\x3e\x3c/span\x3e\x3cimg alt\x3d'image' height\x3d'72' width\x3d'96' class\x3d'' src\x3d'"+row["imageUrl"]+"'\x3e\x3cbr\x3e"+"\x3c/a\x3e"+"\x3cdiv class\x3d'viewallphotos'\x3e\x3ca sso-sign-on brand\x3d"+brand+" data-url\x3d'./lot/"+row["lotNumber"]+"/Photos' ng-click\x3d'storeNavigationInfo("+resultIndex+")' class\x3d'image_viewer_link'  data-lotDesc\x3d'"+row["lotNumber"]+"' data-lot\x3d'"+row["lotNumber"]+"'\x3e"+self.locale.messages["counterman.searchResults.viewAllPhotos.label"]+
"\x3c/a\x3e\x3c/div\x3e"}},{"mData":"lotNumber","render":function(data,type,row,meta){var lotId=row["lotNumber"];var brand=row["brand"];var resultIndex=saveLotNumbersService.getResultIndex(row.lotNumber);rowDataStore[row["lotNumber"]]=row;saveLotNumbersService.addLotNumber(row["lotNumber"]);if(self.viewedLot&&self.viewedLot==lotId){self.viewedRowIndex=meta.row;self.viewedLot=null}return"\x3ca sso-sign-on brand\x3d"+brand+" data-url\x3d'./lot/"+row["lotNumber"]+"' ng-click\x3d'storeNavigationInfo("+
resultIndex+")'\x3e"+row["lotNumber"]}},{"mData":"lotYear","render":function(data,type,row){var lotYear=row["lotYear"]?row["lotYear"]:"";if(row["lotIcons"]){var iconCodes=_.intersection(row["lotIcons"],self.validIconCodes);var template="\x3cspan data-uname\x3d'lotsearchLotcenturyyear'\x3e"+lotYear+"\x3c/span\x3e\x3cbr\x3e";return self.generateIconTemplate(template,iconCodes)}return lotYear}},{"mData":"lotMake","render":function(data,type,row){return row["lotMake"]}},{"mData":"lotModel","render":function(data,
type,row){return row["lotModel"]}},{"mData":"yardName","render":function(data,type,row){var html="\x3ca class\x3d'cursor-pointer' href\x3d'"+urlService.getLocationUrl(row["yardNumber"])+"' target\x3d'_blank'\x3e"+"\x3cspan\x3e"+row["yardName"]+"\x3c/span\x3e\x3c/a\x3e \x3cbr/\x3e";return html}},{"mData":"runLights","render":function(data,type,row){if(row["runLights"]){var template="";return self.generateRunLightTemplate(template,row["runLights"])}else return""}},{"mData":"sellerName","render":function(data,
type,row){if(row["sellerName"])return row["sellerName"];else return""}},{"mData":"crGrade","render":function(data,type,row){return'\x3ccondition-report¬†display-name\x3d"{{'+row["crGrade"]+'| trim}}"¬†document-type\x3d"VGLK_CONDITION_REPORT"\x3e\x3c/condition-report\x3e'}},{"mData":"vin","render":function(data,type,row){var vin=row["vin"]?row["vin"]:"";var vin=$filter("redactFilter")(vin,"limitVIN","*");return vin}},{"mData":"saleDateStr","render":function(data,type,row){var saleDateFormatted=row["saleDateStr"];
return moment(saleDateFormatted).format(self.dateFormat)}},{"mData":"odometerReading","render":function(data,type,row){var odoMeterUOM=row["odometerUOM"]||"";if(!_.isUndefined(data))return $filter("odometer_reading_display")(parseFloat(row["odometerReading"]),"",odoMeterUOM);else return row["odometerReading"]?$filter("globalize_number")(row["odometerReading"]):""}},{"mData":"docType","render":function(data,type,row){var docType=row["docType"]?row["docType"]:"";return docType}},{"mData":"damageType",
"render":function(data,type,row){var damageType=row["damageType"]?row["damageType"].toTitleCase():"";return damageType}},{"mData":"actualCostOfVehicle","render":function(data,type,row){if(row["currency"])return $filter(currencyFilterName)(row["actualCostOfVehicle"],row["currency"]["code"],2);else return row["actualCostOfVehicle"]}},{"mData":"myBid","render":function(data,type,row){var currencyCode=row["myBid"];var bidStatus=row["bidStatus"];if(bidStatus&&bidStatus.trim().toUpperCase()==="OUTBID")bidStatus=
self.locale.messages["lotdetail.bidStatus.outBid"];if(row["currency"])currencyCode=$filter(currencyFilterName)(row["myBid"],row["currency"]["code"],2);var html="\x3cspan class\x3d'btn btn-danger'\x3e"+bidStatus+"\x3c/span\x3e\x3cbr/\x3e\x3cspan\x3e{{locale.messages['app.label.last.bid']}}: \x3c/span\x3e"+currencyCode+"\x3cbr/\x3e"+"\x3ca ng-click\x3d'search("+row["lotNumber"]+")'\x3e{{locale.messages['app.label.findSimilarVehicles']}}\x3c/a\x3e";return html}},{"mData":"","render":function(data,type,
row){return""}}]};var datatable=table.initServerSideDataTable("#serverSideDataTable",dataTableOptions,function(){self.compileDom("#serverSideDataTable");$(window).trigger("scrollToPoint");$timeout(function(){if(self.viewedRowIndex||self.viewedRowIndex==0){jQuery("#serverSideDataTable"+" tbody tr").eq(self.viewedRowIndex).addClass("bold fs12");self.viewedRowIndex=null}},0)});datatable.on("stateSaveParams.dt",function(e,settings,data){data.selectedBidder=self.selectedBidder;data.bidderList=self.bidderList;
data.showTimeRanges=self.showTimeRanges;data.timeRangeSelcted=self.timeRangeSelcted});datatable.on("responsive-display.dt",function(e,datatable,row){$compile(row.child())(self)});dataServiceG2.getBidderStatusList(function(responseData){console.log(responseData);if(responseData.returnCode==-1)log.error("Error");else self.bidderList=responseData.data})};self.compileDom=function(table){var $dest=jQuery(table).find("tbody");var retn=$compile($dest)($scope);self.$apply()};self.reloadTable=function(){var temptable=
jQuery("#serverSideDataTable").DataTable();temptable.ajax.url("/data/bidStatus/lotsLost").load()};table.overrideDefaults=function(data){if(!self.timeRangeSelcted)self.timeRangeSelcted=self.showTimeRanges[0];data.fromDate=self.timeRangeSelcted.fromDate;data.toDate=self.timeRangeSelcted.toDate;var filterJSONString={filters:[]};var bidderFilter={};if(self.selectedBidder){bidderFilter.filterBy="bidderNumber";bidderFilter.filterValue=[self.selectedBidder];filterJSONString.filters.push(bidderFilter)}data.filterCriteria=
JSON.stringify(filterJSONString)};self.search=function(lotNumber){var displayStr=[];var miscFilter=[];var lot=rowDataStore[lotNumber];if(!_.isUndefined(lot)||!_.isEmpty(lot)){if(lot.lotMake){miscFilter.push("#MakeDesc:"+lot.lotMake.toUpperCase());displayStr.push(lot.lotMake)}if(lot.lotModel){miscFilter.push("#LotModel:"+lot.lotModel.trim().toUpperCase());displayStr.push(lot.lotModel.trim())}if(lot.lotYear){displayStr.push(lot.lotYear.trim());miscFilter.push("#LotYear:"+lot.lotYear.trim())}displayStr=
displayStr.join(",");self.searchCriteria.setMiscFilter(miscFilter);$location.url("/vehicleFinderSearch?displayStr\x3d"+displayStr+"\x26from\x3d"+$location.url())}};self.filterTable=function(bidder){self.selectedBidder=bidder;console.log("calling filtering"+bidder);self.reloadTable()};var highlightIcons=_.where(appConfigService.appConfig.getHighlightIcons(),{iconType:"H"});self.validIconCodes=_.pluck(highlightIcons,"iconCode");self.generateIconTemplate=function(template,iconCodes){template=template+
'\x3cspan copart-vehicle-iconss class\x3d" highlighticon "\x3e ';for(var i=0;i<iconCodes.length;i++){var code=iconCodes[i];template+='\x3ca lot-highlights-tool-tip fragment-id\x3d"'+code+'" class\x3d"icon-tooltip" data-placement\x3d"auto right" data-toggle\x3d"popover" data-container\x3d".lots-lost"\x3e'+'\x3cspan class\x3d"vehicleicon"\x3e\x3cimg src\x3d"../images/global/highlightIcons-'+appInit.regionCode+'.png" class\x3d"lotIcon-'+code+' bid-icon-img"\x3e\x3c/span\x3e\x3c/a\x3e'}template=template+
"\x3c/span\x3e";return template};self.generateRunLightTemplate=function(template,iconCodes){var runLightsTemplate="";var defaultRunLights=["green","red","yellow","blue"];var lotRunLights=iconCodes||[];lotRunLights=lotRunLights.toString().toLowerCase();runLightsTemplate+='\x3cspan class\x3d"float-none"\x3e';_.each(defaultRunLights,function(code){if(lotRunLights.indexOf(code)>-1){var highLightedClass="dot";runLightsTemplate+="\x3cspan data-uname\x3d'runLights'  class\x3d'"+code.toLowerCase()+highLightedClass+
" no-wrap run-highLight'\x3e\x26nbsp;\x26nbsp;\x26nbsp;\x26nbsp;\x26nbsp;\x3c/span\x3e"}});runLightsTemplate+="\x3c/span\x3e";return runLightsTemplate}}]);
app.controller("vehicleFinderController",["$scope","searchCriteriaFactory","$location","dataServiceG2","urlStore","urlService","vehicleFinderService","userService","copartUtils","metaDataService","searchCriteriaConstants",function($scope,searchCriteriaFactory,$location,dataServiceG2,urlStore,urlService,vehicleFinderService,userService,copartUtils,metaDataService,searchCriteriaConstants){var self=$scope;self.form={};self.errors={};self.searchCriteria=searchCriteriaFactory.getSearchCriteria(searchCriteriaConstants.lotSearch);
var locale=$scope.$parent.locale;self.userConfig=userService.userConfig;var vehicleFinderPreference=userService.userConfig.vehicleFinderPreference||{};var getLotByVin=function(searchQuery){var lotSearchArr=[];lotSearchArr.push("ps_vin_number:"+searchQuery);var sendSoldFlagSearchCriteria=vehicleFinderPreference.widgets&&vehicleFinderPreference.widgets.indexOf("removeSoldFlag")>-1?false:true;if(sendSoldFlagSearchCriteria)lotSearchArr.push("sold_flag:"+false);var searchCriteria={MISC:lotSearchArr};self.searchCriteria.setMiscFilter(lotSearchArr);
dataServiceG2.getLotsByLotNumber({filter:searchCriteria},function(response){try{if(!_.isUndefined(response.data.data.results.content)&&response.data.data.results.content.length==1){var lot=response.data.data.results.content[0];$location.url(urlService.lotDetailUrl+lot.ln)}else{var displayStr=[];displayStr.push(self.vin);displayStr=displayStr.join(",");$location.url("/vehicleFinderSearch?displayStr\x3d"+displayStr+"\x26from\x3d"+$location.url())}}catch(e){self.searchCriteria.reset();console.log("Error fetching lot by lot number"+
e)}})};self.searchByVINNumber=function(){self.errors.vin=false;self.vin=self.form.vin;if(!self.vin||!copartUtils.validateVIN(self.vin))self.errors.vin=true;else getLotByVin(self.vin)};self.searchQuickPicks=function(query){var miscFilter=self.searchCriteria.getMiscFilter();miscFilter.push(query);self.searchCriteria.setMiscFilter(miscFilter);return true};self.searchByLotNumber=function(){self.emptyLookUpLot=false;self.inValidLookUpLot=false;var lotNumber=self.lotNumber;if(_.isEmpty(lotNumber))self.emptyLookUpLot=
true;else if(lotNumber.trim().length<3||lotNumber.trim().length>10||_.isNaN(lotNumber-0))self.inValidLookUpLot=true;else $location.url(urlStore.lotDetailUrl+lotNumber)}}]);
app.controller("vehicleFinderDirectiveController",["$scope","searchCriteriaFactory","$timeout","$location","$filter","dataServiceG2","$interpolate","$q","urlStore","localStorageService","userService","appConfigService","urlService","geocodingService","vehicleFinderService","searchCriteriaConstants",function($scope,searchCriteriaFactory,$timeout,$location,$filter,dataServiceG2,$interpolate,$q,urlStore,localStorageService,userService,appConfigService,urlService,geocodingService,vehicleFinderService,
searchCriteriaConstants){var self=$scope;self.parentScope=$scope.$parent;var locale=$scope.$parent.locale;var redoSearch=false;var CATEGORY="VEHCAT";var VTYPE="VEHTYPE";if(self.parentScope.cleanUp){self.parentScope.cleanUp();redoSearch=true}self.form={};self.form.zip=userService.userConfig.buyerZip;self.searchCriteria=searchCriteriaFactory.getSearchCriteria(searchCriteriaConstants.lotSearch);var quickPickCountUpdate=null;self.vehicleFinderQuickPicks=new QuickPicks;self.showLocation=true;self.defaultLocation=
{};self.categories=[];self.alerts=[];self.errors={zipCode:false,vin:false};self.childParam=self.childParam?true:false;self.vehicleTypes=self.appConfig.vehicleTypes||{};var searchYears=self.appConfig.searchYears||{};var zipMiles=self.appConfig.zipMiles||{};var formName="vehicle-finder-form";self.siteCode=userService.userConfig.siteCode;self.getLocations=function(){vehicleFinderService.getLocationsByInventory().then(function(response){self.locationsByInventory=response})};var addAlerts=function(type,
msg){self.alerts.push({msg:msg,type:type})};self.closeAlert=function(index){self.alerts.splice(index,1)};self.getVehicleType=function(form){if(form.vehicleType.category&&form.vehicleType.category===CATEGORY)return"#VehicleCatCode:"+CATEGORY+"_"+form.vehicleType.code;return"#VehicleTypeCode:"+VTYPE+"_"+form.vehicleType.code};self.search=function(form,eid){var displayStr=[];var formDetails={};if(form.model==null)formDetails.model="All Models";else formDetails.model=form.model;if(!form.vehicleMake)formDetails.vehicleMake=
"All Makes";else formDetails.vehicleMake=form.vehicleMake.description;var miscFilter=self.searchCriteria.getMiscFilter();eid=eid?eid:"";if(form.vehicleMake){var vehicleMake=form.vehicleMake;miscFilter.push("#MakeCode:"+vehicleMake.code+" OR #MakeDesc:"+vehicleMake.description);displayStr.push(vehicleMake.description)}if(form.model&&form.model!=="All Models"&&form.model!=="ALL MODELS"){miscFilter.push("#LotModel:"+form.model);displayStr.push(form.model)}if(form.category){miscFilter.push(form.category.searchQuery);
displayStr.push(form.category.itemName)}if(form.vehicleType)miscFilter.push(self.getVehicleType(form));if(form.yardLocation&&form.searchBy=="locations"){miscFilter.push("#PhysicalYardNo:"+form.yardLocation.yardNumber);displayStr.push(form.yardLocation.yardName)}else if(!_.isEmpty(self.defaultLocation)&&!self.showLocation){miscFilter.push("#PhysicalYardNo:"+self.defaultLocation.yardNumber);displayStr.push(self.defaultLocation.yardName)}if(form.state&&form.searchBy=="state"){miscFilter.push("#LocState:"+
'"'+form.state.yardStateCode+'"');displayStr.push(form.state.yardStateCode)}if(form.fromYear||form.toYear){var yearRngObject={};_.defaults(yearRngObject,{fromYear:"*",toYear:"*"});if(form.fromYear)yearRngObject.fromYear=form.fromYear;if(form.toYear)yearRngObject.toYear=form.toYear;if(form.fromYear&&form.toYear&&form.fromYear>form.toYear){addAlerts("danger",locale.messages["app.label.error.fromYear"]);return}var yearQueryStr=$interpolate("[{{fromYear}} TO {{toYear}}]")(yearRngObject);formDetails.yearRange=
yearQueryStr;copartOmnitureCallOne("doVehicleFinderSearch",formDetails);displayStr.push(yearQueryStr);miscFilter.push("#LotYear:"+yearQueryStr)}if(form.searchBy=="zip")if(!AppUtils.isUndefined(form.zip)&&form.zip!=""){self.errors.zipCode=false;geocodingService.getCoordinatesForZip(form.zip,function(retData){var zipObject={};_.defaults(zipObject,{latitude:"*",longitude:"*",miles:9999});zipObject.latitude=retData.latitude;zipObject.longitude=retData.longitude;if(form.miles)zipObject.miles=form.miles;
var zipQuery=$interpolate("{!geofilt pt\x3d{{latitude}},{{longitude}} sfield\x3dyard_location d\x3d{{miles}}}")(zipObject);miscFilter.push(encodeURIComponent(zipQuery));self.searchCriteria.setSortByZip(true);self.searchCriteria.setBuyerEnteredZip(form.zip);self.searchCriteria.setMilesAway(zipObject.miles);displayStr.push(form.zip);displayStr=displayStr.join(",");localStorageService.set(formName,form);var queryString=redoSearch?displayStr:displayStr+"\x26from\x3d"+$location.url();$location.url("/vehicleFinderSearch?displayStr\x3d"+
queryString+eid)})}else self.errors.zipCode=true;else{displayStr=displayStr.join(",");localStorageService.set(formName,form);var queryString=redoSearch?displayStr:displayStr+"\x26from\x3d"+$location.url();$location.url("/vehicleFinderSearch?displayStr\x3d"+queryString+eid)}self.searchCriteria.setMiscFilter(miscFilter)};self.getMakes=function(){self.makeList=vehicleFinderService.getMakes(self.form.vehicleType);self.getModels();if(self.form.vehicleMake)self.form.vehicleMake=_.findWhere(self.makeList,
self.form.vehicleMake)};self.getModels=function(){self.modelList=vehicleFinderService.getModels(self.form.vehicleType,self.form.vehicleMake)};var retrieveForm=function(){var previousForm=localStorageService.get(formName);if(previousForm!==undefined&&previousForm!=null){self.form.vehicleType=previousForm.vehicleType&&_.findWhere(self.vehicleTypes,previousForm.vehicleType);self.form.fromYear=previousForm.fromYear;self.form.toYear=previousForm.toYear;self.form.vehicleMake=previousForm.vehicleMake;self.form.model=
previousForm.model;self.form.searchBy=previousForm.searchBy;self.form.yardLocation=previousForm.yardLocation&&_.findWhere(self.yardLocations,previousForm.yardLocation);self.form.state=previousForm.state;self.form.zip=previousForm.zip;self.form.miles=previousForm.miles}else{self.form.vehicleType=vehicleFinderService.getDefaultVehicleType(self.vehicleTypes);self.form.fromYear=searchYears[11]?searchYears[11].code:"2006";self.form.toYear=searchYears[0]?searchYears[0].code:"2017";self.form.searchBy="locations";
self.form.miles=zipMiles[0]?zipMiles[0].description:""}self.getMakes(self.form.vehicleType);self.getModels()};self.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){self.form.vehicleType=vehicleTypes[0]});self.selectVehicleType=function(vehicleType){self.form.vehicleType=vehicleType;self.getMakes()};self.selectVehicleMake=function(vehicleMake){self.form.vehicleMake=vehicleMake;self.form.model=null;self.getModels()};self.selectVehicleModel=function(vehicleModel){if(vehicleModel!=null)self.form.model=
vehicleModel.description;else self.form.model=null};self.selectYardLocation=function(yardLocation){if(yardLocation!=null)self.form.yardLocation=yardLocation;else self.form.yardLocation=null};self.selectYardState=function(yardState){if(yardState!=null)self.form.state=yardState;else self.form.state=null};self.selectFromYear=function(fromYear){if(fromYear!=null)self.form.fromYear=fromYear.code};self.selectToYear=function(toYear){if(toYear!=null)self.form.toYear=toYear.code};var quickPicks=function(){dataServiceG2.getQuickPicks("HOME",
function(quickPicks){self.categories=quickPicks.category})};self.init=function(){self.searchCriteria.reset();retrieveForm();if(!self.childParam){self.getMakes();self.getLocations();self.getModels()}quickPicks()};$scope.$on("$destroy",function(){if(quickPickCountUpdate)$timeout.cancel(quickPickCountUpdate)});self.init()}]);
app.controller("vehicleFinderDirectiveController_GLOBAL",["$scope","$controller","appConfigService",function($scope,$controller,appConfigService){$scope.childParam=true;$controller("vehicleFinderDirectiveController",{$scope:$scope});var self=$scope;self.getMakes=function(){self.makeList=[];var vehicleTypeCode=self.form&&self.form.vehicleType?self.form.vehicleType.code:undefined;if(vehicleTypeCode)self.appConfig.getVehicleMakes(vehicleTypeCode,function(makes){self.makeList=makes})};self.getModels=
function(){self.modelList=[];var vehicleMakeCode=self.form&&self.form.vehicleMake?self.form.vehicleMake.code:undefined;if(vehicleMakeCode)self.appConfig.vehicleModels(vehicleMakeCode,function(models){self.modelList=models})};self.getLocations=function(){appConfigService.getLocationsListBySite(function(response){self.locationsByInventory=response})};self.getVehicleType=function(form){return"#VehicleTypeCode:"+form.vehicleType.code};self.childParam=false;self.init()}]);
app.controller("lotDetailsController",["$rootScope","$scope","$location","backToLinkService","dataServiceG2","$routeParams","$timeout","urlService","$q","userService","$locale","$filter","config","watchListService","appConfigService","staticLotDetails","dateFilter","searchCriteriaFactory","copartUser","trimFilter","$sce","auctionsCalendarService","bidService","siteCatalyst","$window","$route","deviceService","localStorageService","lotDetailsService","$cookies","ConditionReportService","copartUtils",
"copartVideosService","userLocationService","searchCriteriaConstants","metaDataService","shippingService",function($rootScope,$scope,$location,backToLinkService,dataServiceG2,$routeParams,$timeout,urlService,$q,userService,$locale,$filter,config,watchListService,appConfigService,staticLotDetails,dateFilter,searchCriteriaFactory,copartUser,trimFilter,$sce,auctionsCalendarService,bidService,siteCatalyst,$window,$route,deviceService,localStorageService,lotDetailsService,$cookies,conditionReport,copartUtils,
copartVideosService,userLocationService,searchCriteriaConstants,metaDataService,shippingService){var self=$scope;var staticLotDetailsPromise=staticLotDetails;self.siteRegionCode=userService.userConfig.siteRegionCode;self.isAnonymous=userService.isAnonymous();self.membershipExpiringSoon=userService.userConfig.membershipExpiringSoon;self.isBasicBuyer=userService.userConfig.userAccess==="BASIC";self.membershipExpiresIn=userService.userConfig.membershipExpiresIn.toString().split("");self.showAlertWidget=
self.isAnonymous||self.isBasicBuyer||!self.membershipExpiringSoon;self.showMemExpWidget=!self.isAnonymous&&self.membershipExpiringSoon;self.lotDetails=lotDetailsService.verifyAndGetLotIfExists(staticLotDetailsPromise);if(!self.lotDetails){self.lotExists=false;return}else if(self.lotDetails.searchUnavailable){self.searchUnavailable=true;self.lotExists=false;return}self.lotExists=true;self.lotNumber=$routeParams.lotId;self.lotInfoForSEO=$routeParams.lotInfo;self.bidLimitInquiryObj={};self.buildSheetVO=
new BuildSheetVO;self.addBidLimitInquiryVO={};self.estimates={};self.iconDesc="";self.played=false;self.showWatchList=false;self.showConditionReportButton=false;self.showConditionReportLink=false;self.bidEligibilityFlag=true;self.dynamiclotDetails={};self.isLive=false;self.slider={sliderImgId:"#sliderImg",hdImgExt:"_HR",openSeaDragonImgs:"/images/openSeaDragon/"};var lotDetailsPreference=userService.userConfig.lotDetailsPreference;var saleDateFormat=lotDetailsPreference.saleDateFormat;var saleTimeFormat=
lotDetailsPreference.saleTimeFormat;var locationHoursSaleTimeFormat="hh:mm a";var lastUpdatedDateFormat=lotDetailsPreference.lastUpdatedDateFormat;var libraryLoaded=false;self.firstRegDateFormat=lotDetailsPreference.firstRegDateFormat;self.showBuildSheet=lotDetailsPreference.showBuildSheet;self.isMobileSizeOrDevice=deviceService.isMobileSizeOrDevice();self.csvUrl="/data/export/downloadLotDetails?lotNumber\x3d"+self.lotDetails.ln;self.marketGuideUrl="/marketGuide/"+self.lotNumber+"/"+trimFilter(self.lotDetails.fv);
self.bidIncrements=bidService.getBidIncrements();self.yardNumber=self.lotDetails.phynumb;self.yourOfferAmount=0;self.activeTab=1;self.showOneMoreBidIncrementMsg=lotDetailsPreference.showOneMoreBidIncrementMsg;self.showGoAppMakeAnOffer=lotDetailsPreference.showGoAppMakeAnOffer;self.vehicleTypeDesc=lotDetailsPreference.vehicleTypeDesc;self.showChromeBuildSheet=lotDetailsPreference.showChromeBuildSheet;lotDetailsService.updateTitleAndDescMetaData($route,self.lotDetails,$location.path());self.lotDetails.lotId=
self.lotNumber;self.showDelivery=false;var userConfig=userService.userConfig;self.enableThreeSixtyImages=appConfigService.envConfigProps.enableThreeSixtyImages;var url="/lot/"+self.lotNumber;self.backToLink=$location.url();backToLinkService.setBackToLink(self.backToLink);backToLinkService.setBackToLinkText("lotdetail.label.backToLotDetails");localStorageService.set("no-navigation",false);self.showInspectorLink=userConfig.defaultDisplayPref.showInspectorLink;lotDetailsService.getOffSiteYardDetails(self.lotDetails).then(function(offSiteLotDetails){self.lotDetails.offsiteYard=
offSiteLotDetails});auctionsCalendarService.isYardLive(self.lotDetails.ynumb).then(function(flag){self.isLive=flag});self.searchCriteria=searchCriteriaFactory.getSearchCriteria(searchCriteriaConstants.lotSearch);self.searchCriteria.reset();self.userConfig=self.$parent.userConfig;self.buyerStatus=self.$parent.userConfig.buyerStatus;self.lotFullDesc=self.lotDetails.ld?self.lotDetails.ld:trimFilter(self.lotDetails.lcy)+" "+trimFilter(self.lotDetails.mkn)+" "+trimFilter(self.lotDetails.lm)+" "+trimFilter(self.lotDetails.ltd);
if($location.search().showflag&&$location.search().showflag=="true")$("#market-purchase-success").modal("show");if(self.userConfig.brand==="COPART")self.isDRIVELot=self.lotDetails.brand?self.lotDetails.brand==="DRIVE":"";watchListService.setWatchListDefinition($location.url());self.showAllPhotos=lotDetailsService.getPhotosIdFromParams($location.path());self.showRegularView=!(self.showAllPhotos&&(self.showAllPhotos.toUpperCase()=="ALL"||self.showAllPhotos.toUpperCase()=="PHOTOS"));self.yardDetails=
{};self.destZipLatitude=null;self.destZipLongitude=null;self.imageURL=appConfigService.getEnvConfigProps().imageBaseUrl;self.defaultMaxBidForOneMoreBidInc=appConfigService.getEnvConfigProps().defaultMaxBidForOneMoreBidInc;self.urlProtocol=urlService.getURLProtocol();self.locale=$scope.$parent.locale;self.loadingBidDetails=true;self.siteCode=copartUser.getUserConfig().siteCode;self.roles=copartUser.config.roles;self.showBuyItNow=false;self.showCounterBidInline=false;self.showPrelimBidInline=false;
self.showPrelimBidInline=false;self.showBidInfo=true;self.alreadyPurchasedPayNow=false;self.purchasedNowPayLater=false;self.marketGuideAvailableForALot="N";self.autoCheckSubscriptrionInfo=null;self.autoGuidePurchased=null;self.marketGuide=null;self.lotIconCodes=null;self.showAutoCheck="N";self.showInstaVin="N";self.isAnonymous=userService.isAnonymous();self.showBlackBook=true;var log=new Logger({name:"LotDetailsController",level:config.logLevel});self.internationalUser=userConfig.internationalMember;
if(self.internationalUser)self.typeOfDelivery="international";else self.typeOfDelivery="domestic";self.timeZoneAbbr=copartUser.getUserTimzoneAbbr();self.showProp65WarningMsg=false;self.showDisclaimerMsg=false;var dateFormatForStorageInfo="MMMM Do YYYY";var bidInquiryVO={};self.carriedBidInfo=$window.history.state;self.paymentmethodsForUKCR=[{code:"K",description:"Credit Card"},{code:"X",description:"Debit Card"},{code:"X",description:"International Debit Card"}];self.lotDetails.paymentMethod=null;
self.getInspectorURL=function($event){lotDetailsService.getInspectorLink(self.lotDetails,self.showInspectorLink,$event);copartOmnitureCallOne("doTagInspectionServicesLotDetails",copartUser.getUserConfig().buyerNumber)};self.scrollTo=function(){if(jQuery("#shipping-estimate").length>0)var shipping=jQuery("#shipping-estimate");else var shipping=jQuery("#shipping-status");jQuery("html, body").animate({scrollTop:shipping.offset().top-200},700,function(){if(jQuery(".delivery-estimate input").length>0)jQuery(".delivery-estimate input").focus()})};
self.validateDate=function(inputDate){if(!inputDate)return false;var date=new Date(inputDate);return angular.isDate(date)};self.isUpcomingLot=false;if(!self.validateDate(self.lotDetails.ad))self.isUpcomingLot=true;self.isKioskUser=copartUser.getUserConfig().isKioskBidder&&!self.isKioskBidTurnedOff;self.meaYards=userConfig.defaultDisplayPref.meaYards;self.isMeaYard=false;if(self.meaYards!=undefined)self.isMeaYard=self.meaYards.indexOf(self.lotDetails.phynumb+"")>-1;self.openRegularView=function(){self.showRegularView=
true};self.showAllPhotosView=function(event){try{s.products=";"+self.lotNumber;self.$parent.doTagPageView("lotphotos")}catch(e){log.error("site catalyst page view lotphotos call unsuccessful")}if(!event.ctrlKey){self.showRegularView=false;event.stopPropagation();event.preventDefault()}};var loadBidAndSaleInformation=function(){self.loadingBidDetails=false;self.loadingsaleEndInfo=false;generateSaleDate();generateLastUpdated();setReviveParams();loadDynamicFields();buildStorageAndPaymentDueDate()};metaDataService.prepareSEOLotDetails(self.lotDetails,
self.locale);var computeLotAuctionStatusFromSolr=function(){if(!(self.dynamiclotDetails&&self.dynamiclotDetails.lotAuctionStatus))auctionsCalendarService.isAuctionLive(Number(self.lotDetails.ynumb),self.lotDetails.al,self.lotDetails.ad,Number(self.lotDetails.aan)).then(function(flag){if(flag)self.dynamiclotDetails.lotAuctionStatus="LIVE_BIDDING";else self.dynamiclotDetails.lotAuctionStatus=self.lotDetails.pbf?"PRELIM_BIDDING":"COUNTER_BIDDING"})};var getDynamicLotDetails=function(){if(self.isAnonymous){self.dynamiclotDetails=
self.lotDetails.dynamicLotDetails||{};if(self.dynamiclotDetails.currentBid==0)self.dynamiclotDetails.bidIncrement=parseInt(self.lotDetails.ymin)+parseInt(bidService.getBidIncrement(self.lotDetails.ymin));else self.dynamiclotDetails.bidIncrement=bidService.getBidIncrement(self.dynamiclotDetails.currentBid);computeLotAuctionStatusFromSolr();loadBidAndSaleInformation()}else dataServiceG2.getDynamicLotDetails(self.lotNumber,lotDetailsDymicSuccessCallBack)};var getYardCordinates=function(){if(self.lotDetails.lat&&
self.lotDetails["long"])return;dataServiceG2.getLocationDetail(self.lotDetails.phynumb,function(response){var yardDetails={};_.defaults(yardDetails,{yardLatitude:"*",yardLongitude:"*"});var yardDetails=response.data||"";self.lotDetails.lat=yardDetails.yardLatitude;self.lotDetails["long"]=yardDetails.yardLongitude})};var computeSellerIconVisibility=function(){if(userConfig.companyCode=="COPARTUK"){if(self.lotDetails.lic&&self.lotDetails.lic.indexOf("MUNT")>-1)self.showSellerIcon=true}else if(userConfig.companyCode==
"COPART"){var sellerCompanyCode=self.lotDetails.scn||"";self.showSellerIcon=copartUtils.validateIfImage(sellerCompanyCode)}};var computeBlackBookVisibility=function(){if(self.lotDetails.sr===undefined||self.lotDetails.sr=="")self.showBlackBook=false};var computeProp65WarningMsg=function(){var stateCodesToShowProp65WarningMsg=lotDetailsPreference.stateCodesToShowProp65WarningMsg||"";if(!_.isEmpty(stateCodesToShowProp65WarningMsg)){var memberRegisteredState=!self.isAnonymous?self.userConfig.memberContactInfo.mailingAddressState:
"";if(_.contains(stateCodesToShowProp65WarningMsg,self.lotDetails.locState)||_.contains(stateCodesToShowProp65WarningMsg,memberRegisteredState))self.showProp65WarningMsg=true;else if(!self.isAnonymous)userLocationService.getUserLocationInfo().then(function(ipLocationDetails){if(_.contains(stateCodesToShowProp65WarningMsg,ipLocationDetails.stateCode))self.showProp65WarningMsg=true})}};var computeDisclaimerMsg=function(){var yardsToShowDisclaimerMsg=lotDetailsPreference.yardsToShowDisclaimerMsg||"";
if(!_.isEmpty(yardsToShowDisclaimerMsg))if(_.contains(yardsToShowDisclaimerMsg,self.yardNumber))self.showDisclaimerMsg=true};function computeBidInfoVisibility(){self.showBidInfo=self.showBidInfo&&self.lotDetails.las!=="UNASSIGNED_TO_AUCTION"}var getOfferForLot=function(){self.isMakeAnOfferAmount=false;dataServiceG2.getOfferForLot(self.lotNumber,userConfig.buyerNumber,function(response){var data=response.data;_.each(data,function(e){if(e.offerAmt!=null&&e.offerAmt!=0&&e.offerAmt!=""){self.yourOfferAmount=
e.offerAmt;self.isMakeAnOfferAmount=true}})})};self.getGoLotReport=function(){dataServiceG2.getGoLotReport(self.lotNumber,function(response){$("#goAppReportTable tbody").empty();$scope.reportData=response.data;$scope.exteriorData=response.data.exterior;$scope.interiorData=response.data.interior;$scope.mechanicalData=response.data.mechanical;if(response.data.addnts)$scope.additionalNotes=response.data.addnts;$("#goAppReportModal").modal("show")})};self.acceptOfferModal=function(){$("#MakeAnOfferAcceptModal").modal("show")};
self.setActiveTabInformation=function(tabToSet){self.activeTab=tabToSet;copartOmnitureCallOne("doTagMoreInformation","")};self.setActiveTabModal=function(modalTabToSet){self.activeTabModal=modalTabToSet;if(self.activeTabModal===2)if($scope.interior360)self.renderpannellum()};self.play=function(){self.played=true;window.CI360._viewers[0].play()};self.stop=function(){self.played=false;window.CI360._viewers[0].stop()};jQuery("#threesixty").on("hidden.bs.modal",function(){window.CI360._viewers[0].stop();
self.played=false});self.renderpannellum=function(){pannellum.viewer("panorama",{"type":"equirectangular","panorama":self.INTERIOR_360[0].url,"autoLoad":true,"keyboardZoom ":true})};self.openThreeSixtyModal=function(event){$("#threesixty").modal("show");console.log(window.CI360);if(libraryLoaded==false)$timeout(function(){if($scope.exterior360){window.CI360.init();window.CI360._viewers[0].play();self.played=true;self.setActiveTabModal(1);jQuery("canvas").click(function(){self.played=false})}else if($scope.interior360)self.renderpannellum();
libraryLoaded=true},100)};self.goToBidInformation=function(){jQuery("html, body").animate({scrollTop:jQuery(".bid-information").offset().top},"slow")};self.acceptOffer=function(){var data={};data.lotNumber=self.lotNumber;data.offerAmt=self.dynamiclotDetails.buyTodayBid;data.buyerNumber=userConfig.buyerNumber;data.secretKey=self.dynamiclotDetails.randomHash;if(self.lotDetails.gou!=""&&self.lotDetails.gou!=undefined)data.golot=true;else data.golot=false;data.type="ACCEPT";dataServiceG2.acceptOffer(data,
function(response){var responseCode=response.returnCodeDesc;if(response.returnCode!=-1&&responseCode==="Success"){$("#buyitnowModal").modal("show");self.purchaseSuccess=true;copartOmnitureCallMulti("doTagLotDetailsAcceptOffer",[userConfig.buyerNumber])}else if(response.returnCode==-1){self.purchaseSuccess=false;var errorCode=response.data.errorObject.code;if(errorCode!=null){self.acceptOfrError=getMakeAnOfferErrorMessage(response.data.errorObject);$("#buyitnowModal").modal("show")}}})};var init=function(){computeBidInfoVisibility();
getLotImages();getDynamicLotDetails();retrieveLotIconCodes();getLotIconObjects();getLotVideo();getYardCordinates();conditionReport.setDisplayConditionReportFlag(self.lotDetails,self.userConfig);conditionReport.handleCrReportCallback($routeParams.lotId,self.lotDetails.ynumb,showCRModal);computeSellerIconVisibility();computeBlackBookVisibility();computeProp65WarningMsg();computeDisclaimerMsg();if(self.showGoAppMakeAnOffer&&!self.isAnonymous)getOfferForLot()};var getLotVideo=function(){var successCallBack=
function(response){try{if(response.data&&response.data.data.lotVideo[0].url){var url=response.data.data.lotVideo[0].url;url=copartVideosService.validateAndFrameYouTubeUrl(url);self.videoUrl=$sce.trustAsResourceUrl(url)}}catch(error){log.error(error)}};dataServiceG2.getLotVideo(self.lotNumber,successCallBack)};self.getPreviousLot=function(){lotDetailNavigationService.getPreviousLot(self)};self.getNextLot=function(){lotDetailNavigationService.getNextLot(self)};var generateLastUpdated=function(){if(self.validateDate(self.lotDetails.lu))self.displayLastUpdatedDate=
moment.utc(self.lotDetails.lu).tz(userService.userConfig.selectedTimezone).format(lastUpdatedDateFormat)};var generateSaleDate=function(){if(!self.lotDetails.ifs&&self.validateDate(self.lotDetails.ad)){self.displaySaleDate=moment.utc(self.lotDetails.ad).tz(userService.userConfig.selectedTimezone).format(saleDateFormat);self.displaySaleTime=moment.utc(self.lotDetails.ad).tz(userService.userConfig.selectedTimezone).format(saleTimeFormat);if(!self.isLotSold()&&self.dynamiclotDetails.lotAuctionStatus!=
"COUNTER_BIDDING")calculateTimeDifference(self.lotDetails.ad)}};var calculateTimeDifference=function(saleDateTime){var currDate=moment().utc();if(self.dynamiclotDetails.lotAuctionStatus=="LIVE_BIDDING"){self.displayTimeLeftForSale=self.locale.messages["app.label.auctionsCalendar.live"]+"!";return}if(currDate.isAfter(moment.utc(saleDateTime)))return;self.showAddToCalendar=true;self.outLookStartDate=moment(saleDateTime).format("YYYY-MM-DDTHH:mm");self.outLookEndDate=moment(self.outLookStartDate).add(30,
"minutes").format("YYYY-MM-DDTHH:mm");self.outLookSubject=self.lotFullDesc;self.outLookUrl=$location.host();self.displayTimeLeftForSale=auctionsCalendarService.timeToAuction(saleDateTime)};self.isLotSold=function(){return!!self.lotDetails.ils};function retrieveStoredBidInfoAndAction(){if(self.carriedBidInfo){var action=$filter("sanitize_html")(self.carriedBidInfo.action);if(action==="prelimBid"){self.dynamiclotDetails.bidAmount=$filter("sanitize_html")(self.carriedBidInfo.bidAmount);self.dynamiclotDetails.maximumBid=
$filter("sanitize_html")(self.carriedBidInfo.maximumBid);self.openPrelimBidModal()}else if(action==="increaseBid"){self.dynamiclotDetails.bidAmount=$filter("sanitize_html")(self.carriedBidInfo.bidAmount);self.openIncreaseBidModal()}else if(action==="makeAnOffer")self.openMakeAnOfferInline();else if(action==="buyItNow")self.toggleBuyItToday();urlService.removeStateFromRouteHistory()}self.carriedBidInfo=null}var defaultOneMoreIncement=function(){if(parseInt(self.dynamiclotDetails.bidAmount)>=self.defaultMaxBidForOneMoreBidInc||
parseInt(self.dynamiclotDetails.maximumBid)>=self.defaultMaxBidForOneMoreBidInc)self.dynamiclotDetails.oneMoreIncrement=true;else self.dynamiclotDetails.oneMoreIncrement=false};var lotDetailsDymicSuccessCallBack=function(response){try{if(response.data.returnCode==-1)self.dynamicLotDetailsError=response.data.data.errorObject;else self.dynamiclotDetails=response.data.data.lotDetails||{}}catch(e){log.error(e)}self.showBidInfo=self.showBidInfo&&"UNASSIGNED_TO_AUCTION"!==self.dynamiclotDetails.lotAuctionStatus;
loadBidAndSaleInformation();retrieveStoredBidInfoAndAction()};var loadDynamicFields=function(){if(self.dynamiclotDetails.eligibility!=undefined&&self.dynamiclotDetails.eligibility.eligibility!=undefined)self.bidEligibilityFlag=self.dynamiclotDetails.eligibility.eligibility;self.dynamiclotDetails.isBuyerEligibleToExport=self.dynamiclotDetails.saleStatus&&self.dynamiclotDetails.saleStatus.toUpperCase()=="SOLD"?self.dynamiclotDetails.buyerHighBidder:true;if(!self.isLotSold())self.showWatchList=true;
if(self.dynamiclotDetails.buyTodayFlag=="Y"||self.dynamiclotDetails.buyTodayFlag=="B")self.buyTodayBid=self.dynamiclotDetails.buyTodayBid;else self.buyTodayBid=self.dynamiclotDetails.currentBid;self.showQuoteInDelivery=lotDetailsService.showQuoteInDelivery(self.dynamiclotDetails);self.intlRedirectStatus=$location.search().status;self.intlRedirectTrackingUrl=$location.search().trackingUrl;self.intlRedirectClientRefId=$location.search().clientRefId;self.intlRedirectProviderName=$location.search().providerName;
if(copartUser.getUserConfig().defaultDisplayPref&&copartUser.getUserConfig().defaultDisplayPref.internationalShipping){var titleTypes=[];if(userService.userConfig.defaultDisplayPref&&userService.userConfig.defaultDisplayPref.titleType)titleTypes=userService.userConfig.defaultDisplayPref.titleType;self.displayIntlShipping=self.lotDetails&&self.lotDetails.vehTypDesc&&(self.lotDetails.vehTypDesc=="AUTOMOBILE"||self.lotDetails.vehTypDesc=="MOTORCYCLE")&&self.lotDetails.lstg!==99&&!self.lotDetails.offFlg&&
!titleTypes.includes(self.lotDetails.td);if(self.displayIntlShipping){self.internationalUser=userConfig.internationalMember;if(self.internationalUser)self.typeOfDelivery="international";else self.typeOfDelivery="domestic"}else self.typeOfDelivery="domestic";dataServiceG2.lotCurrentShippingStatus(userConfig.buyerNumber,self.lotNumber,function(response){var location=$location.search();self.intlOrder=true;self.currentLotShippingData=[];if(response&&response.returnCode!=-1){for(var i=0;i<response.length;++i)if(response[i].memberShippingItemDetails.trackingUrl){currentLotShipping=
{};currentLotShipping["providerCode"]=response[i].memberShippingItemDetails.providerCode;currentLotShipping["transactionUrl"]=response[i].memberShippingItemDetails.trackingUrl;currentLotShipping["destinationIso3CountryCode"]=response[i].memberShippingItemDetails.destinationCountryCode;currentLotShipping["destinationPortCode"]=response[i].memberShippingItemDetails.destinationPortCode;currentLotShipping["trackingStatus"]=response[i].memberShippingItemDetails.trackingStatus;currentLotShipping["providerName"]=
response[i].memberShippingItemDetails.providerName;currentLotShipping["destinationPortName"]=response[i].memberShippingItemDetails.destinationPortName;currentLotShipping["destinationCountryName"]=response[i].memberShippingItemDetails.destinationCountryName;currentLotShipping["clientRefId"]=response[i].clientRefId;self.currentLotShippingData.push(currentLotShipping)}if(location.hasOwnProperty("status")&&self.currentLotShippingData&&self.currentLotShippingData.length>0){self.currentShippingOrder=self.currentLotShippingData[0];
self.vendorContactInfo=self.locale.getMessage("app.label.orderQuestionsModal.")+self.currentShippingOrder.providerName;$("#shippingSuccess").modal("show")}}else if(self.intlRedirectStatus!=undefined&&self.intlRedirectTrackingUrl!=undefined&&self.intlRedirectClientRefId!=undefined){self.intlOrder=false;self.redirectIntlShipData={};self.redirectIntlShipData["trackingStatus"]=self.intlRedirectStatus;self.redirectIntlShipData["transactionUrl"]=self.intlRedirectTrackingUrl;self.redirectIntlShipData["clientRefId"]=
self.intlRedirectClientRefId;self.redirectIntlShipData["providerName"]=self.intlRedirectProviderName;self.currentLotShippingData.push(self.redirectIntlShipData);if(location.hasOwnProperty("status")&&self.currentLotShippingData&&self.currentLotShippingData.length>0){self.redirectIntlShipOrderData=self.currentLotShippingData[0];self.vendorContactInfo=self.locale.getMessage("app.label.orderQuestionsModal.")+self.redirectIntlShipOrderData.providerName;self.showDelivery=false;self.displayError=false;$("#redirectShippingStatusModel").modal("show")}}else{self.displayError=
true;self.showDelivery=true}console.log("Current Lot Shipping Data: ",response)},function(error){console.log(error);self.showDelivery=true})}else{self.typeOfDelivery="domestic";self.showDelivery=true}self.showEstimateInDelivery=lotDetailsService.showEstimateInDelivery(self.dynamiclotDetails);self.showLocationDeliveryWidget=self.showQuoteInDelivery||self.showEstimateInDelivery};var buildStorageAndPaymentDueDate=function(){if(self.dynamiclotDetails.pdd&&self.dynamiclotDetails.pdd.dateAsInt&&self.validateDate(self.dynamiclotDetails.pdd.date))self.displayPaymentDueDate=
moment.tz(self.dynamiclotDetails.pdd.date,copartUser.getUserConfig().selectedTimezone).format(dateFormatForStorageInfo);if(self.dynamiclotDetails.lstgdetails){self.numberOfStorageDays=self.dynamiclotDetails.lstgdetails.numberOfDays;if(self.validateDate(self.dynamiclotDetails.lstgdetails.storageStartDate))self.displayStorageStartDate=moment.tz(self.dynamiclotDetails.lstgdetails.storageStartDate,copartUser.getUserConfig().selectedTimezone).format(dateFormatForStorageInfo)}};self.onCalculate=function(){var estimate=
[];estimate.push(trimFilter(self.lotDetails.zip));estimate.push(trimFilter(self.lotDetails.zipTo));estimate.push(trimFilter(self.lotDetails.mkn));estimate.push(trimFilter(self.lotDetails.lm));estimate.push(self.lotDetails.lcy);estimate.push(trimFilter(self.lotDetails.fv));estimate.push(true);dataServiceG2.getDeliveryEstimate(estimate,function(response){if(response.returnCode==1&&response.data.estimate.amount){self.amount=response.data.estimate.amount;self.showAmount=true}else self.displayError=true})};
var location={};location.threeCharCountryCode="USA";self.viewMaps=function(){location.zipCode=self.estimates.newZipCode;self.errorMessage=null;if(!self.estimates.showViewMapLink){jQuery("#viewMapError").modal("show").find(".modal-body").html(self.locale.messages["app.lotdetail.viewmap.error.001"]);return}dataServiceG2.updateLocationInfo(location,function(response){if(response.returnCode!=-1&&!_.isEmpty(response.data)){self.updatedLocation=response.data||[];if(self.updatedLocation.length>0){self.destZipLatitude=
self.updatedLocation[0].latitude;self.destZipLongitude=self.updatedLocation[0].longitude;window.open("http://maps.google.com/maps?saddr\x3d"+self.lotDetails.lat+","+self.lotDetails["long"]+"\x26daddr\x3d"+self.destZipLatitude+","+self.destZipLongitude)}else{log.error("update Location Call -\x3e Failed "+response);jQuery("#viewMapError").modal("show").find(".modal-body").html(self.locale.messages["app.lotdetail.viewmap.error.002"])}}else jQuery("#viewMapError").modal("show").find(".modal-body").html(self.locale.messages["app.lotdetail.viewmap.error.002"])})};
self.purchaseSubscriptionForMarketGuide=function(){var marketGuideInquiryVO={"lotId":self.lotNumber,"price":self.marketGuide.price};dataServiceG2.createMGuidePurchaseRequest(marketGuideInquiryVO,function(response){if(response.returnCode==1){var batchNumber=response.data.marketGuide.batchNumber;var requestParam={};requestParam.transactionId=batchNumber;requestParam.GATEWAY_URL_KEY="MARKET_GUIDE";requestParam.cancelCallBackUrl="lot/"+self.lotNumber;requestParam.successCallBackURL="lot/"+self.lotNumber+
"?showflag\x3dtrue";dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==1)$window.location.href=trimFilter(response.data.pciURL);else log.error("Error in Gateway")})}else log.error(" Market Guide Purchase Request denied  as the Response is"+response.returnCode)})};self.checkWhyNotEligible=function(){jQuery("#eligibilityErrorModal").modal()};self.checkBidEligibility=function(){function displayStatusResult(isEligible){if(isEligible){jQuery(".check-now").addClass("ng-hide");
jQuery(".eligible").removeClass("ng-hide");jQuery(".not-eligible").addClass("ng-hide")}else{jQuery(".check-now").addClass("ng-hide");jQuery(".not-eligible").removeClass("ng-hide");jQuery(".eligible").addClass("ng-hide")}}if(!userService.isAnonymous())dataServiceG2.getBidEligibility(self.lotNumber,self.lotDetails.locCountry,function(response){if(response.returnCode==1){self.eligibilityChecked=true;self.bidEligibilityResponse=response.data;self.eligibleToBid=self.bidEligibilityResponse.memberEligible;
self.notEligibleBid=!self.eligibleToBid;self.islotEligible=self.bidEligibilityResponse.lotStatusCheckEvaluation?self.bidEligibilityResponse.lotStatusCheckEvaluation.isLotStatusOpen:"";self.isbuyerHasValidPhotoId=self.bidEligibilityResponse.photoLicenseCheckEvaluation?self.bidEligibilityResponse.photoLicenseCheckEvaluation.buyerHasValidPhotoId:"";self.isbuyerLicenseToBid=self.bidEligibilityResponse.eligibilityChecks?self.bidEligibilityResponse.eligibilityChecks.LicenseRulesCheckStep:"";self.isBidderEligible=
self.bidEligibilityResponse.buyerStatusCheckEvaluation?self.bidEligibilityResponse.buyerStatusCheckEvaluation.isBuyerActive:"";self.isBrokerEligible=self.bidEligibilityResponse.buyerStatusCheckEvaluation?self.bidEligibilityResponse.buyerStatusCheckEvaluation.isParentBuyerActive:"";self.isInternationTitle=self.bidEligibilityResponse.eligibilityChecks?self.bidEligibilityResponse.eligibilityChecks.InternationalTitleRestrictionCheckStep:"";self.hasPurchaceLimit=self.bidEligibilityResponse.eligibilityChecks?
self.bidEligibilityResponse.eligibilityChecks.PurchaseLimitRulesCheckStep:"";self.isBrokerRestriction=self.bidEligibilityResponse.eligibilityChecks?self.bidEligibilityResponse.eligibilityChecks.BrokerRestrictionCheckStep:"";displayStatusResult(self.eligibleToBid)}else if(JSON.parse(response.data.errorObject).status=="BUYER_INFO_NOT_AVAILABLE"){self.eligibilityChecked=true;displayStatusResult()}else log.error("Error occurred while calling bid eligibility service"+response)})};self.openMarketGuide=
function(){if(!userService.isAnonymous())dataServiceG2.getMarketGuideDetails(self.lotNumber,function(response){if(response.returnCode==1){self.marketGuide=response.data.marketGuide;if(self.marketGuide.marketGuidePurchased=="Y")$location.url("/marketGuide/"+self.lotNumber+"/"+trimFilter(self.lotDetails.fv)+"/"+trimFilter(self.marketGuide.marketGuidePurchased)+"/"+trimFilter(self.marketGuide.secretKeyForMarketGuide));else $("#marketGuideReport").modal("show")}else log.error(" Market Guide Purchase Information  denied for "+
self.lotNumber+" as the Response is"+response.returnCode)})};self.openAutoCheckGuideForLoggedInUsers=function(){if(userService.isAnonymous())return;self.openAutoCheckGuide()};self.openAutoCheckGuide=function(){if(containsElementInArray(self.roles,"ROLE_BROKER_BIDDER"))$("#bidderUnderBuyerMessage").modal("show");else $("#autocheckDisclaimerReport").modal("show")};self.requestAutoCheckKey=function(){self.loadingAutoCheckDetails=true;self.autoCheckErrorMessage=null;$("#autocheckDisclaimerReport").modal("hide");
var autoCheckKeyVO={"mode":"A","key_in":"0","vin_in":trimFilter(self.lotDetails.fv)};dataServiceG2.getAuthTokenForAutoCheck(self.lotDetails.fv,self.lotDetails.ln,function(response){if(response.returnCode!=-1&&!_.isEmpty(response.data)){self.loadingAutoCheckDetails=false;self.aurl="/g2mext/autocheck/"+trimFilter(self.lotDetails.fv)+"?token\x3d"+trimFilter(response.data)+"\x26buyerNumber\x3d"+userConfig.buyerNumber+"\x26siteCode\x3d"+userConfig.siteCode+"\x26lotNumber\x3d"+self.lotNumber;$("#autocheckReport").modal("show")}else{log.error("Error getting token for autocheck -\x3e Failed "+
response);self.loadingAutoCheckDetails=false;$("#autocheckReport").modal("show");self.autoCheckErrorMessage="Your Limit exceeded for Autocheck report"}},function(error){self.loadingAutoCheckDetails=false;$("#autocheckReport").modal("show");self.autoCheckErrorMessage="Your Limit exceeded for Autocheck report";log.error("Error getting token for autocheck -\x3e Failed "+error)})};var retrieveLotIconCodes=function(){dataServiceG2.retrieveLotIconCodes(self.lotNumber,function(response){if(response.returnCode==
1){if(response.data.lotIconCodes.iconCodes)self.lotIconCodes=response.data.lotIconCodes.iconCodes.trim().split("|");if(_.contains(self.lotIconCodes,"IV"))self.showInstaVin="Y";if(_.contains(self.lotIconCodes,"AUTOCHECK")||_.contains(self.lotIconCodes,"AUTOCHECKP"))self.showAutoCheck="Y";if(_.contains(self.lotIconCodes,"MKT_GUIDE")||_.contains(self.lotIconCodes,"MKT_GUIDEP"))self.marketGuideAvailableForALot="Y";if(_.contains(self.lotIconCodes,"CR"))self.showConditionReportButton=true;if(_.contains(self.lotIconCodes,
"GOCAR"))self.showGoReport=true}else log.error("Error in fetching lot icon codes")})};self.addToWatchList=watchListService.addToWatchList;self.isAlreadyAdded=watchListService.isAlreadyAdded;self.removeFromWatchList=watchListService.removeFromWatchList;self.openCounterBidCnfrmModal=function(actionType){if(!userService.isAnonymous()){self.counterBidErrorMsg="";if(actionType=="acceptSellerMin"){self.successBid=self.dynamiclotDetails.minBid;self.submitBid=self.acceptSellerMininimumBid}if(actionType==
"keepCurrentBid"){self.successBid=self.dynamiclotDetails.currentBid;self.submitBid=self.confirmKeepCurrentBid}if(actionType=="counterBid"){if(!self.dynamiclotDetails.counterBidAmount||parseInt(self.dynamiclotDetails.counterBidAmount)<0){self.counterBidErrorMsg=self.locale.getMessage("lotdetail.error.bid.valid.amount");return}else if(parseInt(self.dynamiclotDetails.counterBidAmount)<parseInt(self.dynamiclotDetails.currentBid)||parseInt(self.dynamiclotDetails.counterBidAmount)<parseInt(self.dynamiclotDetails.currentBid)+
parseInt(self.dynamiclotDetails.bidIncrement)){var validBid=parseInt(self.dynamiclotDetails.currentBid)+parseInt(self.dynamiclotDetails.bidIncrement);self.counterBidErrorMsg=self.locale.getMessage("lotdetail.error.not.lower.than")+" "+validBid;return}self.successBid=self.dynamiclotDetails.counterBidAmount;self.submitBid=self.confrimCounterBid}self.showCounterBidInline=true;self.showBidInfo=false}};self.cancelCounterBidInlineModal=function(){self.showBidInfo=true;self.showCounterBidInline=false;self.counterBidErrorMsg=
""};var closeBidModal=function(id){self.loadingBidDetails=true;if($("#"+id).is(":visible"))$("#"+id).modal("hide")};var counterBidSuccessCallBack=function(response){self.cancelCounterBidInlineModal();if(response.returnCode==1)$("#counterBidCnfrmSuccessModal").modal("show");else{var lotReturnCode=response.data.errorObject;if(lotReturnCode.code.trim()=="WB84013"){$("#counterBidErrorModal").modal("show");getDynamicLotDetails();return}else if(self.locale.messages["lotdetail.error.code."+lotReturnCode.code.trim()])self.bidErrorMsg=
self.locale.getMessage("lotdetail.error.code."+lotReturnCode.code.trim());else self.bidErrorMsg=lotReturnCode.message;$("#bidErrorModal").modal("show")}getDynamicLotDetails()};self.invokeCounterBidService=function(bidInquiryVO,callBack){self.loadingBidDetails=true;dataServiceG2.confirmCounterBid(bidInquiryVO,callBack)};self.confrimCounterBid=function(){bidInquiryVO={};bidInquiryVO.eventType="counterBid";bidInquiryVO.lotId=self.lotNumber;bidInquiryVO.maxBid=self.dynamiclotDetails.counterBidAmount;
bidInquiryVO.bidAmount=self.dynamiclotDetails.counterBidAmount;self.invokeCounterBidService(bidInquiryVO,counterBidSuccessCallBack)};self.confirmKeepCurrentBid=function(){bidInquiryVO={};bidInquiryVO.eventType="keepCurrentBid";bidInquiryVO.lotId=self.lotNumber;bidInquiryVO.bidAmount=self.dynamiclotDetails.currentBid;self.invokeCounterBidService(bidInquiryVO,counterBidSuccessCallBack)};self.acceptSellerMininimumBid=function(){bidInquiryVO={};bidInquiryVO.eventType="acceptSellerMin";bidInquiryVO.lotId=
self.lotNumber;bidInquiryVO.minBid=self.dynamiclotDetails.minBid;self.invokeCounterBidService(bidInquiryVO,counterBidSuccessCallBack)};function incrementValue(bidValue,incrementValue){bidValue=parseInt(bidValue);incrementValue=parseInt(incrementValue);var baseValue=self.dynamiclotDetails.currentBid+incrementValue;if((bidValue+incrementValue)%incrementValue==0)return bidValue+incrementValue<=9999999?bidValue+incrementValue<baseValue?baseValue:bidValue+incrementValue:9999999;var incrementFactor=Math.abs(incrementValue-
bidValue%incrementValue);return bidValue+incrementFactor<=9999999?bidValue+incrementFactor<baseValue?baseValue:bidValue+incrementFactor:9999999}self.increment=function(event){if(event!==undefined&&event=="counterbid")self.dynamiclotDetails.bidAmount=self.dynamiclotDetails.counterBidAmount;if(self.dynamiclotDetails.bidAmount==""||self.dynamiclotDetails.bidAmount==undefined)if(self.dynamiclotDetails.currentBid<=0)self.dynamiclotDetails.bidAmount=incrementValue(self.dynamiclotDetails.currentBid,self.dynamiclotDetails.bidIncrement);
else self.dynamiclotDetails.bidAmount=incrementValue(self.dynamiclotDetails.currentBid,bidService.getBidIncrement(self.dynamiclotDetails.currentBid));else if(self.dynamiclotDetails.currentBid<=0)self.dynamiclotDetails.bidAmount=incrementValue(self.dynamiclotDetails.bidAmount,self.dynamiclotDetails.bidIncrement);else self.dynamiclotDetails.bidAmount=incrementValue(self.dynamiclotDetails.bidAmount,bidService.getBidIncrement(self.dynamiclotDetails.currentBid));if(event!==undefined&&event=="counterbid")self.dynamiclotDetails.counterBidAmount=
self.dynamiclotDetails.bidAmount};function decrementValue(bidValue,decrementValue){bidValue=parseInt(bidValue);decrementValue=parseInt(decrementValue);var baseValue=self.dynamiclotDetails.currentBid+decrementValue;if((bidValue-decrementValue)%decrementValue==0)return bidValue-decrementValue>baseValue?bidValue-decrementValue:baseValue;var decrementFactor=Math.abs(decrementValue-bidValue%decrementValue);return bidValue-decrementValue+decrementFactor>baseValue?bidValue-decrementValue+decrementFactor:
baseValue}self.decrement=function(event){if(event!==undefined&&event=="counterbid")self.dynamiclotDetails.bidAmount=self.dynamiclotDetails.counterBidAmount;if(self.dynamiclotDetails.bidAmount==""||self.dynamiclotDetails.bidAmount==undefined)if(self.dynamiclotDetails.currentBid<=0)self.dynamiclotDetails.bidAmount=decrementValue(self.dynamiclotDetails.currentBid,self.dynamiclotDetails.bidIncrement);else self.dynamiclotDetails.bidAmount=decrementValue(self.dynamiclotDetails.currentBid,bidService.getBidIncrement(self.dynamiclotDetails.currentBid));
else if(self.dynamiclotDetails.currentBid<=0)self.dynamiclotDetails.bidAmount=decrementValue(self.dynamiclotDetails.bidAmount,self.dynamiclotDetails.bidIncrement);else self.dynamiclotDetails.bidAmount=decrementValue(self.dynamiclotDetails.bidAmount,bidService.getBidIncrement(self.dynamiclotDetails.currentBid));if(event!==undefined&&event=="counterbid")self.dynamiclotDetails.counterBidAmount=self.dynamiclotDetails.bidAmount};self.openPrelimBidModal=function(){defaultOneMoreIncement();self.clearBidFieldsErrorMsg=
"";if(!userService.isAnonymous()){self.startingBidErrorMsg="";self.maxBidErrorMsg="";if(!self.dynamiclotDetails.bidAmount||parseInt(self.dynamiclotDetails.bidAmount)<0)self.startingBidErrorMsg=self.locale.getMessage("lotdetail.error.bid.valid.amount");if(!self.dynamiclotDetails.maximumBid||parseInt(self.dynamiclotDetails.maximumBid)<0)self.maxBidErrorMsg=self.locale.getMessage("lotdetail.error.bid.valid.amount");if(self.startingBidErrorMsg||self.maxBidErrorMsg)return;if(parseInt(self.dynamiclotDetails.bidAmount)<
parseInt(self.dynamiclotDetails.bidIncrement))self.startingBidErrorMsg=self.locale.getMessage("lotdetail.error.bid.enter.mimimum")+" "+self.dynamiclotDetails.bidIncrement;if(parseInt(self.dynamiclotDetails.maximumBid)<parseInt(self.dynamiclotDetails.bidAmount))self.maxBidErrorMsg=self.locale.getMessage("lotdetail.error.maxbid.less.than.startbid");if(!self.startingBidErrorMsg&&!self.maxBidErrorMsg){self.showPrelimBidInline=true;self.showBidInfo=false}}else{var paramMap={"bidAmount":self.dynamiclotDetails.bidAmount,
"maximumBid":self.dynamiclotDetails.maximumBid,"action":"prelimBid"};urlService.saveStateToRouteHistory(paramMap)}};self.openIncreaseBidModal=function(){defaultOneMoreIncement();self.clearBidFieldsErrorMsg="";if(!userService.isAnonymous()){self.maxBidErrorMsg="";if(!self.dynamiclotDetails.bidAmount||parseInt(self.dynamiclotDetails.bidAmount)<0){self.maxBidErrorMsg=self.locale.getMessage("lotdetail.error.bid.valid.amount");return}var currentMaxBid=parseInt(self.dynamiclotDetails.maxBid)>parseInt(self.dynamiclotDetails.currentBid)?
self.dynamiclotDetails.maxBid:self.dynamiclotDetails.currentBid;var validBid=parseInt(currentMaxBid)+parseInt(self.dynamiclotDetails.bidIncrement);if(parseInt(self.dynamiclotDetails.bidAmount)<validBid)self.maxBidErrorMsg=self.locale.getMessage("lotdetail.error.bid.enter.mimimum")+" "+validBid;if(!self.maxBidErrorMsg){self.showIncreaseBidInline=true;self.showBidInfo=false}}else{var paramMap={"bidAmount":self.dynamiclotDetails.bidAmount,"action":"increaseBid"};urlService.saveStateToRouteHistory(paramMap)}};
self.openMakeAnOfferInline=function(){self.clearBidFieldsErrorMsg="";if($("#makeAnOfferBtn").hasClass("action-disable-btn")){self.clearBidFieldsErrorMsg=self.locale.getMessage("lotdetail.error.label.toSelect.makeOffer")+self.locale.getMessage("lotdetail.error.clear.bidFields");return}if(!userService.isAnonymous()){self.showMakeAnOfferInline=true;self.maxBidErrorMsg="";self.showBidInfo=false}else{var paramMap={"action":"makeAnOffer"};urlService.saveStateToRouteHistory(paramMap)}};self.closeMakeAnOfferModal=
function(){self.maxBidErrorMsg="";self.showMakeAnOfferInline=false;self.showBidInfo=true;self.dynamiclotDetails.offerBidAmount=""};self.cancelPrelimBidInline=function(){self.maxBidErrorMsg="";self.showPrelimBidInline=false;self.showBidInfo=true};self.cancelIncreaseBidInline=function(){self.maxBidErrorMsg="";self.showIncreaseBidInline=false;self.showBidInfo=true};self.cancelMisTypedBidInline=function(){self.maxBidErrorMsg="";self.showMisTypedBidInline=false;self.showBidInfo=true};var isLicenceRequired=
function(errorCode){if(errorCode==self.locale.getMessage("lotdetail.error.code.licenceRequired")||errorCode==self.locale.getMessage("lotdetail.error.code.licenceRequired.5004")){$("#licenceRequiredModal").modal("show");return true}};var isIncBuyingPwrRequired=function(errorCode){if(errorCode==self.locale.getMessage("lotdetail.error.code.increase.buying.power")){self.bidderUnderBroker=copartUser.hasRoleAccess("ROLE_BROKER_BIDDER")||copartUser.hasRoleAccess("ROLE_BIDDER");$("#pciRedirectionModal").modal("show");
return true}};var getBidErrorMessage=function(errorObj){if(!errorObj)return;var errorCode=errorObj.errorCode?errorObj.errorCode.trim():"";if(self.locale.messages["lotdetail.error.code."+errorCode])return self.locale.getMessage("lotdetail.error.code."+errorCode,errorObj.outLowerBid,errorObj.outHigherBid);else return errorObj.errorMessage};var prelimBidSuccessCallBack=function(response,callBack){self.maxBidErrorMsg="";self.cancelPrelimBidInline();self.cancelIncreaseBidInline();self.cancelMisTypedBidInline();
if(response.returnCode==1){if(response.data.result.lots[self.lotNumber]){var lotReturnCode=response.data.result.lots[self.lotNumber];lotDetailsService.callBidEligibilityService(lotReturnCode,self.lotDetails);if(lotReturnCode&&lotReturnCode.errorCode){var errorCode=lotReturnCode.errorCode?lotReturnCode.errorCode.trim():"";self.failureBidInquiryVO=bidInquiryVO;if(isLicenceRequired(errorCode)||isIncBuyingPwrRequired(errorCode)){self.loadingBidDetails=false;return}self.bidErrorMsg=getBidErrorMessage(lotReturnCode);
$("#bidErrorModal").on("hidden.bs.modal",function(){if(lotReturnCode.errorCode=="5008")$route.reload()});$("#bidErrorModal").modal("show");if(callBack)callBack()}}else{lotDetailsService.callBidEligibilityService(bidInquiryVO,self.lotDetails);$("#bidCnfrmSuccessModal").modal("show");try{copartOmnitureCallMulti("doTagPrelimBid",[userService.userConfig.buyerNumber,bidInquiryVO.lotId,bidInquiryVO.maxBid,bidInquiryVO.bidAmount])}catch(e){log.debug("Error executing site catalyst call")}}getDynamicLotDetails()}};
self.invokePrelimBidService=function(bidInquiryVO,misTypedBidErrorCallBack){self.loadingBidDetails=true;if(!isBuyerEligible()){self.loadingBidDetails=false;return}var bidInquiryVOArray=[];bidInquiryVOArray.push(bidInquiryVO);dataServiceG2.prelimBidForLot(bidInquiryVOArray,prelimBidSuccessCallBack,misTypedBidErrorCallBack)};var buildBidInquiryObj=function(){self.successBid=self.dynamiclotDetails.bidAmount;bidInquiryVO={};bidInquiryVO.lotId=self.lotNumber;bidInquiryVO.bidAmount=self.dynamiclotDetails.bidAmount;
bidInquiryVO.startingBid=self.dynamiclotDetails.bidAmount;bidInquiryVO.oneMoreIncrement=self.dynamiclotDetails.oneMoreIncrement?"Y":"N";self.callSiteCatalystForBidIncrement(self.dynamiclotDetails.oneMoreIncrement);bidInquiryVO.lotCountry=self.lotDetails.locCountry;bidInquiryVO.yardNumber=self.lotDetails.phynumb};self.increaseBidForLot=function(){buildBidInquiryObj();bidInquiryVO.maxBid=self.dynamiclotDetails.bidAmount;bidInquiryVO.currentBid=self.dynamiclotDetails.currentBid;bidInquiryVO.currentMaxBid=
self.dynamiclotDetails.maxBid;self.invokePrelimBidService(bidInquiryVO,null)};self.prelimBidForLot=function(){buildBidInquiryObj();bidInquiryVO.maxBid=self.dynamiclotDetails.maximumBid;self.invokePrelimBidService(bidInquiryVO,null)};self.callSiteCatalystForBidIncrement=function(isOneMoreIncrement){if(isOneMoreIncrement)copartOmnitureCallMulti("doTagSelectBidIncrement",[userService.userConfig.buyerNumber])};self.openMisTypedModal=function(){self.showMisTypedBidInline=true;self.maxBidErrorMsg="";self.showBidInfo=
false};self.sumbitBidForMistypedBid=function(){if(!userService.isAnonymous())if(!self.dynamiclotDetails.misTypedMaxbid||self.dynamiclotDetails.misTypedMaxbid<0)self.maxBidErrorMsg=self.locale.getMessage("lotdetail.error.bid.valid.amount");else if(parseInt(self.dynamiclotDetails.misTypedMaxbid)<parseInt(self.dynamiclotDetails.currentBid))self.maxBidErrorMsg=self.locale.getMessage("lotdetail.error.bid.enter.mimimum")+" "+self.dynamiclotDetails.currentBid;else if(parseInt(self.dynamiclotDetails.misTypedMaxbid)>=
parseInt(self.dynamiclotDetails.maxBid))self.maxBidErrorMsg=self.locale.getMessage("lotdetail.error.bid.should.be.less.than.previous");else{bidInquiryVO={};bidInquiryVO.eventType="misTypedBid";bidInquiryVO.lotId=self.lotNumber;bidInquiryVO.bidAmount=self.dynamiclotDetails.misTypedMaxbid;self.successBid=self.dynamiclotDetails.misTypedMaxbid;copartOmnitureCallMulti("doTagMistypedbidSuccess",[userService.userConfig.buyerNumber,self.lotNumber]);self.invokePrelimBidService(bidInquiryVO,function(){if(self.maxBidErrorMsg){self.showMisTypedBidInline=
true;self.showBidInfo=false}})}};self.confirmBuyItNowPurchase=function(){if(self.dynamiclotDetails.buyTodayBid>0&&(self.dynamiclotDetails.buyTodayFlag==="Y"||self.dynamiclotDetails.buyTodayFlag=="B")){if(!isBuyerEligible())return;bidInquiryVO={};bidInquiryVO.lotId=self.lotNumber;bidInquiryVO.bidAmount=self.dynamiclotDetails.buyTodayBid;bidInquiryVO.yardNumber=self.lotDetails.phynumb;bidInquiryVO.lotCountry=self.lotDetails.locCountry;dataServiceG2.confirmBuyItNowPurchase(bidInquiryVO,function(response){if(response.returnCode==
1){log.info(" Purchase successfull lot:"+bidInquiryVO.lotId+" for amt:"+bidInquiryVO.bidAmount);self.loadingsaleEndInfo=true;$("#buyitnowModal").modal("show");copartOmnitureCallMulti("doTagLotDetailsBuyitNow",[userConfig.buyerNumber]);self.purchaseSuccess=true}else{log.info(" Purchase unsuccessful for lot:"+bidInquiryVO.lotId+" for amt:"+bidInquiryVO.bidAmount);var errorCode=response.data&&response.data.errorCode?response.data.errorCode.trim():"";if(isLicenceRequired(errorCode)||isIncBuyingPwrRequired(errorCode))return;
$("#buyitnowModal").modal("show");self.purchaseSuccess=false;self.buyItNowError=getBidErrorMessage(response.data)}})}};self.closePurchaseModal=function(){if(self.purchaseSuccess){self.loadingBidDetails=true;getDynamicLotDetails()}self.showBuyItNow=false;self.showBidInfo=true};self.payForBuyItNow=function(){$("#purchase-success").removeClass("fade").modal("hide");var url="/paymentsDue";log.info(" payForBuyItNow ROUTE URL:"+url);$location.url(url)};self.disableBuyItNow=function(){if(!self.isAnonymous&&
(self.dynamiclotDetails.bidAmount||self.dynamiclotDetails.maximumBid))return"action-disable-btn";self.clearBidFieldsErrorMsg="";return""};self.toggleBuyItToday=function(){self.clearBidFieldsErrorMsg="";if($("#buyItNowBtn").hasClass("action-disable-btn")){self.clearBidFieldsErrorMsg=self.locale.getMessage("lotdetail.error.label.toSelect.buyItNow")+self.locale.getMessage("lotdetail.error.clear.bidFields");return}if(!userService.isAnonymous())if(self.showBuyItNow){self.showBuyItNow=false;self.showBidInfo=
true;self.alreadyPurchasedPayNow=false;self.purchasedNowPayLater=false}else{self.showBuyItNow=true;self.showBidInfo=false;self.alreadyPurchasedPayNow=false;self.purchasedNowPayLater=false}else{var paramMap={"action":"buyItNow"};urlService.saveStateToRouteHistory(paramMap)}try{siteCatalyst.addToQueue("doTagBuyItNowClick",{});siteCatalyst.executeCall("doTagBuyItNowClick")}catch(e){}};self.openFutureSaleModal=function(){$("#futureSaleModal").modal("show")};self.upcomingLotModal=function(){$("#upcomingLotModal").modal("show")};
self.getLocationHours=function(startTime,endTime,showLocationHoursFlag){if(showLocationHoursFlag)return dateFilter(startTime,locationHoursSaleTimeFormat)+" - "+dateFilter(endTime,locationHoursSaleTimeFormat);else return self.locale.getMessage("app.label.not.available")};self.goToGlossary=function(){$location.path("/glossary")};self.viewInventory=function(){localStorageService.remove("restore-search-state");var displayStr=[];var miscFilter=self.searchCriteria.getMiscFilter();if(self.lotDetails.mkn){miscFilter.push("lot_make_desc:"+
self.lotDetails.mkn);displayStr.push(self.lotDetails.mkn)}if(self.lotDetails.lm){miscFilter.push("lot_model_desc:"+self.lotDetails.lm);displayStr.push(self.lotDetails.lm)}if(self.lotDetails.lcy){displayStr.push(self.lotDetails.lcy);miscFilter.push("lot_year:"+self.lotDetails.lcy)}displayStr=displayStr.join(",");self.searchCriteria.setMiscFilter(miscFilter);$location.url("/vehicleFinderSearch?displayStr\x3d"+displayStr)};var getLotIconObjects=function(){self.iconCodesObjArray=lotDetailsService.getValidHighLightIcons(self.lotDetails.lic)};
var openEpicVinReport=function(vin){var url=appConfigService.getEnvConfigProps().epicVinUrl||"";window.open(url.replace("${FULL_VIN}",trimFilter(vin)))};var tagEpicVIN=function(){var siteCatalystVal={};siteCatalystVal.fname="doTagInstaVin";siteCatalystVal.lotId=self.lotNumber;siteCatalyst.addToQueue("doTagInstaVin",siteCatalystVal);siteCatalyst.executeCall("doTagInstaVin")};self.getEpicVinURL=function(){tagEpicVIN();if(self.isAnonymous)return;else openEpicVinReport(self.lotDetails.fv)};self.toolTipForTtlDesc=
function(){var searchDesc="TITLE_LONG_DESC."+trimFilter(self.lotDetails.stt)+"."+trimFilter(self.lotDetails.ts);var searchDescObj=_.find(self.appConfig.getTitleLongDescription(),function(obj){if(obj.code==searchDesc)return true});return searchDescObj&&searchDescObj.description?searchDescObj.description:trimFilter(self.lotDetails.ts)+" "+trimFilter(self.lotDetails.td)};self.openAsIsModal=function(){self.fetchAsIsCmsContent=true;$("#bidInfoAsIsModal").modal("show")};self.increaseBuyingPower=function(){var currentBidInquiry=
{};currentBidInquiry.lotNumber=self.lotNumber;currentBidInquiry.yardNumber=self.lotDetails.ynumb;currentBidInquiry.auctionDate="0";currentBidInquiry.bidAmount=self.failureBidInquiryVO.maxBid;dataServiceG2.getCurrentBidDetails(currentBidInquiry,function(bidResponse){if(bidResponse.returnCode==1){self.requiredDeposit=bidResponse.data.currentBidDetails.requiredDeposit;self.currentDeposit=bidResponse.data.currentBidDetails.currentDepositBal;self.addBidLimitInquiryVO.lotNumber=self.lotNumber;self.addBidLimitInquiryVO.buyingPower=
currentBidInquiry.bidAmount;self.addBidLimitInquiryVO.depositAmount=self.requiredDeposit==null?0:self.requiredDeposit;dataServiceG2.increaseBuyingPower(self.addBidLimitInquiryVO,function(response){if(response.returnCode==1){var batchNumber=response.data.batchNumber;var requestParam={};requestParam.transactionId=batchNumber;requestParam.GATEWAY_URL_KEY="ADD_DEPOSIT";requestParam.cancelCallBackUrl="lot/"+self.lotNumber;requestParam.successCallBackURL="lot/"+self.lotNumber;requestParam.pciCallBackUrl=
$location.absUrl();requestParam.pciCallBackBaseUrl=$location.absUrl();requestParam.currentBidAmount=self.dynamiclotDetails.currentBid;requestParam.currentBidCount=self.dynamiclotDetails.currentBid;requestParam.currentDeposit=self.currentDeposit;requestParam.maxBid=self.dynamiclotDetails.maximumBid;requestParam.requiredDeposit=self.requiredDeposit;requestParam.pciCallBackEventId="valBid";requestParam.pciCallBackExecution="els3";dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==
1)$window.location.href=trimFilter(response.data.pciURL);else log.error("Error in Gateway")},"data/payments/setPciParamForBidding")}})}else{log.error("Error increasing bid-limit");$("#pciRedirectionModal").modal("hide");$("#PCIerrorOccured").modal("show");return}})};self.upgradeMember=function(){var requestParam={};requestParam.GATEWAY_URL_KEY="UPGRADE_MEMBERSHIP";requestParam.cookieValue=$location.path()+"?reAuthn\x3dtrue";dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==
1)$window.location.href=response.data.pciURL.trim();else log.error("Error in Gateway")})};self.conditionReportChecks=function(){if(self.isAnonymous)return;conditionReport.conditionReportChecks(self.lotDetails,self.dynamiclotDetails,showCRModal,confirmDialogue);copartOmnitureCallOne("doTagConditionReportNew",copartUser.getUserConfig().buyerNumber)};self.conditionReportComplete=function(){if(self.isAnonymous)return;copartOmnitureCallOne("doTagConditionReportComplete",copartUser.getUserConfig().buyerNumber)};
self.buyConditionReport=function(){if(self.isAnonymous)return;copartOmnitureCallOne("doTagBuyConditionReport",copartUser.getUserConfig().buyerNumber)};var getLotImages=function(){dataServiceG2.getLotImages($scope.lotNumber,function(response){if(response!=null){var imagesList=response.data.data.imagesList||{};$scope.fullSizeImages=imagesList.FULL_IMAGE;$scope.thumbNailImages=imagesList.THUMBNAIL_IMAGE;$scope.highResImages=imagesList.HIGH_RESOLUTION_IMAGE;$scope.interior360=imagesList.INTERIOR_360!==
null&&imagesList.INTERIOR_360!==undefined&&imagesList.INTERIOR_360!==""&&imagesList.INTERIOR_360.length>0;$scope.exterior360=imagesList.EXTERIOR_360!==null&&imagesList.EXTERIOR_360!==undefined&&imagesList.EXTERIOR_360!==""&&imagesList.EXTERIOR_360.length>0;if($scope.exterior360||$scope.interior360)jQuery(".view-threesixty").removeClass("hide");if($scope.exterior360){$scope.EXTERIOR_360=imagesList.EXTERIOR_360;self.imageThreeSixty=$scope.EXTERIOR_360[0].url.substr(0,$scope.EXTERIOR_360[0].url.lastIndexOf("/")+
1);self.imageFileThreeName=$scope.EXTERIOR_360[0].url.replace(/^.*[\\\/]/,"").slice(0,$scope.EXTERIOR_360[0].url.lastIndexOf("_"));self.imageFileThreeSixty=self.imageFileThreeName.replace(/^.*[\\\/]/,"").slice(0,self.imageFileThreeName.lastIndexOf("_"));self.format=$scope.EXTERIOR_360[0].url.split(".").pop();self.frameCount=$scope.EXTERIOR_360[0].frameCount-1}if($scope.interior360)$scope.INTERIOR_360=imagesList.INTERIOR_360;var populateHDImageUrl=function(i){var obj=_.findWhere($scope.highResImages,
{"sequenceNumber":i+1});$scope.thumbNailImages[i].hdUrl=obj.url};_.each($scope.fullSizeImages,function(e,i){$scope.thumbNailImages[i].fullUrl=e.url;$scope.thumbNailImages[i].highRes=e.highRes;if(e.highRes)populateHDImageUrl(i)})}},self.lotDetails.locCountry)};var setReviveParams=function(){self.reviveappendurl="\x26lotid\x3d"+self.lotNumber+"\x26yardlocation\x3d"+self.lotDetails.yn+"\x26categoryid\x3d"+self.lotDetails.bstl+"\x26name\x3d"+self.lotFullDesc+"\x26odometer\x3d"+self.lotDetails.orr+"\x26make\x3d"+
self.lotDetails.mkn+"\x26model\x3d"+self.lotDetails.lm+"\x26year\x3d"+self.lotDetails.lcy+"\x26color\x3d"+self.lotDetails.clr+"\x26drive\x3d"+self.lotDetails.drv+"\x26keys\x3d"+self.lotDetails.hk+"\x26bodystyle\x3d"+self.lotDetails.bstl+"\x26fuel\x3d"+self.lotDetails.ft+"\x26saletype\x3ds1\x26"+"\x26buyitnow\x3d "+(self.dynamiclotDetails.buyTodayFlag=="Y"||false)+"\x26salestatus\x3d"+self.locale.messages["lotdetail.bidStatus."+self.dynamiclotDetails.bidStatus]+"\x26acv\x3d"+self.lotDetails.la+"\x26repaircost\x3d "+
self.lotDetails.rc+"\x26saledate\x3d"+dateFilter(self.lotDetails.ad,self.saleDateFormat)+"\x26website\x3dwww.copart.com\x26_wco_replace\x3dDefault Content"};self.stateFilter=function(item){return item.type==="USA"||item.type==="CAN"};var containsElementInArray=function(inputArray,value){for(var index=0;index<inputArray.length;index++)if(inputArray[index]===value)return true;return false};self.getAllLaneSaleListResultUrl=function(lotDetails){localStorageService.remove("restore-search-state");var yardNumber=
lotDetails.ynumb;var auctionId=lotDetails.acId;var saleListUrl="/saleListResult/"+yardNumber+"?location\x3d"+lotDetails.syn+"\x26from\x3d/lot/"+lotDetails.ln+"\x26yardNum\x3d"+lotDetails.ynumb+"\x26saleDate\x3dFuture\x26brand\x3d"+lotDetails.brand;var auctionData=auctionsCalendarService.getAuctionDetails(auctionId,yardNumber,lotDetails.ad);auctionData.then(function(auction){if(auction)$location.url(urlService.getAllLaneSaleListResultUrl(auction));else $location.url(saleListUrl)})};self.getAuctionURIWithLotNumber=
function(lot){return urlService.getAuctionURIWithLotNumber(lot.ynumb,lot.al,lot.ln)};init();self.bidIncrementGuidelinesModal=function(){$("#bidIncrementGuidelinesModal").modal("show")};self.lotDescriptionModal=function(){$("#lotDescriptionModal").modal("show")};self.showAdditionalLotNotes=function(){var successCallBack=function(response){self.additionalLotNotes=response.lotNotes};dataServiceG2.getAdditionalLotNotes(self.lotNumber,successCallBack);$("#showAdditionalLotNotes").modal("show")};$scope.$on("$destroy",
function(){if(!self.prevNextLotClicked){localStorageService.get("from-rec-engine")?"":localStorageService.remove("lot-navigation-info");jQuery("body").removeClass("cursor-pointer")}});$("#closepurchase").on("click",function(){$(".buy-itnow").hide();$(".sale-purchase-end").show()});self.showHD=function(event){var idx=self.slider.target.getCurrentSlide();var parent=$($('li[class\x3d"lot-details-images"]')[idx]);var imgElement=parent.children(":first-child");var highResUrl=self.highResImages[idx]?self.highResImages[idx].url:
self.fullSizeImages[idx].url;var parentWidth=parent.width();var parentHeight=parent.height();imgElement.width(parentWidth);imgElement.height(parentHeight);imgElement.html("");OpenSeadragon({element:imgElement[0],prefixUrl:self.slider.openSeaDragonImgs,autoResize:true,showFullPageControl:false,defaultZoomLevel:1,minZoomLevel:1,visibilityRatio:1,tileSources:{type:"image",url:highResUrl}});if(event.target.nodeName==="IMG")$(event.target.parentElement).hide();else $(event.target.parentElement).hide();
event.preventDefault()};self.doTagConditionReport=function(conditionReportGrade){copartOmnitureCallOne("doTagConditionReport",conditionReportGrade)};self.doTagRunLights=function(runLights){if(runLights)copartOmnitureCallOne("doTagRunLights",runLights)};function showCRModal(message,isCROrdered){self.isCROrdered=isCROrdered;var modalElement=$("#conditionReport");modalElement.find("p").html(message);modalElement.modal({backdrop:"static",keyboard:false})}function confirmDialogue(message,purchasePrice,
lotNumber,callback){var modalElement=$("#confirmDialog");var isConfirmed=false;self.crLotNumber=lotNumber;self.purchasePriceText=purchasePrice;self.baseAmount=0;self.baseAmountVAT=0;self.cnvFee=0;self.cnvFeeVAT=0;self.totalCnVFeeInclVAT=0;self.totalCRPurchase=0;conditionReport.baseAmount=0;conditionReport.baseAmountVAT=0;conditionReport.totalCnVFeeInclVAT=0;self.currencyCodeForCR=userConfig.defaultDisplayPref.currencyCode;self.lotDetails.paymentMethod=self.paymentmethodsForUKCR[0].code;self.selectPayMethod();
$("#confirmDialog .purchaseMsg").html(message);modalElement.find();modalElement.modal("show");modalElement.find("#confirmBtn").click(function(){self.buyConditionReport();modalElement.modal("hide");isConfirmed=true});modalElement.on("hidden.bs.modal",function(e){if(_.isFunction(callback))callback(isConfirmed)})}self.selectPayMethod=function(){if(self.lotDetails.paymentMethod!=null)dataServiceG2.getConditionReportCharges(self.crLotNumber,self.lotDetails.paymentMethod,function(response){if(response.returnCode>
0){self.baseAmount=response.data.baseAmount;self.baseAmountVAT=response.data.baseAmountVAT;self.cnvFee=response.data.cnvFee;self.cnvFeeVAT=response.data.cnvFeeVAT;self.totalCnVFeeInclVAT=response.data.totalCnVFeeInclVAT;self.totalCRPurchase=response.data.totalCRPurchase;conditionReport.baseAmount=self.baseAmount;conditionReport.baseAmountVAT=self.baseAmountVAT;conditionReport.totalCnVFeeInclVAT=self.totalCnVFeeInclVAT}else return});else{self.baseAmount=0;self.baseAmountVAT=0;self.cnvFee=0;self.cnvFeeVAT=
0;self.totalCnVFeeInclVAT=0;self.totalCRPurchase=0;conditionReport.baseAmount=0;conditionReport.baseAmountVAT=0;conditionReport.baseAmountVAT=0}};self.checkForTitlePending=function(){if(self.lotDetails.td&&self.lotDetails.td.indexOf("(P)")>0){self.titlePendingTooltip=true;self.lotDetails.td=self.lotDetails.td.substring(0,self.lotDetails.td.indexOf("(P)"))}};self.getBuildSheet=function(){var successCallBack=function(response){try{if(response.data&&response.data.buildSheetData){self.buildSheetVO=response.data.buildSheetData;
var modalElement=$("#buildSheetsResponse");modalElement.find();modalElement.modal("show")}else{var modalElement=$("#buildSheets");modalElement.find();modalElement.modal("show")}}catch(error){log.error(error)}};dataServiceG2.getBuildSheetForLot(self.lotNumber,successCallBack)};var isBuyerEligible=function(){if(self.siteRegionCode=="de"&&!self.bidEligibilityFlag){$("#licenceRequiredModal").modal("show");return false}return true};self.submitMakeAnOffer=function(){self.maxBidErrorMsg="";if(!self.dynamiclotDetails.offerBidAmount||
parseInt(self.dynamiclotDetails.offerBidAmount)<=0){self.maxBidErrorMsg=self.locale.getMessage("lotdetail.error.bid.valid.amount");return}if(self.dynamiclotDetails.offerBidAmount>=self.dynamiclotDetails.buyTodayBid){self.maxBidErrorMsg=self.locale.getMessage("lotdetail.error.valid.offerAmount");return}if(self.dynamiclotDetails.offerBidAmount<=self.yourOfferAmount){self.maxBidErrorMsg=self.locale.getMessage("lotdetail.error.yourOffer.valid.amount");return}self.loadingBidDetails=true;bidInquiryVO={};
bidInquiryVO.lotId=self.lotNumber;bidInquiryVO.offerAmt=self.dynamiclotDetails.offerBidAmount;if(self.lotDetails.gou!=""&&self.lotDetails.gou!=undefined)bidInquiryVO.golot=true;else bidInquiryVO.golot=false;bidInquiryVO.type="MAKE";bidInquiryVO.buyTodayBid=self.dynamiclotDetails.buyTodayBid;bidInquiryVO.currentBid=self.dynamiclotDetails.currentBid;bidInquiryVO.bidAmount=self.dynamiclotDetails.offerBidAmount;dataServiceG2.submitMakeAnOffer(bidInquiryVO,function(response){if(response.returnCode==1){self.yourOfferAmount=
response.data.offer.offerAmt;self.makeAnOfrSuccess=true;self.closeMakeAnOfferModal();$("#makeAnOfrSuccessModal").modal("show");copartOmnitureCallMulti("doTagLotDetailsMakeanOffer",[userConfig.buyerNumber]);getDynamicLotDetails();self.isMakeAnOfferAmount=true}else if(response.returnCode==-1){self.makeAnOfrSuccess=false;self.loadingBidDetails=false;var errorCode=response.data.errorObject.code;if(errorCode!=null){if(!_.isEmpty(response.data.errorObject.paramMap)){var paramMap=response.data.errorObject.paramMap;
var errorCodeMsg="lotdetail.error.code.";var prevValidOfferAmt=$filter("globalize_currency_using_code")(paramMap.prevValidOfferAmt,self.lotDetails.cuc);var nextValidOfferAmt=$filter("globalize_currency_using_code")(paramMap.nextValidOfferAmt,self.lotDetails.cuc);if(errorCode.trim().toUpperCase()=="C219004"||errorCode.trim().toUpperCase()=="10034")errorCodeMsg="lotdetail.makeanoffer.error.code.";self.makeAnOfrError=self.locale.getMessage(errorCodeMsg+errorCode,prevValidOfferAmt,nextValidOfferAmt)}else self.makeAnOfrError=
getMakeAnOfferErrorMessage(response.data.errorObject);$("#makeAnOfrSuccessModal").modal("show")}}else{self.openMakeAnOfferInline();self.loadingBidDetails=false;var errorObject=response.errorObject;if(!errorObject)return;if(errorObject.errorCode&&errorObject.errorCode.trim()==self.locale.getMessage("lotdetail.error.code.licenceRequired"))self.maxBidErrorMsg=self.locale.getMessage("lotdetail.bidInfo.alerts.dueTo.licensing");else self.maxBidErrorMsg=getBidErrorMessage(errorObject)}})};var getMakeAnOfferErrorMessage=
function(errorObj){if(!errorObj)return;var errorCode=errorObj.code?errorObj.code.trim():"";if(self.locale.messages["app.acceptOffer.error.errorcode."+errorCode])return self.locale.getMessage("app.acceptOffer.error.errorcode."+errorCode);else return errorObj.message};var getAcceptOfferErrorMessage=function(errorObj){if(!errorObj)return;var errorCode=errorObj.code?errorObj.code.trim():"";if(self.locale.messages["lotdetail.error.code."+errorCode])return self.locale.getMessage("lotdetail.error.code."+
errorCode);else return errorObj.message};self.getChromeBuildSheetData=function(){dataServiceG2.getChromeBuildSheetData(self.lotNumber,function(response){$scope.buildSheetData=response.data;$scope.buildSheetData.engines=_.each($scope.buildSheetData.engines,function(i){i.fuelEcoCityHwy=(i.fuelEcoCityHigh?i.fuelEcoCityHigh+"/":"")+(i.fuelEcoHwyHigh?i.fuelEcoHwyHigh:"")});if(response.returnCode==1)$("#chromeBuildSheet").modal("show");else log.error("Error ")})};self.getLocationData=function(){dataServiceG2.getLocationDetail(self.yardNumber,
function(response){self.showZip=true;self.locationDetail=response.data})}}]);
app.controller("locationsListController",["$scope","$http","$locale","dataServiceG2","localStorageService","$location","userService",function($scope,$http,$locale,dataServiceG2,localStorageService,$location,userService){var self=$scope;self.locationsList=null;self.location={};self.usaAvailable=true;self.regions=[];self.location.primaryCountry="usa";self.location.selectedRegion="NORTH_AMERICA";self.location.primaryContinent="NORTH_AMERICA";self.region=appInit.regionCode;self.lang=appInit.localeString;
self.userConfig=userService.userConfig;localStorageService.remove("_continentVal");self.isAnonymous=userService.isAnonymous();var deviceAgent=navigator.userAgent.toLowerCase();var ipad=deviceAgent.match(/(ipad)/);var iphone=deviceAgent.match(/(iphone)/);self.init=function(){getRegionList()};var getRegionList=function(){dataServiceG2.getRegions(function(response){self.regions=response.data.continents.sort();self.location.selectedRegion=$location.search().region||response.data.primaryContinent;self.location.primaryCountry=
response.data.primaryCountry;self.getYardLocations(self.location.selectedRegion);if(self.location.primaryCountry=="deu"||self.location.primaryCountry=="esp"||self.location.primaryCountry=="ind"){self.staticList=[];self.gstackSites=["deu","ind","esp"];self.gstackSiteNames=["GERMANY","INDIA","SPAIN"];for(var i in self.gstackSites){var countryCode=self.gstackSites[i],countryName=self.gstackSiteNames[i];self.staticList[countryCode]=[];self.staticList[countryCode].countryName=self.locale.messages["locations.label."+
countryName];self.staticList[countryCode].displayLink=self.locale.messages["locations.displayLink."+countryName];self.staticList[countryCode].countryLink="https://"+self.staticList[countryCode].displayLink;self.staticList[countryCode].siteCode=self.locale.messages["locations.siteCode."+countryName]}}})};var createLocationUrl=function(locationObj){return locationObj[0].locationUrl};self.buildVirtualLocationObj=function(country,state,yardNumber,yardName,location,brand){var saleListUrl="/saleListResult/"+
yardNumber+"?location\x3d"+location+"\x26from\x3d/lot\x26yardNum\x3d"+yardNumber+"\x26brand\x3d"+brand;var obj={id:"COPART|"+yardNumber,baseUrl:undefined,locationUrl:saleListUrl,openNewTab:false,yardCity:"",yardName:yardName,yardNumber:yardNumber,yardStateName:state,yardCountryCode:country.toUpperCase()};return obj};self.getYardLocations=function(continent){if(continent=="NORTH_AMERICA"){self.finalList=[];dataServiceG2.getLocationsList(continent,function(response){var countries=response.data.countries;
if(!_.isEmpty(countries)&&countries.hasOwnProperty("can"))countries["can"].push(self.buildVirtualLocationObj("can","NEW BRUNSWICK",295,"NB - Atlantic Canada Auction","ATLANTIC CANADA AUCTION","COPART"),self.buildVirtualLocationObj("can","NOVA SCOTIA",295,"NS - Atlantic Canada Auction","ATLANTIC CANADA AUCTION","COPART"));self.countryList=[];if(self.location.primaryCountry=="can")self.countryList.push(self.location.primaryCountry);else self.countryList.push("usa");for(var countryCode in countries){self.yardStates=
_.chain(countries[countryCode]).groupBy("yardStateName").map(function(value1,key1){return{yardStateName:key1.toUpperCase(),yardNumbers:_.chain(value1).groupBy("yardName").map(function(locationObj,key2){return{yardNumber:locationObj[0].yardNumber,openNewTab:locationObj[0].openNewTab,baseUrl:locationObj[0].baseUrl,yardName:_.pluck(locationObj,"yardName").toString(),yardCity:key2,locationUrl:createLocationUrl(locationObj)}}).value()}}).value();self.yardStates=_.sortBy(self.yardStates,function(num){return num.yardStateName});
var listOfStates=[];var lengthOfStates=self.yardStates.length;self.finalList[countryCode]={};self.countryList.push(countryCode);self.finalList[countryCode].list=self.yardStates;if(countryCode=="can"){self.finalList[countryCode].rowClass=[];self.finalList[countryCode].regionClass=[];if(iphone||ipad)self.finalList[countryCode].cellClass=[""];else self.finalList[countryCode].cellClass=["col-sm-12 loc-layout can-list"];self.finalList[countryCode].countryName=self.locale.messages["locations.label.CANADA"]}else{self.finalList[countryCode].rowClass=
["state-location"];self.finalList[countryCode].regionClass=["location-region","north-america"];if(iphone||ipad)self.finalList[countryCode].cellClass=[];else self.finalList[countryCode].cellClass=["col-sm-12 loc-layout"];self.finalList[countryCode].countryName=self.locale.messages["locations.label.US"]}if(iphone)self.finalList[countryCode].cellStyle={"float":"left","width":"100%"};else if(ipad)self.finalList[countryCode].cellStyle={"float":"left","width":"20%"}}self.countryList=_.uniq(self.countryList)})}else if(continent==
"EUROPE"||continent=="MIDDLE_EAST"||continent=="ASIA")dataServiceG2.getLocationsList(continent,function(response){var countries=response.data.countries;self.otherCountries=[];self.countryList=[];if(self.location.primaryCountry=="deu"||self.location.primaryCountry=="esp")self.countryList.push(self.location.primaryCountry);for(var countryCode in countries){var countryList=_.chain(countries[countryCode]).groupBy("yardName").map(function(locationObj,key1){return{yardName:key1,yardNumber:locationObj[0].yardNumber,
openNewTab:locationObj[0].openNewTab,baseUrl:locationObj[0].baseUrl,locationUrl:createLocationUrl(locationObj)}}).value();var sortedCountryList=_.sortBy(countryList,function(num){return num.yardName});self.otherCountries[countryCode]=sortedCountryList;self.countryList.push(countryCode)}self.countryList=_.uniq(self.countryList)});self.stateVisible=function(){self.showState=!showState}};self.init()}]);
app.controller("locationDetailController",["$scope","$http","$locale","$routeParams","dataServiceG2","auctionsCalendarService","localStorageService","$rootScope","$filter","copartUser","userService","$location","metaDataService","urlService",function($scope,$http,$locale,$routeParams,dataServiceG2,auctionsCalendarService,localStorageService,$rootScope,$filter,copartUser,userService,$location,metaDataService,urlService){var self=$scope;var seoObj={};self.yardNumber=$routeParams.locationName?$routeParams.locationName.slice($routeParams.locationName.lastIndexOf("-")+
1):$routeParams.yardNumber;self.locationDetail=null;self.saleTime=null;self.userConfig=copartUser.getUserConfig();self.timeZoneAbbr=moment().tz(self.userConfig.selectedTimezone).format("z");self.locDetParentFragment="Content/us/en/locations/location-"+self.yardNumber+".html";self.isAnonymous=userService.isAnonymous();var SPACE=" ";self.hideCallChargesMsg=false;self.isYardLive=false;self.locale=$scope.$parent.locale;window.appInit.isUserAgentBOT=true;var yardNumberArray=[2,9,10,11,12,41,47,50,54,57,
59,61,68,97];if(yardNumberArray.indexOf(parseInt(self.yardNumber))>-1)self.displayAdYard=true;if(window.appInit.isUserAgentBOT){var script=$("#seoScript");if(script.length==0){script=$(document.createElement("script"));script.attr("id","seoScript");script.attr("type","application/ld+json");$("body").append(script)}seoObj=metaDataService.getEventsSeoObj($location.absUrl())}auctionsCalendarService.todayAuctionsByYard(self.yardNumber).then(function(auctionList){self.todaysAuctionList=auctionList;self.liveAuctionList=
_.filter(self.todaysAuctionList,function(num){return(num.isLive||num.closedFlag=="I")&&num.showLink});self.isYardLive=self.liveAuctionList&&self.liveAuctionList.length>0;self.laterAuctionList=_.filter(self.todaysAuctionList,function(num){return num.closedFlag=="N"&&num.showLink});metaDataService.appendEventToSEO(seoObj,script,self.laterAuctionList)});auctionsCalendarService.laterAuctionsByYard(self.yardNumber).then(function(auctionList){self.upcomingAuctionList=_.filter(auctionList,function(num){return num.showLink});
metaDataService.appendEventToSEO(seoObj,script,self.upcomingAuctionList)});dataServiceG2.getLocationDetail(self.yardNumber,function(response){self.locationDetail=response.data;self.isMEALoc=_.contains(self.locationDetail.siteCodes,"CPRTMEA");if("IRL"==self.locationDetail.yardCountryCode){self.locationDetail.yardZip="R14 YK37";self.locationDetail.yardMailingZip="R14 YK37";self.hideCallChargesMsg=true}self.navigationAddress=(self.locationDetail.yardAddress1||"")+" "+(self.locationDetail.yardAddress2||
"")+" "+(self.locationDetail.yardCity||"")+" "+(self.locationDetail.yardStateName||"")+" "+(self.locationDetail.yardZip||"");self.showZip=true;if(self.$parent.checkForMEACountryCode(self.locationDetail.yardCountryCode)){self.hideCallChargesMsg=true;self.showZip=false;self.navigationAddress="Copart "+self.locationDetail.yardCity+SPACE+self.locationDetail.yardStateName}$rootScope.$emit("location-fetched",self.locationDetail);if(self.locationDetail&&self.locationDetail.saleTime){self.saleTime=self.locationDetail.saleTime.toString();
self.saleTimeDisplay=$filter("convert24hrsTo12hrs")(self.saleTime)}localStorageService.set("_continentVal",self.locationDetail.yardContinentCode);var yardName;try{yardName=appInit.regionCode!="us"?self.locationDetail.yardName:self.locationDetail.yardName.substring(5,self.locationDetail.yardName.length);yardName=yardName+" "+self.locationDetail.yardMailingStateName}catch(e){console.log(e)}$rootScope.$emit("meta-args-update",{yardName:yardName,yardAddress:self.locationDetail.yardAddress1+", "+self.locationDetail.yardCity+
", "+self.locationDetail.yardMailingStateName});metaDataService.updateEventSEOAddr(seoObj,script,self.locationDetail,self.locale)});auctionsCalendarService.getLanesListForLiveYard(self.yardNumber).then(function(laneList){self.liveAuctionLaneList=laneList});self.saleListUrl=function(auction){return urlService.getAllLaneSaleListResultUrl(auction)};$scope.$on("$destroy",function(){window.appInit.isUserAgentBOT=false})}]);
app.controller("VehicleAlertsController",["$scope","dataServiceG2","vehicleFactory","$routeParams","$location","appConfigService","vehicleFinderService","userService",function($scope,dataServiceG2,vehicleFactory,$routeParams,$location,appConfigService,vehicleFinderService,userService){var self=$scope;self.locale=$scope.$parent.locale;self.vehicleAlertVO=new VehicleAlertVO;self.invalidYears=false;self.isError=null;self.signupStatus="fillDetails";self.wlWaiting=false;self.formSubmitted=false;self.disableMake=
true;self.functionality=$routeParams.subscribe;self.vehicleTypes=self.appConfig.vehicleTypes;self.disableForm=false;var userConfig=userService.userConfig;var fromGetmodelsFn;var isAnonymous=userService.isAnonymous();var isFromLotDetails=false;self.init=function(){self.vehicleAlertVO.typeOfVehicleObj=vehicleFinderService.getDefaultVehicleType(self.vehicleTypes);self.getMakes();self.vehicleAlertVO.yearFrom=self.appConfig.searchYears[11].code!==undefined?self.appConfig.searchYears[11].code:"2006";self.vehicleAlertVO.yearTo=
self.appConfig.searchYears[0].code!==undefined?self.appConfig.searchYears[0].code:"2017";self.vehicleAlertVO.frequency="Daily"};if(self.functionality=="UnSubscribeVehicleAlert"){self.signupStatus="inProgress";self.wlWaiting=true;var subscriberKey=$location.search().SubscriberKey;dataServiceG2.unsubscribeVehicleAlerts(subscriberKey,function(response){var responseCode=response.errorMsg;var responseCodeDesc=response.returnCodeDesc;if(response.returnCodeDesc!=="undefined"&&response.returnCodeDesc=="Success"){self.signupStatus=
"fillDetails";self.isError=false;self.errorDesc=self.locale.getMessage("app.vehicle.signup.alert.successMsg")}else{self.signupStatus="Failure";self.isError=true;self.errorDesc=self.locale.getMessage("app.vehicle.signup.alert.failureMsg")}self.wlWaiting=false})}else if(self.functionality=="EditVehicleAlert"){self.signupStatus="inProgress";self.wlWaiting=true;smsAlertVO={};smsAlertVO.key=$location.search().SubscriberKey;smsAlertVO.functionalityType="editSubscription";dataServiceG2.editVehicleAlerts(smsAlertVO,
function(response){var responseCode=response.errorMsg;var responseCodeDesc=response.returnCodeDesc;if(response.returnCodeDesc!=="undefined"&&response.returnCodeDesc=="Success"){self.vehicleAlertVO=response.data.vehicleAlerts;if(self.vehicleAlertVO.makeOfVehicleObj!==undefined&&self.vehicleAlertVO.makeOfVehicleObj!=="")self.disableMake=false;self.signupStatus="fillDetails";self.isError=false;self.errorDesc=self.locale.getMessage("app.vehicle.signup.alert.successMsg")}else{self.signupStatus="Failure";
self.isError=true;self.errorDesc=self.locale.getMessage("app.vehicle.signup.alert.failureMsg")}self.wlWaiting=false})}self.lotAlerts=function(isValid){var lotVehObj=self.$parent.lotDetails;var isFromLotDetails=true;self.vehicleAlertVO.typeOfVehicleObj={};self.vehicleAlertVO.makeOfVehicleObj={};self.vehicleAlertVO.modelOfVehicleObj={};self.alertType=self.vehicleAlertVO.alertType;self.vehicleAlertVO.typeOfVehicle=lotVehObj.vehicleTypeCode.split("_")[1];self.vehicleAlertVO.makeOfVehicle=lotVehObj.mkn;
self.vehicleAlertVO.modelOfVehicle=lotVehObj.lmg;self.vehicleAlertVO.yearFrom=lotVehObj.lcy;self.vehicleAlertVO.yearTo=lotVehObj.lcy;self.signUpForAlerts(isValid,isFromLotDetails)};self.signUpForAlerts=function(isValid,isFromLotDetails){self.formSubmitted=true;if(isValid){if(!validateForm(self.alertType))return;self.signupStatus="inProgress";self.wlWaiting=true;var requestVO=new VehicleAlertVO(self.vehicleAlertVO);var lotAlertSuccessActions=function(){jQuery("#lotAlertSuccess").modal();self.vehicleAlertsForm.$setPristine();
self.vehicleAlertsForm.$setUntouched();self.vehicleAlertVO={};self.vehicleAlertVO.frequency="Daily";self.signupStatus="Thank you for signing up";self.formSubmitted=false};dataServiceG2.signUpForVehicleAlerts(requestVO,function(response){var responseCode=response.errorMsg;var responseCodeDesc=response.returnCodeDesc;if(response.returnCodeDesc!=="undefined"&&response.returnCodeDesc=="Success"){if(requestVO.alertType=="sms")copartOmnitureCallMulti("doTagVehicleAlertsSMS",[userConfig.buyerNumber]);else copartOmnitureCallMulti("doTagVehicleAlertsEmail",
[userConfig.buyerNumber]);isFromLotDetails?lotAlertSuccessActions():$location.url("/content/"+appInit.regionCode+"/"+appInit.userLang+(isAnonymous?"/vehicle-alert-non-members":"/vehicle-alert-members"));self.isError=false;self.errorDesc="Now you‚Äôll be the first to hear when a vehicle you‚Äôre looking for is listed on Copart."}else{self.signupStatus="Failure";self.isError=true;self.errorDesc=self.locale.getMessage("app.vehicle.signup.alert.failureMsg")}self.wlWaiting=false})}};function validateForm(alertType){if(self.vehicleAlertVO.typeOfVehicleObj==
undefined||self.vehicleAlertVO.makeOfVehicleObj==undefined||self.vehicleAlertVO.yearFrom==undefined||self.vehicleAlertVO.yearTo==undefined||self.vehicleAlertVO.firstName==undefined||self.vehicleAlertVO.lastName==undefined||userConfig.siteRegionCode=="us"&&self.vehicleAlertVO.alertType==undefined)return false;else if(alertType=="sms"&&self.vehicleAlertVO.mobileNum==undefined)return false;else if(alertType=="Email"&&self.vehicleAlertVO.email==undefined)return false;return true}self.clickMe=function(){self.vehicleAlertVO.yearFrom=
self.appConfig.searchYears[11].code};self.validateYears=function(form){if(self.vehicleAlertVO.yearFrom>self.vehicleAlertVO.yearTo){self.invalidYears=true;$scope.vehicleAlertsForm.yearFrom.$setValidity("invalid",false)}else{$scope.vehicleAlertsForm.yearFrom.$setValidity("invalid",true);self.invalidYears=false}};$scope.greaterThan=function(prop,val){return function(item){return item.code>val}};$scope.lessThan=function(prop,val){return function(item){return item.code<val}};self.getModels=function(){self.modelList=
vehicleFinderService.getModels(self.vehicleAlertVO.typeOfVehicleObj,self.vehicleAlertVO.makeOfVehicleObj);function disableForm(){self.disableForm=true;fromGetmodelsFn=true}function enableForm(){self.disableForm=false;fromGetmodelsFn=false}var index=_.findLastIndex(self.modelList,{description:"ALL MODELS"});index>=0?self.modelList.length>=0?enableForm():disableForm():self.modelList&&self.modelList.length==0?disableForm():enableForm();if(self.modelList&&self.modelList.length>0)self.disableMake=false};
self.getSelectedModel=function(modelOfVehicleObj){if(!fromGetmodelsFn)if(modelOfVehicleObj!=null&&modelOfVehicleObj.trim().toUpperCase()=="ALL MODELS")self.disableForm=true;else self.disableForm=false};self.getMakes=function(){self.makeList=vehicleFinderService.getMakes(self.vehicleAlertVO.typeOfVehicleObj);self.getModels()};self.init()}]);
app.controller("CreatePasswordController",["$scope","$location","dataServiceG2","loginService","copartUser","constants",function($scope,$location,dataServiceG2,loginService,copartUser,constants){var self=$scope;self.form={};self.createPasswordForm={};self.locale=$scope.$parent.locale;self.isFormSubmitted=false;self.errors={};self.locale=self.$parent.locale;self.passwordRule=copartUser.getUserConfig().passwordRule;self.passwordPattern=self.passwordRule.pattern?self.passwordRule.pattern:constants.PATTERN;
self.minLength=self.passwordRule.minLength?self.passwordRule.minLength:constants.PASSWORD_MIN_LENGTH;self.maxLength=self.passwordRule.maxLength?self.passwordRule.maxLength:constants.PASSWORD_MAX_LENGTH;self.patternValidation=self.locale.getMessage("app.accountinformation.createPasswordMessage",self.minLength);self.emailRule=copartUser.getUserConfig().emailRule;self.createPasswordBtnVisible=false;self.msgPropPrefix="app.error.label.";setTimeout(function(){if($location.search()&&$location.search().userId)self.createPasswordForm.email=
$location.search().userId},0);self.validateFunc=function(errorObj){if(errorObj.field&&errorObj.code)switch(errorObj.field){case "currentPassword":self.errors.currentPassword=true;self.errors.currentPasswordErrorDesc=self.locale.getMessage(self.msgPropPrefix+errorObj.code);break;case "newPassword":self.errors.newPassword=true;self.errors.newPasswordErrorDesc=self.locale.getMessage(self.msgPropPrefix+errorObj.code);break;case "confirmNewPassword":self.errors.confirmNewPassword=true;self.errors.confirmNewPasswordErrorDesc=
self.locale.getMessage(self.msgPropPrefix+errorObj.code);break;case "email":self.errors.email=true;self.errors.emailErrorDesc=self.locale.getMessage(self.msgPropPrefix+errorObj.code);break;default:self.errors.isErrorExists=true;self.errors.errorMessage=self.locale.getMessage(self.msgPropPrefix+errorObj.code)}else if(errorObj.code){self.errors.isErrorExists=true;self.errors.errorMessage=self.locale.getMessage(self.msgPropPrefix+errorObj.code)}};self.handleServerSideErrors=function(errorsList){if(errorsList){jQuery("#createPasswordSubmit").prop("disabled",
false);_.each(errorsList,function(error){self.validateFunc(error)});return true}return false};self.createPassword=function(isFormValid){var key=$location.search().key;self.isFormSubmitted=true;self.errors={};if(_.isEmpty(key)){self.errors.errorMessage=self.locale.getMessage("app.error.label.PASSWORD_LINK_EXPIRED");self.errors.isErrorExists=true;return}if(self.createPasswordForm.password.$viewValue.length>self.passwordRule.maxLength){self.errors.errorMessage=self.locale.getMessage("registration.newPasswordMaxLength",
self.passwordRule.maxLength);self.errors.isErrorExists=true;return}if(self.createPasswordForm.retypepassword.$viewValue.length>self.passwordRule.maxLength){self.errors.errorMessage=self.locale.getMessage("registration.newPasswordMaxLength",self.passwordRule.maxLength);self.errors.isErrorExists=true;return}if(!isFormValid)return;var data={"username":self.createPasswordForm.email,"uid":key,"password":self.createPasswordForm.newPassword,"confirmNewPassword":self.createPasswordForm.confirmNewPassword};
self.createPasswordBtnVisible=true;dataServiceG2.createPassword(data,{onSuccess:function(response){self.createPasswordBtnVisible=false;if(response.data.status=="CREATED"){data.accountType={};data.accountType.value="0";loginService.submitForm("processLogin",data,true)}else if(response.returnCode===-1)if(!(response.data&&response.data.errorsList&&self.handleServerSideErrors(response.data.errorsList))){self.errors.errorMessage=self.locale.getMessage("app.label.ServerException");self.errors.isErrorExists=
true}},onFailure:function(response){self.createPasswordBtnVisible=false;log.error("Error in create password controller",response);self.errors.isErrorExists=true;self.errors.errorMessage=self.locale.getMessage("app.label.ServerException")}})}}]);
app.controller("CollectSecurityQuestionsController",["$scope","$location","dataServiceG2",function($scope,$location,dataServiceG2){var self=$scope;self.selectedQuestions={};self.selectedQuestions.questions=[];self.isFormSubmitted=false;self.isSavingFailed=false;self.init=function(){self.questions=self.appConfig.getSecurityQuestions()};self.init();self.isAllFieldsValid=function(){return self.securityQuestionsForm.$valid};self.collectQuestions=function(isFormValid){self.isSavingFailed=false;self.isFormSubmitted=
true;if(!isFormValid)return;if(self.selectedQuestions.questions[0].questionId==self.selectedQuestions.questions[1].questionId||self.selectedQuestions.questions[1].questionId==self.selectedQuestions.questions[2].questionId||self.selectedQuestions.questions[2].questionId==self.selectedQuestions.questions[0].questionId){self.showDuplicateQuestions=true;return}dataServiceG2.saveSecurityQuestions(self.selectedQuestions,{onSuccess:function(responseData){if(responseData.returnCode=="-1")self.isSavingFailed=
true;else $location.path("/dashboard")},onFailure:function(responseData){self.isSavingFailed=true}})}}]);
app.controller("paymentsDueController",["$scope","$http","$location","dataServiceG2","$compile","$filter","$route","copartUser","appConfigService","backToLinkService","saveLotNumbersService","paymentService","dataTableConfig","$window","localStorageService","$timeout","siteCatalyst","userService","History","copartUtils",function($scope,$http,$location,dataServiceG2,$compile,$filter,$route,copartUser,appConfigService,backToLinkService,saveLotNumbersService,paymentService,dataTableConfig,$window,localStorageService,
$timeout,siteCatalyst,userService,History,copartUtils){var paymentsConstants={SELECTED_BIDDER_OBJ:"selBidderObj",SELECTED_SALE_TYPE:"selSaleType",BIDDER_LIST:"bidderList",SALE_TYPE_LIST:"saleTypeList",PAYMENTS_DUE_LOCAL_STORAGE_KEY:"payments-due-data"};var self=$scope;self.selectedCurrency=copartUser.getUserConfig().currencyCode;self.selectedInvoices={};self.siteCode=copartUser.getUserConfig().siteCode;self.isPayOnline=copartUser.getUserConfig().isPayOnline;self.isHighVolumePayment=copartUser.hasAccessSitePref("highVolPayments",
"Y")||false;var showOwnershipTypeDocColumn=copartUser.hasAccessSitePref("salesListPreference.columns","showOwnershipTypeDoc");self.otherCurrency=copartUser.getUserConfig().secondaryCurrencyCode;var selectedTimezone=copartUser.getUserConfig().selectedTimezone;var date=moment().tz(selectedTimezone).format("YYYY MMMM DD");self.exportFileName="PaymentsDue_"+date+".csv";self.table="#paymentDueDataTable";self.totalDues=-1;self.showInvoiceConfirmation=false;self.showInvoiceProcessing=false;self.locale=$scope.$parent.locale;
self.loadedFirstTime=false;self.showBidderColumn=false;self.showCheckboxColumn=false;self.yardDetails={};self.disabledPaymentButton=true;self.disabledRemoveButton=true;self.paymentConfirmButtonStatus=false;self.selectedEstimate=null;self.bidders={};self.images={};self.ccmaxLimit=appConfigService.getAppConfig().getCcMaxLimit()[0].code;self.backToLink=$location.url();backToLinkService.setBackToLink(self.backToLink);backToLinkService.setBackToLinkText("paymentdue.invoice.backurl.text");self.buyerForCCPay=
0;self.estimates={};self.availableFundAmount=[];self.currentEstimatesList=[];self.wuMaxLimit=0;self.wuInvoiceCount=0;self.email=copartUser.getUserConfig().memberContactInfo.email;self.fromMobileApp=userService.userConfig.mobileAppUser;self.showImage=localStorageService.get("show-image")!=null?localStorageService.get("show-image"):false;self.saleTypeList=[];self.saleTypeSelected={};self.financeVOList={};self.enablePaymentCap=copartUser.getUserConfig().paymentCap;self.availableCash=0;self.afcFunderVO=
{};var wuLimitRemaining=0;var wuEndPointUrl="";var wuServiceId="";var wuClientId="";var showWUInfoPopUp=true;self.transporterEmail="";self.emailTransporterMessage=null;self.emailErrorMessage=null;var userConfig=userService.userConfig;self.ShwDelEstChecked=false;self.isNonSyncedBuyer=copartUtils.isNonSyncedBuyer();self.showMemberPickupStatus=copartUser.getUserConfig().defaultDisplayPref.showMemberPickupStatus||false;self.showDiscountedDue=copartUser.getUserConfig().defaultDisplayPref.showDiscountedDue||
false;self.memberShipUpgradeInvoices=["INITIAL REGISTRATION FEE","INITIAL DEPOSIT"];self.internationalUser=userConfig.internationalMember;if(self.internationalUser)self.typeOfDelivery="international";else self.typeOfDelivery="domestic";if(_.contains(self.userConfig.roles,"ROLE_BROKER")||_.contains(self.userConfig.roles,"ROLE_MASTER"))self.showBidderColumn=true;if(copartUser.getUserConfig().siteCode!="CPRTMEA")self.showCheckboxColumn=true;self.estimates.selectedCurrency=self.selectedCurrency;function checkIfFromDetails(){try{var lastRoute=
History.lastRoute;if(lastRoute&&(lastRoute.indexOf("lot/")==0||lastRoute.indexOf("invoiceDetails/")==0))return true;else return false}catch(e){return false}}function checkIfFromDriverSeat(){var backToUrl=$location.search().backTo;self.viewedLot=$location.search().viewedLot}var state=false;var stateRestoreFromAnywhere=localStorageService.get("restore-search-state-from-anywhere");localStorageService.remove("restore-search-state-from-anywhere");if(checkIfFromDetails()||$location.search().state=="restore"||
stateRestoreFromAnywhere){state=localStorageService.get("restore-search-state");localStorageService.remove("restore-search-state");self.viewedLot=localStorageService.get("viewed-lot");localStorageService.remove("viewed-lot")}var scrollToTop=function(){$window.scrollTo(0,0)};self.init=function(refreshData){dataServiceG2.loadPaymentDueData(self.selectedCurrency,function(result){if(result.returnCode==1){var paymentTypesList=result.data.paymentTypesList;self.preferredPaymentType=result.data.preferredPaymentType;
self.setInitData(result);_.each(paymentTypesList,function(paymentMethod){if(paymentMethod.paymentType=="U"){paymentMethod.paymentDesc=self.locale.messages["paymentDue.paymentType."+paymentMethod.paymentType]+" "+paymentMethod.buyerNumber+"-"+paymentMethod.buyerName;self.availableFundAmount[paymentMethod.buyerNumber]=paymentMethod.availableFund}else paymentMethod.paymentDesc=self.locale.messages["paymentDue.paymentType."+paymentMethod.paymentType]});self.paymentTypesList=paymentTypesList;if(!self.selectedPaymentMethod){var preferredPaymentType=
_.filter(self.paymentTypesList,function(item){return item.paymentType===result.data.preferredPaymentType.code&&item.buyerNumber===result.data.preferredPaymentType.type});self.selectedPaymentMethod=preferredPaymentType.length>0?preferredPaymentType[0]:self.paymentTypesList[0]}else{var selectedPaymentType=_.filter(self.paymentTypesList,function(item){return item.paymentType===self.selectedPaymentMethod.paymentType&&item.buyerNumber===self.selectedPaymentMethod.buyerNumber});self.selectedPaymentMethod=
selectedPaymentType[0]}var paymentType=$location.search().paymentMethod;var currency=$location.search().currency;if(paymentType){var selectedPaymentType=_.filter(self.paymentTypesList,function(item){return item.paymentType===paymentType});self.selectedPaymentMethod=selectedPaymentType[0]}if(!self.selectedPaymentMethod)self.selectedPaymentMethod=self.preferredPaymentType;if(self.paymentTypesList&&self.paymentTypesList.length==0){self.availableFundAmount[self.userConfig.buyerNumber]=0;self.noAvailableFundAmountError=
true;self.selectedPaymentMethod.buyerNumber=self.userConfig.buyerNumber;self.errorMessage="paymentdue.noAvailableFundAmount.Error";if(self.siteCode=="CPRTMEA")self.showErrorMessage=false;else self.showErrorMessage=true}self.enablePayAllButton();self.estimates.selectedPaymentMethod=self.selectedPaymentMethod.paymentType;if(result.data.epayTermAndConditions=="Y")$("#epayTermAndCond").modal("show");if(!refreshData){self.loadInvoices();self.initInvoiceConfirmDatatable()}else self.reloadPaymentTable(self.selectedPaymentMethod);
self.availableCash=result.data.availableCash;dataServiceG2.getFinanceInfo(function(response){if(response.returnCodeDesc=="Success"){self.financeVOList=response.data.financeList;if(self.selectedPaymentMethod.paymentType=="L")_.each(self.financeVOList,function(financeVO){if(self.selectedPaymentMethod.funderCode.trim()===financeVO.providerCode.trim()){self.afcFunderVO=financeVO;return}})}});checkIfFromDriverSeat()}else{var error=self.locale.messages[result.data.errorObject];if(error)self.errorMessage=
result.data.errorObject;else self.errorMessage="error.proc.defaultMessage";self.showErrorMessage=true}self.loadAfterInit()})};self.init(false);self.setInitData=function(result){self.epayFundsLimit=result.data.epayFundsLimit;self.epayFundsLimitCalculation=self.epayFundsLimit;self.wuMaxLimit=result.data.wuMaxLimit;wuLimitRemaining=result.data.wuMaxLimit;wuEndPointUrl=result.data.wuEndPointUrl;wuServiceId=result.data.wuServiceId;wuClientId=result.data.wuClientId;wuServiceId=result.data.wuServiceId};
self.acceptEpayTerms=function(){dataServiceG2.acceptEpayTerms(function(result){if(result.returnCode==1){$("#epayTermAndCond").modal("hide");self.init(true)}else self.showEpayErrorMessage=true})};self.getPaymentLimit=function(paymentLimit){var table=$(self.table).dataTable();jQuery(table.fnGetNodes()).find(":checkbox:checked").each(function(){var rowIndex=table.fnGetPosition(jQuery(this).closest("tr")[0]);var aData=table.fnGetData(rowIndex);paymentLimit=paymentLimit-aData.amountDue});return paymentLimit};
self.payAllInvoices=function(){$("#chkSelectAll").prop("checked",true);self.selectAllCheckBox();var invoicesSelected=$(".invoiceId:checked").size();if(invoicesSelected>=1)self.confirmInvoices()};self.enablePayAllButton=function(){self.disabledPayAllButton=self.selectedPaymentMethod.paymentType=="U"?false:true};self.selectAllCheckBox=function(){var checked_status=$("#chkSelectAll").is(":checked");$(".invoiceId").not(":disabled").prop("checked",checked_status);if(self.selectedPaymentMethod.paymentType==
"P")if(checked_status){$(".invoiceId").not(":disabled").each(function(){var value=this.checked?$(this).data("item"):"";$(".invoiceId").not(".invoiceId[data-item\x3d"+value+"]").attr("disabled",true);$(".invoiceId").not(".invoiceId[data-item\x3d"+value+"]").prop("checked",false);return false});self.ccmaxLimit=self.getPaymentLimit(self.ccmaxLimit);if(self.ccmaxLimit<=0)$("#paymentLimit").modal("show")}else{self.ccmaxLimit=appConfigService.getAppConfig().getCcMaxLimit()[0].code;self.ccmaxLimit=self.getPaymentLimit(self.ccmaxLimit)}if(self.selectedPaymentMethod.paymentType==
"G")if(checked_status){var selectedInvoiceCount=$(".invoiceId:checked").size();if(selectedInvoiceCount>15){$("#westernUnionInvoice").modal("show");return}wuLimitRemaining=self.getPaymentLimit(self.wuMaxLimit);if(wuLimitRemaining<=0)$("#paymentLimit").modal("show")}else wuLimitRemaining=self.getPaymentLimit(self.wuMaxLimit);self.enablePaymentButton()};self.selectAllCheckBoxPayConfirm=function(lotNumber){var checked_status=$("#chkSelectAllPayConfirm").is(":checked");$(".invoiceIdPayConfirm").not(":disabled").prop("checked",
checked_status)};self.initInvoiceConfirmDatatable=function(){var oTableDest=$("#paymentDueConfirmTable").dataTable({"iDisplayLength":1E4,"bLengthChange":false,"bFilter":false,"aaSorting":[[0,"asc"]],"responsive":{details:{type:"column",target:-1,renderer:function(api,rowIdx,columns){var data=$.map(columns,function(col,i){return col.hidden?'\x3cli data-dt-row\x3d"'+col.rowIndex+'" data-dt-column\x3d"'+col.columnIndex+'"\x3e'+'\x3cspan\x3e\x3cspan class\x3d"bold" data-uname\x3d"saleslistRegion"\x3e'+
col.title+": "+'\x3c/span\x3e\x3cspan class\x3d"dtr-data"\x3e'+col.data+"\x3c/span\x3e\x3c/span\x3e"+"\x3c/li\x3e":""}).join("");return data?$("\x3cul/\x3e").append(data):false}}},"columnDefs":[{className:"control",orderable:false,targets:-1},{"targets":[0,1,2,3,4,5],"data":null,"defaultContent":""}],"oLanguage":{"sZeroRecords":"No matching records found"},"columns":[{"mData":"saleDate","render":function(data,type,row){var saleDate=moment(row["saleDate"],"YYYYMMDD");var defualtDateFormat=self.userConfig.dateFormat.toUpperCase();
return saleDate.format(defualtDateFormat)}},{"mData":"id","sClass":"nowrap"},{"mData":"yardName","render":function(data,type,row){var html="";if(row["yn"]==655||row["yn"]==700||row["yn"]==400)html=row["yname"];else html='\x3ca class\x3d"cursor-pointer" ng-href\x3d"" ng-click\x3d\'navigateToLocationDetails('+row["yn"]+")'\x3e"+row["yname"]+"\x3c/a\x3e";return html}},{"mData":"description"},{"mData":"lfd","render":function(data,type,row){var lfd=row["lfd"];if(lfd&&lfd>0){var leftFacilityDate=moment(lfd,
"YYYYMMDD");var defualtDateFormat=self.userConfig.displayPref.dateFormat.toUpperCase();return leftFacilityDate.format(defualtDateFormat)}else return""}},{"mData":"amountDue","sClass":"nowrap","name":"amountDue","visible":!self.showDiscountedDue,"render":function(data,type,row){var invoiceAmount=$filter("globalize_currency_using_code")(data,self.selectedCurrency,2);return invoiceAmount}},{"mData":"disctdue","sClass":"nowrap","name":"disctdue","visible":self.showDiscountedDue,"render":function(data,
type,row){var invoiceAmount=$filter("globalize_currency_using_code")(data,self.selectedCurrency,2);return invoiceAmount}},{"mData":"id","render":function(data,type,row){if(row["amountDue"]>0&&!row["pastDue"])return'\x3cinput  class\x3d"invoiceIdPayConfirm" type\x3d"checkbox" value\x3d"'+row["id"]+'" ng-change\x3d"updateRemoveButton()" ng-model\x3d"selectedInvoices['+row["id"]+']"\x3e';else return'\x3cinput  type\x3d"checkbox" style\x3d"display:none" value\x3d"'+row["id"]+'"\x3e'}},{"mData":"id","render":function(data,
type,row){return""}}]})};self.updateRemoveButton=function(){var table=$("#paymentDueConfirmTable").dataTable();var selectedItems=jQuery(table.fnGetNodes()).find(":checkbox:checked").length;if(selectedItems>0)self.disabledRemoveButton=false;else self.disabledRemoveButton=true};self.resetDefaultValues=function(){self.epayFundsLimitCalculation=self.epayFundsLimit;self.ccmaxLimit=appConfigService.getAppConfig().getCcMaxLimit()[0].code;wuLimitRemaining=self.getPaymentLimit(self.wuMaxLimit)};self.changeCurrency=
function(){self.otherCurrency=[self.selectedCurrency,self.selectedCurrency=self.otherCurrency][0];self.init(true)};self.emailInvoiceStatus=[];self.emailPDFInvoice=function(emailInvoiceParam){emailInvoiceParam.emailAddress=self.email;dataServiceG2.emailInvoice(emailInvoiceParam,callBack=function(result){self.emailConfirmMessage=true;self.emailSend=result.returnCode==1?true:false;self.emailError=!self.emailSend},"/data/emailInvoice/pdf")};$("#emailInvoice").on("hidden.bs.modal",function(){self.emailConfirmMessage=
false;self.$apply()});var table=new ServersideDatatable_DB(saveLotNumbersService,dataTableConfig);var populateBidder=function(bidderObj,bidderList){self.bidders.selBidderObj=_.find(bidderList,{bidderId:bidderObj.bidderId})};self.loadInvoices=function(){var backto=self.backToLink;saveLotNumbersService.clearAll();var dataTableOptions={"pageLength":1E4,"backToTop":false,"recalculateTableWidth":true,"columnDefs":[{"targets":[0,1,2,3,4,5,6,7,8,9,10,11,12],"data":null,"defaultContent":""},{"targets":["imagePath",
"id","transport"],"orderable":false},{"targets":["id"],"visible":self.showCheckboxColumn,"searchable":false},{"targets":["bidderId"],"visible":self.showBidderColumn,"searchable":false},{"targets":["imagePath"],"visible":false,"searchable":false},{"targets":["transport"],"visible":true,"searchable":false},{"targets":["ownershipDocType"],"visible":!showOwnershipTypeDocColumn,"searchable":!showOwnershipTypeDocColumn},{className:"control",orderable:false,targets:-1}],"lengthMenu":[[20,25,50,100],[20,
25,50,100]],"stateSave":state,"stateRetrieveFunction":function(data){self.bidderList=self.getCachedPaymentsData(paymentsConstants.BIDDER_LIST);self.saleTypeList=self.getCachedPaymentsData(paymentsConstants.SALE_TYPE_LIST);var selBidderObj=data.selectedBidderObj;if(selBidderObj){populateBidder(selBidderObj,self.bidderList);self.reloadPaymentTable(self.selectedPaymentMethod)}self.reloadBidders=true},"url":(self.isHighVolumePayment?"/data/payments/getAdvancedDueInvoiceList/":"/data/payments/getDueInvoiceList/")+
self.selectedPaymentMethod.paymentType+"/"+self.selectedCurrency,"containsFilters":false,"language":{"paginate":{"first":self.locale.messages["app.label.first"],"previous":self.locale.messages["app.label.previous"],"next":self.locale.messages["app.label.next"],"last":self.locale.messages["app.label.last"]},"lengthMenu":self.locale.messages["app.label.show"]+" _MENU_ "+self.locale.messages["app.label.entries"],"info":self.locale.messages["app.label.showing"]+" _START_ "+self.locale.messages["app.label.to"]+
" _END_ "+self.locale.messages["app.label.of"]+" _TOTAL_ "+self.locale.messages["app.label.entries"],"infoFiltered":"("+self.locale.messages["app.label.filteredFrom"]+" _MAX_ "+self.locale.messages["app.label.totalEntries"]+")","searchPlaceholder":self.locale.getMessage("app.label.searchListPlaceholder"),"search":self.locale.getMessage("app.label.search")+":"},"columns":[{"mData":"id","render":function(data,type,row){return self.applyPaymentRules(row)}},{"mData":"imgp","sClass":"compile","name":"imagePath",
"render":function(data,type,row,meta){var lotNumber=row["lotNumber"];var brand=row["brand"];var imgLink=row["imgp"];if(row["imgp"]&&row["imgp"].trim()!=""&&row["lotNumber"]>0){var link;link="\x3ca class\x3d'imgpath cursor-pointer' lot-id\x3d'"+lotNumber+"' lot-desc\x3d'"+row["description"]+"' images\x3d'images' "+"hide-watch-btn\x3dtrue modal-image-viewer check-yard-exist\x3dtrue yard-number\x3d'"+row.yn+"'\x3e"+"\x3cspan class\x3d'searchiconbtn'\x3e\x3c/span\x3e\x3cimg alt\x3d'image' height\x3d'72' width\x3d'96' class\x3d'img-icon' src\x3d'/images/testImages/no_photo.jpg'  o-data-src\x3d '"+
imgLink+"'error-image\x3d'/images/testImages/no_photo.jpg'\x3e\x3c/a\x3e\x3cbr\x3e";link+="\x3cdiv class\x3d'viewallphotos'\x3e\x3ca ng-href\x3d'' viewPhotos\x3d'true' ng-click\x3d\"navigateToLotDetails("+row["yn"]+",'"+lotNumber+"','"+brand+"',$event)\" class\x3d'image_viewer_link'  data-lotDesc\x3d'"+row["lotNumber"]+"' data-lot\x3d'"+row["lotNumber"]+"'\x3e"+self.locale.messages["counterman.searchResults.viewAllPhotos.label"]+"\x3c/a\x3e\x3c/div\x3e";return link}else return"\x3cimg alt\x3d'image' height\x3d'72' width\x3d'96' class\x3d'' src\x3d '/images/testImages/no_photo.jpg'\x3e\x3c/a\x3e"}},
{"mData":"saleDate","sClass":"nowrap","render":function(data,type,row){var saleDate=moment(row["saleDate"],"YYYYMMDD");var defualtDateFormat=self.userConfig.dateFormat.toUpperCase();return saleDate.format(defualtDateFormat)}},{"mData":"bid"},{"mData":"itemNumber","sClass":"nowrap","render":function(data,type,row){return row["itemNumber"]>0?row["itemNumber"]:""}},{"mData":"lotNumber","sClass":"nowrap","render":function(data,type,row,meta){var lotId=row["lotNumber"];var brand=row["brand"];if(self.viewedLot&&
self.viewedLot==lotId)self.viewedRowIndex=meta.row;if(row["lotNumber"]>0){saveLotNumbersService.addLotNumber(row["lotNumber"]);return'\x3ca class\x3d"lotNumberAnchor" ng-href\x3d"" ng-click\x3d\'navigateToLotDetails('+row["yn"]+',"'+lotId+'","'+brand+"\",$event)'\x3e"+row["id"]+"\x3c/a\x3e"}else return row["id"]}},{"mData":"yardName","render":function(data,type,row){var html="";if(row["yn"]==655||row["yn"]==700||row["yn"]==400)html=row["yname"];else html='\x3ca class\x3d"cursor-pointer" ng-href\x3d"" ng-click\x3d\'navigateToLocationDetails('+
row["yn"]+")'\x3e"+row["yname"]+"\x3c/a\x3e";return html}},{"mData":"st","render":function(data,type,row){if(!_.isEmpty(row["description"])&&!_.isEmpty(row["lori"]))if(row["description"].toLowerCase()==="MISCELLANEOUS CHARGE".toLowerCase()||row["lori"].trim()=="INVOICE")return"";else return row["st"];else return""}},{"mData":"description"},{"mData":"vin","render":function(data,type,row){var vin=$filter("redactFilter")(row["vin"],"limitVIN");return vin}},{"mData":"ownerTitleType"},{"mData":"bidAmount",
"render":function(data,type,row){var bidAmount=$filter("globalize_currency_using_code")(data,row["cur"],2);return bidAmount}},{"mData":"invoiceAmount","render":function(data,type,row){var invoiceAmount=$filter("globalize_currency_using_code")(data,row["cur"],2);var invoiceURL="";var payType=self.selectedPaymentMethod.paymentType;var invType=self.userConfig.companyCode=="COPART"?"INVOICE":"RECEIPT";var hazardousDocNotSubmitted=row["hd"];if(payType==undefined)payType="P";var invoiceNumber=row["lotNumber"]==
0?row["id"]:row["lotNumber"];if(row["description"].toUpperCase().indexOf("RELIST")>=0)invoiceNumber=row["id"];if(row["pdf"]==true){var lotNumber=row["lotNumber"]>0?row["lotNumber"]:null;invoiceURL+='\x3cspan\x3e\x3ca target\x3d"_blank" ng-href\x3d"/invoice/pdf?invoiceNumber\x3d'+invoiceNumber+"\x26paymentType\x3d"+payType+"\x26currencyCode\x3d"+row["cur"].trim()+"\x26invoiceType\x3d"+invType+"\x26lotNumber\x3d"+row["lotNumber"]+"\x26outputType\x3dD"+"\x26secretId\x3d"+row["secretId"]+"\x26bidderNumber\x3d"+
row["bid"]+'"\x3e'+invoiceAmount+"\x3c/a\x3e\x3c/span\x3e\x3cbr/\x3e"+'\x3cspan\x3e\x3ca ng-click\x3d"emailInvoiceCall('+invoiceNumber+",'"+row["secretId"]+"','"+payType+"','"+row["cur"].trim()+"','"+invType+"',"+row["lotNumber"]+","+row["bid"]+')" data-toggle\x3d"modal"\x3e{{locale.messages["paymentdue.label.email.invoice"]}}\x3c/a\x3e\x3c/span\x3e'}else invoiceURL='\x3ca ng-href\x3d"/invoiceDetails/'+invoiceNumber+"/"+payType+"/"+row["cur"].trim()+"/"+invType+"/"+row["lotNumber"]+"/"+row["secretId"]+
"/"+row["bid"]+'"\x3e'+invoiceAmount+"\x3c/a\x3e";return invoiceURL}},{"mData":"amountDue","name":"amountDue","render":function(data,type,row){var due=$filter("globalize_currency_using_code")(data,row["cur"],2);return due}},{"mData":"lfd","render":function(data,type,row){var lfd=row["lfd"];if(lfd&&lfd>0){var leftFacilityDate=moment(lfd,"YYYYMMDD");var defualtDateFormat=self.userConfig.displayPref.dateFormat.toUpperCase();return leftFacilityDate.format(defualtDateFormat)}else return""}},{"mData":"lly",
"name":"transport","sClass":"compileEstimates","render":function(data,type,row){if(row["lotNumber"]==row["id"])return"\x3cspan request-Type\x3d'QUOTE' lot-id\x3d'"+row["lotNumber"]+"'  invoice-id\x3d'"+row["id"]+"' estimates\x3d'estimates' current-estimates-List\x3d'currentEstimatesList' amount-due\x3d'"+row["amountDue"]+"'  transportaion-estimates\x3e";else return""}},{"mData":"buyerPickupStatus","visible":self.showMemberPickupStatus,"render":function(data,type,row){return paymentService.buildMemberPickUpStatus(row,
row["yname"],row["lotNumber"])}},{"mData":"","render":function(data,type,row){return""}}]};var dataTable=table.initServerSideDataTable(self.table,dataTableOptions,function(){self.setTotalInvoices(self.table);self.setBrokerBidders();self.compileDom(self.table);self.showWesturnUnionInfo();$(window).trigger("scrollToPoint");$timeout(function(){if(self.viewedRowIndex||self.viewedRowIndex==0){jQuery("#paymentsDueTable"+" tbody tr").eq(self.viewedRowIndex).addClass("bold fs12");self.viewedRowIndex=null}},
0)});dataTable.on("stateSaveParams.dt",function(e,settings,data){data.selectedBidderObj=self.bidders.selBidderObj});if(self.fromMobileApp||window.innerWidth<="768"){dataTable.on("draw.dt",function(){self.showImages()});jQuery("#hideImg").attr("checked","checked")}else jQuery("#hideImg").removeAttr("checked","checked")};self.setBrokerBidders=function(){if(self.reloadBidders)return;if(!self.loadedFirstTime){var oTable=$(self.table).DataTable();var data=oTable.rows().data();var bidders=_.groupBy(data,
function(value){return value.bid});self.bidderList=_.map(bidders,function(group){return{bidderId:group[0].bid,bidderName:group[0].bname,invoiceCount:group.length}});self.loadedFirstTime=true;self.saleTypeList=_.chain(data).filter(function(result){return result.st!=""}).map(function(result){return result.st}).uniq().value();self.cachePaymentsData(paymentsConstants.BIDDER_LIST,self.bidderList);self.cachePaymentsData(paymentsConstants.SALE_TYPE_LIST,self.saleTypeList)}};self.compileDom=function(table){var $dest=
jQuery(table).find("tbody");var retn=$compile($dest)($scope);$scope.safeApply();self.enablePaymentButton();if(self.selectedPaymentMethod.paymentType=="P"||self.selectedPaymentMethod.paymentType=="G"){$(".invoiceId:checkbox:checked").each(function(){var value=this.checked?$(this).data("item"):"";$(".invoiceId").not(".invoiceId[data-item\x3d"+value+"]").attr("disabled",true)});self.ccmaxLimit=self.getPaymentLimit(self.ccmaxLimit);wuLimitRemaining=self.getPaymentLimit(self.wuMaxLimit)}jQuery("#paymentDueDataTable").on("order.dt",
function(){self.resetDefaultValues()}).DataTable();if(self.showImage){$("#hideImg").attr("checked",true);self.showImages()}jQuery("#paymentDueDataTable").on("search.dt",function(){self.resetDefaultValues()}).DataTable();if(self.showImage){$("#hideImg").attr("checked",true);self.showImages()}};self.applyPaymentRules=function(row){if(row["amountDue"]>0){var checked=false;var disabled=true;var visible=true;var showCheckBox=true;var fundingStatus="";if(row["fundingStatus"]&&row["fundingStatus"].trim().length)if(self.selectedPaymentMethod.paymentType==
"F"||self.selectedPaymentMethod.paymentType=="L"){showCheckBox=false;fundingStatus=row["fundingStatus"]}if(self.selectedPaymentMethod.paymentType=="O")if(self.epayFundsLimitCalculation>0&&self.epayFundsLimitCalculation>=row["amountDue"])if(row["pastDue"]){checked=true;visible=true;disabled=true;self.epayFundsLimitCalculation=self.epayFundsLimitCalculation-row["amountDue"]}else{checked=false;visible=true;disabled=false}else if(row["pastDue"]){visible=false;checked=false;disabled=true}else{visible=
true;disabled=true;checked=false}if(self.selectedPaymentMethod.paymentType=="F"||self.selectedPaymentMethod.paymentType=="L")if(row["pastDue"]){checked=true;disabled=true}else{checked=false;disabled=false}else if(self.selectedPaymentMethod.paymentType=="U"){var buyerNumber=self.selectedPaymentMethod.buyerNumber;if(buyerNumber==row["bid"])if(row["pastDue"]){var checked=true;var disabled=true}else{if(row["lotNumber"]<=0)checked=true;else checked=false;disabled=false}else{checked=false;disabled=true;
visible=false}}else if(self.noAvailableFundAmountError)if(row["pastDue"]){var checked=true;var disabled=true}else{checked=false;disabled=true}else if(self.selectedPaymentMethod.paymentType=="P"||self.selectedPaymentMethod.paymentType=="G"){if(row["pastDue"]){checked=true;disabled=true;if(self.buyerForCCPay==0)self.buyerForCCPay=row["bid"];if(self.selectedPaymentMethod.paymentType=="G")self.wuInvoiceCount++}else{checked=false;disabled=false}if(self.buyerForCCPay&&self.buyerForCCPay!=row["bid"]){disabled=
true;checked=false}}if(row["plcflg"]!=null&&row["plcflg"]!=undefined&&row["plcflg"].trim().toUpperCase()=="Y"){visible=false;checked=false;disabled=true}if(showCheckBox){var hidden=visible==true?"":"style\x3ddisplay:none";return'\x3cinput class\x3d"invoiceId" id\x3d"'+row["id"]+'"'+'ng-click\x3d"enablePaymentButton(false); checkPaymentLimits('+row["id"]+","+row["amountDue"]+');"'+'data-item\x3d"'+row["bid"]+'" type\x3d"checkbox" value\x3d"'+row["id"]+'" ng-checked\x3d"'+checked+'"  ng-disabled\x3d"'+
disabled+'"'+hidden+"\x3e"}else return'\x3ca ng-href\x3d"" ng-click\x3d"showDSCPaymentStatus(\''+fundingStatus+"')\"\x3e"+fundingStatus+"\x3c/a\x3e"}else return""};self.showDSCPaymentStatus=function(status){self.fundingStatus=status.trim();$("#fundingStatus").modal("toggle")};self.checkPaymentLimits=function(checkBoxId,amount){if(self.selectedPaymentMethod.paymentType=="P"||self.selectedPaymentMethod.paymentType=="G"){var table=$(self.table).DataTable();$(self.table+" tbody").unbind("click").on("click",
"tr",function(){var seletedRow=table.row(this).data();var seletedBidder=seletedRow.bid;table.rows().eq(0).each(function(index){var row=table.row(index);var data=row.data();if(seletedBidder!=data.bid)$("#"+data.id).attr("disabled",true);else if(!data.pastDue)$("#"+data.id).attr("disabled",false)});var invoicesSelected=$(".invoiceId:checked").size();if(invoicesSelected<1)$(".invoiceId").attr("disabled",false)});if(self.selectedPaymentMethod.paymentType=="P"){if(jQuery("#"+checkBoxId).is(":checked"))self.ccmaxLimit=
self.ccmaxLimit-amount;else self.ccmaxLimit=self.ccmaxLimit+amount;if(self.ccmaxLimit<=0){$("#"+checkBoxId).prop("checked",false);self.ccmaxLimit=self.ccmaxLimit+amount;$("#paymentLimit").modal("show")}}if(self.selectedPaymentMethod.paymentType=="G"){var selectedInvoiceCount=$(".invoiceId:checked").size();if(jQuery("#"+checkBoxId).is(":checked"))wuLimitRemaining=wuLimitRemaining-amount;else wuLimitRemaining=wuLimitRemaining+amount;if(wuLimitRemaining<=0||selectedInvoiceCount>15){$("#"+checkBoxId).prop("checked",
false);wuLimitRemaining=wuLimitRemaining+amount;if(selectedInvoiceCount>15)$("#westernUnionInvoice").modal("show");else $("#paymentLimit").modal("show")}}}if(self.selectedPaymentMethod.paymentType=="O"){if(jQuery("#"+checkBoxId).is(":checked"))self.epayFundsLimitCalculation=self.epayFundsLimitCalculation-amount;else self.epayFundsLimitCalculation=self.epayFundsLimitCalculation+amount;if(self.epayFundsLimitCalculation<=0){$("#"+checkBoxId).prop("checked",false);self.epayFundsLimitCalculation=self.epayFundsLimitCalculation+
amount;$("#paymentLimit").modal("show")}}};self.setTotalInvoices=function(tableId){self.totalDues=0;self.totalDiscountedDues=0;self.totalInvoices=0;var oTable=$(tableId).DataTable();oTable.column("amountDue:name").data().each(function(value,index){self.totalDues+=value});if(tableId=="#paymentDueConfirmTable"&&self.showDiscountedDue){oTable.column("disctdue:name").data().each(function(value,index){self.totalDiscountedDues+=value});self.totalDiscountedDues=$filter("globalize_currency_using_code")(self.totalDiscountedDues,
self.selectedCurrency,2)}self.totalDues=$filter("globalize_currency_using_code")(self.totalDues,self.selectedCurrency,2);self.totalInvoices=oTable.data().count();self.dataFromServer=oTable.data()};self.confirmInvoices=function(){scrollToTop();if(self.selectedPaymentMethod.paymentType=="M"||self.selectedPaymentMethod.paymentType=="X"||self.selectedPaymentMethod.paymentType=="W"||self.selectedPaymentMethod.paymentType=="K"){$("#restrictPaymentModal").modal("show");return}omnitureCallWesternUnion("doTagPaymentStartedWU",
self.selectedPaymentMethod.paymentType);if(self.selectedPaymentMethod.paymentType!="G")self.wuInvoiceCount=0;if(self.selectedPaymentMethod.paymentType=="O"){self.epayFundsAmount=self.getPaymentLimit(self.epayFundsLimit);if(self.epayFundsAmount<=0){$("#paymentLimit").modal("show");return}}if(self.selectedPaymentMethod.paymentType=="L"){self.checkPartialPaymentForAFC();if(self.isPartialPaymentForAFC==true){var afcErrorMsg=self.locale.getMessage("paymentdue.afc.partialpayment.error");self.showAFCInfoModal(afcErrorMsg);
return}}if(self.selectedPaymentMethod.paymentType=="L")if(self.getPaymentLimit(self.selectedPaymentMethod.availableFund)<=0){self.paymentLimitInfoMsg=self.locale.getMessage("paymentDue.afc.limit.msg",$filter("globalize_currency_using_code")(self.selectedPaymentMethod.availableFund,self.selectedCurrency,2));$("#paymentLimit").modal("show");return}if(self.wuInvoiceCount>15){$("#westernUnionInvoicePastDue").modal("show");return}self.checkNonSecuredPartialPayment();if(self.isNonSecuredPartialPaymentApplied){$("#nonSecuredPartialPaymentMsgErrorModal").modal("show");
return}if(self.enablePaymentCap&&self.selectedPaymentMethod.paymentType=="U"){self.showInvoiceProcessing=true;var paymentCapInquiryVO=self.preparePaymentCapInquiryVO();var catBlots=[];_.each(paymentCapInquiryVO.invoices,function(invoice){if(invoice.isCatBLot)catBlots.push(invoice.invoiceNumber)});if(catBlots.length>0&&self.availableCash>0){self.paymentCapLimitMsg=self.locale.getMessage("paymentDue.paymentCap.catbrestriction.msg",catBlots);$("#paymentCapErrorModal").modal("show");return}dataServiceG2.getPaymentCapRestriction(paymentCapInquiryVO,
function(response){self.showInvoiceProcessing=false;if(response.returnCodeDesc=="Success"){var payCapResponse=response.data.paymentCapResponseVO;if(!_.isEmpty(payCapResponse)&&!payCapResponse.paymentApproved){self.paymentConfirmButtonStatus=false;self.paymentCapLimitMsg=self.locale.getMessage("paymentDue.paymentCap.limit.msg",$filter("globalize_currency")(self.enablePaymentCap.lotCashLimit,self.selectedCurrency,2));$("#paymentCapErrorModal").modal("show");self.backPaymentDue();return}}else{self.paymentCapLimitMsg=
self.locale.getMessage("paymentDue.paymentCap.default.error");$("#paymentCapErrorModal").modal("show");self.backPaymentDue();return}})}self.paymentConfirmButtonStatus=false;var table=$(self.table).dataTable();$("#chkSelectAllPayConfirm").prop("checked",false);var paymentDueConfirmTable="#paymentDueConfirmTable";var oTableDest=$(paymentDueConfirmTable).DataTable();oTableDest.clear().draw();jQuery(table.fnGetNodes()).find(":checkbox:checked").each(function(){var rowIndex=table.fnGetPosition(jQuery(this).closest("tr")[0]);
var aData=table.fnGetData(rowIndex);oTableDest.row.add(aData)});oTableDest.draw();self.compileDom(paymentDueConfirmTable);self.setTotalInvoices(paymentDueConfirmTable);self.checkPartialPayment();self.showInvoiceConfirmation=true;$timeout(function(){oTableDest.columns.adjust().responsive.recalc()},0)};self.checkNonSecuredPartialPayment=function(){if(self.selectedPaymentMethod.paymentType=="U"){var funds=self.selectedPaymentMethod.availableFund;var firstPayTypes=[];var amountDuesTotal=0;self.isNonSecuredPartialPaymentApplied=
false;var table=$(self.table).dataTable();var invoiceIds=[];var invoiceIdsofNonSecuredUsed=[];jQuery(table.fnGetNodes()).find(":checkbox:checked").each(function(index){var rowIndex=table.fnGetPosition(jQuery(this).closest("tr")[0]);var data=table.fnGetData(rowIndex);amountDuesTotal=amountDuesTotal+data.amountDue;firstPayTypes.push(data.firstPayType);if(data.firstPayType!=undefined&&data.firstPayType!=null&&data.firstPayType=="NSEC")invoiceIdsofNonSecuredUsed.push(data.id);invoiceIds.push(data.id)});
if(_.contains(firstPayTypes,"NSEC")&&amountDuesTotal>funds){self.nonSecuredPartialPaymentMsg=self.locale.getMessage("paymentDue.nonsecured.partial.payment.msg",invoiceIdsofNonSecuredUsed.join(","));self.isNonSecuredPartialPaymentApplied=true}}};self.preparePaymentCapInquiryVO=function(){var total=0,catBdesc="CAT B - BREAKER";var invoices=[];var table=$(self.table).dataTable();jQuery(table.fnGetNodes()).find(":checkbox:checked").each(function(index){var rowIndex=table.fnGetPosition(jQuery(this).closest("tr")[0]);
var aData=table.fnGetData(rowIndex);total+=aData.disctdue;var invoice={"invoiceNumber":aData.id,"outstandingPayment":aData.disctdue,"order":index+1,"invoiceType":aData.lori==="LOT"?"Lot":"Misc","invoiceDate":aData.saleDate,"isCatBLot":!_.isEmpty(aData.ownerTitleType)&&aData.ownerTitleType.trim()===catBdesc?true:false};invoices.push(invoice)});return{"currencyCode":self.selectedCurrency,"payments":[{"amount":self.selectedPaymentMethod.availableFund<total?self.selectedPaymentMethod.availableFund:total,
"paymentType":self.selectedPaymentMethod.paymentType}],"invoices":invoices}};self.checkPartialPayment=function(){if(self.selectedPaymentMethod.paymentType=="U"){var funds=self.selectedPaymentMethod.availableFund;var fundsMessageFlag=false;var table=$("#paymentDueConfirmTable").DataTable();self.showPartialPaymentMessage=false;table.rows().eq(0).each(function(index){var row=table.row(index);var data=row.data();funds=funds-data.amountDue;if(funds<0&&!fundsMessageFlag){fundsMessageFlag=true;self.showPartialPaymentMessageText=
self.locale.getMessage("availableFund.partialPayment.message",data.id);self.showPartialPaymentMessage=true}})}};self.removeSelectedInvoices=function(){var table=$("#paymentDueConfirmTable").dataTable();jQuery(table.fnGetNodes()).find(":checkbox:checked").each(function(){table.fnDeleteRow($(this).parents("tr")[0],false)});table.fnDraw();self.setTotalInvoices(paymentDueConfirmTable);self.enablePaymentConfirmButton();self.checkPartialPayment()};self.backPaymentDue=function(){scrollToTop();var table=
$(self.table).dataTable();self.setTotalInvoices(table);self.showInvoiceConfirmation=false;$("#chkSelectAll").prop("checked",false);self.selectAllCheckBox()};self.paySeletedInvoices=function(){scrollToTop();omnitureCallWesternUnion("doTagSubmitPaymentWU",self.selectedPaymentMethod.paymentType);if(self.selectedPaymentMethod.paymentType=="G")self.payUsingWU();else{self.showInvoiceProcessing=true;var table=$("#paymentDueConfirmTable").dataTable();var ids=jQuery(table.fnGetNodes()).find(":checkbox").map(function(){return this.value}).get().join(",");
var payInvoicesParam={};payInvoicesParam.invoiceIds=ids;payInvoicesParam.paymentType=self.selectedPaymentMethod.paymentType;if(self.showDiscountedDue)payInvoicesParam.invoiceTotal=Number(self.totalDiscountedDues.replace(/[^0-9\.]+/g,""));else payInvoicesParam.invoiceTotal=Number(self.totalDues.replace(/[^0-9\.]+/g,""));try{var lotIds=ids.split(",");for(var i=0;i<lotIds.length;i++)copartOmnitureCallMulti("doTagSelectedForPayment",[lotIds[i],self.userConfig.buyerNumber,payInvoicesParam.invoiceTotal])}catch(e){console.log("site catalyst call failed")}self.checkFormemberShipUpgradeInvoices(table);
if(self.selectedPaymentMethod.paymentType=="L")self.payUsingAFC(payInvoicesParam);else dataServiceG2.paySelectedInvoices(payInvoicesParam,function(result){if(result.returnCode==1){var transactionId=result.data.transactionId;var paidInvoiceSecretId=result.data.paidInvoiceSecretId;var paymentType=self.selectedPaymentMethod.paymentType;if(self.selectedPaymentMethod.paymentType=="P"){var requestParam={};requestParam.transactionId=transactionId;requestParam.paidInvoiceSecretId=paidInvoiceSecretId;requestParam.GATEWAY_URL_KEY=
"PAYMENT_DUE";requestParam.cancelCallBackUrl="paymentsDue";requestParam.successCallBackURL="paidInvoicesList/"+transactionId+"/"+paymentType+"/"+paidInvoiceSecretId;dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==1)$window.location.href=response.data.pciURL.trim();else console.log("error")})}else $location.url("/paidInvoicesList/"+transactionId+"/"+paymentType+"/"+paidInvoiceSecretId)}else{if(paymentService.getUpgradeMembershipFlag())paymentService.removeUpgradeMembershipFlag();
var modalElement=$("#ccPaymentTransLimit"),ccPerTransactionLimit=appConfigService.getAppConfig().getCcMaxLimit()[0].code;var message=self.locale.getMessage("member.paymentDue.creditCard.api.transactionlimit."+result.data.errorCode,$filter("globalize_currency_using_code")(ccPerTransactionLimit,self.selectedCurrency,2));modalElement.find("#mes").html(message.toString());self.showInvoiceProcessing=false;self.backPaymentDue();modalElement.modal("show")}})}};self.payUsingWU=function(){var table=$("#paymentDueConfirmTable").dataTable();
dataServiceG2.getContactInfo(function(response){self.accountInfoVO=response.data.contactInfoList;var servicesIds=wuServiceId.split(",");var xmldata="\x3cpaymentInformation\x3e\x3cclientId\x3e"+wuClientId+"\x3c/clientId\x3e\x3clocale\x3een_GB\x3c/locale\x3e\x3cbuyer\x3e\x3cid\x3e"+self.userConfig.buyerNumber+"\x3c/id\x3e\x3cfirstName\x3e"+self.accountInfoVO.firstName+"\x3c/firstName\x3e\x3clastName\x3e"+self.accountInfoVO.lastName+"\x3c/lastName\x3e\x3caddress\x3e"+self.accountInfoVO.physicalAddressLine1+
"\x3c/address\x3e\x3ccity\x3e"+self.accountInfoVO.city+"\x3c/city\x3e\x3cstate\x3e"+self.accountInfoVO.state+"\x3c/state\x3e\x3czip\x3e"+self.accountInfoVO.zip1+"\x3c/zip\x3e\x3ccountry\x3e"+self.accountInfoVO.country+"\x3c/country\x3e\x3cemail\x3e"+self.accountInfoVO.email+"\x3c/email\x3e";jQuery(table.fnGetNodes()).find(":checkbox").each(function(index){var rowIndex=table.fnGetPosition(jQuery(this).closest("tr")[0]);var aData=table.fnGetData(rowIndex);xmldata=xmldata+"\x3ccustomField\x3e"+aData.id+
"\x3c/customField\x3e"});xmldata=xmldata+"\x3c/buyer\x3e";jQuery(table.fnGetNodes()).find(":checkbox").each(function(index){var rowIndex=table.fnGetPosition(jQuery(this).closest("tr")[0]);var aData=table.fnGetData(rowIndex);console.log(aData);xmldata=xmldata+"\x3cservice\x3e\x3cid\x3e"+servicesIds[index]+"\x3c/id\x3e\x3camount\x3e"+aData.amountDue+"\x3c/amount\x3e\x3c/service\x3e"});xmldata=xmldata+"\x3c/paymentInformation\x3e";console.log(xmldata);$("#payload").val(xmldata);var form=document.getElementById("PaymentAllowedForm");
form.action=wuEndPointUrl;form.submit()})};self.payUsingAFC=function(payInvoicesParam){payInvoicesParam.dealerId=self.afcFunderVO.dealerID;dataServiceG2.paySelectedInvoicesUsingAFC(payInvoicesParam,function(result){if(result.returnCode==1){result.data.invoiceTotal=payInvoicesParam.invoiceTotal;result.data.currencyCode=self.selectedPaymentMethod.currency;paymentService.storePaymentInfo(result.data);$location.url("/paidInvoicesList/1/"+self.selectedPaymentMethod.paymentType)}else{var errorMsg="";if(!_.isEmpty(result.data.errorCode))errorMsg=
self.locale.getMessage("member.paymentDue.floorplan.error."+result.data.errorCode.trim())+". "+self.locale.getMessage("member.paymentDue.floorplan.error.common");else errorMsg=self.locale.getMessage("member.paymentDue.floorplan.error.common");self.showAFCInfoModal(errorMsg);self.showInvoiceProcessing=false;self.backPaymentDue();return}})};self.checkPartialPaymentForAFC=function(){if(self.selectedPaymentMethod.paymentType=="L"){self.isPartialPaymentForAFC=false;var table=$(self.table).dataTable();
jQuery(table.fnGetNodes()).find(":checkbox:checked").each(function(index){var rowIndex=table.fnGetPosition(jQuery(this).closest("tr")[0]);var data=table.fnGetData(rowIndex);if(data.amountDue<data.invoiceAmount){self.isPartialPaymentForAFC=true;return false}})}};self.checkFormemberShipUpgradeInvoices=function(table){var membershipUpgradeArr=[];jQuery(table.fnGetNodes()).find(":checkbox").each(function(index){var rowIndex=table.fnGetPosition(jQuery(this).closest("tr")[0]);var aData=table.fnGetData(rowIndex);
if(_.contains(self.memberShipUpgradeInvoices,aData.description))membershipUpgradeArr.push(aData)});if(membershipUpgradeArr.length>0){var initalRegsitrationFeeObj=_.find(membershipUpgradeArr,function(invoice){return invoice.description==self.memberShipUpgradeInvoices[0]});var initalDepositObj=_.find(membershipUpgradeArr,function(invoice){return invoice.description==self.memberShipUpgradeInvoices[1]});if(initalRegsitrationFeeObj&&initalDepositObj||initalDepositObj)paymentService.setUpgradeMembershipFlag(true)}};
self.reloadPaymentTable=function(paymentMethod,bidderObj){self.selectedPaymentMethod=paymentMethod;self.bidders.selBidderObj=bidderObj;self.estimates.selectedPaymentMethod=paymentMethod.paymentType;self.estimates.selectedScope=undefined;omnitureCallWesternUnion("doTagPaymentSelectedWU",self.selectedPaymentMethod.paymentType);self.getFunderAvailableBalance();var table=jQuery(self.table).DataTable();table.clear();if(self.isHighVolumePayment&&self.bidders&&self.bidders.selBidderObj)self.bidderNumber=
self.bidders.selBidderObj.bidderId;table.ajax.url((self.isHighVolumePayment?"/data/payments/getAdvancedDueInvoiceList/":"/data/payments/getDueInvoiceList/")+self.selectedPaymentMethod.paymentType+"/"+self.selectedCurrency).load(self.resetDefaultValues(),false);$("#chkSelectAll").prop("checked",false);self.showWesturnUnionInfo();self.enablePayAllButton()};self.getFunderAvailableBalance=function(){if(self.selectedPaymentMethod.paymentType=="L"){_.each(self.financeVOList,function(financeVO){if(self.selectedPaymentMethod.funderCode.trim()===
financeVO.providerCode.trim()){self.afcFunderVO=financeVO;return}});var accountInfoVO={funderCode:self.afcFunderVO.providerCode,dealerID:self.afcFunderVO.dealerID};dataServiceG2.getAvailableBalance(accountInfoVO,function(response){if(response.returnCode==1){var errorCode=response.data.accountInfoVO?response.data.accountInfoVO.errorCode:JSON.parse(response.data.errorObject).errorCode;if(errorCode!=null&&errorCode.trim()!=""){self.getAfcBalAPIErrorMsg=self.locale.getMessage("app.acctInfo.error.errorcode."+
errorCode.trim())+". "+self.locale.getMessage("app.acctInfo.verifyFinance.error.errorcode.common");self.getAfcBalAPIError=true;self.showAFCInfoModal(self.getAfcBalAPIErrorMsg);return}else{if(response.data.accountInfoVO.availableCreditVO){var availableCreditVO=response.data.accountInfoVO.availableCreditVO;self.selectedPaymentMethod.availableFund=availableCreditVO.availableCredit;self.selectedPaymentMethod.currency=availableCreditVO.currency}self.getAfcBalAPIErrorMsg="";self.getAfcBalAPIError=false}}})}};
self.showAFCInfoModal=function(message){var modalElement=$("#afcErrorModal");modalElement.find("#mes").html(message.toString());modalElement.modal("show")};self.showWesturnUnionInfo=function(){if(self.selectedPaymentMethod.paymentType=="G")if(showWUInfoPopUp){$("#westernUnionInfo").modal("show");showWUInfoPopUp=false}};self.print=function(){window.print()};table.overrideDefaults=function(data){var filterJSONString={filters:[]};if(self.bidders.selBidderObj){var jsonData={};jsonData.filterBy="bidderId";
jsonData.filterValue=[self.bidders.selBidderObj.bidderId];filterJSONString.filters.push(jsonData)}if(Object.keys(self.saleTypeSelected).length){var list=[];var check=true;angular.forEach(self.saleTypeSelected,function(value,key){if(key=="All"&&value)check=false;else if(value&&check)list.push(key.replace(/\s+/g,""))});if(check&&list.length>0){var jsonData={};jsonData.filterBy="saleType";jsonData.filterValue=list;filterJSONString.filters.push(jsonData)}}self.extendFilterObj(data,filterJSONString);data.filterCriteria=
JSON.stringify(filterJSONString)};self.extendFilterObj=function(data,filterJSONString){};self.showImages=function(){var ttable=jQuery(self.table).DataTable();var column=ttable.column("imagePath:name");if(jQuery("#hideImg").is(":checked")==false){self.showImage=false;localStorageService.set("show-image",false);column.visible(false)}else{self.showImage=true;column.visible(true)}if(self.showImage){localStorageService.set("show-image",true);var rows=ttable.rows({page:"current"}).nodes();for(var i=0;i<
rows.length;i++){var image=jQuery(".img-icon",rows[i]);image.attr("src",image.attr("o-data-src"))}self.compileDomByClassName(".compile")}};self.showDeliveryEstimates=function(){if(self.ShwDelEstChecked){var expandedChildRows=angular.element(document.querySelectorAll("tr.parent td.control"));_.each(expandedChildRows,function(child){child.click()})}self.compileDomByClassName(".compileEstimates")};self.compileDomByClassName=function(className){$(className).each(function(){var value=$(this);var retn=
$compile(value)($scope);self.safeApply()})};self.payAllUK=function(fromRequest){var requestParam={};requestParam.GATEWAY_URL_KEY="PAY_ALL_UK";dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==1)$window.location.href=response.data.pciURL.trim();else log.error("Error in Gateway")})};self.payAllIE=function(fromRequest){var requestParam={};requestParam.GATEWAY_URL_KEY="PAY_ALL_IE";dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==1)$window.location.href=
response.data.pciURL.trim();else log.error("Error in Pay All IE Gateway")})};self.enablePaymentButton=function(applyChanges){var invoicesSelected=$(".invoiceId:checked").size();self.disabledPaymentButton=invoicesSelected>0?false:true;if(self.selectedPaymentMethod.paymentType=="O")if(self.epayFundsLimit<1)self.disabledPaymentButton=true;if(self.selectedPaymentMethod.paymentType=="P")if(self.ccmaxLimit<=0)self.disabledPaymentButton=true;if(self.selectedPaymentMethod.paymentType=="G")if(wuLimitRemaining<=
0)self.disabledPaymentButton=true;if(self.selectedCurrency=="CAD"){self.disabledPaymentButton=true;$(".invoiceId").attr("disabled",true)}if(self.noAvailableFundAmountError)self.disabledPaymentButton=true;if(!applyChanges&&applyChanges!=false)$scope.safeApply()};$scope.safeApply=function(fn){var phase=this.$root.$$phase;if(phase=="$apply"||phase=="$digest"){if(fn&&typeof fn==="function")fn()}else this.$apply(fn)};self.enablePaymentConfirmButton=function(){var table=$("#paymentDueConfirmTable").dataTable();
var numberOfInvoices=table.fnSettings().fnRecordsTotal();self.paymentConfirmButtonStatus=numberOfInvoices>0?false:true};$(self.table).on("click.dtr",function(e){var retn=$compile($(e.target).parent().next().find(".child"))($scope)});self.stateFilter=function(item){return item.type==="USA"||item.type==="CAN"};self.navigateToLotDetails=paymentService.navigateToLotDetails;self.navigateToLocationDetails=paymentService.navigateToLocationDetails;self.isUKSite=function(){var userConfig=copartUser.getUserConfig();
return userConfig.companyCode=="COPARTUK"};function omnitureCallWesternUnion(eventName,paymentMethodType){if(paymentMethodType=="G"){var siteCatalystVal={};siteCatalystVal.fname=eventName;siteCatalyst.addToQueue(eventName,siteCatalystVal);siteCatalyst.executeCall(eventName)}}self.hazardousWasteNotePopup=function(){$("#hazardousWasteNote").modal("show")};self.emailInvoiceCall=function(invoiceNumber,secretId,payType,currency,invType,lotNumber,bidderNumber){self.emailInvoiceParam={};self.emailInvoiceParam.invoiceNumber=
invoiceNumber;self.emailInvoiceParam.paymentType=payType;self.emailInvoiceParam.currencyCode=currency;self.emailInvoiceParam.invoiceType=invType;self.emailInvoiceParam.lotNumber=lotNumber;self.emailInvoiceParam.bidderNumber=bidderNumber;self.emailInvoiceParam.secretId=secretId;$("#emailInvoice").modal("show")};self.redirect=function(){var url=$location.absUrl();var path=$location.path();url=url.replace(path,"");$window.location.href=url};self.cachePaymentsData=function(key,value){var cachedData=localStorageService.get(paymentsConstants.PAYMENTS_DUE_LOCAL_STORAGE_KEY)||
{};cachedData[key]=value;localStorageService.set(paymentsConstants.PAYMENTS_DUE_LOCAL_STORAGE_KEY,cachedData)};self.getCachedPaymentsData=function(key){var cachedData=localStorageService.get(paymentsConstants.PAYMENTS_DUE_LOCAL_STORAGE_KEY)||{};return cachedData[key]};self.openEmailGatePassToTransporterModal=function(lotNumber,existingTransporterEmail){self.emailErrorMessage="";self.emailGatePassParam={};self.emailGatePassParam.lotNumber=lotNumber;self.transporterEmail=existingTransporterEmail;self.isOffSiteLot=
false;self.isOrderDeliveryMade=false;if(_.isEmpty(self.transporterEmail)&&self.siteCode!="CPRTUK")paymentService.getOrderAndDeliveryStatus(lotNumber).then(function(response){self.isOrderDeliveryMade=response.transportationOrderStatus.toLowerCase()=="cancel"?true:false;$("#emailGatePassToTransporter").modal("show")});else $("#emailGatePassToTransporter").modal("show")};self.emailGatePassToTransporter=function(emailGatePassToTransporterForm){if(emailGatePassToTransporterForm.$valid){$("#emailGatePassToTransporter").modal("hide");
self.submitted=true;var emailGatePassVO={};emailGatePassVO.email=self.transporterEmail;emailGatePassVO.lot_numbers=[self.emailGatePassParam.lotNumber];dataServiceG2.sendGatePassToTransporter(emailGatePassVO,function(response){if(response.returnCode!=-1&&!_.isEmpty(response.data)){if(!_.isEmpty(response.data.status)&&response.data.status=="success"){self.emailTransporterMessage=self.locale.messages["app.label.sendGassPassToTransporter.msg.success"];$("#emailGatePassToTransporterSuccess").modal("show");
copartOmnitureCallMulti("doTagSendToTransporter",[userService.userConfig.buyerNumber])}}else if(response.returnCode==-1){self.emailTransporterMessage=response.data.errorObject.errorMessage+" "+self.locale.messages["app.label.sendGassPassToTransporter.msg.error"];$("#emailGatePassToTransporterFailure").modal("show")}else{self.emailTransporterMessage=self.locale.messages["app.label.sendGassPassToTransporter.msg.error"];$("#emailGatePassToTransporterFailure").modal("show")}},function(error){log.error("send Gatepass to Transporter Call -\x3e Failed "+
error)})}else self.emailErrorMessage=self.locale.messages["app.error.invalid.email"]};self.openCancelTransporterModal=function(lotNumber,existingTransporterEmail){self.CancelTransporterLot=lotNumber;self.transporterEmail=existingTransporterEmail;$("#cancelTransporter").modal("show")};self.cancelTransporter=function(){$("#cancelTransporter").modal("hide");self.submitted=true;var cancelTransporterVO={};cancelTransporterVO.lot_numbers=[self.CancelTransporterLot];dataServiceG2.cancelTransporter(self.CancelTransporterLot,
function(response){if(response.returnCode!=-1&&!_.isEmpty(response.data)){if(!_.isEmpty(response.data.status)&&response.data.status=="success"){self.cancelTransporterMessage=self.locale.getMessage("app.label.sendGassPassToTransporter.cancel.success",self.transporterEmail);$("#cancelTransporterSuccess").modal("show");copartOmnitureCallMulti("doTagCancelTransporter",[userService.userConfig.buyerNumber])}}else if(response.returnCode==-1){self.cancelTransporterMessage=response.data.errorObject.errorMessage+
" "+self.locale.messages["app.label.cancelTransporter.msg.error"];$("#cancelTransporterFailure").modal("show")}else{self.cancelTransporterMessage=self.locale.messages["app.label.cancelTransporter.msg.error"];$("#cancelTransporterFailure").modal("show")}},function(error){log.error("cancel Transporter Call -\x3e Failed "+error)})};self.openBuyerPickupStatusDetailsModal=function(lotNumber){var statusDetailsTable=$("#buyerPickupStatusDetailsTable").DataTable({"responsive":true,"ajax":{"type":"GET","url":"/data/buyerPickup/status/details/"+
lotNumber,"dataSrc":function(response){if(response.returnCode!=-1&&!_.isEmpty(response.data))return response.data.data}},"destroy":true,"filter":false,"info":false,"ordering":false,"stateSave":false,"paging":false,"cache":false,"deferRender":true,"columns":[{"data":"updated_at","render":function(data,type,row){return moment.utc(data).tz(userService.userConfig.selectedTimezone).format("YYYY-MM-DD hh:mm:ss a")}},{"data":"event_name"},{"data":"event_notes"}]});$("#buyerPickupStatusDetails").modal("show")};
self.loadAfterInit=function(){};self.biddersList=[];dataServiceG2.getBidderStatusList(function(responseData){if(responseData.returnCode==-1)log.error("Error");else self.biddersList=responseData.data||[]})}]);
app.controller("invoiceDetailsController",["$scope","$http","$location","dataServiceG2","$filter","$routeParams","backToLinkService","localStorageService","$timeout","copartUser",function($scope,$http,$location,dataServiceG2,$filter,$routeParams,backToLinkService,localStorageService,$timeout,copartUser){var self=$scope;self.locale=$scope.$parent.locale;self.invoiceId=$routeParams.invoiceId;self.invoiceNumberForSecurity=$routeParams.invoiceId;self.paymentType=$routeParams.paymentType;self.selectedCurrency=
$routeParams.selectedCurrency;self.invoiceType=$routeParams.invoiceType==null?"":$routeParams.invoiceType;self.lotNumber=$routeParams.lotNumber==null?"":$routeParams.lotNumber;self.secretId=$routeParams.secretId==null?"":$routeParams.secretId;self.emailConfirmMessage=false;self.fromPaymentHistory=$routeParams.fromPaymentHistory;self.showInvoiceLoadingProcessing=false;self.backToLink=backToLinkService.getBackToLink();self.backToLinkText=backToLinkService.getBackToLinkText();self.bidderNumber=$routeParams.bidderNumber;
self.init=function(){self.showInvoiceLoadingProcessing=true;var invoiceDetailsParam={};invoiceDetailsParam.invoiceId=self.invoiceId;invoiceDetailsParam.paymentType=self.paymentType;invoiceDetailsParam.selectedCurrency=self.selectedCurrency;invoiceDetailsParam.invoiceType=self.invoiceType;invoiceDetailsParam.lotNumber=self.lotNumber;dataServiceG2.invoiceDetails(invoiceDetailsParam,function(result){self.showInvoiceLoadingProcessing=false;self.invoiceDetails=result.data.invoiceDetails;self.isPdf=self.invoiceDetails.isPdf;
var documentId=result.data.documentId;if(documentId!=null&&documentId!="0"){self.invoiceId=documentId;self.invoiceType="VAT"}self.email=result.data.email?result.data.email.trim():"";$timeout(function(){if($(window).width()<800)$("pre").contents().unwrap().wrap('\x3cdiv class\x3d"pre"/\x3e');else $("div.pre").contents().unwrap().wrap("\x3cpre /\x3e")},0)})};self.restore=function(){localStorageService.set("restore-search-state",true)};self.emailInvoice=function(){self.emailConfirmMessage=true;var emailInvoiceParam=
{};emailInvoiceParam.invoiceNumber=self.invoiceId;emailInvoiceParam.invoiceType=self.invoiceType;emailInvoiceParam.lotNumber=self.lotNumber;emailInvoiceParam.emailAddress=self.email;emailInvoiceParam.secretId=self.secretId;emailInvoiceParam.bidderNumber=self.bidderNumber;emailInvoiceParam.invoiceNumberForSecurity=self.invoiceNumberForSecurity;dataServiceG2.emailInvoice(emailInvoiceParam,function(result){self.emailSend=result.returnCode==1?true:false;self.emailError=!self.emailSend})};$("#emailInvoice").on("hidden.bs.modal",
function(){self.emailConfirmMessage=false;self.$apply()});self.print=function(){window.print()};self.init()}]);
app.controller("todaysAuctionController",["$scope","$http","$locale","$sce","$routeParams","initData","copartUser","userService","$compile","$location","$timeout","$cookies","dataServiceG2","auctionsCalendarService","appConfigService","$filter","urlService","metaDataService",function($scope,$http,$locale,$sce,$routeParams,initData,copartUser,userService,$compile,$location,$timeout,$cookies,dataServiceG2,auctionsCalendarService,appConfigService,$filter,urlService,metaDataService){var self=$scope;self.siteCode=
copartUser.getUserConfig().siteCode;self.data={};var yards=appConfigService.getAppConfig().getYards();self.liveSaleTypeList=[];self.laterSaleTypeList=[];self.liveSelected={};self.laterSelected={};self.locale=$scope.$parent.locale;var formatDate=function(date){if(date){var year=date.substr(0,4);var month=date.substr(4,2);var day=date.substr(6,2);return year+"-"+month+"-"+day}};var formatSaleDate=function(date){if(date){var year=date.substr(0,4);var month=date.substr(4,2);var day=date.substr(6,2);return month+
"/"+day+"/"+year}};self.joinLiveAuction=function(auction){var url=getJoinAuctionUrl(auction);$location.url(url)};self.getJoinAuctionUrl=function(auction){return"/auctionDashboard?auctionDetails\x3d"+(auction.auctionHostId?auction.auctionHostId:auction.yardNumber)+"-"+auction.lane};self.viewSaleList=function(auction,liveAuction){auction.liveAuction=liveAuction;auction.from="/todaysAuction";return urlService.getSaleListResultUrl(auction,true)};self.viewAllLanesSalesList=function(auction,liveAuction){if(auction){auction.liveAuction=
liveAuction;auction.from="/todaysAuction";return urlService.getAllLaneSaleListResultUrl(auction)}};self.init=function(){self.saleTypeMap=_.object(_.map(yards,function(yard){return[yard.number,yard.saleType]}));var timeZonePrefStr=$cookies.get("copartTimezonePref");if(timeZonePrefStr)timeZonePrefStr=encodeURI(timeZonePrefStr);var url="/public/data/todaysAuctions";if(appInit.appPlatform!="gbl")url=url+"?appId\x3dg2\x26copartTimezonePref\x3d"+timeZonePrefStr;self.loadingSearchResults=true;self.loadingSearchResultsLater=
true;dataServiceG2.getTodayAuctionData(url,function(response){self.data.liveAuctions=response.data.saleList.liveSales||[];self.data.laterTodaysAuctions=response.data.saleList.laterSales;self.loadingSearchResults=false;var liveAuctionsFilter=_.filter(self.data.laterTodaysAuctions,function(auction){return auction.isLive==true||auction.closedFlag=="I"});if(!_.isEmpty(liveAuctionsFilter))self.data.liveAuctions=self.data.liveAuctions.concat(liveAuctionsFilter);self.data.laterTodaysAuctions=_.filter(self.data.laterTodaysAuctions,
function(auction){return!(auction.isLive==true||auction.closedFlag=="I")});$timeout(function(){self.initializeDatatable("#auctionLiveNow-datatable")},0);if(null==self.data.laterTodaysAuctions||self.data.laterTodaysAuctions.length==0){self.loadingSearchResultsLater=copartUser.hasAccessSitePref("auctionFields","showLaterTodaysAuctions");if(self.loadingSearchResultsLater)$timeout(function(){self.initializeDatatable("#auctionLaterToday-datatable")},0)}self.liveSaleTypeList=_.chain(self.data.liveAuctions).filter(function(auction){return self.saleTypeMap[auction.yardNumber]!=
""}).map(function(auction){return self.saleTypeMap[auction.yardNumber]}).uniq().value();self.laterSaleTypeList=_.chain(self.data.laterTodaysAuctions).filter(function(auction){return self.saleTypeMap[auction.yardNumber]!=""}).map(function(auction){return self.saleTypeMap[auction.yardNumber]}).uniq().value()})}();self.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){var id=null;if(!$.fn.DataTable.isDataTable("#auctionLiveNow-datatable")&&self.data.liveAuctions.length>0)id="#auctionLiveNow-datatable";
else if(self.data.laterTodaysAuctions.length>0)id="#auctionLaterToday-datatable";if(null!=id)self.initializeDatatable(id)});self.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){var El1=angular.element(document.querySelector("#modal-join-auction #auctionLiveNow-datatable_wrapper .row:first-child \x3e div:first-child"));El1.removeClass("col-sm-6");El1.addClass("col-sm-12");var El2=angular.element(document.querySelector("#modal-join-auction #auctionLaterToday-datatable_wrapper .row:first-child \x3e div:first-child"));
El2.removeClass("col-sm-6");El2.addClass("col-sm-12");var El3=angular.element(document.querySelector("#modal-join-auction #auctionLiveNow-datatable_wrapper .row:first-child \x3e div:nth-child(2)"));El3.removeClass("col-sm-6");El3.addClass("col-sm-12");var El3=angular.element(document.querySelector("#modal-join-auction #auctionLaterToday-datatable_wrapper .row:first-child \x3e div:nth-child(2)"));El3.removeClass("col-sm-6");El3.addClass("col-sm-12")});self.initializeDatatable=function(id){if(!$.fn.DataTable.isDataTable(id))self.id=
$(id).DataTable({"bPaginate":false,"responsive":{details:{type:"column",target:-1}},"aaSorting":[],"columnDefs":[{className:"control",orderable:false,targets:-1},{"bSortable":false,"aTargets":["sorting_disabled"]}],"language":{"search":self.locale.messages["app.label.search"]+":","emptyTable":self.locale.messages["app.todaysauction.emptytable"],"searchPlaceholder":self.locale.messages["app.label.searchListPlaceholder"],"info":self.locale.getMessage("app.label.showingRecords.info","_START_","_END_",
"_TOTAL_"),"infoEmpty":self.locale.messages["app.todaysauction.infoEmpty"]},"fnInitComplete":function(){$("#auctionLiveNow-datatable_filter input,#auctionLaterToday-datatable_filter input").focus(function(e){e.target.placeholder=""}).blur(function(e){e.target.placeholder=self.locale.messages["app.label.searchListPlaceholder"]||"Search this list"})}});else self.id.draw()};var checkBoxFilter=function(selected,dataTableId){var list=[];angular.forEach(selected,function(value,key){if(value)list.push(key)});
var combinedString=list.join("|");var filteredData=jQuery(dataTableId).DataTable().column(".saleTypeCol").search(combinedString,true,false).draw()};self.liveSaleType=function(){checkBoxFilter(self.liveSelected,"#auctionLiveNow-datatable")};self.laterSaleType=function(){checkBoxFilter(self.laterSelected,"#auctionLaterToday-datatable")}}]);
app.controller("paidInvoiceListController",["$scope","$http","$location","dataServiceG2","$filter","$routeParams","paymentService","$window",function($scope,$http,$location,dataServiceG2,$filter,$routeParams,paymentService,$window){var self=$scope;self.transactionId=$routeParams.transactionId;self.paidInvoiceSecretId=$routeParams.paidInvoiceSecretId;self.paymentType=$routeParams.paymentType?$routeParams.paymentType.trim():"";self.showReferenceNumber=true;self.init=function(){var requestParam={};var paidAmount=
0;requestParam.transactionId=self.transactionId;requestParam.paidInvoiceSecretId=self.paidInvoiceSecretId;self.upgradeMembershipFlag=paymentService.getUpgradeMembershipFlag();if(self.paymentType==="L"){var paymentInfo=paymentService.getPaymentInfo();_.each(paymentInfo.invoicesList,function(invoice){paidAmount+=invoice.amountDue;invoice.amountDue=0});self.invoiceList=paymentInfo.invoicesList;self.failedInvoices=paymentInfo.failedInvoices;self.transactionDate=paymentInfo.transactionDate;self.showReferenceNumber=
false;self.invoiceData={currencyCode:paymentInfo.currencyCode,paymentAmount:paidAmount}}else dataServiceG2.paidInvoicesList(requestParam,function(result){if(result.returnCode==1){self.invoiceList=result.data.invoicesList;self.invoiceData=result.data.invoiceData;if(result.data.failedInvoices&&result.data.failedInvoices.length>0)self.failedInvoices=result.data.failedInvoices.join(",");self.transactionDate=result.data.transactionDate}else{console.log("Error fetchimg invoice list");jQuery("#paidInvoiceListErrMessageModal").modal("show")}})};
self.init();self.showUpgradeMembershipModal=function(){$("#showUpgradeMembershipModal").modal({backdrop:"static",keyboard:false});$("#showUpgradeMembershipModal").modal("show")};self.doLogout=function(){paymentService.removeUpgradeMembershipFlag();$window.location.href="/logout"}}]);
app.controller("saleReceiptController",["$scope","$http","$location","dataServiceG2","$filter","$routeParams","backToLinkService",function($scope,$http,$location,dataServiceG2,$filter,$routeParams,backToLinkService){var self=$scope;self.locale=$scope.$parent.locale;self.invoiceId=$routeParams.invoiceId;self.fromPaymentHistory=$routeParams.fromPaymentHistory;self.showSaleReceiptLoadingProcessing=false;self.backToLink=backToLinkService.getBackToLink();self.backToLinkText=backToLinkService.getBackToLinkText();
self.init=function(){self.showSaleReceiptLoadingProcessing=true;var saleReceiptParam={};saleReceiptParam.invoiceId=self.invoiceId;dataServiceG2.saleReceipt(saleReceiptParam,function(result){self.showSaleReceiptLoadingProcessing=false;self.saleReceiptDetails=result.data.saleReceiptDetails})};self.print=function(){window.print()};self.init()}]);
app.controller("registrationController",["$scope","$location","$http","$locale","$filter","$window","dataServiceG2","appConfigService","copartUser","$q","childParam","geocodingService","memberChoicesService","subscriptionsService","vcRecaptchaService",function($scope,$location,$http,$locale,$filter,$window,dataServiceG2,appConfigService,copartUser,$q,childParam,geocodingService,memberChoicesService,subscriptionsService,vcRecaptchaService){var self=$scope;self.myArray=[];self.registration={};self.newBuyerNumber;
self.locale=$scope.$parent.locale;self.showTellUsAboutYouIn=self.locale.getMessage("app.register.TellUsAboutYou.showTellUsAboutYouIn");self.showUploadBlock=false;self.registrationStepIncomplete=true;self.contactPhone1="";self.searchByZipCriteria={};self.pairedWithBroker="YES";self.choiceTypes=[];self.selChoicesDisplayName="";self.selectedMemberChoices="";self.marketingGroup="MARKETING_NEWS";self.isGDPRCountry=false;var memberType="WBDY";var businessType="BUTP";var vehicleType="VHTP";var vehiclePurpose=
"VPRP";var pairWithBroker="PBRK";var individual="INDL";var copartPrimaryUseCode="PUCF";var emailLanguage="ELNG";self.documentCategories=appConfigService.distinctDocCategories();var memberChoicesConstants=[{id:"VHTP",filterDiv:"vehicleTypes"},{id:"VPRP",filterDiv:"vehiclePurpose"},{id:"DTYP",filterDiv:"dealershipTypes"},{id:"VSRC",filterDiv:"vehicleSources"},{id:"BRND",filterDiv:"brands"},{id:"ELNG",filterDiv:"emailLanguage"}];self.getMemberChoicesFilterDiv=function(id){var constObj=_.find(memberChoicesConstants,
{id:id})||{};return constObj.filterDiv};self.isError=false;var registrationPreferenceConstant={REGISTRATION_PREF_COL_STR:"registrationPreference.components"};var showSubscriptions=copartUser.hasAccessSitePref(registrationPreferenceConstant.REGISTRATION_PREF_COL_STR,"subscriptions");var isBusinessUse=copartUser.hasAccessSitePref(registrationPreferenceConstant.REGISTRATION_PREF_COL_STR,"businessUse");self.contactPhone1="";self.states=[];self.submitDisabled=false;self.countries=appConfigService.appConfig.getCountries();
self.emailRule=copartUser.getUserConfig().emailRule;self.countriesMap=_.object(_.map(self.countries,function(item){return[item.code,item]}));self.defaultZipFormat="^[a-zA-Z0-9- ]*$";self.personalDetails={companyFlag:false,country:{culture:"AMERICA_US"},firstName:"",lastName:"",emailAddress:"",confirmationEmailAddress:"",companyName:"",address:"",addressLine2:"",stateOrProvince:"",city:"",zipOrPostalCode:"",phoneNumber:"",phoneExtension:"",termsAndConditions:false,physicalZip5:"",physicalZip4:"",subscriptionListVO:{},
subscription:{},subscriptionVOMap:{},contactPhoneIntlDialCode:"",alternatePhoneIntlDialCode:"",contactPhoneISOCountryCd:"",altPhoneISOCountryCd:""};self.personalDetails.pairedWithBroker="YES";if(copartUser.getUserConfig().availableSubscriptionsMap&&!_.isEmpty(copartUser.getUserConfig().availableSubscriptionsMap)){self.personalDetails.subscriptionVOMap=JSON.parse(JSON.stringify(copartUser.getUserConfig().availableSubscriptionsMap));self.personalDetails.subscriptionListVO=subscriptionsService.getSubscriptionVOListFromMap(self.personalDetails.subscriptionVOMap);
self.subscription=self.personalDetails.subscriptionVOMap.MARKETING_NEWS}self.cultureTemplateUrl="/public/fetchDirective.html?directive\x3dregistration/addressCultureTemplateFragment";self.irelandCounties=["Co. Carlow","Co. Cavan","Co. Clare","Co. Cork","Co. Donegal","Co. Dublin","Co. Galway","Co. Kerry","Co. Kildare","Co. Kilkenny","Co. Laois","Co. Leitrim","Co. Limerick","Co. Longford","Co. Louth","Co. Mayo","Co. Meath","Co. Monaghan","Co. Offaly","Co. Roscommon","Co. Sligo","Co. Tipperary","Co. Waterford",
"Co. Westmeath","Co. Wexford","Co. Wicklow"];self.errors={emailAlreadyExist:false,cityStateZipConbinationInvalid:false,termsAndCondtionsNotSelected:false,phoneNumber:false,specialChars:false,zipCode:false};self.patternRegExp={userName:/^[a-zA-Z\s]*$/};self.validateFunc=function(errorCode){switch(errorCode){case "email.already.exists":self.errors.emailAlreadyExist=true;break;case "city.zip.combination.invalid":self.errors.cityStateZipConbinationInvalid=true;break;case "C269113":self.errors.cityStateZipConbinationInvalid=
true;break;case "C269106":self.errors.emailAlreadyExist=true;break;default:return false}return true};self.buildChoicesElementData=function(){self.registration.member_types=memberChoicesService.getQuestion(memberType);self.registration.business_types=memberChoicesService.getQuestion(businessType);self.registration.pair_with_broker=memberChoicesService.getQuestion(pairWithBroker);self.registration.primary_use=memberChoicesService.getQuestion(copartPrimaryUseCode);self.registration.email_language=memberChoicesService.getQuestion(emailLanguage)};
self.getMemberChoices=function(){self.buildChoicesElementData()};var findByObj=function(list,object){return _.find(list,object)};self.typeSelected=function(choiceType){if(!choiceType)return;self.personalDetails.memberTypeAnswers=choiceType.answerCode;if(choiceType.answerCode=="INDL"){self.personalDetails.companyFlag=false;self.hideBlock=true;self.checkPairedWithBroker();memberChoicesService.updateChoiceSelections(copartPrimaryUseCode,findByObj(self.registration.primary_use.answers,{answerCode:"PRSLUSE"}),
true)}else{self.personalDetails.companyFlag=true;self.hideBlock=false;memberChoicesService.updateChoiceSelections(copartPrimaryUseCode,findByObj(self.registration.primary_use.answers,{answerCode:"BSNUSE"}),true)}memberChoicesService.updateChoiceSelections(memberType,choiceType,true)};self.populateSelection=function(answerCode,choiceType){if(!choiceType)return;_.forEach(choiceType.answers,function(type){if(type.answerCode==answerCode)type.activeStatusFlag="A";else type.activeStatusFlag="I"})};var getNearestLocationSearchCriteria=
function(){geocodingService.getCoordinatesForZip(self.personalDetails.zipOrPostalCode,function(retData){self.nearestLocationCriteria=self.$parent.getSearchCriteriaForSearchByZip(retData,50)})};self.getRequestData=function(){var requestData={physicalCountry:self.personalDetails.country.code,physicalState:self.personalDetails.stateOrProvince,firstName:self.personalDetails.firstName,lastName:self.personalDetails.lastName,emailAddress:self.personalDetails.emailAddress,confirmationEmailAddress:self.personalDetails.confirmationEmailAddress,
companyName:self.personalDetails.companyName,physicalAddress1:self.personalDetails.address,physicalAddress2:self.personalDetails.addressLine2,stateOrProvince:self.personalDetails.stateOrProvince,physicalCity:self.personalDetails.city,physicalZip:self.personalDetails.physicalZip5,physicalPostCode:self.personalDetails.zipOrPostalCode,contactPhoneNumber:self.contactPhone1.substring(3),contactPhoneExt:self.personalDetails.phoneExtension,contactPhoneAreaCode:self.contactPhone1.substring(0,3),physicalZip4:self.personalDetails.physicalZip4,
nearestLocationCriteria:self.nearestLocationCriteria,selectedChoices:memberChoicesService.getSelectedChoices(),acceptTerms:self.personalDetails.termsAndConditions?"Y":"N",companyFlag:self.personalDetails.companyFlag,contactPhoneIntlDialCode:self.personalDetails.contactPhoneIntlDialCode,alternatePhoneIntlDialCode:self.personalDetails.alternatePhoneIntlDialCode,contactPhoneISOCountryCd:self.personalDetails.contactPhoneISOCountryCd,altPhoneISOCountryCd:self.personalDetails.altPhoneISOCountryCd};if(showSubscriptions){_.each(self.personalDetails.subscriptionListVO,
function(subscription){if(subscription){subscription.subscriptionStatus=subscription.textSubscriptionStatus||subscription.webSubscriptionStatus||subscription.emailSubscriptionStatus||subscription.phoneSubscriptionStatus?"SUBSCRIBED":"NOT_SUBSCRIBED";subscription.showSignUpModal=true}});requestData.memberSubscriptionSignUpVOList=self.personalDetails.subscriptionListVO}if(isBusinessUse)memberChoicesService.updateChoiceSelections(copartPrimaryUseCode,findByObj(self.registration.primary_use.answers,{answerCode:"BSNUSE"}),
true);if(self.hideBlock)memberChoicesService.updateChoiceSelections(pairWithBroker,findByObj(self.registration.pair_with_broker.answers,{answerCode:self.personalDetails.pairedWithBroker}),true);if(appConfigService.getEnvConfigProps().enableReCaptcha){var reCaptchaResponse=vcRecaptchaService.getResponse();if(reCaptchaResponse==="")console.log("Please resolve the captcha in Registration");else requestData.reCaptchaResponse=reCaptchaResponse}return requestData};self.capturePreRegistrationData=function(successCallBack){dataServiceG2.capturePreRegistrationData(self.getRequestData(),
{onSuccess:function(responseData){if(responseData.returnCode==-1)self.registrationErrorResponseHandler(responseData);else successCallBack()},onFailure:function(data){console.error("Error in saving the pre registration data")}})};self.submitTellUsAboutYouFormWithChoices=function(isValid,form){self.submitted=true;if(self.validateAndMapSubmitRequest(isValid)){self.isError=false;var successCallBack=function(){getNearestLocationSearchCriteria();self.formObj=form;self.expandUploadBlock();if(self.personalDetails.memberTypeAnswers==
"INDL")copartOmnitureCallOne("doTagIndividualFormSubmitRegistration",self.personalDetails.pairedWithBroker);else copartOmnitureCallOne("doTagBusinessFormSubmitRegistration","")};self.capturePreRegistrationData(successCallBack)}else self.isError=true};self.validateAndMapSubmitRequest=function(isValid){if(self.errors.phoneNumber)return;self.submitDisabled=true;var isValidNumber=$('[name\x3d"phoneNumber"]').intlTelInput("isValidNumber");if(!self.validateZip("personalDetails"))self.errors.zipCode=true;
if(isValid&&self.personalDetails.termsAndConditions&&self.personalDetails.phoneNumber&&isValidNumber&&self.validateZip("personalDetails")){self.errors.phoneNumber=false;self.errors.zipCode=false;self.errors.emailAlreadyExist=false;self.errors.cityStateZipConbinationInvalid=false;self.errors.termsAndCondtionsNotSelected=false;self.contactPhone1=self.personalDetails.phoneNumber.replace(/[^a-zA-Z0-9]+/g,"");if(self.personalDetails.stateOrProvince=="")appConfigService.appConfig.getCountryStates().forEach(function(item){if(item.type==
self.personalDetails.country.code){self.personalDetails.stateOrProvince=item.code;return}});return true}self.errors.termsAndCondtionsNotSelected=!self.personalDetails.termsAndConditions;self.errors.phoneNumber=!isValidNumber;self.submitDisabled=false;return false};self.submitTellUsAboutYouForm=function(isValid){self.submitted=true;self.isSubScrError=false;if(self.validateAndMapSubmitRequest(isValid)){self.isError=false;self.registration_ServerException="";self.submitted="";dataServiceG2.registerNewMember(self.getRequestData(),
{onSuccess:function(responseData){if(responseData.returnCode==-1){if(responseData.data.errorObjects||responseData.data.errorObjectsMap){if(!self.handleServerSideErrors(responseData))self.registration_ServerException=self.$parent.locale.getMessage("registration.label.ServerException")}else self.registration_ServerException=self.$parent.locale.getMessage("registration.label.ServerException");self.submitDisabled=false}else{self.submitDisabled=true;try{copartOmnitureCallMulti("doTagRegistrationThankYouPage",
[responseData.data.newBuyerNumber,responseData.data.physicalState,responseData.data.physicalZip,responseData.data.physicalCountry,responseData.data.physicalCity])}catch(e){}self.showThankYou()}},onFailure:function(data){self.registration_ServerException=self.$parent.locale.getMessage("registration.label.ServerException");self.submitDisabled=false;console.error("UnHandled error during registration")}})}else self.isError=true};self.goToRegisteration=function(){$location.path("/doRegistration")},self.showPrivacyStatement=
function(){};self.showTermsAndConditions=function(){},self.showWebConditions=function(){},self.expandUploadBlock=function(){self.showTellUsAboutYouIn="";self.uploadBlockId=self.locale.getMessage("app.register.uploadLicense.uploadBlockId");self.showUploadBlock=true;self.showUploadIn=self.locale.getMessage("app.register.uploadLicense.showUploadIn");$window.scrollTo(0,0);self.registrationStepIncomplete=false},self.changeCountry=function(details,q){var countryObj=self[details].country;var element=$('[name\x3d"phoneNumber"]');
self[details].stateOrProvince="";countryObj=countryObj||{};if(self.$parent.cookiePolicyCountries&&_.contains(self.$parent.cookiePolicyCountries,countryObj.code))self.isGDPRCountry=true;else self.isGDPRCountry=false;self.resetPhoneData(details,countryObj);self.resetZipOrPostalCode(details);self.appConfig.getStatesOfCountry(self[details].country.code,function(states){self.states[details]=states;if(q)q.resolve(states)})},self.resetPhoneData=function(details,countryObj){if(details=="personalDetails"){var selected=
countryObj.description?countryObj.description.toUpperCase():"";var untranslatedCountryDesc=countryObj.descriptionOriginal?countryObj.descriptionOriginal.toUpperCase():"";self[details].phoneNumber="";self.errors.phoneNumber=false;var element=$('[name\x3d"phoneNumber"]');var countryArray=element.intlTelInput.getCountryData();for(var i=0;i<countryArray.length;i++){var country=countryArray[i].name;if(country.indexOf("(")>-1)country=country.substring(0,countryArray[i].name.indexOf("(")).trim();country=
country.toUpperCase();if(country==selected||country==untranslatedCountryDesc){element.intlTelInput("setCountry",countryArray[i].iso2);break}}}},self.resetZipOrPostalCode=function(details){self[details].physicalZip4="";self[details].physicalZip5=""},self.selectedCountry=function(detailsStr){var country="USA";var q=$q.defer();var siteCode=copartUser.getUserConfig().siteCode.trim();if(siteCode=="CPRTUK")country="GBR";else if(siteCode=="CPRTMEA")country="ARE";else if(siteCode=="CPRTIE")country="IRL";
else if(siteCode=="CPRTCA")country="CAN";else if(siteCode=="CPRTDE")country="DEU";else if(siteCode=="CPRTIN")country="IND";else if(siteCode=="CPRTES")country="ESP";self[detailsStr].country=self.countriesMap[country];self.changeCountry(detailsStr,q);return q.promise},self.openPrivacyPolicyModal=function(){self.fetchPrivacyPolicyCmsContent=true},self.openMemberServiceModal=function(){self.fetchMemberServiceCmsContent=true},self.openMemberTermsModal=function(){self.fetchMemberTermsCmsContent=true},self.changePhoneNumber=
function(){self.errors.phoneNumber=$('[name\x3d"phoneNumber"]').intlTelInput("isValidNumber")},self.checkForSpecialChars=function(details){if(self[details].address==""||self[details].address==undefined||self[details].country.culture=="GLOBAL")self.errors.specialChars=false;else self.errors.specialChars=!/^[a-zA-Z0-9- ]*$/.test(self[details].address.toString())},self.validateZip=function(details){if(self[details].country.culture=="MIDDLE_EAST"||self[details].country.culture=="EURO_IR"||self[details].country.culture==
"NONE")return true;if(self[details].zipOrPostalCode!=""&&self[details].zipOrPostalCode!=undefined){var zip=self[details].zipOrPostalCode;if(zip.indexOf("-")>-1){var split=zip.trim().split("-");self[details].physicalZip5=split[0].trim();self[details].physicalZip4=split[1].trim();return true}else if(zip.indexOf(" ")>-1){var split=zip.trim().split(" ");self[details].physicalZip5=split[0].trim();self[details].physicalZip4=split[1].trim();return true}else if(zip.length>5){self[details].physicalZip5=zip.substring(0,
zip.length-3);self[details].physicalZip4=zip.substring(zip.length-3);return true}else{self[details].physicalZip5=zip;return true}}return false};self.$watch("personalDetails.zipOrPostalCode",function(){self.validateZip("personalDetails")});self.trackEvent=function(){};self.handleServerSideErrors=function(response){if(response.data.errorObjects){self.submitDisabled=false;_.each(response.data.errorObjects,function(error){self.validateFunc(error.code)});return true}return false};self.removeFile=function(fileName,
$index){self.uploadObjs.splice($index,1);self.validatedFiles.splice($index,1);document.getElementById("inputBrowse").value=""};self.registrationErrorResponseHandler=function(responseData){self.isError=true;if(self.formObj){self.formObj.$setDirty();self.formObj.email.$setDirty();self.formObj.stateOrProvince.$setDirty();self.formObj.city.$setDirty()}if(responseData.data.errorCode){self.showUploadBlock=false;self.showTellUsAboutYouIn=self.locale.getMessage("app.register.TellUsAboutYou.showTellUsAboutYouIn");
jQuery("#registrationSubmitbutton").prop("disabled",false);var errors=responseData.data.errorCode.trim();if(errors=="C226098"||errors=="C225598"){errors=responseData.data.errorText.trim().split("|");for(var i=0;i<errors.length;i++)self.validateFunc(errors[i])}else self.validateFunc(responseData.data.errorCode.trim())}};self.verifyRegistrationStatus=function(){if(self.registrationStepIncomplete)jQuery("#uploadBlockWarning").modal("show")};self.registrationSuccessHandler=function(responseData,formObj){self.showThankYou();
var crmId=responseData&&responseData.data?responseData.data.crmId:null;copartOmnitureCallMulti("doTagRegistrationThankYouPage",[responseData.data.newBuyerNumber,responseData.data.physicalState,responseData.data.physicalZip,responseData.data.physicalCountry,responseData.data.physicalCity,crmId]);if(self.personalDetails.memberTypeAnswers=="INDL")copartOmnitureCallMulti("doTagIndividualFormSuccessRegistration",[responseData.data.newBuyerNumber,self.personalDetails.pairedWithBroker,crmId]);else copartOmnitureCallOne("doTagBusinessFormSuccessRegistration",
responseData.data.newBuyerNumber,crmId);if(self.personalDetails.memberTypeAnswers=="INDL"&&copartUser.getUserConfig().defaultDisplayPref.tuPreference){var fullName=formObj.firstName.$modelValue+" "+formObj.lastName.$modelValue;var addressLine1=formObj.address1.$modelValue;var city=formObj.city.$modelValue;var zip=formObj.zipOrPostalCode.$modelValue;var state=formObj.stateOrProvince.$modelValue;var formData={"CompanyId":"","ConfigId":"","IDMVerifyPlus":{"SSN":"","FullName":fullName,"Address":{"Line1":addressLine1,
"City":city,"State":state,"Zip":zip,"County":"","Zip4":""},"ReferenceId":responseData.data.newBuyerNumber},"Masquerade":""};dataServiceG2.verifyIdentity(formData)}};self.uploadLicenceErrorHandler=function(responseData){if(responseData.failedDocs&&responseData.failedDocs.length>0)self.message=self.locale.getMessage("registration.upload.error")};self.checkPairedWithBroker=function(){_.each(self.registration.pair_with_broker.answers,function(answer){if(answer.answerCode==self.personalDetails.pairedWithBroker&&
self.hideBlock)answer.activeStatusFlag="A";else answer.activeStatusFlag="I"})};self.registration.uploadResponseErrorMessage="";var populateMemberDataObj=function(memberObj){self.personalDetails.firstName=memberObj.firstName;self.personalDetails.lastName=memberObj.lastName;self.personalDetails.emailAddress=memberObj.emailAddress;self.personalDetails.confirmationEmailAddress=memberObj.emailAddress;self.personalDetails.country=_.find(self.appConfig.getCountries(),{code:memberObj.physicalCountry});self.personalDetails.address=
memberObj.physicalAddress1;self.personalDetails.addressLine2=memberObj.physicalAddress2;var stateObj=_.find(self.appConfig.getCountryStates(),{code:memberObj.physicalState,type:memberObj.physicalCountry})||{};self.personalDetails.stateOrProvince=stateObj.code;self.personalDetails.city=memberObj.physicalCity;self.personalDetails.zipOrPostalCode=(memberObj.physicalZip||"")+(memberObj.physicalZip4?" "+(memberObj.physicalZip4||""):"");self.personalDetails.phoneNumber=(memberObj.contactPhoneAreaCode||
"")+(memberObj.contactPhoneNumber||"");self.personalDetails.phoneExtension=memberObj.contactPhoneExt;self.personalDetails.companyName=memberObj.companyName};var populatePairedWithBroker=function(selectedChoices){selectedChoices=selectedChoices||{};if(selectedChoices.hasOwnProperty(pairWithBroker))self.personalDetails.pairedWithBroker=selectedChoices.PBRK[0].answerCode};var populateMemberChoices=function(selectedChoices){selectedChoices=selectedChoices||{};if(selectedChoices.hasOwnProperty(memberType))self.typeSelected(selectedChoices[memberType]?
selectedChoices[memberType][0]:{})};var getPreRegistrationData=function(){var email=$location.search().email;var userId=$location.search().userId;if(email&&userId){var successCallBack=function(response){var memberInfo=response.data.memberInfo||{};populateMemberDataObj(memberInfo);populateMemberChoices(memberInfo.selectedChoices);populatePairedWithBroker(memberInfo.selectedChoices);self.selectedMemberChoices=memberInfo.selectedChoices};dataServiceG2.getPreRegistrationData(email,userId,successCallBack)}};
self.subscriptionSelectAll=function(subscription){subscriptionsService.subscriptionSelectAll(subscription)};self.updateSelectAll=function(subscription){subscriptionsService.updateSelectAll(subscription)};var submitEmailLangChoice=function(){var selectedLang=copartUser.getUserConfig().selectedLang;var lang=self.locale.messages["member.choices.email.language.registration"]||"EN-US";if(self.registration.email_language&&emailLanguage)memberChoicesService.updateChoiceSelections(emailLanguage,findByObj(self.registration.email_language.answers,
{answerCode:lang.toUpperCase()}),true)};self.init=function(){memberChoicesService.init();dataServiceG2.getSiteKey(function(response){self.siteKey=response.data});self.selectedCountry("personalDetails").then(function(){if(childParam){_.each(childParam,function(param){self.selectedCountry(param)});self["personalDetails"].taxIssuingCountry=self.personalDetails.country}});if(!childParam){self.getMemberChoices();if(appConfigService.appConfig.getDefaultMemberChoices())if(self.registration.member_types&&
self.registration.member_types.answers){var choiceType=_.find(self.registration.member_types.answers,{answerCode:"BSNS"});self.typeSelected(choiceType)}submitEmailLangChoice();populateMemberTypes();changeModelBasedOnURLParams();getPreRegistrationData()}};self.handlePatternForName=function(){var regex=/^[a-zA-Z\s]*$/;return{test:function(value){return regex.test(self.personalDetails.firstName)}}};var changeModelBasedOnURLParams=function(){if($location.search().memberType==="INDL"){var choiceType=_.find(self.registration.member_types.answers,
{answerCode:"INDL"});self.typeSelected(choiceType)}};self.showThankYou=function(){$location.url("/thankyou/"+(self.hideBlock?"?type\x3dindividual":"?type\x3dbusiness"))};self.notABussiness=function(){copartOmnitureCallOne("doTagBusinessRegistration","");$("#notABusinessRedirectModal").modal("show")};self.openCopartRegistration=function(){$window.open("https://www.copart.com/doRegistration/?memberType\x3dINDL","_blank")};var populateMemberTypes=function(){var memberTypeQueryParam=$location.search().memberType;
if(memberTypeQueryParam=="INDL"&&self.personalDetails!=null)self.personalDetails.memberTypeAnswers="INDL";else self.personalDetails.memberTypeAnswers="BSNS"};if(!childParam)self.init();var registrationPreference=copartUser.getUserConfig().registrationPreference||{};self.resetPwdforexistingUser=function(email){$location.url("./login?existingEmail\x3d"+email);self.tellUsAboutYouForm.$setPristine()}}]);
app.controller("registrationController_GLOBAL",["$scope","$location","$http","$locale","$filter","dataServiceG2","appConfigService","copartUser","$controller","copartUtils",function($scope,$location,$http,$locale,$filter,dataServiceG2,appConfigService,copartUser,$controller,copartUtils){$controller("registrationController",{$scope:$scope,childParam:["mailingDetails","taxAndVatDetails"]});var self=$scope;self.addressVatAndTaxTemplateFragment="/public/fetchDirective.html?directive\x3dregistration/addressVatAndTaxTemplateFragment";
self.checkbox={physicalSameAsMailing:true,physicalSameAsVatAndTax:true};self.isError=false;self.personalDetails={country:{culture:"GLOBAL"},firstName:"",lastName:"",email:"",confirmEmail:"",gender:"",howDidYouHearAboutUs:"",promocode:"",companyName:"",address:"",addressLine2:"",stateOrProvince:"",city:"",zipOrPostalCode:"",mailingAddress1:"",mailingAddress2:"",mailingState:"",mailingCity:"",mailingCountry:"",mailingPostCode:"",taxIssuingCountry:"",taxId:"",phoneNumber:"",phoneExtension:"",termsAndConditions:false,
physicalZip5:"",physicalZip4:"",taxIdPrefix:"",emailSubscriptionCheck:false,alternatePhoneExtension:"",contactPhoneIntlDialCode:"",alternatePhoneIntlDialCode:"",altPhoneISOCountryCd:"",contactPhoneISOCountryCd:""};self.mailingDetails={country:{culture:"GLOBAL"},address:"",addressLine2:"",stateOrProvince:"",city:"",zipOrPostalCode:""};self.taxAndVatDetails={country:{culture:"GLOBAL"},address:"",addressLine2:"",stateOrProvince:"",city:"",zipOrPostalCode:""};self.buildOptionsList=function(list,messageKey){return _.map(list,
function(item){var key=item.code||item;return{key:key,description:self.locale.getMessage(messageKey+key)}})};self.genderList=self.buildOptionsList(["M","F","ND"],"registration.gender.");self.howDidYouHearAboutUsList=self.buildOptionsList(appConfigService.appConfig.getRegistrationSource(),"registration.howDidYouHearAboutUs.");var langSpecialCharacters="√Ñ√ñ√ú·∫û√§√∂√º√ü√°√©√≠√≥√∫√Ω√±√ë√Ø√º√ú√Å√â√ç√ì√ö√ùƒÑƒÖƒÜƒáƒòƒô≈Å≈Ç≈É≈Ñ√ì√≥≈ö≈õ≈π≈∫≈ª≈º¬ø¬°";self.patternRegExp={userName:new RegExp("^[a-zA-Z"+langSpecialCharacters+"\\s]*$"),city:new RegExp("^[a-zA-Z"+
langSpecialCharacters+"\\s-]*$")};var changeCountry=self.changeCountry;self.changeCountry=function(details,q){changeCountry(details,q);var countryObj=self[details].country;if(countryObj.culture=="GLOBAL"){self[details+"_minZipLength"]=countryObj.postCodeLength||0;self[details+"_maxZipLength"]=countryObj.postCodeLength||10;self[details+"_zipRequired"]=countryObj.postalCodereq=="Y"?true:false;self[details+"_stateRequired"]=countryObj.statereq=="Y"?true:false;self[details+"_zipPattern"]=countryObj.postalCodeFormat||
self.defaultZipFormat;setVATDetails(details,countryObj)}};function setVATDetails(details,countryObj){if(details=="personalDetails"||details=="taxAndVatDetails"){self[details].taxIdPrefix=countryObj.taxIdPrefix;self[details].taxIssuingCountry=countryObj;self[details+"_taxIdminLength"]=countryObj.taxIdMinLength?countryObj.taxIdPrefix?countryObj.taxIdMinLength-countryObj.taxIdPrefix.length:countryObj.taxIdMinLength:countryObj.taxIdPrefix?countryObj.taxIdPrefix.length:0;self[details+"_taxIdmaxLength"]=
countryObj.taxIdMaxLength?countryObj.taxIdPrefix?countryObj.taxIdMaxLength-countryObj.taxIdPrefix.length:countryObj.taxIdMaxLength:countryObj.taxIdPrefix?16-countryObj.taxIdPrefix.length:16;self[details+"_taxIdPattern"]=countryObj.taxIdRegex?countryObj.taxIdPrefix?countryObj.taxIdRegex.replace(countryObj.taxIdPrefix,""):countryObj.taxIdPrefix:"^.*$"}}self.changeVatCountry=function(details){var countryObj=self[details].taxIssuingCountry;if(countryObj.culture=="GLOBAL")setVATDetails(details,countryObj)};
var registrationErrorCodesMap={"member.companyName":"registration_companyName","member.contact.email":"registration_email","taxIds.taxId":"registration_taxId","member.firstName":"registration_firstName","member.lastName":"registration_lastName.","member.gender":"registration_gender","member.howDidYouHearAboutUs":"registration_howDidYouHearAboutUs","mailingAddress.line1":"registration_mailingDetails_address1","mailingAddress.line2":"registration_mailingDetails_address2","mailingAddress.city":"registration_mailingDetails_city",
"mailingAddress.zip1":"registration_mailingDetails_zip","Member.mailingAddress.stateType.code":"registration_mailingDetails_state","physicalAddress.line1":"registration_personalDetails_address1","physicalAddress.line2":"registration_personalDetails_address2","physicalAddress.city":"registration_personalDetails_city","physicalAddress.zip1":"registration_personalDetails_zip","physicalAddress.countryType.codeId":"registration_personalDetails_country","Member.physicalAddress.stateType.code":"registration_personalDetails_state",
"member.contact.primaryPhone":"registration_personalDetails_phoneNumber","taxIds.countryType.codeId":"registration_taxCountry","Member.taxIds[0].taxId":"registration_taxId","documents[0]":"registration_taxId"};var getPropertyIgnoreCase=function(obj,name){var realName=_.findKey(obj,function(value,key){return key.toLowerCase()===name.toLowerCase()});return obj[realName]};self.validateFunc=function(value,key){var element=getPropertyIgnoreCase(registrationErrorCodesMap,key);var errorMessage=[];_.each(value,
function(error){self.isError=true;errorMessage.push(self.$parent.locale.messages["registration.global.error."+error.code]||error.message);self[element]=errorMessage.join(" ")})};self.handleServerSideErrors=function(response){if(response.data.errorObjectsMap){jQuery("#registrationSubmitbutton").prop("disabled",false);_.each(response.data.errorObjectsMap,function(value,key){self.validateFunc(value,key)});return true}return false};self.getRequestData=function(){return{physicalCountry:self.personalDetails.country.code,
physicalState:self.personalDetails.stateOrProvince,firstName:self.personalDetails.firstName,lastName:self.personalDetails.lastName,emailAddress:self.personalDetails.emailAddress,confirmationEmailAddress:self.personalDetails.confirmationEmailAddress,genderCode:!_.isEmpty(self.personalDetails.gender)?self.personalDetails.gender.key:"",hearAboutCode:!_.isEmpty(self.personalDetails.howDidYouHearAboutUs)?self.personalDetails.howDidYouHearAboutUs.key:"",companyName:self.personalDetails.companyName,physicalAddress1:self.personalDetails.address,
physicalAddress2:self.personalDetails.addressLine2,stateOrProvince:self.personalDetails.stateOrProvince,physicalCity:self.personalDetails.city,physicalZip:self.personalDetails.zipOrPostalCode,physicalPostCode:self.personalDetails.zipOrPostalCode,mailingAddress1:self.mailingDetails.address,mailingAddress2:self.mailingDetails.addressLine2,mailingState:self.mailingDetails.stateOrProvince,mailingCity:self.mailingDetails.city,mailingCountry:self.mailingDetails.country.code,mailingPostCode:self.mailingDetails.zipOrPostalCode,
taxIssuingCountry:self.personalDetails.taxIssuingCountry.code,taxIdNumber:self.personalDetails.taxId&&self.personalDetails.taxIdPrefix?self.personalDetails.taxIdPrefix+self.personalDetails.taxId:self.personalDetails.taxId,contactPhoneNumber:self.contactPhone1.substring(3),alternatePhoneNumber:self.personalDetails.alternatePhoneNumber,contactPhoneAreaCode:self.contactPhone1.substring(0,3),physicalZip4:self.personalDetails.physicalZip4,mailingZip4:self.mailingDetails.physicalZip4,mailingZip5:self.mailingDetails.physicalZip5,
emailSubscriptionCheck:self.personalDetails.emailSubscriptionCheck,contactPhoneExt:self.personalDetails.phoneExtension,alternatePhoneExt:self.personalDetails.alternatePhoneExtension,physicalSameAsMailing:self.checkbox.physicalSameAsMailing,taxVatAddress1:self.taxAndVatDetails.address,taxVatAddress2:self.taxAndVatDetails.addressLine2,taxVatState:self.taxAndVatDetails.stateOrProvince,taxVatCity:self.taxAndVatDetails.city,taxVatCountry:self.taxAndVatDetails.country.code,taxVatPostCode:self.taxAndVatDetails.zipOrPostalCode,
contactPhoneIntlDialCode:self.personalDetails.contactPhoneIntlDialCode,alternatePhoneIntlDialCode:self.personalDetails.alternatePhoneIntlDialCode,altPhoneISOCountryCd:self.personalDetails.altPhoneISOCountryCd,contactPhoneISOCountryCd:self.personalDetails.contactPhoneISOCountryCd,vatAndTaxName:self.personalDetails.vatAndTaxName}};self.validateAndMapSubmitRequest=function(isValid){var isValidNumber=!(self.errors.phoneNumber||copartUtils.isNullOrBlank(self.personalDetails.phoneNumber));if(!isValidNumber){self.errors.phoneNumber=
true;return false}_.each(registrationErrorCodesMap,function(value){self[value]=""});if(self.checkbox.physicalSameAsMailing){self.mailingDetails.address=self.personalDetails.address;self.mailingDetails.addressLine2=self.personalDetails.addressLine2;self.mailingDetails.country=self.personalDetails.country;self.mailingDetails.stateOrProvince=self.personalDetails.stateOrProvince;self.mailingDetails.city=self.personalDetails.city;self.mailingDetails.zipOrPostalCode=self.personalDetails.zipOrPostalCode}else if(self.mailingDetails.stateOrProvince==
"")appConfigService.appConfig.getCountryStates().forEach(function(item){if(item.type==self.mailingDetails.country.code)self.mailingDetails.stateOrProvince=item.code});if(self.checkbox.physicalSameAsVatAndTax){self.taxAndVatDetails.address=self.personalDetails.address;self.taxAndVatDetails.addressLine2=self.personalDetails.addressLine2;self.taxAndVatDetails.country=self.personalDetails.country;self.taxAndVatDetails.stateOrProvince=self.personalDetails.stateOrProvince;self.taxAndVatDetails.city=self.personalDetails.city;
self.taxAndVatDetails.zipOrPostalCode=self.personalDetails.zipOrPostalCode}else if(self.taxAndVatDetails.stateOrProvince=="")appConfigService.appConfig.getCountryStates().forEach(function(item){if(item.type==self.taxAndVatDetails.country.code)self.taxAndVatDetails.stateOrProvince=item.code});self.contactPhone1=self.personalDetails.phoneNumber.replace(/[-/ )(\+]/g,"");self.contactPhone1=self.contactPhone1.substring(self.contactPhone1.length-15);if(isValid&&self.personalDetails.termsAndConditions&&
isValidNumber)return true;self.errors.termsAndCondtionsNotSelected=!self.personalDetails.termsAndConditions;self.submitted=true;jQuery("#registrationSubmitbutton").prop("disabled",false);return false};self.showThankYou=function(){self.personalDetails.emailSubscriptionCheck?$location.path("/thankyou").search({subscription:"true"}):$location.path("/thankyou")};self.personalDetails.country.culture="GLOBAL";self.dateOptions={showWeeks:false,maxDate:new Date,invalidDob:false,minMode:"year"};self.invalidDob=
false;self.init()}]);
app.controller("manageCountermanController",["$scope","$http","$route","dataServiceG2",function($scope,$http,$route,dataServiceG2){var self=$scope;self.countermanVO={};var errorMsg1="Passwords not identical. Try again.";var errorMsg2="Password must be between 5-10 characters.";var successHeader1="Password Updated";var successHeader2="Counterman Enabled";var successMsg1="Your Counterman profile password has been updated.";var successMsg2="Your Counterman profile is now active.You can log-in using the password created.";self.successMsg=
{};self.successMsg.msgHeading="";self.successMsg.msgText="";self.countermanForm={password:"",rePassword:""};var lhnAccountN="22724-1";var lhnButtonN=7677;var lhnChatPosition="righttab";var lhnInviteEnabled=1;var lhnWindowN=0;var lhnDepartmentN=0;var lhnInviteN=41139;var lhnInviteChime=1;self.errorShow=false;self.ErrorMessage="";self.myClick=function(myModel){if(myModel==false){self.counterFormShow=false;jQuery("#countermodal").modal()}else self.counterFormShow=true};self.submitCountermanForm=function(){if(self.countermanForm.password!=
self.countermanForm.rePassword){self.errorShow=true;self.errorMessage=errorMsg1}else if(self.countermanForm.password.length<5||self.countermanForm.password.length>10){self.errorShow=true;self.errorMessage=errorMsg2}else{self.errorShow=false;self.counterFormShow=true;self.countermanVO.password=self.countermanForm.password;dataServiceG2.createUpdateCountermanAccount(self.countermanVO,function(response){if(response.returnCode==1&&response.returnCodeDesc=="Success"){if(response.data.outExistFlag=="A"){self.successMsg.msgHeading=
successHeader2;self.successMsg.msgText=successMsg2}else if(response.data.outExistFlag=="U"){self.successMsg.msgHeading=successHeader1;self.successMsg.msgText=successMsg1}jQuery("#counterpassword").modal()}})}};dataServiceG2.getCountermanAccount(function(response){if(response.returnCode==1&&response.returnCodeDesc=="Success")if(response.data.outExistFlag=="Y"){self.myChkModel=true;self.counterFormShow=true}else{self.myChkModel=false;self.counterFormShow=false}});self.disableCounterman=function(){self.counterFormShow=
false;dataServiceG2.deleteCountermanAccount(function(response){if(response.returnCode==1&&response.returnCodeDesc=="Success");})};self.clearPasswordFields=function(){self.countermanForm.password="";self.countermanForm.rePassword=""};self.enableCounterman=function(){self.myChkModel=true;self.counterFormShow=true};self.disableCounterman=function(){self.myChkModel=false;self.counterFormShow=false}}]);
app.controller("inventoryController",["$scope","$http","$locale","$routeParams","$location","urlService","copartUser","dataServiceG2","$filter","searchInventoryResult","appConfigService","userService","vehicleFinderService",function($scope,$http,$locale,$routeParams,$location,urlService,copartUser,dataServiceG2,$filter,searchInventoryResult,appConfigService,userService,vehicleFinderService){var self=$scope;self.locale=$scope.$parent.locale;self.form={};self.countermanInventoryVO={};self.searchInventoryResultList=
{};self.modelList=null;self.makeList=null;self.vehicleTypes=self.appConfig.vehicleTypes||{};self.getModels=function(){self.modelList=vehicleFinderService.getModels(self.form.vehicleType,self.form.make)};self.getMakes=function(){self.makeList=vehicleFinderService.getMakes(self.form.vehicleType);if(self.form.make)self.form.make=_.findWhere(self.makeList,self.form.make);self.getModels()};self.errors={allFieldsEmpty:false};self.searchInventoryByLotVinSerial=function(){self.countermanInventoryVO.vehicleType=
"";self.countermanInventoryVO.yearFrom="";self.countermanInventoryVO.yearTo="";self.countermanInventoryVO.make="";self.countermanInventoryVO.model="";self.countermanInventoryVO.color="";self.countermanInventoryVO.lotNumber=self.form.lotNumber?self.form.lotNumber:"";self.countermanInventoryVO.vin=self.form.vin?self.form.vin:"";self.countermanInventoryVO.serialNumber=self.form.serialNumber?self.form.serialNumber:"";if(self.form.lotNumber==""&&self.form.vin==""&&self.form.serialNumber==""){self.errors.allFieldsEmpty=
true;return}if(_.isNaN(self.countermanInventoryVO.lotNumber-0)){self.errors.invalidLotNumber=true;return}self.errors.allFieldsEmpty=false;self.errors.invalidLotNumber=false;dataServiceG2.searchCountermanInventory(self.countermanInventoryVO,function(response){self.searchInventoryResultList=response.data.data.lotList;searchInventoryResult.searchInventoryResultList=self.searchInventoryResultList;$location.path("/countermanInventorySearchResults")})};self.searchInventoryByVehicleType=function(){self.countermanInventoryVO.vehicleType=
self.form.vehicleType.code?self.form.vehicleType.code:"";self.countermanInventoryVO.yearFrom=self.form.yearFrom?self.form.yearFrom:"";self.countermanInventoryVO.yearTo=self.form.yearTo?self.form.yearTo:"";self.countermanInventoryVO.make=self.form.make?self.form.make.code:"";self.countermanInventoryVO.model=self.form.model?self.form.model:"";self.countermanInventoryVO.color=self.form.color?self.form.color:"";self.countermanInventoryVO.lotNumber="";self.countermanInventoryVO.vin="";self.countermanInventoryVO.serialNumber=
"";dataServiceG2.searchCountermanInventory(self.countermanInventoryVO,function(response){self.searchInventoryResultList=response.data.data.lotList;searchInventoryResult.searchInventoryResultList=self.searchInventoryResultList;$location.path("/countermanInventorySearchResults")})};$scope.filterValue=function($event){if(isNaN(String.fromCharCode($event.keyCode)))$event.preventDefault()};var init=function(){self.form.vehicleType=vehicleFinderService.getDefaultVehicleType(self.vehicleTypes);if(self.form.vehicleType)self.getMakes()};
init()}]);app.factory("searchInventoryResult",function(){return{}});
app.controller("inventorySearchResultsController",["$scope","$http","$locale","$routeParams","$location","urlService","copartUser","$timeout","dataServiceG2","$filter","searchInventoryResult",function($scope,$http,$locale,$routeParams,$location,urlService,copartUser,$timeout,dataServiceG2,$filter,searchInventoryResult){var self=$scope;self.locale=$scope.$parent.locale;self.images={};self.myLot={};self.searchInventoryResultList=searchInventoryResult.searchInventoryResultList;self.initializeDatatable=
function(){self.table=jQuery("#countermanSearchResults-datatable").DataTable({"processing":true,"data":self.searchInventoryResultList,"bPaginate":true,"deferRender":true,"paging":true,"ordering":true,"info":true,"fnDrawCallback":function(object){},"columns":[{"mData":"lotId","render":function(data,type,row){var imageDiv="\x3cimg alt\x3d'"+row["description"]+"' class\x3d'lazy' src\x3d'"+row["smallImage"].url+"' modal-image-viewer"+"lot-id\x3d'"+row.lotId+"' lot-desc\x3d'"+row.description+"' hide-watch-btn\x3dtrue images\x3d'images'/\x3e";
return imageDiv}},{"mData":"description","render":function(data,type,row){var link="\x3ca href\x3d'./lotDetail/"+row.lotId+"'\x3e"+data+"\x3c/a\x3e";return link}},{"mData":"lotId","render":function(data,type,row){var link="\x3ca href\x3d'./lotDetail/"+row.lotId+"'\x3e"+data+"\x3c/a\x3e";return link}},{"mData":"vin"},{"mData":"odometerReading"},{"mData":"color"},{"mData":"yard","render":function(data,type,row){return row["yard"].name}},{"mData":"saleDate","render":function(data,type,row){return $filter("date")(row["saleDate"].date,
"MM/dd/yyyy")}},{"mData":"color"}]});return self.table};self.showHideImages=function(flag){var table=$("#countermanSearchResults-datatable").DataTable();table.column(0).visible(flag)};if(_.isUndefined(self.searchInventoryResultList))$location.path("/countermanInventory");else self.initializeDatatable()}]);
app.controller("SupportServicesController",["$scope","$locale","$location","$anchorScroll","cmsContentService","dataServiceG2","copartUtils","appConfigService",function($scope,$locale,$location,$anchorScroll,cmsContentService,dataServiceG2,copartUtils,appConfigService){var self=$scope;self.locale=$scope.$parent.locale;self.facilities={};self.yardLocations=[];self.inspectors=[];self.copartLocation;self.wlWaiting=false;self.totalNumberOfInspectors=1E3;self.maxSize=5;var pageno=$location.search().page?
parseInt($location.search().page):1;var yardNum=$location.search().yardNum?parseInt($location.search().yardNum):0;self.currentPage=pageno;self.newInspectorFormURL=cmsContentService.getCmsContentUrl("PDFs/Inspector-App-Form.pdf");self.getInspectors=function(page,yardNumber){$location.search({"page":page,yardNum:yardNumber});dataServiceG2.getInspectors(yardNumber,page,function(response){self.inspectors=response.data.inspectorsList;for(var i=0;i<self.inspectors.length;i++){var languages=self.inspectors[i].language;
if(typeof languages!="undefined"&&languages!=null&&languages.length>0)self.inspectors[i].language=copartUtils.splitIntoArray(languages)}self.totalNumberOfInspectors=response.data.totalNumberOfInspectors;self.wlWaiting=false;$("#backToTopId").click()},function(errorResponse){console.log("Error occurred"+errorResponse)});self.wlWaiting=true};self.reload=function(){self.currentPage=1;self.pageChanged()};self.pageChanged=function(){var yardNumber=self.copartLocation?self.copartLocation.yardNumber:0;self.getInspectors(self.currentPage,
yardNumber)};var getYardLocations=function(){appConfigService.getLocationsListBySite(function(response){self.yardLocations=response;if(yardNum&&yardNum!=0)self.copartLocation=_.find(self.yardLocations,function(yard){return yard.yardNumber==yardNum});self.inspectors=self.getInspectors(self.currentPage,yardNum)})};getYardLocations()}]);
app.controller("InspectorController",["$scope","$locale","$routeParams","cmsContentService","dataServiceG2","copartUtils",function($scope,$locale,$routeParams,cmsContentService,dataServiceG2,copartUtils){var self=$scope;self.locale=$scope.$parent.locale;self.facilities={};self.inspectors={};self.facilityVO={};self.copartLocation;self.inspectorNumber=$routeParams.inspectorNumber;self.inspectorDetails={};self.yardLocationsArray={};self.langs={};self.languages={};self.wlWaiting=false;self.newInspectorFormURL=
cmsContentService.getContentUrl("PDFs/Inspector-App-Form.pdf");self.getInspectorDetails=function(){dataServiceG2.getInspectorDetails(self.inspectorNumber,function(response){self.inspectorDetails=response.data.inspectorDetails;var yardLocations=response.data.inspectorDetails.yardVOList;if(yardLocations!==undefined&&yardLocations.length>0)self.yardLocationsArray=copartUtils.splitArrayIntoChunks(yardLocations,4);var languages=self.inspectorDetails.language;if(typeof languages!="undefined"&&languages!=
null&&languages.length>0)self.languages=copartUtils.splitIntoArray(languages);self.wlWaiting=false},function(errorResponse){console.log("Error occurred"+errorResponse)});self.wlWaiting=true};self.getInspectorDetails()}]);
app.controller("SupportServicesBrokersController",["$scope","$timeout","$location","$filter","dataServiceG2","$routeParams",function($scope,$timeout,$location,$filter,dataServiceG2,$routeParams){var self=$scope;self.locale=$scope.$parent.locale;self.allBrokers=[];self.resellerAccountInfo={};self.resellerServices={};self.resellerPaymentMethods={};self.marketMakerslist={};self.activeTab=$routeParams.tab;self.wlWaiting=false;self.totalNumberOfBrokers=0;self.maxSize=5;self.currentPage=1;self.brokerContentUrl=
"Content/US/EN/Services/Brokers.html";$scope.setPage=function(pageNo){$scope.currentPage=pageNo};$scope.pageChanged=function(){self.getAllBrokers();console.log("Page changed to: "+$scope.currentPage)};self.getAllBrokers=function(){if(typeof self.currentPage=="undefined"||self.currentPage==null)self.currentPage=1;dataServiceG2.getAllBrokers(self.currentPage,function(response){self.allbrokers=response.data.allBrokersList;for(var index in self.allbrokers){self.getResellerAccountInfo(self.allbrokers[index].buyerNumber,
index);self.totalNumberOfBrokers=response.data.totalNumberOfBrokers}self.wlWaiting=false},function(errorResponse){console.log("Error occured while getting All Brokers"+errorResponse)})};self.getResellerAccountInfo=function(broker,index){dataServiceG2.getResellerAccountInfo(broker,function(response){self.allbrokers[index].brokerInfo=response.data.resellerAccount;if(self.allbrokers[index].brokerInfo.phoneNumber==null||self.allbrokers[index].brokerInfo.phoneNumber.trim()=="")self.allbrokers[index].brokerInfo.brokerPhoneNumber=
false;else self.allbrokers[index].brokerInfo.brokerPhoneNumber=true;if(self.allbrokers[index].brokerInfo.areaCode!=null&&self.allbrokers[index].brokerInfo.areaCode.trim()!="0")if(self.allbrokers[index].brokerInfo.country!=null&&self.allbrokers[index].brokerInfo.country.trim().toUpperCase()=="NGA"){var phoneNum="+"+self.allbrokers[index].brokerInfo.areaCode+self.allbrokers[index].brokerInfo.phoneNumber+self.allbrokers[index].brokerInfo.extension;self.allbrokers[index].brokerInfo.phoneNumber=phoneNum.substr(0,
4)+" "+phoneNum.substr(4,3)+" "+phoneNum.substr(7,4)+" "+phoneNum.substring(11)}else self.allbrokers[index].brokerInfo.phoneNumber=self.allbrokers[index].brokerInfo.areaCode+self.allbrokers[index].brokerInfo.phoneNumber;if(self.allbrokers[index].brokerInfo.website==null||self.allbrokers[index].brokerInfo.website.trim()=="")self.allbrokers[index].brokerInfo.brokerWebsite=false;else self.allbrokers[index].brokerInfo.brokerWebsite=true},function(errorResponse){console.log("Error occured while getting  Reseller Account info"+
errorResponse)})};$scope.getPaginationArray=function(){var paginationSize=Math.round(self.totalNumberOfBrokers!=0?self.totalNumberOfBrokers/10:1);return new Array(paginationSize)};self.init=function(){self.getAllBrokers()};self.init()}]);
app.controller("SupportServicesMarketMakersController",["$scope","$timeout","$location","$filter","dataServiceG2","$routeParams",function($scope,$timeout,$location,$filter,dataServiceG2,$routeParams){var self=$scope;self.locale=$scope.$parent.locale;self.allMarketMakers={};self.marketmakerdetails={};self.activeTab=2;self.wlWaiting=false;self.totalNumberOfMarketMakers=0;self.maxSize=5;self.currentPage=1;$scope.setPage=function(pageNo){$scope.currentPage=pageNo};$scope.pageChanged=function(){self.getAllMarketMakers();
console.log("Page changed to: "+$scope.currentPage)};self.getAllMarketMakers=function(){if(typeof self.currentPage=="undefined"||self.currentPage==null)self.currentPage=1;dataServiceG2.getMarketMakerslist(self.currentPage,function(response){self.allMarketMakers=response.data.marketMakersList;for(var index in self.allMarketMakers){self.getMarketmakerdetails(self.allMarketMakers[index].marketMakerKey,index);self.totalNumberOfMarketMakers=response.data.totalNumberOfMarketMakers}self.wlWaiting=false},
function(errorResponse){console.log("Error occured while getting All Market Makers"+errorResponse)})};self.getMarketmakerdetails=function(marketMaker,index){dataServiceG2.getMarketMakerDetails(marketMaker,function(response){self.allMarketMakers[index].marketMakerInfo=response.data.marketMakerDetails;if(self.allMarketMakers[index].marketMakerInfo.phoneNumber==null||self.allMarketMakers[index].marketMakerInfo.phoneNumber.trim()=="")self.allMarketMakers[index].marketMakerInfo.marketPhoneNumber=false;
else self.allMarketMakers[index].marketMakerInfo.marketPhoneNumber=true;if(self.allMarketMakers[index].marketMakerInfo.phoneAreaCode!=null&&self.allMarketMakers[index].marketMakerInfo.phoneAreaCode.trim()!="0")self.allMarketMakers[index].marketMakerInfo.phoneNumber=self.allMarketMakers[index].marketMakerInfo.phoneAreaCode+self.allMarketMakers[index].marketMakerInfo.phoneNumber;if(self.allMarketMakers[index].marketMakerInfo.registrationFee.charAt(0)=="0"){self.allMarketMakers[index].marketMakerInfo.registrationFee=
self.locale.messages["support.services.market.fees1"];self.allMarketMakers[index].marketMakerInfo.securityDeposit=self.locale.messages["support.services.market.fees2"];self.allMarketMakers[index].marketMakerInfo.transactionFee=self.locale.messages["support.services.market.fees3"]}},function(errorResponse){console.log("Error occured while getting Market Maker Details"+errorResponse)})};$scope.getPaginationArray=function(){var paginationSize=Math.round(self.totalNumberOfMarketMakers!=0?self.totalNumberOfMarketMakers/
10:1);return new Array(paginationSize)};self.init=function(){self.getAllMarketMakers()};self.init()}]);
app.controller("SupportServicesViewMarketMakerController",["$scope","$timeout","$routeParams","$location","$filter","dataServiceG2",function($scope,$timeout,$routeParams,$location,$filter,dataServiceG2){var self=$scope;self.locale=$scope.$parent.locale;self.marketMakerAccountInfo={};self.resellerServices={};self.marketMaker=$routeParams.marketMaker;self.phoneValue=true;self.getMarketMakerAccountInfo=function(){dataServiceG2.getMarketMakerDetails(self.marketMaker,function(response){self.marketMakerAccountInfo=
response.data.marketMakerDetails;if(self.marketMakerAccountInfo.phoneNumber==null||self.marketMakerAccountInfo.phoneNumber.trim()=="")self.phoneValue=false;if(self.marketMakerAccountInfo.phoneAreaCode!=null&&self.marketMakerAccountInfo.phoneAreaCode.trim()!="0")self.marketMakerAccountInfo.phoneNumber=self.marketMakerAccountInfo.phoneAreaCode+self.marketMakerAccountInfo.phoneNumber},function(errorResponse){console.log("Error occured while getting  market maker info"+errorResponse)})};self.init=function(){self.getMarketMakerAccountInfo()};
self.init()}]);
app.controller("SupportServicesViewBrokerController",["$scope","$locale","$routeParams","dataServiceG2","copartUtils",function($scope,$locale,$routeParams,dataServiceG2,copartUtils){var self=$scope;self.locale=$scope.$parent.locale;self.brokerDetails={};self.services={};self.paymentMethods={};self.brokerNumber=$routeParams.brokerNumber;self.getBrokerDetails=function(){dataServiceG2.getResellerAccountInfo(self.brokerNumber,function(response){self.brokerDetails=response.data.resellerAccount;if(self.brokerDetails.areaCode!=
null&&self.brokerDetails.areaCode.trim()!="0")if(self.brokerDetails.country!=null&&self.brokerDetails.country.trim().toUpperCase()=="NGA"){var phoneNum="+"+self.brokerDetails.areaCode+self.brokerDetails.phoneNumber+self.brokerDetails.extension;self.brokerDetails.phoneNumber=phoneNum.substr(0,4)+" "+phoneNum.substr(4,3)+" "+phoneNum.substr(7,4)+" "+phoneNum.substring(11)}else self.brokerDetails.phoneNumber=self.brokerDetails.areaCode+self.brokerDetails.phoneNumber;self.buildFeesAndPayments()},function(errorResponse){console.log("Error occurred in Reseller Account Info"+
errorResponse)})};self.buildFeesAndPayments=function(){if(_.isEmpty(self.brokerDetails.registrationFee))self.brokerDetails.registrationFee="0.0";if(_.isEmpty(self.brokerDetails.securityDeposit))self.brokerDetails.securityDeposit="0.0"};self.getResellerServices=function(){dataServiceG2.getResellerServices(self.brokerNumber,function(response){self.services=response.data.resellerServicesList},function(errorResponse){console.log("Error occurred in Reseller Services"+errorResponse)})};self.getResellerPaymentMethods=
function(){dataServiceG2.getResellerPaymentMethods(self.brokerNumber,function(response){self.paymentMethods=response.data.resellerPaymentMethodsList},function(errorResponse){console.log("Error occurred in Reseller Services"+errorResponse)})};self.init=function(){self.getBrokerDetails();self.getResellerServices();self.getResellerPaymentMethods()};self.init()}]);
app.controller("TowProviderContactUsController",["$scope","$locale","dataServiceG2","copartUtils","appConfigService",function($scope,$locale,dataServiceG2,copartUtils,appConfigService){var self=$scope;self.contactUsInquiry={};self.contactUsInquiry.message="-";self.isError=null;self.locationObj={};self.filterLocationObj=[];self.locale=$scope.$parent.locale;$scope.filterLocations=function(item){return item.type==="USA"||item.type==="CAN"};$scope.stateFilter=function(item){return item.type==="USA"||
item.type==="CAN"};self.getYardLocations=function(){appConfigService.getLocationsListBySite(function(response){self.yardLoations=response})};self.getYardLocationsByState=function(state){self.locationObj=_.where(self.yardLoations,{yardStateCode:self.contactUsInquiry.state});self.filterLocationObj=_.filter(self.locationObj,function(item){if(item.yardName.charAt(0)!="*"&&item.yardName.indexOf("-")==3)return item})};self.towProviderContactUS=function(isValid){if(self.contactUsInquiry.location==null||
self.contactUsInquiry.location=="")self.contactUsInquiry.location="";if(isValid)dataServiceG2.towProviderContactUS(self.contactUsInquiry,function(response){var responseCode=response.data.errorMsg;var responseCodeDesc=response.returnCodeDesc;if(responseCode!=null&&responseCode.trim()!=""&&responseCodeDesc!=null&&responseCodeDesc.trim()!="Success"){self.isError=true;var temp=self.locale.getMessage("member.error.tow.phone."+responseCode.trim());if(temp!=null&&temp!="")self.errorDesc=temp;else self.errorDesc=
"Unknown Error"}else{self.isError=false;self.errorDesc="Success";jQuery("#successModal").modal()}},function(errorResponse){console.log("Error occurred in Tow Provider Contact Us"+errorResponse)});else self.submitted=true};self.init=function(){self.getYardLocations()};self.init()}]);
app.controller("bidderManagementController",["$scope","$location","$http","$locale","$filter","$compile","dataServiceG2","userService",function($scope,$location,$http,$locale,$filter,$compile,dataServiceG2,userService){var self=$scope;self.statusList=[{bidderStatus:"ACTIVE",bidderStatusCode:"A"},{bidderStatus:"IN-ACTIVE",bidderStatusCode:"I"},{bidderStatus:"SUSPEND",bidderStatusCode:"S"}];self.bidderStatusList=null;self.searchBy;self.searchKeyWord;self.selectedBidder;self.selectedStatus;self.test=
"test";self.refreshRows=false;self.isPremier=false;self.isMaster=false;self.noOfRecords;self.submitted=false;self.isManageBiddError=null;self.manageBiddersError=null;self.ERROR_STATUS_REQUIRED=false;self.ERROR_AMOUNT_ZERO=false;self.ERROR_COUNT_ZERO=false;self.ERROR_AMOUNT_NAN=false;self.ERROR_COUNT_NAN=false;self.locale=$scope.$parent.locale;self.updatableBidder;self.SUCCESS_TITLE=self.$parent.locale.messages["bidder.model.title.success"];self.SUCCESS_MSG=self.$parent.locale.messages["bidder.model.msg.success"];
self.SUCCESS_RESET_PASSWORD_MESSAGE=self.$parent.locale.messages["bidder.model.msg.reset.success"];self.BIDDER_ASSIGN_SUCCESS_MESSAGE=self.$parent.locale.messages["bidder.model.msg.assign.success"];self.getBidderStatusList=function(){dataServiceG2.getBidderStatusList(function(responseData){if(responseData.returnCode==-1)log.error("Error");else{self.bidderStatusList=responseData.data;self.noOfRecords=responseData.data?responseData.data.length:"";self.isPremier=responseData.isPremier}})};self.$on("ngRepeatFinished",
function(ngRepeatFinishedEvent){self.initializeDatatable()});self.initializeDatatable=function(){self.table=$("#manageBiddersDataTable").DataTable({"bPaginate":false,"responsive":true,"aaSorting":[],"language":{"zeroRecords":self.$parent.locale.messages["bidder.grid.zerorecords.text"]},columnDefs:[{className:"control",orderable:false,targets:0}],"fnDrawCallback":function(object){}});$("#manageBiddersDataTable_info").html(self.$parent.locale.messages["bidder.grid.footer.numofbidders"]+" : "+self.noOfRecords);
return self.table};self.filterTable=function(filterBy){console.log(self.selectedBidder);self.table.columns("").search("");if(filterBy=="STATUS"){self.selectedBidder="";if(self.selectedStatus!=null&&self.selectedStatus!="")self.table.columns(".bidderStatus").search("^\\s*"+self.selectedStatus+"\\s*$",true,false);else self.table.columns(".bidderStatus").search("")}else if(filterBy=="BIDDER"){self.selectedStatus="";self.table.columns(".bidderNumber").search(self.selectedBidder!=null?self.selectedBidder.bidderNumber:
"")}self.table.draw();$("#manageBiddersDataTable_info").html(self.$parent.locale.messages["bidder.grid.footer.numofbidders"]+" : "+self.noOfRecords)};self.updateBidder=function(bidder,event){self.ERROR_STATUS_REQUIRED=false;self.errors=null;self.requestVO={};self.ERROR_INVALID_STATUS=false;self.ERROR_AMOUNT_ZERO=false;self.ERROR_COUNT_ZERO=false;self.ERROR_AMOUNT_NAN=false;self.ERROR_COUNT_NAN=false;self.SPROC_ERROR_STATUS=false;self.ERROR_LIMIT=false;self.changePasswordForm.$setPristine();self.updatableBidder=
bidder;self.selectedElement=event.target;self.requestVO.buyerNumber=bidder.buyerNumber;self.requestVO.bidderNumber=bidder.bidderNumber;self.requestVO.bidderId=bidder.bidderId;self.requestVO.bidderEmail=bidder.bidderEmail;self.requestVO.bidderStatus="";self.requestVO.bidderStatusDate=bidder.bidderStatusDate;self.requestVO.bidderCountLimit=bidder.bidderCountLimit;self.requestVO.bidderDollarLimit=bidder.bidderDollarLimit;self.requestVO.newPassword=bidder.newPassword;self.requestVO.confirmPassword=bidder.confirmPassword;
self.requestVO.sendEmailTo=bidder.sendEmailTo;self.requestVO.sendEmailTo="B";self.selectedStatusList=self.statusList[0];self.manageBiddersError=""};self.updateBidderStatus=function(){dataServiceG2.updateBidderStatus(self.requestVO,function(responseData){var data=responseData.data;if(responseData.returnCode==-1){if(data)if(data instanceof Array)self.errors=data}else{self.table.destroy();jQuery(self.selectedModel).modal("hide");self.getBidderStatusList();jQuery("#successModal").modal()}})};self.assignBidder=
function(){self.requestVO.bidderStatus=self.selectedStatusList.bidderStatusCode;dataServiceG2.assignBidderSlot(self.requestVO,function(responseData){if(responseData.returnCode==-1){var errorObj=responseData.data||{};self.assignBidderErrorMsg=self.locale.getMessage("app.error.label."+errorObj.errorCode)||"Unknown Error";self.submitted=true;console.log("Error")}else{self.table.destroy();if(self.requestVO.sendEmailTo=="R")self.BIDDER_ASSIGN_SUCCESS_MESSAGE=globalLocale.getMessageStr("bidder.model.msg.assign.success",
[userService.userConfig.email]);else self.BIDDER_ASSIGN_SUCCESS_MESSAGE=globalLocale.getMessageStr("bidder.model.msg.assign.success",[self.requestVO.bidderEmail]);jQuery("#assignBidderModal").modal("hide");self.getBidderStatusList();jQuery("#bidderAssignSuccessModal").modal();self.selectedStatusList=null}})};self.updateAllocatedLimit=function(event){if(self.validateAllocatedLimits())dataServiceG2.updateBidderAllocatedLimit(self.requestVO,function(responseData){var data=responseData.data;if(responseData.returnCode==
-1){if(data)if(data instanceof Array)self.errors=data}else{self.table.destroy();self.getBidderStatusList();jQuery("#myModalbidlimit").modal("hide");jQuery("#successModal").modal()}})};self.validateAllocatedLimits=function(bidderVO){var validate=true;if(isNaN(self.requestVO.bidderDollarLimit)){self.ERROR_AMOUNT_NAN=true;validate=false}if(isNaN(self.requestVO.bidderCountLimit)){self.ERROR_COUNT_NAN=true;validate=false}if(!isNaN(self.requestVO.bidderDollarLimit)&&self.requestVO.bidderDollarLimit<=0){self.ERROR_AMOUNT_ZERO=
true;validate=false}if(!isNaN(self.requestVO.bidderCountLimit)&&self.requestVO.bidderCountLimit<=0){self.ERROR_COUNT_ZERO=true;validate=false}return validate};self.onChangeHideError=function(element){jQuery(element).hide()};self.changePassword=function(isValid){if(isValid&&self.requestVO.newPassword==self.requestVO.confirmPassword)dataServiceG2.changeBidderPassword(self.requestVO,function(responseData){self.isManageBiddError=false;if(responseData.returnCode==-1){var errorCode=responseData.data.errorCode;
if(errorCode){self.isManageBiddError=true;self.manageBiddersError=self.locale.messages["app.managebidders.error.errorcode."+errorCode.trim()]}}else{jQuery("#myModalpassword").modal("hide");jQuery("#successResetPasswordModal").modal()}});else self.submitted=true};self.showConfirmationDialog=function(){if(!self.requestVO.bidderStatus||self.updatableBidder.bidderStatus==self.requestVO.bidderStatus){self.ERROR_STATUS_REQUIRED=true;return}jQuery("#myModalstatus").modal("hide");switch(self.requestVO.bidderStatus){case "A":jQuery("#activemodal").modal();
self.selectedModel="#activemodal";break;case "I":jQuery("#inactivemodal").modal();self.selectedModel="#inactivemodal";break;case "S":jQuery("#suspendedmodal").modal();self.selectedModel="#suspendedmodal";break;case "V":jQuery("#vacantmodal").modal();self.selectedModel="#vacantmodal";break}};self.resetStatus=function(){dataServiceG2.resetBidderStatus(self.requestVO,function(responseData){if(responseData.returnCode==-1)log.error("Error");else if(responseData.data.errorCode.trim()){self.SPROC_ERROR_STATUS=
true;self.sprocErrorCode="bidder.info."+responseData.data.errorCode.trim();jQuery("#resetmodal").modal("hide");jQuery("#myModalstatus").modal()}else{self.table.destroy();jQuery("#resetmodal").modal("hide");self.getBidderStatusList();jQuery("#successModal").modal()}})};self.getStatusValue=function(){};self.searchBidder=function(event){self.selectedBidder="";self.selectedStatus="";self.table.columns("").search("");self.table.search(self.searchKeyWord).draw();$("#manageBiddersDataTable_info").html(self.$parent.locale.messages["bidder.grid.footer.numofbidders"]+
" : "+self.noOfRecords)};self.checkSearchEmpty=function(event){if(self.searchKeyWord.trim()==""){self.table.columns("").search("").draw();$("#manageBiddersDataTable_info").html(self.$parent.locale.messages["bidder.grid.footer.numofbidders"]+" : "+self.noOfRecords)}else self.searchBidder()};self.getViewCounts=function(bidder,event){self.updatableBidder=bidder;dataServiceG2.getBidderCounts(self.updatableBidder,function(responseData){if(responseData.returnCode==-1)log.error("Error");else self.updatableBidder=
responseData.data})};self.getBidderStatusList()}]);
app.controller("marketGuideController",["$scope","$http","$location","dataServiceG2","$routeParams",function($scope,$http,$location,dataServiceG2,$routeParams){var self=$scope;self.lotNumber=$routeParams.lotId;self.vinNumber=$routeParams.vin;self.marketGuidePurchased=$routeParams.isPurchased;self.secretKeyForMarketGuide=$routeParams.secretKey;self.NADAValues=null;self.proQuotaSalesList=null;self.vinDetails=null;self.images={};var staticLotDetails=function(){dataServiceG2.getLotDetails(self.lotNumber,
function(response){self.lotDetails=response.data.data.lotDetails;getLotIconObjects()})};var getLotIconObjects=function(){self.iconCodesObjArray=[];var showHighlightIconsArray=_.where(self.appConfig.getHighlightIcons(),{iconType:"H"});var sellerHighlightIconsArray=_.where(self.appConfig.getHighlightIcons(),{iconType:"S"});_.each(self.lotDetails.lic,function(iconCodeObj){_.find(showHighlightIconsArray,function(obj){if(obj.iconCode==iconCodeObj){self.iconCodesObjArray.push(obj);return true}});self.seller=
self.seller||_.find(sellerHighlightIconsArray,{iconCode:iconCodeObj})})};self.getNADAValues=function(){dataServiceG2.getNADAValues(self.lotNumber,function(response){if(response)self.NADAValues=response.data.nadaValues;else log.error("NADAValues Info is not available for lot "+self.lotNumber+"as the Response is"+response.returnCode)})};self.getVinDetails=function(){dataServiceG2.getVinDetails(self.vinNumber,function(response){if(response)self.vinDetails=response.data.vinDetails;else log.error(" VinDetails Info is not available for lot "+
self.lotNumber+"as the Response is"+response.returnCode)})};self.getProQuotaSalesList=function(){dataServiceG2.getProquoteSalesList(self.lotNumber,function(response){if(response){self.proQuotaSalesList=response.data.proQuotaSalesList;self.proQuotaValues=response.data.proQuotaValues}else log.error(" ProquoteSalesList Info is not available "+self.lotNumber+"as the Response is"+response.returnCode)})};self.showAllPhotosView=function(){$location.url("/lotDetail/"+self.lotNumber+"/Photos")};var getLotImages=
function(){dataServiceG2.getLotImages($scope.lotNumber,function(response){if(response!=null){var imagesList=response.data.data.imagesList;$scope.fullSizeImages=imagesList.THUMBNAIL_IMAGE}})};self.init=function(){var marketGuideInquiryVO={"lotId":self.lotNumber,"marketGuidePurchased":self.marketGuidePurchased,"secretKeyForMarketGuide":self.secretKeyForMarketGuide};self.purchaseMarketGuideSuccess=true;dataServiceG2.validateMGuidePurchaseRequest(marketGuideInquiryVO,function(response){if(response.returnCode==
1&&marketGuideInquiryVO.marketGuidePurchased=="Y"){staticLotDetails();self.getVinDetails();self.getProQuotaSalesList();self.getNADAValues();getLotImages()}else{$location.url("/lot/"+self.lotNumber);log.error(" Market Guide Purchase Request denied  as the Response is"+response.returnCode)}})};self.init()}]);
app.controller("brokerProfileController",["$scope","$http","$route","copartUser","dataServiceG2","$window","$q",function($scope,$http,$route,copartUser,dataServiceG2,$window,$q){var self=$scope;self.brokerAccountInfo;self.brokerPaymentBusinessInfo;self.brokerServiceTexts;self.brokerPaymentMethods;self.brokerAdditionalInfoVO=[];self.brokerAdditionalInfoVO.moreInfoLBL="";self.brokerAdditionalInfoVO.moreInfoFL="";self.brokerAdditionalInfoVO.termsAndCond="";self.brokerAdditionalInfoVO.logo="";self.checkEditFlag=
false;self.buyerNumber=copartUser.getUserConfig().buyerNumber;self.amountToIncrease=0;self.totalSeatsRequested=0;self.totalSeatsRequested=self.totalSeatsRequested+self.amountToIncrease;self.parseInt=parseInt;self.init=function(){dataServiceG2.getBrokerProfile(function(response){if(response.returnCode==1&&response.returnCodeDesc=="Success"){self.brokerAccountInfo=response.data.brokerProfile.brokerAccountInfo;self.totalSeatsRequested=self.totalSeatsRequested+self.brokerAccountInfo.currentBidders;switch(self.brokerAccountInfo.accountStatus.trim()){case "ACTIVE":self.brokerAccountInfo.accountStatus=
"Active";break;case "INACTIVE":self.brokerAccountInfo.accountStatus="InActive";break;case "SUSPENDED":self.brokerAccountInfo.accountStatus="Suspended";break;default:self.brokerAccountInfo.accountStatus="Void"}self.brokerPaymentBusinessInfo=response.data.brokerProfile.brokerPaymentBusinessInfo;self.brokerAdditionalInfoVO.moreInfoLBL=self.brokerPaymentBusinessInfo.moreInfoLBL;self.brokerAddress="";self.brokerPhone="";if(!_.isEmpty(self.brokerPaymentBusinessInfo)){self.getCountryAndStateInfo();self.buildPhoneNumber();
self.buildBrokerAddress();self.buildFeesAndPayments()}self.brokerServiceTexts=response.data.brokerProfile.brokerServiceTexts;self.brokerPaymentMethods=response.data.brokerProfile.brokerPaymentMethods}})};self.getCountryAndStateInfo=function(){if(!_.isEmpty(self.brokerPaymentBusinessInfo.country)){self.countryObj=_.where(self.appConfig.getCountries(),{code:self.brokerPaymentBusinessInfo.country});self.brokerPaymentBusinessInfo.country=self.countryObj[0].description;self.getState(self.brokerPaymentBusinessInfo.country,
self.brokerPaymentBusinessInfo.state).then(function(state){self.brokerPaymentBusinessInfo.state=state})}};self.buildPhoneNumber=function(){if(!_.isEmpty(self.brokerPaymentBusinessInfo.areaCode))self.brokerPhone="("+self.brokerPaymentBusinessInfo.areaCode+")";if(!_.isEmpty(self.brokerPaymentBusinessInfo.phoneNumber)){var phoneNumber=self.brokerPaymentBusinessInfo.phoneNumber;self.brokerPhone=self.brokerPhone+phoneNumber.substring(0,3)+"-"+phoneNumber.substring(3,7)}};self.buildBrokerAddress=function(){if(!_.isEmpty(self.brokerPaymentBusinessInfo.addressLine1))self.brokerAddress=
self.brokerPaymentBusinessInfo.addressLine1;if(!_.isEmpty(self.brokerPaymentBusinessInfo.addressLine2))self.brokerAddress=self.brokerAddress+", "+self.brokerPaymentBusinessInfo.addressLine2;if(!_.isEmpty(self.brokerPaymentBusinessInfo.city))self.brokerAddress=self.brokerAddress+", "+self.brokerPaymentBusinessInfo.city;if(!_.isEmpty(self.brokerPaymentBusinessInfo.state))self.brokerAddress=self.brokerAddress+", "+self.brokerPaymentBusinessInfo.state;if(!_.isEmpty(self.brokerPaymentBusinessInfo.country))self.brokerAddress=
self.brokerAddress+", "+self.brokerPaymentBusinessInfo.country;if(!_.isEmpty(self.brokerPaymentBusinessInfo.zipCode))self.brokerAddress=self.brokerAddress+" - "+self.brokerPaymentBusinessInfo.zipCode;if(!_.isEmpty(self.brokerAddress)&&!_.isEmpty(self.brokerPaymentBusinessInfo.contactName))self.brokerAddress=self.brokerPaymentBusinessInfo.contactName+", "+self.brokerAddress};self.buildFeesAndPayments=function(){if(_.isEmpty(self.brokerPaymentBusinessInfo.registrationFee))self.brokerPaymentBusinessInfo.registrationFee=
"0";if(_.isEmpty(self.brokerPaymentBusinessInfo.securityDeposit))self.brokerPaymentBusinessInfo.securityDeposit="0";if(_.isEmpty(self.brokerPaymentBusinessInfo.transactionFee))self.brokerPaymentBusinessInfo.transactionFee="0"};self.getState=function(country,state){var deferred=$q.defer();if(country&&state){var stateObj=_.where(self.appConfig.getCountryStates(),{code:state});deferred.resolve(stateObj&&stateObj.length>0?stateObj[0].description:"")}else deferred.resolve("");return deferred.promise};
self.init();self.dateFormat=function(dateString){if(dateString!=undefined){var date=new Date(Date.parse(dateString));return moment(date).format("MM/DD/YYYY")}};self.editToggle=function(){if(self.checkEditFlag){self.brokerAdditionalInfoVO.moreInfoLBL=self.brokerPaymentBusinessInfo.moreInfoLBL||"";self.checkEditFlag=false}else self.checkEditFlag=true};self.additionalInfo=function(){self.checkEditFlag=false;self.brokerInfoVO={};self.brokerInfoVO["moreInfoLBL"]=self.brokerAdditionalInfoVO.moreInfoLBL;
self.brokerInfoVO["moreInfoFL"]=self.brokerAdditionalInfoVO.moreInfoFL;self.brokerInfoVO["termsAndCond"]=self.brokerAdditionalInfoVO.termsAndCond;self.brokerInfoVO["logo"]=self.brokerAdditionalInfoVO.logo;dataServiceG2.updateBrokerInfo(self.brokerInfoVO,function(response){if(response.returnCode==1&&response.returnCodeDesc=="Success");})};self.editClick=function(){self.editClickFlag=true};self.sendMail=function(userId,currBidderNo,incBidderNo){currBidderNo=currBidderNo?parseInt(currBidderNo):0;incBidderNo=
incBidderNo?parseInt(incBidderNo):0;var increaseTo=currBidderNo+incBidderNo;var emailId="Member.License@copart.com";var subject="Increase Bidder Seats Request - Member #"+userId;var message="Please increase my bidder seats from "+currBidderNo+" to "+increaseTo+".";$window.open("mailto:"+emailId+"?subject\x3d"+subject+"\x26body\x3d"+message,"_self");jQuery("#myModalbidderrequest").modal("hide")};self.isNumber=function(data){return!isNaN(data)}}]);
app.controller("brokerBidderEmailController",["$scope","$http","$locale","$routeParams","dataServiceG2","urlService","$location",function($scope,$http,$locale,$routeParams,dataServiceG2,urlService,$location){var self=$scope;self.emailVO={};self.errorMessage="";self.displayError=false;self.flag=false;self.submitEmail=function(){self.emailVO["bidderEmail"]=self.email;dataServiceG2.updateBidderEmail(self.emailVO,function(response){var responseCode=response.data.data.errorMsg;var responseCodeDesc=response.data.returnCodeDesc;
if(responseCode!=null&&responseCode.trim()!=""){self.displayError=true;self.errorMessage=responseCodeDesc}else if(response.data.returnCode==1){jQuery("#mysavemodal").modal();self.flag=true;self.errorMessage=""}})};self.forwardURL=function(){$location.path(urlService.dashboard)}}]);
app.controller("downloadSalesDataController",["$scope","$timeout","userService","dataServiceG2",function($scope,$timeout,userService,dataServiceG2){var self=$scope;var selectedTimezone=userService.userConfig.selectedTimezone;var dwnldSalesDataPref=userService.userConfig.downloadSalesDataPreference;self.fetchCsvFromExtDomain=dwnldSalesDataPref&&dwnldSalesDataPref.fetchFromExtDomain?true:false;self.createCsvUsingSolrData=dwnldSalesDataPref&&dwnldSalesDataPref.createCsvUsingSolrData?true:false;self.getDate=
function(){return moment().tz(selectedTimezone).format("YYYY MMMM DD")};var submitForm=function(){var form=document.csv;form.action=self.saleDataConfig.formAction?self.saleDataConfig.formAction.trim():"";form.submit()};self.downloadCSV=function(){var successCallBack=function(response){self.saleDataConfig=response.saleDataConfig;$timeout(submitForm,0)};dataServiceG2.getSalesDataConfig(successCallBack)};self.solrCsvUrl="/data/sales/solr/downloadSalesData/"+self.getDate();self.exportFileName="SalesData_"+
self.getDate()+".csv"}]);
app.controller("SellByIndividualController",["$scope","$filter","$location","dataServiceG2","vehicleFactory","appConfigService","copartUser","vehicleFinderService",function($scope,$filter,$location,dataServiceG2,vehicleFactory,appConfigService,copartUser,vehicleFinderService){var self=$scope;self.appInit=appInit;self.locale=$scope.$parent.locale;self.formSubmitted=false;self.sellVehicleVO=new SellVehicleVO;self.submissionConfirmed=false;self.errors={phoneNumber:false};self.showUploadButton=false;
self.submissionFailed=false;self.disableSubmitButton=false;var defaultVehicleType=vehicleFinderService.getDefaultVehicleType(self.appConfig.vehicleTypes);self.getMakes=function(){self.makeObjs=vehicleFinderService.getMakes(defaultVehicleType);self.getModels()};self.getModels=function(){self.modelList=vehicleFinderService.getModels(defaultVehicleType,self.sellVehicleVO.vehicleMake)};self.removeFile=function(fileName,$index){self.message="";self.fileList.splice($index,1);self.validatedFiles.splice($index,
1);document.getElementById("inputBrowse").value=""};self.toggleUploadButton=function(){if(self.sellVehicleVO.uploadPhotosFlag.trim()==="Yes")self.showUploadButton=true;else{self.showUploadButton=false;self.fileList=[];self.failedFiles=[];self.validatedFiles=[];self.files=[];self.message=""}};self.submitForm=function(isValid){console.log("form triggered");if(self.sellVehicleVO.zipPostalCode==null)self.sellVehicleVO.zipPostalCode=self.sellVehicleVO.PostalCode1+" "+self.sellVehicleVO.PostalCode2;if(!isValid||
self.errors.phoneNumber||self.sellVehicleVO.phoneNumber==undefined||self.sellVehicleVO.phoneNumber==""||self.sellVehicleVO.phoneNumber==null){self.formSubmitted=true;return}if(self.showUploadButton&&self.fileList.length===0){self.formSubmitted=true;return}var sellVehicleVO=_.omit(self.sellVehicleVO,"vehicleMake");sellVehicleVO.vehicleMake=self.sellVehicleVO.vehicleMake.description;if(copartUser.getUserConfig().siteCode=="CPRTMEA"){self.disableSubmitButton=true;self.submissionFailed=false;var formData=
new FormData;_.each(self.validatedFiles,function(file){formData.append("file",file)});formData.append("sellVehicleVO",JSON.stringify(sellVehicleVO));dataServiceG2.leadFormEmailApi(formData,function(response){var responseCode=response.returnCodeDesc;if(responseCode!=="undefined"&&responseCode==="Success"){if(response.data.success)$location.url("/Content/"+appInit.regionCode+"/"+appInit.localeString+"/How-To-Sell/Individual-ThankYou.html");else{self.submissionFailed=true;self.errorMessage=self.locale.messages["sellForIndividual.label.uploadimages.failed"]}self.submissionConfirmed=
true}else{self.submissionFailed=true;self.errorMessage=self.locale.messages["sellForIndividual.label.submit.error.desc"]}self.disableSubmitButton=false})}else dataServiceG2.signUpToSellVehicleAsIndividual(sellVehicleVO,function(response){var responseCode=response.returnCodeDesc;if(responseCode!=="undefined"&&responseCode==="Success"){self.submissionConfirmed=true;$location.url("/Content/"+appInit.regionCode+"/"+appInit.localeString+"/How-To-Sell/Individual-ThankYou.html")}else;})};var init=function(){self.getMakes()};
init()}]);
app.controller("SellByBusinessOrDealerController",["$scope","$location","dataServiceG2","copartUser","appConfigService",function($scope,$location,dataServiceG2,copartUser,appConfigService){var self=$scope;self.appInit=appInit;self.locale=$scope.$parent.locale;self.formSubmitted=false;self.sellVehicleVO=new SellVehicleVO;self.submissionConfirmed=false;self.siteCode=copartUser.getUserConfig().siteCode;self.errors={phoneNumber:false};self.mycounties=appConfigService.appConfig.getCountryStates();self.sellerDetails=
{};self.displayCollectionFields=false;self.errorMsg="";self.isError=false;self.disabledSave=false;self.streetField=!copartUser.hasAccessSitePref("sellavehicleBusiness","hide_streetaddress");self.stateField=!copartUser.hasAccessSitePref("sellavehicleBusiness","hide_statefield");self.irelandCounties=["Co. Carlow","Co. Cavan","Co. Clare","Co. Cork","Co. Donegal","Co. Dublin","Co. Galway","Co. Kerry","Co. Kildare","Co. Kilkenny","Co. Laois","Co. Leitrim","Co. Limerick","Co. Longford","Co. Louth","Co. Mayo",
"Co. Meath","Co. Monaghan","Co. Offaly","Co. Roscommon","Co. Sligo","Co. Tipperary","Co. Waterford","Co. Westmeath","Co. Wexford","Co. Wicklow"];self.submitForm=function(isValid){if(self.sellVehicleVO.zipPostalCode==null)self.sellVehicleVO.zipPostalCode=self.sellVehicleVO.PostalCode1+" "+self.sellVehicleVO.PostalCode2;if(!isValid||self.errors.phoneNumber||self.sellVehicleVO.phoneNumber==undefined||self.sellVehicleVO.phoneNumber==""||self.sellVehicleVO.phoneNumber==null){self.formSubmitted=true;return}dataServiceG2.signUpToSellVehicleAsBusinessOrDealer(self.sellVehicleVO,
function(response){var responseCode=response.returnCodeDesc;if(responseCode!=="undefined"&&responseCode==="Success"){self.submissionConfirmed=true;$location.url("/Content/"+appInit.regionCode+"/"+appInit.localeString+"/How-To-Sell/Business-ThankYou.html")}else;})};self.dispPickupInfoNyard=function(doDisplay,showYard){self.displayPickUpFields=doDisplay;self.displayYardFields=showYard};appConfigService.getLocationsListBySite(function(response){self.yardLocations=response});self.submitSellForBusinessForm=
function(isValid){self.isError=false;self.disabledSave=true;if(isValid){var sellerObj=self.sellerDetails;if(!self.displayPickUpFields){sellerObj.pickupName=null;sellerObj.pickupAddressLn1=null;sellerObj.pickupAddressLn2=null;sellerObj.pickupAddressTown=null;sellerObj.pickupAddressPc=null;sellerObj.pickupAddressPhone=null;if(!self.displayYardFields)sellerObj.pickupYard=null;else sellerObj.pickupYard=sellerObj.pickupYard.yardNumber}dataServiceG2.sendSellerReqForBusiness(sellerObj,function(response){self.disabledSave=
false;if(response.returnCode!=-1)$location.path("/content/uk/en/sellForBusiness/thankyou");else{self.isError=true;self.errorMsg=self.locale.messages["app.sellVehicle.sellForBusiness.failed.text"]}})}else self.disabledSave=false}}]);
app.controller("hireABrokerController",["$scope","$timeout","$location","$filter","dataServiceG2","$routeParams","watchListService","staticLotDetails",function($scope,$timeout,$location,$filter,dataServiceG2,$routeParams,watchListService,staticLotDetails){var self=$scope;self.lotNumber=$routeParams.lotNumber;self.allBrokers={};self.resellerAccountInfo={};self.resellerServices={};self.resellerPaymentMethods={};self.marketMakerslist={};var staticLotDetailsPromise=staticLotDetails;if(staticLotDetailsPromise&&
staticLotDetailsPromise.returnCode==1&&staticLotDetailsPromise.data.lotDetails)self.lotDetails=staticLotDetailsPromise.data.lotDetails;else return;watchListService.setWatchListDefinition($location.url());self.addToWatchList=watchListService.addToWatchList;self.isAlreadyAdded=watchListService.isAlreadyAdded;self.removeFromWatchList=watchListService.removeFromWatchList;var getDynamicLotDetails=function(){dataServiceG2.getDynamicLotDetails(self.lotNumber,lotDetailsDymicSuccessCallBack)};var lotDetailsDymicSuccessCallBack=
function(response){try{if(response.data.returnCode==-1)self.dynamicLotDetailsError=response.data.data.errorObject;else self.dynamiclotDetails=response.data.data.lotDetails}catch(e){log.error(e)}};self.getAllBrokers=function(){dataServiceG2.getHireabrokerList(self.lotNumber,self.lotDetails.stt,"USA",function(response){if(response.returnCode==1)self.allbrokers=response.data.brokerResults;else;},function(errorResponse){console.log("Error occured while getting All Brokers"+errorResponse)})};self.getResellerAccountInfo=
function(broker,index){};self.init=function(){self.getAllBrokers();getDynamicLotDetails()};self.init()}]);
app.controller("copartVideosController",["$scope","$sce","cmsContentService","siteCatalyst","copartVideosService",function($scope,$sce,cmsContentService,siteCatalyst,copartVideosService){var self=$scope;self.videosGroupArray=[];self.playCurrentVideo=function(video){var siteCatalystVal={};siteCatalystVal.fname="doTagCopartVideoPlay";siteCatalyst.addToQueue("doTagCopartVideoPlay",siteCatalystVal);siteCatalyst.executeCall("doTagCopartVideoPlay");self.iframeVideoUrl=$sce.trustAsResourceUrl(validateYouTubeUrl(video.embedUrl));
self.videoDescription=video.description;self.videoTitle=video.title};var parentFragmentId="Content/US/EN/copartVideos";var fragmentId="CopartVideos";var validateYouTubeUrl=function(url){return copartVideosService.validateAndFrameYouTubeUrl(url)};self.getImageUrl=function(url,size){if(url===null)return"";size=size===null?"big":size;var vid;var results;results=url.match("[\\?\x26]v\x3d([^\x26#]*)");vid=results===null?url:results[1];if(size=="small")return"http://img.youtube.com/vi/"+vid+"/2.jpg";else return"http://img.youtube.com/vi/"+
vid+"/0.jpg"};var getSuggestedVideos=function(){if(self.videosGroup){var firstVideoGroup=_.first(_.values(self.videosGroup));if(firstVideoGroup&&firstVideoGroup.video){self.suggestedVideos=firstVideoGroup.video.slice(0,2);if(self.suggestedVideos&&!_.isEmpty(self.suggestedVideos))self.iframeVideoUrl=$sce.trustAsResourceUrl(validateYouTubeUrl(self.suggestedVideos[0].embedUrl));self.videoDescription=self.suggestedVideos[0].description;self.videoTitle=self.suggestedVideos[0].title}}};var loadSlider=function(){var slider=
$(".bxslider").bxSlider({mode:"horizontal",pagerCustom:"#bx-pager",nextSelector:"#lot-slider-next",prevSelector:"#lot-slider-prev",prevText:"",nextText:"",minSlides:2,maxSlides:4});$("#lot-slider-next").click(function(){slider.goToNextSlide();return false});$("#lot-slider-prev").click(function(){slider.goToPrevSlide();return false})};var init=function(){cmsContentService.getFragmentContent(parentFragmentId).then(function(videosGroup){self.videosGroup=videosGroup;getSuggestedVideos();loadSlider()})};
$scope.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){$(".bxslider").bxSlider({minSlides:2,maxSlides:4,moveSlides:1,slideWidth:300,slideMargin:10})});init()}]);
app.controller("siteMapController",["$scope","$location","dataServiceG2","userService","$route",function($scope,$location,dataServiceG2,userService,$route){var self=$scope;var continentVal=undefined;self.primaryCountry="usa";self.primaryContinent="NORTH_AMERICA";self.finalList=[];self.stateSelected=false;self.userConfig=userService.userConfig;self.countryCodeMap={"usa":self.locale.messages["locations.label.US"],"can":self.locale.messages["locations.label.CANADA"],"gbr":self.locale.messages["locations.label.UK"],
"irl":self.locale.messages["locations.label.REPUBLICIRELAND"],"are":self.locale.messages["locations.label.UAE"],"bhr":self.locale.messages["locations.label.BAHRAIN"],"omn":self.locale.messages["locations.label.OMAN"],"deu":self.locale.messages["locations.label.DEU"],"esp":self.locale.messages["locations.label.ESP"],"ind":self.locale.messages["locations.label.IND"]};self.init=function(){getRegionList()};var getRegionList=function(){dataServiceG2.getRegions(function(response){self.primaryContinent=
response.data.primaryContinent;self.primaryCountry=response.data.primaryCountry;self.getYardLocations(self.primaryContinent)})};self.payAllUK=function(fromRequest){var requestParam={};requestParam.GATEWAY_URL_KEY="PAY_ALL_UK";dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==1)$window.location.href=response.data.pciURL.trim();else log.error("Error in Gateway")})};self.routeReload=function(path){var url=$location.path();if(path==url)$route.reload()};var loadLocationNodes=
function(){jQuery.fn.extend({treed:function(o){var openedClass="glyphicon-minus-sign";var closedClass="glyphicon-plus-sign";if(typeof o!="undefined"){if(typeof o.openedClass!="undefined")openedClass=o.openedClass;if(typeof o.closedClass!="undefined")closedClass=o.closedClass}var tree=jQuery(this);tree.addClass("tree");tree.find("li").has("ul").each(function(){var branch=jQuery(this);console.log(branch,"branch");branch.prepend("\x3ci class\x3d'indicator glyphicon "+closedClass+"'\x3e\x3c/i\x3e");branch.addClass("branch");
branch.on("click",function(e){if(this==e.target){var icon=jQuery(this).children("i:first");icon.toggleClass(openedClass+" "+closedClass);jQuery(this).children().children().toggle()}});branch.children().children().toggle()});tree.find(".branch .indicator").each(function(){$(this).on("click",function(){$(this).closest("li").click()})});tree.find(".branch\x3ea").each(function(){$(this).on("click",function(e){$(this).closest("li").click();e.preventDefault()})});tree.find(".branch\x3ebutton").each(function(){$(this).on("click",
function(e){$(this).closest("li").click();e.preventDefault()})})}})};var sitemapRepeatEvent=self.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){loadLocationNodes();jQuery("#tree1").treed()});self.getYardLocations=function(continent){dataServiceG2.getLocationsList(continent,function(response){var primaryyardDetails;var countries=response.data.countries;if(continent=="NORTH_AMERICA")for(var countryCode in countries){self.yardStates=_.chain(countries[countryCode]).groupBy("yardStateName").map(function(value1,
key1){return{yardStateName:key1.toUpperCase(),yardNumbers:_.chain(value1).groupBy("yardName").map(function(value2,key2){return{yardNumber:value2[0].yardNumber,yardName:_.pluck(value2,"yardName").toString(),yardCity:key2,baseUrl:value2[0].baseUrl,locationUrl:value2[0].locationUrl}}).value()}}).value();if(countryCode==self.primaryCountry)primaryYardDetails={"key":self.primaryCountry,"value":self.yardStates};else self.finalList.push({"key":countryCode,"value":self.yardStates})}else for(var countryCode in countries){if(self.userConfig.siteCode==
"CPRTIE"&&countryCode=="gbr")break;self.yardStates=_.chain(countries[countryCode]).groupBy("yardName").map(function(value1,key1){return{yardCity:key1.toUpperCase(),yardNumber:value1[0].yardNumber,locationUrl:value1[0].locationUrl}}).value();if(countryCode==self.primaryCountry)primaryYardDetails={"key":self.primaryCountry,"value":self.yardStates};else self.finalList.push({"key":countryCode,"value":self.yardStates})}self.finalList.unshift(primaryYardDetails)})};self.init();$scope.$on("$destroy",function(){sitemapRepeatEvent()})}]);
app.controller("brokerDetailController",["$scope","$location","dataServiceG2","$routeParams","watchListService","staticLotDetails",function($scope,$location,dataServiceG2,$routeParams,watchListService,staticLotDetails){var self=$scope;self.brokerID=$routeParams.brokerID;self.lotNumber=$routeParams.lotNumber;self.brokerDetails=null;self.brokerPaymentsMethods=null;self.brokerServiceTexts=null;var staticLotDetailsPromise=staticLotDetails;if(staticLotDetailsPromise&&staticLotDetailsPromise.returnCode==
1&&staticLotDetailsPromise.data.lotDetails)self.lotDetails=staticLotDetailsPromise.data.lotDetails;else return;watchListService.setWatchListDefinition($location.url());self.addToWatchList=watchListService.addToWatchList;self.isAlreadyAdded=watchListService.isAlreadyAdded;self.removeFromWatchList=watchListService.removeFromWatchList;var getDynamicLotDetails=function(){dataServiceG2.getDynamicLotDetails(self.lotNumber,lotDetailsDymicSuccessCallBack)};var lotDetailsDymicSuccessCallBack=function(response){try{if(response.data.returnCode==
-1)self.dynamicLotDetailsError=response.data.data.errorObject;else self.dynamiclotDetails=response.data.data.lotDetails}catch(e){log.error(e)}};self.getSpecificBrokerInfo=function(){dataServiceG2.getSpecificBrokerInfo(self.brokerID,function(response){self.brokerDetails=response.data.brokerAccountInfo;self.brokerPaymentsMethods=response.data.brokerPaymentsMethods;self.brokerServiceTexts=response.data.brokerServiceTexts},function(errorResponse){console.log("Error occured while getting Details of All Brokers"+
errorResponse)})};self.init=function(){self.getSpecificBrokerInfo();getDynamicLotDetails()};self.init()}]);
app.controller("cmsController",["$scope","$rootScope","siteCatalyst","cmsContentService",function($scope,$rootScope,siteCatalyst,cmsContentService){try{var self=$scope;self.locale=self.$parent.locale;var metaTitle=$("#page_meta_title").text();var pageDescription=$("#page_meta_description").text();var pageRobotsMeta=$("#page_robots").text();var pageCanonicalRelHref=$("#page_canonical").text();jQuery("div[id^\x3d'alternate_hreflang_']").each(function(i,el){var link=window.document.createElement("link");
if(el.innerText.length>0){link.setAttribute("seolanglink","lang");link.setAttribute("rel","alternate");link.setAttribute("href",el.innerText);var hreflang=el.id.split("alternate_hreflang_")[1].split("-")[0];link.setAttribute("hreflang",hreflang);jQuery("head").append(link)}});$rootScope.$emit("meta-args-update",{title:metaTitle?metaTitle:self.locale.messages["app.home.title"],description:pageDescription?pageDescription:self.locale.messages["app.home.description"]});$rootScope.robotsTagInfo=pageRobotsMeta;
cmsContentService.setCanonicalHref(pageCanonicalRelHref)}catch(e){}$scope.$on("$destroy",function(){$rootScope.robotsTagInfo=null;$rootScope.canonicalHref=null})}]);
app.controller("makePaymentController",["$scope","$http","$location","dataServiceG2","$compile","$filter","$route","copartUser","appConfigService","backToLinkService","saveLotNumbersService","paymentService","dataTableConfig","$window","$sce",function($scope,$http,$location,dataServiceG2,$compile,$filter,$route,copartUser,appConfigService,backToLinkService,saveLotNumbersService,paymentService,dataTableConfig,$window,$sce){var self=$scope;self.signature="";self.selectedCurrency=copartUser.getUserConfig().currencyCode;
self.totalDues=0;self.showInvoiceConfirmation=false;self.showInvoiceProcessing=false;self.locale=$scope.$parent.locale;self.loadedFirstTime=false;self.showBidderColumn=false;self.yardDetails={};self.disabledPaymentButton=true;self.paymentConfirmButtonStatus=false;self.selectedEstimate=null;self.bidders={};self.images={};var appConfig=appConfigService.getAppConfig();var ccmaxLimitObj=appConfig.getCcMaxLimit();self.ccmaxLimit=ccmaxLimitObj&&ccmaxLimitObj[0]?ccmaxLimitObj[0].code:0;self.backToLink=$location.url();
backToLinkService.setBackToLink(self.backToLink);backToLinkService.setBackToLinkText("paymentdue.invoice.backurl.text");self.buyerForCCPay=0;self.estimates={};self.availableFundAmount=[];self.currentEstimatesList=[];self.wuMaxLimit=0;var wuLimitRemaining=0;var wuEndPointUrl="";var wuServiceId="";var wuClientId="";var showWUInfoPopUp=true;self.totalDuesPaid={"AED":0,"BHD":0,"OMR":0};self.totalInvoices={"AED":0,"BHD":0,"OMR":0};self.totalTransAmount=0;self.selectedInvoices={};self.showDataTable=[{table:"#makePaymentDataTableAED",
curCode:"AED",payButton:"#aedPayselected"},{table:"#makePaymentDataTableBHD",curCode:"BHD",payButton:"#bhdPayselected"},{table:"#makePaymentDataTableOMR",curCode:"OMR",payButton:"#omrPayselected"}];var loadInvoices=function(tableName,curCode){var table=new ServersideDatatable_DB(saveLotNumbersService,dataTableConfig);var tableId=tableName;var backto=self.backToLink;self.paymentType="P";self.selectedCurrency=curCode;var dataTableOptions={"pageLength":1E4,"backToTop":false,"recalculateTableWidth":true,
"columnDefs":[{"targets":[0,1,2,3,4,5,6],"data":null,"defaultContent":""},{"targets":["id"],"orderable":false},{className:"control",orderable:false,targets:-1}],"lengthMenu":[[20,25,50,100],[20,25,50,100]],"url":"data/payments/getMEADueInvoiceList/"+self.paymentType+"/"+self.selectedCurrency,"containsFilters":false,"bPaginate":false,"paging":false,"lengthChange":false,"afterInit":function(){jQuery("#selectAllHdr").html("\x3cdiv class\x3d'text-center'\x3e\x3cinput type\x3d'checkbox' ng-click\x3d'selectAllCheckBox()'/\x3e\x3c/div\x3e");
$compile(jQuery("#selectAllHdr"))($scope);self.$apply()},"language":{"paginate":{"first":self.locale.messages["app.label.first"],"previous":self.locale.messages["app.label.previous"],"next":self.locale.messages["app.label.next"],"last":self.locale.messages["app.label.last"]},"lengthMenu":self.locale.messages["app.label.show"]+" _MENU_ "+self.locale.messages["app.label.entries"],"info":self.locale.messages["app.label.showing"]+" _START_ "+self.locale.messages["app.label.to"]+" _END_ "+self.locale.messages["app.label.of"]+
" _TOTAL_ "+self.locale.messages["app.label.entries"],"infoFiltered":"("+self.locale.messages["app.label.filteredFrom"]+" _MAX_ "+self.locale.messages["app.label.totalEntries"]+")","searchPlaceholder":self.locale.getMessage("app.label.searchListPlaceholder"),"search":self.locale.getMessage("app.label.search")+":"},"columns":[{"mData":"amountDue","name":"amountDue","className":"text-center","render":function(data,type,row){if(row["amountDue"]>0)return'\x3cinput  class\x3d"invoiceIdPayConfirm" type\x3d"checkbox"  value\x3d"'+
row["id"]+'" ng-change\x3d"updateTotal({currencyCode:\''+curCode+"',invoiceNumber:"+row["id"]+",amount:"+row["totalDue"]+'})" ng-model\x3d"selectedInvoices[\''+curCode+"']['"+row["id"]+"']\"\x3e";else return'\x3cinput  type\x3d"checkbox" style\x3d"display:none" value\x3d"'+row["id"]+'"\x3e';return""}},{"mData":"saleDate","sClass":"nowrap","render":function(data,type,row){var saleDate=moment(row["saleDate"],"YYYYMMDD");var defualtDateFormat=self.userConfig.displayPref.dateFormat.toUpperCase();return saleDate.format(defualtDateFormat)}},
{"mData":"id"},{"mData":"yardName","render":function(data,type,row){var html="\x3ca class\x3d'cursor-pointer' href\x3d'/locationDetail/"+row["yn"]+"' target\x3d'_blank'\x3e"+"\x3cspan\x3e"+row["yname"]+"\x3c/span\x3e\x3c/a\x3e";return html}},{"mData":"description"},{"mData":"amountDue","name":"amountDue","render":function(data,type,row){var due=$filter("globalize_currency_using_code")(data,row["cur"],2);return due}},{"mData":"conveyanceFee","name":"conveyanceFee","render":function(data,type,row){var due=
$filter("globalize_currency_using_code")(data,row["cur"],2);return due}},{"mData":"totalDue","name":"totalDue","render":function(data,type,row){var due=$filter("globalize_currency_using_code")(data,row["cur"],2);return due}},{"mData":"","render":function(data,type,row){return""}}]};table.initServerSideDataTable(tableId,dataTableOptions,function(){self.compileDomByClassName(".invoiceIdPayConfirm");self.totalInvoices[curCode]=$(tableId).DataTable().data().count();self.enableDisablePaybutton()})};for(var i=
0;i<self.showDataTable.length;i++)loadInvoices(self.showDataTable[i].table,self.showDataTable[i].curCode);self.compileDom=function(table){var $dest=jQuery(table).find("tbody");var retn=$compile($dest)($scope);$scope.safeApply()};self.confirmInvoices=function(tableId){var countCheckBox=0;var table=$(tableId).dataTable();var selected=true;var tempDue=0;var paymentDueConfirmTable="#MEApaymentDueConfirmTable";var oTableDest=$(paymentDueConfirmTable).DataTable();oTableDest.clear().draw();var currency=
"";jQuery(table.fnGetNodes()).find(":checkbox:checked").each(function(){var rowIndex=table.fnGetPosition(jQuery(this).closest("tr")[0]);var aData=table.fnGetData(rowIndex);tempDue=aData.totalDue+tempDue;currency=aData.cur});self.totalTransAmount=tempDue;oTableDest.draw();self.showInvoiceConfirmation=true;self.paySeletedInvoices(currency,tableId)};self.paySeletedInvoices=function(currency,tableId){self.showInvoiceProcessing=true;var table=$(tableId).dataTable();var ids=jQuery(table.fnGetNodes()).find(":checkbox:checked").map(function(){return this.value}).get().join(",");
var payInvoicesParam={};payInvoicesParam.udf1=copartUser.getUserConfig().buyerNumber;payInvoicesParam.udf2=ids;payInvoicesParam.amount=Number(self.totalTransAmount);payInvoicesParam.currency=currency.trim();dataServiceG2.paySelectedInvoicesMEA(payInvoicesParam,function(result){if(result.returnCode==1){var form=$("#payment_confirmation");form.append(" \x3cinput type\x3d'hidden'  name\x3d'requestParameter' value\x3d'"+result.data.requestParameter+"'\x3e");form.submit()}})};self.updateTotal=function(data){if(self.selectedInvoices[data.currencyCode][data.invoiceNumber])self.totalDuesPaid[data.currencyCode]=
Math.round((self.totalDuesPaid[data.currencyCode]+data.amount)*100)/100;else self.totalDuesPaid[data.currencyCode]=Math.round((self.totalDuesPaid[data.currencyCode]-data.amount)*100)/100;self.enableDisablePaybutton()};self.enableDisablePaybutton=function(){for(var i=0;i<self.showDataTable.length;i++){var table=jQuery(self.showDataTable[i].table).dataTable();var selectedInvoiceCount=jQuery(table.fnGetNodes()).find(":checkbox:checked").size();if(selectedInvoiceCount==0)jQuery(self.showDataTable[i].payButton).prop("disabled",
true);else jQuery(self.showDataTable[i].payButton).prop("disabled",false)}omrPayselected};$scope.safeApply=function(fn){var phase=this.$root.$$phase;if(phase=="$apply"||phase=="$digest"){if(fn&&typeof fn==="function")fn()}else this.$apply(fn)};self.compileDomByClassName=function(className){$(className).each(function(){var value=$(this);var retn=$compile(value)($scope);self.safeApply()})}}]);
app.controller("accountInfoLanguagePreferenceController",["$scope","$http","$locale","$routeParams","$location","urlService","copartUser","dataServiceG2","$filter","$timeout","$window",function($scope,$http,$locale,$routeParams,$location,urlService,copartUser,dataServiceG2,$filter,$timeout,$window){var self=$scope;var selectedLanguage=self.selectedLang;self.updateLanguage=function(selectedLang){dataServiceG2.updateLanguagePreference(selectedLang,function(response){if(response.returnCode==1&&response.data==
"SUCCESS"){self.$parent.changeLanguage(self.selectedLang);selectedLanguage=self.selectedLang}else console.log("could not update the language preferences")})};self.cancelLanguage=function(){self.selectedLang=selectedLanguage};self.init=function(){console.log($routeParams+" "+$routeParams.reAuthn);if(null!==$routeParams.reAuthn&&undefined!==$routeParams.reAuthn&&($routeParams.reAuthn==true||$routeParams.reAuthn.trim()=="true"))$("#upgradeMembershipModal").modal("show")};self.init();self.doLogout=function(){$window.location.href=
"/logout"}}]);
app.controller("accountInfoSubscriptionPreferenceController",["$scope","dataServiceG2","$location","copartUser","subscriptionsService",function($scope,dataServiceG2,$location,copartUser,subscriptionsService){var self=$scope;self.personalDetails={};self.isUpdate=true;var defaultSubscriptionVOMap={};self.showSpinner=true;self.SUBSCRIPTION_PENDING="SUBSCRIPTION_PENDING";self.NOT_SUBSCRIBED="NOT_SUBSCRIBED";self.SUBSCRIBED="SUBSCRIBED";self.disableSaveButton=false;self.showErrorMsg=false;self.collapseTab=
!$location.search().showAcc||false;self.personalDetails.subscriptionVOMap=_.map(defaultSubscriptionVOMap,_.clone);var loginModalFlag=$location.path().indexOf("member-subscriptions")>-1?true:false;self.getMemberSubscription=function(){dataServiceG2.getMemberSubscription(function(response){self.showSpinner=false;if(response.returnCode>-1&&response.data.memberSubscriptionVO&&!_.isEmpty(response.data.memberSubscriptionVO))defaultSubscriptionVOMap=response.data.memberSubscriptionVO;else if(copartUser.getUserConfig().availableSubscriptionsMap&&
!_.isEmpty(copartUser.getUserConfig().availableSubscriptionsMap)){self.isUpdate=false;defaultSubscriptionVOMap=copartUser.getUserConfig().availableSubscriptionsMap}self.personalDetails.subscriptionVOMap=JSON.parse(JSON.stringify(defaultSubscriptionVOMap));self.personalDetails.subscriptionListVO=subscriptionsService.getSubscriptionVOListFromMap(self.personalDetails.subscriptionVOMap);if(loginModalFlag){self.subscription=self.personalDetails.subscriptionVOMap.MARKETING_NEWS;self.disableSaveButton=true;
jQuery("#memberSubscriptionModal").modal("show")}})};self.getMemberSubscription();self.updateSiteSubscription=function(subscriptionStatus){self.showErrorMsg=false;if(subscriptionStatus==self.SUBSCRIPTION_PENDING||subscriptionStatus==self.NOT_SUBSCRIBED){self.personalDetails.subscriptionVOMap=defaultSubscriptionVOMap;self.personalDetails.subscriptionListVO=subscriptionsService.getSubscriptionVOListFromMap(self.personalDetails.subscriptionVOMap)}_.each(self.personalDetails.subscriptionListVO,function(subscription){if(subscription)subscription.subscriptionStatus=
subscriptionStatus});dataServiceG2.saveOrUpdateMemberSubscription(self.personalDetails.subscriptionListVO,self.isUpdate,{onSuccess:function(responseData){if(responseData.returnCode==-1){self.showErrorMsg=true;console.error("Error in updating the site subscription  data :- "+responseData.returnCodeDesc)}else{if(loginModalFlag){jQuery("#memberSubscriptionModal").modal("hide");$location.url("/dashboard")}jQuery("#successModal").modal("show");self.getMemberSubscription()}},onFailure:function(data){self.showErrorMsg=
true;console.error("Error in updating the site subscription  data")}})};self.close=function(){jQuery("#successModal").modal("hide")};self.resetSubscriptions=function(){self.personalDetails.subscriptionVOMap=JSON.parse(JSON.stringify(defaultSubscriptionVOMap));self.personalDetails.subscriptionListVO=subscriptionsService.getSubscriptionVOListFromMap(self.personalDetails.subscriptionVOMap)};self.subscriptionSelectAll=function(subscription){subscriptionsService.subscriptionSelectAll(subscription);self.disableSaveButton=
!enableSaveButton(subscription)};self.updateSelectAll=function(subscription){subscriptionsService.updateSelectAll(subscription);self.disableSaveButton=!enableSaveButton(subscription)};var enableSaveButton=function(subscription){if(loginModalFlag)return subscription.textSubscriptionStatus||subscription.webSubscriptionStatus||subscription.emailSubscriptionStatus||subscription.phoneSubscriptionStatus;else return true}}]);
app.controller("confirmEmailSubscriptionController",["$scope","dataServiceG2","$routeParams","$location",function($scope,dataServiceG2,$routeParams,$location){var self=$scope;var key=$routeParams.key;var id=$routeParams.id||0;self.successFlag=false;self.errorResponse=false;$("#subscribe-modal").modal({backdrop:"static",keyboard:false});if($location.path().indexOf("confirmSubscription")>-1){self.subscribe=true;self.text="Subscribe"}else{self.subscribe=false;self.text="UnSubscribe"}self.redirect=function(){$location.url("/")};
$("#subscribe-modal").modal("show");self.submitEmailSubscription=function(){if(self.subscribe)dataServiceG2.confirmEmailSubscription(key,function(response){if(response.data=="Success")self.successFlag=true;else self.errorResponse=true});else dataServiceG2.confirmUnSubscribeEmailSubscription({"key":key,"id":id},function(response){if(response.data=="Success")self.successFlag=true;else self.errorResponse=true})}}]);
app.controller("thankYouController",["$scope","$routeParams","$controller","userService",function($scope,$routeParams,$controller,userService){$controller("cmsController",{$scope:$scope});var self=$scope;if(userService.userConfig.mobileAppUser){var elemToHide=angular.element(document.querySelector(".printMe"));elemToHide.addClass("hide")}if($routeParams&&$routeParams.subscription)self.emailSubscriptionCheck=true}]);
app.controller("conditionReportController",["$scope","ConditionReportService","$routeParams","$window","userService","$location","$filter",function($scope,conditionReportService,$routeParams,$window,userService,$location,$filter){var self=$scope;var childParam=self.childParam?true:false;self.lotNumber=$routeParams.lotId;self.locale=self.$parent.locale;self.fromMobileApp=userService.userConfig.mobileAppUser;var sections=["vehicleEquipment","vehicleCondition","additionalInformation","tireCondition"];
function loadSliders(){$(".bxslider").bxSlider({slideWidth:250,minSlides:2,maxSlides:7,hideControlOnEnd:true,infiniteLoop:false,controls:true,pause:2E3})}self.locale=$scope.$parent.locale;self.$on("ngRepeatFinished",function(){loadSliders()});self.processResponseData=function(data){_.extend(self,data);if(self.images!=null&&self.images.length>0){self.mainLotImagePath=self.images[0].imagePath;var imageVINPath=self.vehicleDetails&&self.vehicleDetails[0]&&self.vehicleDetails[0].imageInfo&&self.vehicleDetails[0].imageInfo[0]?
self.vehicleDetails[0].imageInfo[0].id:undefined;if(imageVINPath){var vinImage={imagePath:imageVINPath,imageDescription:"VIN"};self.images.push(vinImage)}}for(var section in sections)if(self[sections[section]]&&self[sections[section]].length>0){self[sections[section]+"Images"]=[];var imageArr=self[sections[section]+"Images"];for(var details in self[sections[section]])if(self[sections[section]][details].imageInfo&&self[sections[section]][details].imageInfo.length>0)for(var image in self[sections[section]][details].imageInfo){var imageObj=
{};if(self[sections[section]][details].imageInfo[image].id!=null&&self[sections[section]][details].name!=null){imageObj.url=self[sections[section]][details].imageInfo[image].id;imageObj.name=self[sections[section]][details].name}imageArr.push(imageObj)}}};self.initView=function(response){if(response.returnCode>0)self.processResponseData(response.data);else self.showCRModal(self.locale.messages[response.data.errorObject]);self.dataLoaded=true};self.carousel={};self.openLotCarousal=function(index,event){if(!self.carousel[event.target.attributes.carouselId.value]){self.carousel[event.target.attributes.carouselId.value]=
new ImageCarousel(event.target.attributes.carouselId.value,{errorImage:"/images/testImages/no_photo.jpg",lazyInit:true,lotId:self.lotNumber});self.carousel[event.target.attributes.carouselId.value].initImageViewer()}self.thumbnailClicked=function(index){self.carousel[event.target.attributes.carouselId.value].showStripImage(index)};self.thumbnailClicked(index);self.prevClicked=function(){self.carousel[event.target.attributes.carouselId.value].stripLeft()};self.nextClicked=function(){self.carousel[event.target.attributes.carouselId.value].stripRight()};
$(event.target.attributes.dataId.value).modal("show")};self.init=function(){if(self.isChildCtrl){var token=$filter("sanitize_html")($location.search().crt);conditionReportService.getConditionReportApi(self.lotNumber,token,self.processResponse)}else conditionReportService.getConditionReportData(self.lotNumber,self.initView)};self.showCRModal=function(message){var modalElement=$("#conditionReport");modalElement.find("p").html(message);modalElement.modal("show")};self.redirectToLotDetails=function(){$window.location.href=
"/lot/"+self.lotNumber};self.init();self.printCondiReport=function(){jQuery("a.bx-prev").trigger("click");window.print()}}]);
app.controller("conditionReportApiController",["$scope","$controller","$location","$routeParams",function($scope,$controller,$location,$routeParams){var self=$scope;self.isChildCtrl=true;self.processResponse=function(response){if(response.returnCode>0)self.processResponseData(response.data);else{var errorMsg=response.data.errorObject.message||self.locale.messages["condition.report.api."+response.data.errorObject.error]||self.locale.messages[response.data.errorObject]||self.locale.messages["condition.report.api.error"];
self.showCRModal(errorMsg)}self.dataLoaded=true};if(_.isUndefined($routeParams.lotId)||_.isUndefined($location.search().crt)){var modalElement=$("#conditionReport");modalElement.find("p").html(self.$parent.locale.messages["condition.report.api.error"]);modalElement.modal("show");return}$controller("conditionReportController",{$scope:$scope})}]);
app.controller("validateTowProviderController",["$scope","dataServiceG2",function($scope,dataServiceG2){var self=$scope;self.locale=self.$parent.locale;self.submitMessage=undefined;self.towProvidersList=[];self.towProviderVO={towProviderName:undefined,lastName:undefined,emailID:undefined,phoneNumber:undefined,vin:undefined};var clearFields=function(){self.towProviderVO.lastName=undefined;self.towProviderVO.emailID=undefined};self.submitTowProviderForm=function(){self.submitMessage="";self.towProvidersList=
[];if((self.towProviderVO.towProviderName||self.towProviderVO.phoneNumber||self.towProviderVO.vin)&&self.towProviderVO.lastName&&self.towProviderVO.emailID)dataServiceG2.postTowProviderData(self.towProviderVO,function(response){if(response.returnCode!=-1)if(response.data.towProvidersList&&response.data.towProvidersList.length>0)self.towProvidersList=response.data.towProvidersList;else self.submitMessage="There are no Tow Providers associated with the information provided above";else if(response.data&&
response.data.errorMsg=="Access Denied")self.submitMessage="You are not authorized to perform this action";else self.submitMessage="We are unable to process your request"});else self.submitMessage="Please enter the required fields"}}]);
app.controller("ssoController",["$scope","$location","dataServiceG2","urlService","$window","loginService",function($scope,$location,dataServiceG2,urlService,$window,loginService){var self=$scope;var userUId=$location.search().userUId;var redirectUrl=$location.search().redirectUrl||urlService.home;var redirectRoute=function(url){url=url||redirectUrl;$window.location.href=url};if(!userUId)redirectRoute();var ssoAuthenticate=function(){urlService.redirectUrl=redirectUrl;var form={};form.userUId=$location.search().userUId;
var action="/processLogin";loginService.submitForm(action,form)};var init=function(){ssoAuthenticate()};init()}]);
app.controller("paymentsDueGlobalController",["$scope","$location","dataServiceG2","invoiceService","copartUser",function($scope,$location,dataServiceG2,invoiceService,copartUser){var self=$scope;self.loadingSearchResults=true;var selectedTimezone=copartUser.getUserConfig().selectedTimezone;var date=moment().tz(selectedTimezone).format("YYYY MMMM DD");self.exportFileName="PaymentsDue_"+date+".csv";self.openInvoiceModal=function(invoiceNum,docType,entity){invoiceService.getInvoiceDocuments(invoiceNum,
docType,entity,invoiceSuccessCallBack)};var invoiceSuccessCallBack=function(response){if(response!=null){self.invoiceDocuments=response.data||[];$("#invoiceDisplay").modal("show")}};var initializeDataTable=function(){var datatable=$(document).ready(function(){$("#paymentDueDataTable").DataTable({"language":{"paginate":{"first":self.locale.messages["app.label.first"]?self.locale.messages["app.label.first"]:"First","previous":self.locale.messages["app.label.previous"]?self.locale.messages["app.label.previous"]:
"Previous","next":self.locale.messages["app.label.next"]?self.locale.messages["app.label.next"]:"Next","last":self.locale.messages["app.label.last"]?self.locale.messages["app.label.last"]:"Last"},"search":self.locale.messages["app.label.search"]?self.locale.messages["app.label.search"]+":":"Search"+":","emptyTable":self.locale.messages["app.label.noRecordsAvailable"]?self.locale.messages["app.label.noRecordsAvailable"]:"No records available","searchPlaceholder":self.locale.messages["app.label.searchListPlaceholder"]?
self.locale.messages["app.label.searchListPlaceholder"]:"Search this list","lengthMenu":self.locale.messages["app.label.show"]+" _MENU_ "+self.locale.messages["app.label.entries"],"info":self.locale.getMessage("app.label.showingRecords.info","_START_","_END_","_TOTAL_")?self.locale.getMessage("app.label.showingRecords.info","_START_","_END_","_TOTAL_"):"Showing _START_ to _END_ of _TOTAL_ entries","infoEmpty":self.locale.messages["app.label.noRecordsAvailable"]?self.locale.messages["app.label.noRecordsAvailable"]:
"No records available","processing":'\x3cimg src\x3d"/images/icons/loader.gif" style\x3d"z-index:100000;"\x3e',"zeroRecords":self.locale.messages["app.label.emptyTable.noMatchingRecords"]?self.locale.messages["app.label.emptyTable.noMatchingRecords"]:"No matching records found","infoFiltered":"("+self.locale.messages["app.label.filteredFrom"]+" _MAX_ "+self.locale.messages["app.label.totalEntries"]+")"}})})};self.getPaymentsDueInvoices=function(){dataServiceG2.getGlobalPaymentInvoices(function(response){var responseData=
response&&response.data?response.data:{};self.paymentsDueInvoices=[];self.totalBalanceDue=responseData.totalBalanceDue;self.currency=responseData.currency;var results=responseData.results||{};_.each(results,function(obj){self.paymentsDueInvoices.push(new PaymentsDueGlobal(obj))});self.loadingSearchResults=false})};self.init=function(){self.getPaymentsDueInvoices()};self.$on("ngRepeatFinished",function(){initializeDataTable()});self.init()}]);
app.controller("paymentsHistoryGlobalController",["$scope","$location","dataServiceG2","invoiceService","copartUser",function($scope,$location,dataServiceG2,invoiceService,copartUser){var self=$scope;self.loadingSearchResults=true;var selectedTimezone=copartUser.getUserConfig().selectedTimezone;var date=moment().tz(selectedTimezone).format("YYYY MMMM DD");self.exportFileName="PaymentsHistory_"+date+".csv";self.openInvoiceModal=function(invoiceNum,docType,entity){invoiceService.getInvoiceDocuments(invoiceNum,
docType,entity,invoiceSuccessCallBack)};var invoiceSuccessCallBack=function(response){if(response!=null){self.invoiceDocuments=response.data||{};self.docLength=self.invoiceDocuments.length;if(JSON.stringify(self.invoiceDocuments)=="{}")self.docLength=0;$("#invoiceDisplay").modal("show")}};var initializeDataTable=function(){var datatable=$(document).ready(function(){$("#paymentHistoryDataTable").DataTable({"language":{"paginate":{"first":self.locale.messages["app.label.first"]?self.locale.messages["app.label.first"]:
"First","previous":self.locale.messages["app.label.previous"]?self.locale.messages["app.label.previous"]:"Previous","next":self.locale.messages["app.label.next"]?self.locale.messages["app.label.next"]:"Next","last":self.locale.messages["app.label.last"]?self.locale.messages["app.label.last"]:"Last"},"search":self.locale.messages["app.label.search"]?self.locale.messages["app.label.search"]+":":"Search"+":","emptyTable":self.locale.messages["app.label.noRecordsAvailable"]?self.locale.messages["app.label.noRecordsAvailable"]:
"No records available","searchPlaceholder":self.locale.messages["app.label.searchListPlaceholder"]?self.locale.messages["app.label.searchListPlaceholder"]:"Search this list","lengthMenu":self.locale.messages["app.label.show"]+" _MENU_ "+self.locale.messages["app.label.entries"],"info":self.locale.getMessage("app.label.showingRecords.info","_START_","_END_","_TOTAL_")?self.locale.getMessage("app.label.showingRecords.info","_START_","_END_","_TOTAL_"):"Showing _START_ to _END_ of _TOTAL_ entries","infoEmpty":self.locale.messages["app.label.noRecordsAvailable"]?
self.locale.messages["app.label.noRecordsAvailable"]:"No records available","processing":'\x3cimg src\x3d"/images/icons/loader.gif" style\x3d"z-index:100000;"\x3e',"zeroRecords":self.locale.messages["app.label.emptyTable.noMatchingRecords"]?self.locale.messages["app.label.emptyTable.noMatchingRecords"]:"No matching records found","infoFiltered":"("+self.locale.messages["app.label.filteredFrom"]+" _MAX_ "+self.locale.messages["app.label.totalEntries"]+")"}})})};self.getPaymentsHistoryInvoices=function(){dataServiceG2.getGlobalPaymentHistoryInvoices(function(response){var responseData=
response&&response.data?response.data:{};self.paymentsHistoryInvoices=[];self.totalBalanceDue=responseData.totalBalanceDue;self.currency=responseData.currency;var results=responseData.results||{};_.each(results,function(obj){self.paymentsHistoryInvoices.push(new PaymentsDueGlobal(obj))});self.loadingSearchResults=false})};self.init=function(){self.getPaymentsHistoryInvoices()};self.$on("ngRepeatFinished",function(){initializeDataTable()});self.init()}]);
app.controller("searchRecommendationLotsController",["$scope","dataServiceG2","userService","lotDetailsService","homeQuickpicksService","$window","$timeout","localStorageService","deviceService","$rootScope","userLocationService",function($scope,dataServiceG2,userService,lotDetailsService,homeQuickpicksService,$window,$timeout,localStorageService,deviceService,$rootScope,userLocationService){localStorageService.remove("from-rec-engine");var self=$scope;self.mobileSize=deviceService.isMobileSize();
self.updateLocationCall=false;var log=new Logger({name:"SearchRecommendation"});var userConfig=userService.userConfig;self.threeCharCountryCode=userConfig.preferredCountryCode;self.locationDetails=null;self.elementInViewPort=false;self.locale=$scope.$parent.locale;self.lotStartIndex=0;self.lotCount=self.mobileSize?2:4;var refreshPaginationCount=function(){self.startIndex=self.lotStartIndex+1;self.endIndex=self.mobileSize?self.lotStartIndex+2:self.lotStartIndex+4};refreshPaginationCount();self.init=
function(){self.searchRecommendationCall()};self.getMoreLots=function(lotStartIndex){if(lotStartIndex>=0&&lotStartIndex<self.recommendedLots.length)if(lotStartIndex>=0){self.lotStartIndex=lotStartIndex;refreshPaginationCount()}else if(lotStartIndex<self.recommendedLots.length){self.lotStartIndex=lotStartIndex;refreshPaginationCount()}};self.searchRecommendationCall=function(){userLocationService.getUserLocationInfo().then(function(locationDetails){getLotRecommendations(locationDetails)},function(){getLotRecommendations()})};
var getLotRecommendations=function(locationDetails){self.locationDetails=locationDetails;var lotSearchCriteria={};lotSearchCriteria.searchType="popular";lotSearchCriteria.updateLotRecommendations=self.updateLocationCall;lotSearchCriteria.country=self.threeCharCountryCode&&self.threeCharCountryCode.toUpperCase();if(self.locationDetails){lotSearchCriteria.country=self.locationDetails.threeCharCountryCode?self.locationDetails.threeCharCountryCode:self.locationDetails.countryCode;lotSearchCriteria.state=
self.locationDetails.stateCode?self.locationDetails.stateCode:"";lotSearchCriteria.coordinates=self.locationDetails.latitude+", "+self.locationDetails.longitude}if(self.lotNumber){lotSearchCriteria.searchType="lot";lotSearchCriteria.lotNumber=self.lotNumber;lotSearchCriteria.coordinates=self.lotDetails.lat+", "+self.lotDetails["long"]}homeQuickpicksService.getLotRecommendations(lotSearchCriteria).then(function(data){self.recommendedLots=data||{};if(!_.isEmpty(self.recommendedLots)){self.recommendedLots.length>
12?self.recommendedLots.length=12:self.recommendedLots.length;self.LotTotalCount=self.recommendedLots.length;getRecommendedLotArray(self.recommendedLots)}else{self.recommendedLots=null;log.error("searchRecommendationCall -\x3e Got empty response")}self.updateLocationCall=false})};var getRecommendedLotArray=function(recommendedLots){_.each(recommendedLots,function(recommendedLot,index,list){recommendedLot.images=[];recommendedLot.images.push(recommendedLot.imageUrl);recommendedLot.images.push("/images/testImages/loader_lg.gif");
recommendedLot.lotIconCodes=lotDetailsService.getValidHighLightIcons(recommendedLot.lotIconCodes);recommendedLot.parentLotNumber=self.lotNumber});$window.scrollTo(0,1)};self.init();var loadsearchRecElement=function(){if(!self.elementInViewPort){var elements=angular.element(".in-viewport");var length=elements.length;for(var count=0;count<length;count++){var offsetParentTop=0;var temp=elements[count];do if(!isNaN(temp.offsetTop))offsetParentTop+=temp.offsetTop;while(temp=temp.offsetParent);var pageYOffset=
window.pageYOffset;var viewportHeight=window.innerHeight;if(offsetParentTop>pageYOffset&&offsetParentTop<pageYOffset+viewportHeight){self.elementInViewPort=true;$timeout(self.$digest(),0)}}}};$window.onscroll=function(){loadsearchRecElement()};$rootScope.$on("searchRecommendationCall",function(event,isFreshUpdateRequired){event.preventDefault();self.updateLocationCall=isFreshUpdateRequired;self.searchRecommendationCall()})}]);
app.controller("freeTextSearchController",["$scope","$location","$route","$rootScope","dataServiceG2","urlService","copartUtils","$filter","$window","copartUser","searchCriteriaFactory","searchCriteriaConstants",function($scope,$location,$route,$rootScope,dataServiceG2,urlService,copartUtils,$filter,$window,copartUser,searchCriteriaFactory,searchCriteriaConstants){var self=$scope;self.searchText="";var searchCriteriaObj=searchCriteriaFactory.getSearchCriteria(searchCriteriaConstants.lotSearch);function goToSearchOrLotDetails(response){try{var url=
$location.url();if(!_.isUndefined(response.data.data.results.content)&&response.data.data.results.content.length==1){var lot=response.data.data.results.content[0];$location.url(urlService.lotDetailUrl+lot.ln)}else if(url=="/lotSearchResults?query\x3d"+self.searchText){$location.url("/lotSearchResults?query\x3d"+self.searchText);$route.reload()}else $location.url("/lotSearchResults?free\x3dtrue\x26query\x3d"+self.searchText)}catch(e){console.log(e)}}self.search=function(){var url=$location.url();self.searchText=
$filter("sanitize_html")(self.searchText);if(jQuery("#siteSearchModal").is(":visible"))jQuery("#siteSearchModal").modal("hide");if(!_.isUndefined(self.searchText)&&!_.isNull(self.searchText)&&!isNaN(self.searchText)&&!_.isEmpty(self.searchText)&&self.searchText.length>4){var lotSearchArr=[];lotSearchArr.push("ps_lot_number:"+self.searchText);var searchCriteria={MISC:lotSearchArr};dataServiceG2.getLotsByLotNumber({filter:searchCriteria},goToSearchOrLotDetails)}else if(copartUtils.validateVIN(self.searchText)){var lotSearchArr=
[];lotSearchArr.push("ps_vin_number:"+self.searchText);lotSearchArr.push("sold_flag:"+false);var searchCriteria={MISC:lotSearchArr};dataServiceG2.getLotsByVIN({filter:searchCriteria},goToSearchOrLotDetails)}else if(url=="/lotSearchResults?query\x3d"+self.searchText){$location.url("/lotSearchResults?query\x3d"+self.searchText);$route.reload()}else{searchCriteriaObj.reset();$location.url("/lotSearchResults?free\x3dtrue\x26query\x3d"+self.searchText)}};$rootScope.$on("search-again",function(event,args){self.searchText=
args.searchText;self.search()});self.gotoHelp=function(){$window.location.href="./help"}}]);
app.controller("helpController",["$scope","$location","$filter","$window","copartUser",function($scope,$location,$filter,$window,copartUser){var self=$scope;var query=$filter("sanitize_html")($location.search().q)||"";self.siteSearchText=query?query:"";self.showSearchResults=false;self.locale=self.$parent.locale;var config={gcseId:self.locale.messages["app.label.gcseId"],resultsUrl:"./help/results",resultsWrapperClass:"gcse-results-wrapper",searchWrapperClass:"gcse-search-wrapper"};self.doContentSearch=
function(siteSearchText){self.siteSearchText=$filter("sanitize_html")(siteSearchText)||"";$window.location.href="/help/results?q\x3d"+self.siteSearchText;var helpSearchInfo={};helpSearchInfo.siteSearchText=self.siteSearchText;helpSearchInfo.memberId=copartUser.getUserConfig().buyerNumber;copartOmnitureCallOne("doTagHelpSearchInfo",helpSearchInfo)};var getSearchResultsAndRender=function(){var renderSearchForms=function(){if(document.readyState=="complete")queryAndRender();else google.setOnLoadCallback(function(){queryAndRender()},
true)};var queryAndRender=function(){var gsceResults=document.querySelectorAll("."+config.resultsWrapperClass);if(gsceResults)renderResults(gsceResults[0])};var renderResults=function(div){google.search.cse.element.render({div:div.id,tag:"searchresults-only",attributes:{enableHistory:"false"}})};window.__gcse={parsetags:"explicit",callback:renderSearchForms};(function(){var cx=config.gcseId;var gcse=document.createElement("script");gcse.type="text/javascript";gcse.async=true;gcse.src=(document.location.protocol==
"https:"?"https:":"http:")+"//www.google.com/cse/cse.js?cx\x3d"+cx;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(gcse,s)})()};if($location.$$path==="/help/results"){self.showSearchResults=true;getSearchResultsAndRender()}}]);
app.controller("homeQuickpicksController",["$scope","dataServiceG2","localStorageService","deviceService","userService","$rootScope","appConfigService","copartUser","userLocationService","homeQuickpicksService","config",function($scope,dataServiceG2,localStorageService,deviceService,userService,$rootScope,appConfigService,copartUser,userLocationService,homeQuickpicksService,config){var self=$scope;self.mobileSize=deviceService.isMobileSize();var userConfig=userService.userConfig;self.threeCharCountryCode=
userConfig.preferredCountryCode;self.locationDetails=null;self.locationInfo=null;self.countries=appConfigService.getAppConfig().getCountries();self.userLocation={};self.userLocation.country=_.find(self.countries,{code:self.threeCharCountryCode&&self.threeCharCountryCode.toUpperCase()});self.errorMessage=null;var frameLocation=function(locationDetails){if(locationDetails)if(!_.isUndefined(locationDetails.countryCode))if(locationDetails.stateCode)self.locationInfo=locationDetails.stateCode+", "+locationDetails.countryCode+
" "+locationDetails.zipCode;else self.locationInfo=locationDetails.countryCode+" "+locationDetails.zipCode;else if(locationDetails.description)self.locationInfo=locationDetails.description};self.showChangeLocationModal=function(){if(self.errorMessage){self.userLocation.zipCode=null;self.errorMessage=null}if(!_.isEmpty(self.locationDetails)&&(self.locationDetails.threeCharCountryCode||self.locationDetails.countryCode||self.locationDetails.zipCode)){self.userLocation.country=_.find(self.countries,{code:self.locationDetails.threeCharCountryCode?
self.locationDetails.threeCharCountryCode:self.locationDetails.countryCode?self.locationDetails.countryCode:self.threeCharCountryCode});self.userLocation.zipCode=self.locationDetails.zipCode}isZipCodeRequired()};var zipCodeRequiredCountries=["USA","CAN","GBR","DEU","ESP","IRL","FIN"];var isZipCodeRequired=function(){if(zipCodeRequiredCountries.includes(self.userLocation.country.code)){self.zipCodeRequired=true;self.userLocation.zipCode=!_.isEmpty(self.locationDetails)&&_.isEqual(self.userLocation.country.code,
self.locationDetails.threeCharCountryCode)?self.locationDetails.zipCode:null;self.errorMessage=null;return}self.zipCodeRequired=false;self.userLocation.zipCode=null;self.errorMessage=null};var log=new Logger({name:"Home Quickpicks",level:config.logLevel});var trackLocationInfo=function(locationInfo){var locationTrackInfo={};locationTrackInfo.locationInfo=locationInfo;locationTrackInfo.memberId=copartUser.getUserConfig().buyerNumber;copartOmnitureCallOne("doTagLocationInfo",locationTrackInfo)};self.init=
function(){isZipCodeRequired();userLocationService.getUserLocationInfo().then(function(locationDetails){self.locationDetails=locationDetails;frameLocation(locationDetails);self.getPopularSearches()},function(){self.getPopularSearches()})};self.getPopularSearches=function(){var locationInfo=self.locationDetails;var popularSearchCriteria={};popularSearchCriteria.searchType="popular";popularSearchCriteria.country=self.userLocation.country.code;if(locationInfo){popularSearchCriteria.country=locationInfo.threeCharCountryCode?
locationInfo.threeCharCountryCode:locationInfo.countryCode;popularSearchCriteria.state=locationInfo.stateCode?locationInfo.stateCode:"";popularSearchCriteria.coordinates=locationInfo.latitude+", "+locationInfo.longitude}homeQuickpicksService.getPopularSearch(popularSearchCriteria).then(function(response){self.popularSearches=response||{}})};self.init();self.changeLocation=function(changeLocationForm){if(changeLocationForm.$valid){self.submitted=true;var location={};location.threeCharCountryCode=self.userLocation.country.code;
location.zipCode=self.userLocation.zipCode;if(location.threeCharCountryCode==="CAN"||location.threeCharCountryCode==="IRL")location.zipCode=location.zipCode.slice(0,3);if(location.zipCode)dataServiceG2.updateLocationInfo(location,function(response){if(response.returnCode!=-1&&!_.isEmpty(response.data)){self.updatedLocation=response.data||[];if(self.updatedLocation.length>0){localStorageService.cookie.set("locationInfo",self.updatedLocation[0],365);self.locationDetails=localStorageService.cookie.get("locationInfo");
frameLocation(self.locationDetails);trackLocationInfo(self.locationInfo);jQuery("#changeLocationModal").modal("hide");homeQuickpicksService.popularSearch={};self.getPopularSearches();$rootScope.$emit("searchRecommendationCall",true);self.errorMessage=null}}else{log.error("update Location Call -\x3e Failed "+response);self.errorMessage="Please Enter a Valid Zip/Postal Code"}},function(error){log.error("update Location Call -\x3e Failed "+error);self.errorMessage="Some Error Occurred"});else{self.locationDetails=
{threeCharCountryCode:self.userLocation.country.code,description:self.userLocation.country.description};localStorageService.cookie.set("locationInfo",self.locationDetails);frameLocation(self.locationDetails);trackLocationInfo(self.locationInfo);jQuery("#changeLocationModal").modal("hide");homeQuickpicksService.popularSearch={};self.getPopularSearches();$rootScope.$emit("searchRecommendationCall",true)}}else self.errorMessage="Please Enter a Valid Zip/Postal Code"};self.checkIfZipCodeRequired=function(){isZipCodeRequired()}}]);
app.controller("shippingContentController",["$scope","dataServiceG2",function($scope,dataServiceG2){var self=$scope;self.shippingVO={};self.submitted=false;self.submitForm=function(form,valid){self.submitted=true;if(!valid)return;dataServiceG2.submitShippingDetails(form,function(response){var responseCode=response.returnCodeDesc;if(responseCode!=="undefined"&&responseCode==="Success"){$("#international-shipping").modal("show");self.shippingVO={};self.submitted=false;self.shippingInfoForm.$setPristine()}},
function(error){log.error("shippingContentController::submitShippingDetails Failed "+error)})}}]);
app.controller("breakerBid4UController",["$scope","$location","dataServiceG2",function($scope,$location,dataServiceG2){var self=$scope;self.memberDetails={};self.memberDetails.lotDetails=[];var createObject=function(){return{lotNumber:"",bidAmount:"",isError:false,randomIndex:Math.floor(Math.random()*99999999)+6}};self.memberDetails.lotDetails.push(createObject());self.submitForm=function(isValid){if(isValid&&isAllLotsValid()){self.buildMemberDetails();dataServiceG2.sendEmailRequest(self.memberDetails,
function(response){if(response.returnCode!=-1&&!_.isEmpty(response.data))$location.path("/content/uk/en/BreakerBid4U/thankyou")})}};self.addMoreLots=function(){self.memberDetails.lotDetails.push(createObject())};self.removeLot=function(index){self.memberDetails.lotDetails.splice(index,1)};self.validateLot=function(lotDetail){lotDetail.isError=false;if(_.isEmpty(lotDetail.lotNumber))return;if(isNaN(parseInt(lotDetail.lotNumber))){lotDetail.isError=true;return}dataServiceG2.getLotDetails(lotDetail.lotNumber,
function(response){if(_.isEmpty(response.data.data)||_.isEmpty(response.data.data.lotDetails))lotDetail.isError=true})};self.buildMemberDetails=function(){var lotDetails=self.memberDetails.lotDetails;_.each(lotDetails,function(lotDetail,index){self.memberDetails["lotNumber"+index]=lotDetail.lotNumber;self.memberDetails["maxbid"+index]=lotDetail.bidAmount})};var isAllLotsValid=function(){var lotDetails=self.memberDetails.lotDetails;var lotDetail=_.find(lotDetails,function(lotDetail){return lotDetail.isError==
true});return _.isEmpty(lotDetail)?true:false}}]);
app.controller("vehicleDeliveryController",["$scope","$location","appConfigService","dataServiceG2",function($scope,$location,appConfigService,dataServiceG2){var self=$scope;self.vechileDeliveryVO={};self.isValidLot=true;self.isValidMemberNumber=true;self.yardLocations={};self.error=false;self.submitForm=function(isValid){self.error=false;if(isValid){if(self.isValidNumber(self.vechileDeliveryVO.lotNumber)){self.isValidLot=false;return}if(self.vechileDeliveryVO.memberNumber!=undefined&&self.isValidNumber(self.vechileDeliveryVO.memberNumber)){self.isValidMemberNumber=
false;return}dataServiceG2.getLotDetails(self.vechileDeliveryVO.lotNumber,function(response){if(_.isEmpty(response.data.data)||_.isEmpty(response.data.data.lotDetails)){self.isValidLot=false;return}else{if(response.data.data.lotDetails.yn!=null)self.vechileDeliveryVO.vehicleCurrentLocation=response.data.data.lotDetails.yn;dataServiceG2.sendVehicleDeliveryForm(self.vechileDeliveryVO,function(response){if(response.returnCode!=-1&&!_.isEmpty(response.data)){$("#vehicleDeliveryFormsuccessModal").modal("show");
self.resetForm(self.vehicleDeliveryForm)}else{self.error=true;$("#vehicleDeliveryFormsuccessModal").modal("show")}})}})}};self.resetErrorValue=function(value){if(value==="Lot")self.isValidLot=true;else self.isValidMemberNumber=true};self.isValidNumber=function(number){return _.isEmpty(number)||isNaN(parseInt(number))};self.resetForm=function(form){self.vechileDeliveryVO={};form.$setPristine();form.$setUntouched()};appConfigService.getLocationsListBySite(function(response){self.yardLocations=_.filter(response,
function(item){if("GB"===item.yardStateCode)return item})})}]);
app.controller("smsVehicleAlertsController",["$scope","$controller","$route","dataServiceG2","vehicleFactory","$routeParams","$location","appConfigService","vehicleFinderService",function($scope,$controller,$route,dataServiceG2,vehicleFactory,$routeParams,$location,appConfigService,vehicleFinderService){$scope.childParam=true;$controller("vehicleFinderDirectiveController",{$scope:$scope});var self=$scope;self.locale=$scope.$parent.locale;self.loading=false;self.init=function(){smsAlertVO={};smsAlertVO.key=
$location.search().Key;smsAlertVO.functionalityType="smsVehicleAlert";self.loading=true;dataServiceG2.editVehicleAlerts(smsAlertVO,function(response){var responseCode=response.errorMsg;var responseCodeDesc=response.returnCodeDesc;if(response.returnCodeDesc!=="undefined"&&response.returnCodeDesc=="Success"){self.loading=false;var vehicleAlertVO=response.data.vehicleAlerts;var vehicleType=_.findWhere(self.appConfig.vehicleTypes,{code:vehicleAlertVO.typeOfVehicle||"V"})||self.vehicleTypes[0];var vehicleMake=
_.findWhere(self.appConfig.vehicleMakes,{code:vehicleAlertVO.makeOfVehicle,type:vehicleAlertVO.typeOfVehicle});var form={vehicleType:vehicleType,vehicleMake:vehicleMake,model:vehicleAlertVO.modelOfVehicle,fromYear:vehicleAlertVO.yearFrom,toYear:vehicleAlertVO.yearTo};var eid="\x26eid\x3dsms_vehiclealerts";self.search(form,eid)}else{self.isError=true;self.errorDesc=self.locale.getMessage("app.vehicle.sms.alert.failureMsg")}self.loading=false})};self.init()}]);
app.controller("awaitingDocApprovalController",["$scope","dataServiceG2","$location",function($scope,dataServiceG2,$location){var self=$scope;var log=new Logger({name:"awaitingDocApprovalController"});self.gotToDashBoard=function(){dataServiceG2.removeAwaitingDocApprovalTrafficStop(function(response){if(response.returnCode==1){log.error("Removed awaitingDocApproval traffic cop");$location.url("/dashboard")}else log.error("Error while removing the awaitingDocApproval traffic cop")})};self.goToAccountSettings=
function(){dataServiceG2.removeAwaitingDocApprovalTrafficStop(function(response){if(response.returnCode==1){log.info("Removed awaitingDocApproval traffic cop");$location.url("/accountInformation/accountSetting?showAcc\x3dY")}else log.error("Error while removing the awaitingDocApproval traffic cop")})}}]);
app.controller("driverSeatController",["$controller","$rootScope","$scope","$location","$route","$routeParams","searchQueryCriteria","copartUser","driverSeatService","userService","saveLotNumbersService","$window","urlStore",function($controller,$rootScope,$scope,$location,$route,$routeParams,searchQueryCriteria,copartUser,driverSeatService,userService,saveLotNumbersService,$window,urlStore){$controller("lotSearchBaseController",{$scope:$scope,searchCriteria:searchQueryCriteria});var self=$scope;
self.filters=[];self.view=$routeParams.view?$routeParams.view:"mylots";self.dataTableView="/data/driverseat/dataTable?view\x3d"+self.view;var selectedTimezone=userService.userConfig.selectedTimezone;var defaultDateFormat=userService.userConfig.dateFormat.toUpperCase();var defaultTimeFormat=userService.userConfig.displayPref.timeFormat;var auctionDateFormat=defaultDateFormat+" \x3cbr\x3e "+defaultTimeFormat+" zz";self.localSotragePropObj={"restoreStateFromAnyWhere":"restore-search-state-from-anywhere",
"restore":"restore","restoreSearchState":"restore-search-state","viewdLot":"viewed-lot","stateStage":"stateStage","lotNavigationInfo":"lot-navigation-info","filtersHidden":"driverSeatFiltersHidden","cookie":{"searchResultsPageLength":"searchResultsPageLength","showImages":"driverSeatShowImages"}};self.lotStatus={"winning":["WINNING"],"outbid":["OUTBID"],"counterbidding":["COUNTER_BIDDING"],"paymentdue":["PAYMENT_DUE"],"lotleftyard":["PAID","TO_BE_PICKED_UP"],"pickedup":["PICKED_UP"]};self.getDefaultRowValues=
function(row){row=_.defaults(row,{"lcy":"","orr":0,"pda":0,"ts":"0","ln":0,"ad":0,"hb":0,"ims":"","tims":"","rc":0,"cuc":"","lm":"","obc":"","hbdr":"","stt":"0","syn":"","aan":0,"ia":0,"hbrmstrbkrid":"","tmd":"","dtc":"","al":"-","gr":"-","mkn":"","fv":"","yn":"","la":0,"lic":[],"bds":"","llyd":"","mls":"","mb":0,"adt":"","sbf":false,"las":"","ynumb":0,"phynumb":0,"mmb":0,"bnp":0,"brand":"","invd":0,"brkbid":0,"cmls":"","pd":0,"ldu":""});return row};self.getHeaderColumns=function(tableId){var fieldList=
[];$(tableId).find("thead tr th").each(function(i,v){fieldList.push($(this).data("fieldid"))});var userColumns=self.getLotSearchBaseHeaderColumns(_.difference(fieldList,self.viewSpecificColoums));var columns={};angular.forEach(self.viewSpecificColoums,function(field){if(field=="lotNumber")columns["data"]={"defaultContent":"","render":function(data,type,row,meta){saveLotNumbersService.addLotNumber(row["ln"]);row=self.getDefaultRowValues(row);row["resultIndex"]=meta.settings._iDisplayStart+meta.row;
row["totalRecords"]=meta.settings._iRecordsTotal;row["backTo"]=$location.url();row["header"]=self.header;if(self.viewedLot&&self.viewedLot==row["ln"]){self.viewedRowIndex=meta.row;self.viewedLot=null}var template="\x3cdiv class\x3d'ng-cloak'\x3e"+"\x3ca data-url\x3d'./lot/[[ ln ]]' brand\x3d'[[ brand ]]' sso-sign-on "+"ng-click\x3d'storeNavigationInfo([[resultIndex]],[[totalRecords]],false)' data-uname\x3d'lotsearchLotnumber'\x3e[[ ln ]]\x3c/a\x3e\x3cbr/\x3e";if(row["las"]=="PRE_AUCTION")template+=
"\x3cbutton type\x3d'submit' class\x3d'black-line watch-btn' ng-hide\x3d\"isAlreadyAdded('[[ln]]')\" check-for-logged-in-user state-restore\x3d'true'"+"ng-click\x3d\"::addToWatchList('[[ln]]')\" data-uname\x3d'lotsearchWatchlot'\x3e"+self.locale.messages["app.label.watch"]+"\x3c/button\x3e"+"\x3cbutton type\x3d'submit' class\x3d'black-line watch-btn watched' ng-hide\x3d\"!isAlreadyAdded('[[ln]]')\""+"ng-click\x3d\"removeFromWatchList('[[ln]]')\" data-uname\x3d'lotsearchRemovelot'\x3e"+self.locale.messages["app.label.remove"]+
"\x3c/button\x3e"+"\x3c/div\x3e";return self.compileCellWithUnderscore(template,row)}};else if(field=="invoiceDate")columns["data"]={"defaultContent":"","render":function(data,type,row){row=self.getDefaultRowValues(row);var invoiceDate=row["invd"];if(invoiceDate&&invoiceDate!=0)return moment.utc(invoiceDate).tz(selectedTimezone).format(auctionDateFormat);else return""}};else if(field=="paymentDate")columns["data"]={"defaultContent":"","render":function(data,type,row){row=self.getDefaultRowValues(row);
var paymentDate=row["pd"];if(paymentDate&&paymentDate!=0)return moment.utc(paymentDate).tz(selectedTimezone).format(auctionDateFormat);else return""}};else if(field=="titleMailedDate")columns["data"]={"defaultContent":"","render":function(data,type,row){row=self.getDefaultRowValues(row);var titleMailedDate=row["tmd"];if(titleMailedDate&&titleMailedDate!=0)return moment.utc(titleMailedDate).tz(selectedTimezone).format(auctionDateFormat);else return""}};else if(field=="lotLeftYardDate")columns["data"]=
{"defaultContent":"","render":function(data,type,row){row=self.getDefaultRowValues(row);var lotLeftYardDate=row["llyd"];if(lotLeftYardDate&&lotLeftYardDate!=0)return moment.utc(lotLeftYardDate).tz(selectedTimezone).format(defaultDateFormat);else return""}};else columns["data"]={"defaultContent":"","render":function(data,type,row,meta){row=self.getDefaultRowValues(row);var template=$("#"+field).html();if(!_.isUndefined(template)){var compiled=_.template(template);return compiled(row)}return data}};
userColumns[field]=columns["data"]});var headerColumnRenderingArr=[];angular.forEach(fieldList,function(field){headerColumnRenderingArr.push(userColumns[field])});return headerColumnRenderingArr};self.initialize=function(){saveLotNumbersService.clearAll();self.fromDriverSeat=true;self.externalSearchCriteria=!_.isEmpty(searchQueryCriteria.getSearchCriteriaObj());self.columnDefs=driverSeatService.getColumnsDef();self.viewDefinitionObj=driverSeatService.driverSeatView(self.view);var olDTable=$(self.viewDefinitionObj.tableId).DataTable();
olDTable.destroy();$(self.viewDefinitionObj.tableId).empty();self.header=self.locale.messages["member.lotseacrh.page.header."+self.view];self.viewDefinitionObj.selected=true;self.urlToTrigger=self.viewDefinitionObj.urlToTrigger;self.customColumnsOptions=driverSeatService.getCustomColumDef();self.csvUrl=self.viewDefinitionObj.csvUrl;self.csvFileName=self.viewDefinitionObj.csvFileName+self.date+".csv";self.viewSpecificColoums=self.viewDefinitionObj.viewSpecificColoums;self.init();self.dataTableOptions=
self.defaultDataTableOptions;self.dataTableOptions.fromDriverSeat=true;if(self.viewDefinitionObj.dataTableOptions)self.dataTableOptions=overideDatatableOptions(self.dataTableOptions,self.viewDefinitionObj.dataTableOptions);if(self.dataTableOptions.applyNoOfDaysFilter)self.prepareDateRangeDropDown()};var updateLotLiveAuctionStatusEvent=$rootScope.$on("update-lot-live-auction-status",function(event,data){self.lots=angular.copy(self.lotsObj);var tempLots=data.data;angular.forEach(tempLots,function(value,
key){var dynamicLotDetailObj={"las":value.las};self.lots["lot_"+key]=dynamicLotDetailObj})});var overideDatatableOptions=function(dataTableOptions,overrides){angular.forEach(overrides,function(value,key){dataTableOptions[key]=value});dataTableOptions.language.emptyTable=self.locale.getMessage("member.lotseacrh.noRecordsAvailable",self.header).toString();return dataTableOptions};self.prepareDateRangeDropDown=function(){self.noOfDaysRanges=[];self.defaultDaysRange=30;var dateRanges=driverSeatService.getDateRanges();
angular.forEach(dateRanges,function(value,key){var obj={desc:self.locale.messages["app.label.bidStatusTimeRange.last"+value+"Days"],numOfDays:value};self.noOfDaysRanges.push(obj)});self.selectedNoOfDays=self.selectedNoOfDays||self.defaultDaysRange;self.selectedNoOfDaysRange=self.noOfDaysRanges[0]};var updateDateRangeFilter=$scope.$on("update-daterange-dropdown",function(event,data){data=data||self.defaultDaysRange;var index=_.findIndex(self.noOfDaysRanges,function(item){return item.numOfDays==data});
self.selectedNoOfDaysRange=self.noOfDaysRanges[index]});var redirectToLoginPage=$rootScope.$on("redirect-to-login-page",function(event,data){copartUser.config=copartUser.refreshAndGetConfig();$window.location.href=urlStore.login+"?redirectUrl\x3d"+$location.path()});$scope.$on("$destroy",function(){updateLotLiveAuctionStatusEvent();redirectToLoginPage()});self.initialize()}]);
app.controller("customizeColumnsController",["$scope","$http","$templateCache","localStorageService","$route","$location",function($scope,$http,$templateCache,localStorageService,$route,$location){var self=$scope;$("#customcolmulitselect").multiselect({keepRenderingSort:true});self.resetToDefault=function(){$("#customcolmulitselect_to").empty();var defValues=[];var defValuesOrig=[];$("#customcolmulitselect_def option").each(function(){defValues.push($(this).clone())});$("#customcolmulitselect_to").html(defValues);
$("#customcolmulitselect").empty();var buyerAvailValues=[];var defAvailFields=[];$("#customcolmulitselect_defAvail option").each(function(){buyerAvailValues.push($(this).clone())});$("#customcolmulitselect").html(buyerAvailValues)};self.confirmCustomization=function(){var selectedOptions=[];var options=$("#customcolmulitselect_to option");if(options.length<(self.customColumnsOptions.length||7)){var values=[];angular.forEach(options,function(option){values.push(option.value)});var postData={"driverSeatCustomViewPreferences":{"customColumns":values,
"view":self.view}};var req={method:"POST",url:self.customColumnsOptions.url,data:postData};$http(req).then(function(response){if(response.data&&response.data.returnCode===1){$("#customizeColumns").modal("hide");$("body").removeClass("modal-open");$(".modal-backdrop").remove();var currentPageTemplate=$route.current.templateUrl;$templateCache.remove(currentPageTemplate);$templateCache.remove("/data/driverseat/dataTable?view\x3d"+$route.current.params.view);localStorageService.set(self.localSotragePropObj.restoreSearchState,
true);$location.search("state","restore");$route.reload()}},function(response){log.error("Error returned"+response)})}else{self.errCustomColCount=true;self.addAlerts("danger",self.locale.messages["app.alert.customizeResult"]);self.isAlertOnModal=true}}}]);
app.controller("intlShippingSearchController",["$scope","$q","$timeout","$window","dataServiceG2","$location","lotDetailsService","userService","shippingService","localStorageService","backToLinkService","copartUser",function($scope,$q,$timeout,$window,dataServiceG2,$location,lotDetailsService,userService,shippingService,localStorageService,backToLinkService,copartUser){var self=$scope;var shippingPortData={};self.showRevive=false;self.lotDetails={};self.noData=false;self.destinationDetails=self.destinationPortName+
","+self.countryCode;self.intlShippingReassign="intl-shipping-reassign";self.currencyCode=userService.userConfig.defaultDisplayPref.currencyCode;self.internationalShippingPref=copartUser.getUserConfig().defaultDisplayPref&&copartUser.getUserConfig().defaultDisplayPref.internationalShipping;var titleTypes=userService.userConfig.defaultDisplayPref.titleType;self.navigateToOldPage=function(port,countryCode,lotNumber,shipDataObj){var info={backTo:"."+$location.url(),port:port,countryCode:countryCode,
lotNumber:lotNumber};if(!userService.isAnonymous())$window.open(shipDataObj.transactionUrl);else{localStorageService.set(self.intlShippingReassign,info);return}};self.refreshPage=function(){if(localStorageService.get("intl-shipping-reassign")){var info=localStorageService.get("intl-shipping-reassign");self.port=info.port;self.destinationPortCode=info.port.portCode;self.countryCode=info.countryCode;self.lotNumber=info.lotNumber;localStorageService.remove("intl-shipping-reassign");if(_.isUndefined(shippingService.getPort()))shippingService.setPort(self.port);
self.getCountriesForShipping();if(localStorageService.get("lot-detail-information")){self.lotDetails=localStorageService.get("lot-detail-information");self.yardCityName=self.lotDetails.locCity;self.yardZipCode=self.lotDetails.zip;self.lot=true;self.getQuote(self.destinationPortCode,self.countryCode,self.lotNumber)}}self.elementInViewPort=false};self.setFilterOptions=function(){if(localStorageService.get("lot-navigation-info-shipping")){localStorageService.set("lot-navigation-info",localStorageService.get("lot-navigation-info-shipping"));
localStorageService.remove("lot-navigation-info-shipping")}};self.getQuote=function(destinationPortCode,countryCode,lotNumber){copartOmnitureCallMulti("doTagInternationalShippingEstimate",[lotNumber,userService.userConfig.buyerNumber,self.countryCode,self.destinationPortName]);if(localStorageService.get("lot-detail-information")){var lotDetails=localStorageService.get("lot-detail-information");self.yardCityName=lotDetails.locCity;self.yardZipCode=lotDetails.zip;self.yardName=lotDetails.yn;var port=
$location.port();var newURL=port!=undefined&&port!=null?$location.host()+":"+port:$location.host();newURL=$location.$$protocol+"://"+newURL;self.dataVO={"yardCityName":self.yardCityName,"yardZipCode":self.yardZipCode,"vin":userService.isAnonymous()?undefined:self.lotDetails.fv,"yardTwoLetterState":lotDetails.locState,"destinationPortCode":destinationPortCode,"destinationIso3CountryCode":countryCode,"lotNumber":lotNumber,"buyerNumber":userService.isAnonymous()?undefined:userService.userConfig.buyerNumber,
"domainUrl":newURL,"requestOriginator":$location.search().redirectOriginator,"yardName":self.yardName};self.portCode=self.destinationPortCode;dataServiceG2.getQuoteForShipping(angular.toJson(self.dataVO),function(response){if(response.length==0)self.noData=true;else{self.noData=false;self.shipData=response}self.showRevive=true})}};self.storeQuote=function(shipData,providerName){copartOmnitureCallMulti("doTagInternationalShippingOrderNow",[shipData.lotNumber,shipData.buyerNumber,providerName]);self.redirectToProvider=
providerName;console.log("provider name "+self.redirectToProvider);console.log("Shipping Data"+shipData);jQuery(".spin-head-with-logo").removeClass("hide");$timeout(function(){dataServiceG2.redirectQuote(shipData,function(response){$window.location.href=shipData.transactionUrl;jQuery(".spin-head-with-logo").addClass("hide")},function(error){self.errorMessage=error})},100)};self.getLotDetails=function(lotNumber){var deferred=$q.defer();dataServiceG2.getLotDetails(lotNumber,function(response){deferred.resolve(response.data)});
return deferred.promise};self.getCountriesForShipping=function(){dataServiceG2.getCountriesForShipping(function(response){shippingPortData=response.data;var countryDatas=[];Object.keys(shippingPortData).forEach(function(k){countryDatas.push({countryCode:k,countryName:shippingPortData[k].countryName})});self.countryCodes=countryDatas;if(self.countryCodes&&self.countryCode){self.shippingCountryCodes=self.countryCodes.filter(function(value){return value.countryCode===self.countryCode})[0];self.getPorts(self.shippingCountryCodes)}})};
self.getPorts=function(country){if(shippingPortData.hasOwnProperty(country.countryCode)){self.shipPortData=shippingPortData[country.countryCode].portCities;self.portData=[];for(var i=0;i<self.shipPortData.length;i++)self.portData.push({portName:self.shipPortData[i].portName,portCode:self.shipPortData[i].portCode})}if(self.portData&&shippingService.getPort())self.port=self.portData.filter(function(value){return value.portName===shippingService.getPort().portName})[0]};self.init=function(){jQuery(".spin-head").removeClass("hide");
self.ordered=false;self.shipData=[];self.portData=[];self.lotNumber=shippingService.getLotNumber();self.backToLink=backToLinkService.getBackToLink();self.backToLinkText=backToLinkService.getBackToLinkText();self.lot=self.lotNumber<=7;self.countryCode=shippingService.getDestinationCountryCode();self.port=shippingService.getPort();self.getCountriesForShipping();if(self.lotNumber!==undefined){if(!localStorageService.get("no-navigation"))self.noNavigation=true;else self.noNavigation=false;if(!userService.isAnonymous())getDynamicLotDetails();
self.lot=true;self.destinationPortName=self.port.portName;self.destinationPortCode=self.port.portCode;self.getLotDetails(self.lotNumber).then(function(response){if(response.returnCode===-1){self.lot=true;return}self.lotDetails=response.data.lotDetails;localStorageService.set("lot-detail-information",self.lotDetails);self.getQuote(self.destinationPortCode,self.countryCode,self.lotNumber)});self.portCode=self.destinationPortCode;self.showRevive=true}self.refreshPage();jQuery(".spin-head").addClass("hide")};
var getDynamicLotDetails=function(){dataServiceG2.getDynamicLotDetails(self.lotNumber,lotDetailsDymicSuccessCallBack)};var lotDetailsDymicSuccessCallBack=function(response){try{if(response.data.returnCode==-1)self.dynamicLotDetailsError=response.data.data.errorObject;else{self.dynamiclotDetails=response.data.data.lotDetails||{};self.lotDetails.dynamicLotDetails=self.dynamiclotDetails;localStorageService.set("lot-detail-information",self.lotDetails);self.showQuoteInDelivery=self.dynamiclotDetails.lotAuctionStatus==
"COUNTER_BIDDING"&&self.dynamiclotDetails.bidStatus=="PAID";if(titleTypes.includes(self.lotDetails.td))self.showDocTypeBanner=true}}catch(e){log.error(e)}};self.updateLotNumber=function(){jQuery(".spin-head").removeClass("hide");if(self.lotNumber&&self.lotNumber.length>7){self.noData=false;self.showRevive=false;self.error=false;self.lot=true;self.lotDetails={};self.yardCityName="";self.yardZipCode="";var titleTypes=userService.userConfig.defaultDisplayPref.titleType;var lotData=localStorageService.get("lot-detail-information");
if(lotData&&self.lotNumber===lotData.lotNumberStr&&lotData.dynamicLotDetails){self.lotDetails=lotData;self.showQuoteInDelivery=self.lotDetails.dynamicLotDetails.lotAuctionStatus=="COUNTER_BIDDING"&&self.lotDetails.dynamicLotDetails.bidStatus=="PAID";if(titleTypes.includes(self.lotDetails.td))self.showDocTypeBanner=true;self.displayIntlShipping=(self.lotDetails.vehTypDesc=="AUTOMOBILE"||self.lotDetails.vehTypDesc=="MOTORCYCLE")&&!self.lotDetails.offFlg&&!titleTypes.includes(self.lotDetails.td);if(self.showQuoteInDelivery&&
self.internationalShippingPref&&self.displayIntlShipping)dataServiceG2.lotCurrentShippingStatus(userService.userConfig.buyerNumber,self.lotNumber,function(response){if(response){self.lotDetails.ordered=true;self.ordered=true}else{self.displayError=true;self.ordered=false}console.log("Current Lot Shipping Data: ",response)});self.yardCityName=self.lotDetails.locCity;self.yardZipCode=self.lotDetails.zip;if(self.shippingCountryCodes&&self.port)self.getQuote(self.port.portCode,self.shippingCountryCodes.countryCode,
self.lotNumber);self.lot=true}else self.getLotDetails(self.lotNumber).then(function(response){if(response.returnCode==-1){self.error=true;self.countryCode="";self.lot=false;return}if(!userService.isAnonymous()){getDynamicLotDetails();if(self.showQuoteInDelivery&&self.internationalShippingPref)dataServiceG2.lotCurrentShippingStatus(userService.userConfig.buyerNumber,self.lotNumber,function(response){if(response)self.ordered=true;else{self.displayError=true;self.ordered=false}console.log("Current Lot Shipping Data: ",
response);jQuery(".spin-head").addClass("hide")})}self.lotDetails=response.data.lotDetails;localStorageService.set("lot-detail-information",self.lotDetails);self.yardCityName=self.lotDetails.locCity;self.yardZipCode=self.lotDetails.zip;if(self.shippingCountryCodes&&self.port)self.getQuote(self.port.portCode,self.shippingCountryCodes.countryCode,self.lotNumber);self.lot=true})}else{self.shipData=[];self.countryCode="";self.lot=false;self.error=true;jQuery(".spin-head").addClass("hide");return}jQuery(".spin-head").addClass("hide")};
self.init()}]);
app.controller("registrationBaseController",["$scope","$routeParams","copartUser","registrationConstants","$location","$q","copartUtils","userService","dataServiceG2","constants",function($scope,$routeParams,copartUser,registrationConstants,$location,$q,copartUtils,userService,dataServiceG2,constants){var log=new Logger({name:"registrationBaseController"});var self=$scope;self.companyFlag=false;self.getRegistrationStatus=function(){if(self.referenceId)dataServiceG2.getRegistrationStatus(self.referenceId,function(response){if(response.returnCode!=
-1&&response.data){self.registrationStatus=response.data;self.activeStep=self.registrationStatus.activeStep;self.referenceId=self.registrationStatus.referenceId}else $location.search("refId",null);self.activeStepObj=registrationConstants[copartUser.getUserConfig().siteRegionCode][self.activeStep]});else dataServiceG2.clearRegistrationStatus(function(response){console.log("clearing the user config")})};self.navigateToNextStep=function(registrationStatus){registrationStatus.activeStep=self.activeStepObj.nextStep;
if(registrationStatus.referenceId)self.referenceId=registrationStatus.referenceId;dataServiceG2.saveRegistrationStatus(registrationStatus,function(response){self.activeStepObj=self.getActiveStepObj(self.activeStepObj.nextStep)});if(registrationStatus.physicalAddress)self.registrationStatus.physicalAddress=registrationStatus.physicalAddress;self.activeStep=self.activeStepObj.nextStep;if(!$location.search().refId)$location.search("refId",self.referenceId);$location.search("t",(new Date).getTime())};
self.getActiveStepObj=function(nextStep){var activeStepObj=registrationConstants[copartUser.getUserConfig().siteRegionCode][nextStep];return activeStepObj||registrationConstants[copartUser.getUserConfig().siteRegionCode][registrationConstants.START_STEP]};self.saveRegistrationStatus=function(registrationStatus){dataServiceG2.saveRegistrationStatus(registrationStatus,function(response){})};self.clearRegistrationStatusAndShowThankYou=function(){self.showConfirmOnExit=false;dataServiceG2.clearRegistrationStatus(function(response){if(response.returnCode!==
-1)self.showThankYouPage();else;})};self.getThankYouUrl=function(){var type=constants.INDIVIDUAL;var companyFlag=false;if(self.registrationStatus&&self.registrationStatus.basicInfo)companyFlag=Boolean(self.registrationStatus.basicInfo.companyFlag);if(companyFlag)type=constants.BUSINESS;return"/"+constants.THANK_YOU+"?type\x3d"+type};self.showThankYouPage=function(){self.showConfirmOnExit=false;$location.url(self.getThankYouUrl())};self.registrationYoutubeVideo=function(companyFlag){var clickIframe=
window.setInterval(checkFocus,100);function checkFocus(){if(document.activeElement==document.getElementById("registration-iframe")){if(companyFlag)copartOmnitureCallOne("doTagVideoTrackingForBusiness","");else copartOmnitureCallOne("doTagVideoTrackingForIndividual","");clearInterval(clickIframe)}}};self.navigateToThankyouPage=function(registrationStatus){if(registrationStatus.referenceId)self.referenceId=registrationStatus.referenceId;dataServiceG2.saveRegistrationStatus(registrationStatus,function(response){console.log("Step2 completed suceesfully!!!")});
self.showThankYouPage()};$scope.$on("$destroy",function(){});self.init=function(){self.registrationStatus=undefined;self.activeStep=registrationConstants.START_STEP;self.activeStepObj=self.getActiveStepObj(self.activeStep);self.referenceId=$routeParams.refId||null;self.showConfirmOnExit=$routeParams.refId?true:false;self.getRegistrationStatus();self.registrationYoutubeVideo(self.companyFlag)};self.init();self.openPrivacyPolicyModal=function(){self.fetchPrivacyPolicyCmsContent=true};self.openMemberServiceModal=
function(){self.fetchMemberServiceCmsContent=true};self.openMemberTermsModal=function(){self.fetchMemberTermsCmsContent=true}}]);
app.controller("registrationStep1Controller",["$scope","$routeParams","$location","dataServiceG2","copartUser","memberChoicesService","memberChoicesConstants","appConfigService","vcRecaptchaService","constants","passwordValidationService","smoothScroll",function($scope,$routeParams,$location,dataServiceG2,copartUser,memberChoicesService,memberChoicesConstants,appConfigService,vcRecaptchaService,constants,passwordValidationService,smoothScroll){var log=new Logger({name:"registrationStep1Controller"});
var self=$scope;self.parent=$scope.$parent;self.loadingStepOne=true;self.loadingStepOneSubmit=false;self.locale=$scope.$parent.locale;self.personalDetails={};var emailLanguage="ELNG";var choices={};var getChoicesData=function(){return{email_language:memberChoicesService.getQuestion(emailLanguage),member_types:memberChoicesService.getQuestion(memberChoicesConstants.memberType),primary_use:memberChoicesService.getQuestion(memberChoicesConstants.copartPrimaryUseCode)}};var updateEmailLangChoices=function(){var lang=
self.locale.messages["member.choices.email.language.registration"]||"EN-US";if(choices.email_language&&emailLanguage)memberChoicesService.updateChoiceSelections(emailLanguage,findByObj(choices.email_language.answers,{answerCode:lang.toUpperCase()}),true)};var updateMemberTypeChoices=function(choices,companyFlag){var defaultChoices=[{"questionCode":memberChoicesConstants.copartPrimaryUseCode,"answerCode":findByObj(choices.primary_use.answers,{answerCode:companyFlag?memberChoicesConstants.businessUse:
memberChoicesConstants.personalUse})},{"questionCode":memberChoicesConstants.memberType,"answerCode":findByObj(choices.member_types.answers,{answerCode:companyFlag?memberChoicesConstants.business:memberChoicesConstants.individual})}];_.each(defaultChoices,function(choice){memberChoicesService.updateChoiceSelections(choice.questionCode,choice.answerCode,true)})};self.buildPreferences=function(){updateMemberTypeChoices(choices,self.parent.companyFlag);updateEmailLangChoices()};self.submitBasicInfo=
function(isValid,form){self.submitted=true;self.resetErrors();if(!self.validateRequest(isValid))return;self.loadingStepOneSubmit=true;var requestData=self.getRequestData();dataServiceG2.registerNewMember(requestData,{onSuccess:function(responseData){if(responseData.returnCode===-1){if(responseData.data.errorObjects||responseData.data.errorObjectsMap){if(!self.handleServerSideErrors(responseData))self.registration_ServerException=self.$parent.locale.getMessage("registration.label.ServerException")}else self.registration_ServerException=
self.$parent.locale.getMessage("registration.label.ServerException");self.submitDisabled=false;self.setRegistrationStatus(requestData)}else{self.submitDisabled=true;try{var registrationType="";if(responseData.data.companyFlag===false)registrationType="indv";else registrationType="comp";var userConfig=copartUser.getUserConfig();userConfig.crmId=responseData.data.crmId;copartUser.setUserConfig(userConfig);copartOmnitureCallMulti("doTagRegistrationStep1Complete",[responseData.data.crmId,registrationType])}catch(e){log.error("Registration step1 site catalyst error",
e)}self.submitted=false;requestData.referenceId=responseData.data.referenceId;var registrationStatus={"basicInfo":requestData,"referenceId":responseData.data.referenceId};memberChoicesService.init();self.parent.navigateToNextStep(registrationStatus)}self.loadingStepOneSubmit=false},onFailure:function(data){self.registration_ServerException=self.$parent.locale.getMessage("registration.label.ServerException");self.submitDisabled=false;self.setRegistrationStatus(requestData);self.loadingStepOneSubmit=
false;console.error("UnHandled error during registration")}})};self.getRequestData=function(){return self.prepareFormDataForSubmit()};self.prepareFormDataForSubmit=function(){self.buildPreferences();var requestDataObj={firstName:self.personalDetails.firstName,lastName:self.personalDetails.lastName,emailAddress:self.personalDetails.emailAddress,confirmationEmailAddress:self.personalDetails.confirmationEmailAddress,contactPhoneExt:self.personalDetails.phoneExtension,acceptTerms:self.personalDetails.termsAndConditions?
"Y":"N",selectedChoices:memberChoicesService.getSelectedChoices(),password:self.personalDetails.password};if(self.parent.companyFlag&&self.personalDetails.companyName&&self.personalDetails.companyName.length>0){requestDataObj.companyName=self.personalDetails.companyName;requestDataObj.companyFlag=true}else{requestDataObj.companyFlag=false;self.personalDetails.companyName=undefined}return requestDataObj};self.changeCompanyflag=function(){self.registrationYoutubeVideo(self.companyFlag)};self.validateRequest=
function(isValid){self.errors.termsAndCondtionsNotSelected=!self.personalDetails.termsAndConditions;if(!isValid)return false;return!self.errors.termsAndCondtionsNotSelected};self.handleServerSideErrors=function(response){if(response&&response.data&&response.data.errorObjects){self.submitDisabled=false;return self.validateFunc(response.data.errorCode)||self.validatePassword(response.data.errorObjects)}return false};self.validatePassword=function(errorsList){self.errors=passwordValidationService.handleServerSideErrors(self.errors,
errorsList);return self.errors&&self.errors.password&&self.errors.password.isError};self.validateFunc=function(errorCode){if(errorCode==="email.already.exists"){self.errors.emailAlreadyExist=true;return true}else return false};self.setRegistrationStatus=function(requestData){var registraionStatus={"basicInfo":requestData,"activeStep":self.parent.activeStep};self.parent.saveRegistrationStatus(registraionStatus)};self.buildBasicInfoObj=function(){var registrationStatus=self.registrationStatus;if(registrationStatus&&
registrationStatus.basicInfo){self.personalDetails=registrationStatus.basicInfo;self.personalDetails.termsAndConditions=self.personalDetails.acceptTerms==="Y"}};self.goToLoginPage=function(){self.parent.showConfirmOnExit=false;if(self["registrationBasicInfo"])self["registrationBasicInfo"].$setPristine();$location.url("/login")};self.getNamePattren=function(){var siteCode=copartUser.getUserConfig().siteCode.trim();var namePattern=constants.NAME_PATTERNS[siteCode]||constants.NAME_PATTERNS["DEFAULT"]||
"^[a-zA-Z\\s]*$";return new RegExp(namePattern)};self.resetErrors=function(){self.errors={phoneNumber:false,termsAndCondtionsNotSelected:false,emailAlreadyExist:false,cityStateZipConbinationInvalid:false,password:{isError:false,errorMessage:""}};self.registration_ServerException=""};self.regBeginTracking=function(){try{var queryParam="";queryParam=s.Util.getQueryParam("refId");if(queryParam==="")copartOmnitureCallOne("doTagBeginRegistration","")}catch(e){log.error("begin registration site catalyst error",
e)}};self.init=function(){dataServiceG2.getSiteKey(function(response){self.siteKey=response.data;self.loadingStepOne=false});self.buildBasicInfoObj();self.namePattern=self.getNamePattren();choices=getChoicesData();memberChoicesService.init();self.resetErrors();self.regBeginTracking();smoothScroll.targetElement("registration")};var findByObj=function(list,object){return _.find(list,object)};self.init()}]);
app.controller("registrationStep2Controller",["$scope","constants","$window","copartUser","copartUtils","smoothScroll",function($scope,constants,$window,copartUser,copartUtils,smoothScroll){var log=new Logger({name:"registrationStep2Controller"});var self=$scope;self.parent=$scope.$parent;self.additionalInfo={};self.membershipPurchaseFuncs={};self.loadingStepTwo=true;self.loadingStepTwoSubmit=false;self.docUploadFailureHandler=function(response){console.log("Document upload Failed:",response)};self.saveRegistrationStatusAndMoveNextStep=
function(nextStep,contactPreferences){var registrationStatus={};if(contactPreferences&&contactPreferences.addresses)contactPreferences.addresses.forEach(function(address){if(address&&address.addressType.length>0&&address.addressType[0]===constants.PHYSICAL_ADDRESS_REF)registrationStatus.physicalAddress=address});if(contactPreferences&&contactPreferences.physicalAddress)registrationStatus.physicalAddress=contactPreferences.physicalAddress;self.parent.navigateToNextStep(registrationStatus)};self.submitPayment=
function(){if(_.isFunction(self.membershipPurchaseFuncs.submitWithOutReview)){self.loadingStepTwoSubmit=true;self.membershipPurchaseFuncs.submitWithOutReview().then(function(response){self.loadingStepTwoSubmit=false},function(error){self.loadingStepTwoSubmit=false})}};self.membershipPurchaseSuccessHandler=function(response){var contactPreferences={};if(response&&response.returnCode!==-1){if(response.data&&response.data.contactPreferences)contactPreferences=response.data.contactPreferences;self.saveRegistrationStatusAndMoveNextStep(self.parent.activeStepObj.nextStep,
contactPreferences)}self.loadingStepTwoSubmit=false};self.membershipPurchaseFailureHandler=function(response){self.loadingStepTwoSubmit=false;console.log("registration step2 failed")};self.init=function(){var registrationStatus=self.parent.registrationStatus;if(registrationStatus){self.additionalInfo.registrationStatus=registrationStatus;if(registrationStatus.basicInfo)self.parent.companyFlag=registrationStatus.basicInfo.companyFlag}self.loadingStepTwo=false;self.parent.showConfirmOnExit=true;smoothScroll.targetElement("registration")};
self.init()}]);
app.controller("registrationStep3Controller",["$scope","$window","copartUser","copartUtils","smoothScroll",function($scope,$window,copartUser,copartUtils,smoothScroll){var log=new Logger({name:"registrationStep3Controller"});var self=$scope;self.parent=$scope.$parent;self.additionalInfo={};self.updateAccountInfoFuncs={};self.loadingStepThree=true;self.loadingStepThreeSubmit=false;self.physicalAddress=new AddressVO;self.accountInfoSuccessHandler=function(response){if(self["registrationAddressAndDocumentForm"])self["registrationAddressAndDocumentForm"].$setPristine();self.loadingStepThreeSubmit=
false;navigateToThankYou()};self.authenticateUserAndShowThankYou=function(){var queryParamObj={redirectUrl:encodeURIComponent(copartUser.getLocationUrlWithLocale(self.parent.getThankYouUrl()))};var baseUrl="/member/authenticate/registration";baseUrl=copartUtils.appendQueryStringToURL(baseUrl,queryParamObj);$window.location.href=baseUrl};self.accountInfoFailureHandler=function(response){console.log("Account Info Update Failure:: ",response);self.parent.saveRegistrationStatus(self.getRegistrationStatus(self.parent.activeStep));
self.loadingStepThreeSubmit=false};var navigateToThankYou=function(){self.parent.showThankYouPage()};self.getRegistrationStatus=function(activeStep){var requestData=self.updateAccountInfoFuncs.getAccountInfoRequestData();requestData.referenceId=self.parent.referenceId;requestData.activeStep=activeStep;return requestData};self.updateAccountInfoFuncs.updateAccountInfoSubmit=function(){if(_.isFunction(self.updateAccountInfoFuncs.updateAccountInfo)){self.loadingStepThreeSubmit=true;self.updateAccountInfoFuncs.updateAccountInfo().then(function(response){self.loadingStepThreeSubmit=
false},function(error){self.loadingStepThreeSubmit=false})}};self.init=function(){var registrationStatus=self.parent.registrationStatus;if(registrationStatus){self.additionalInfo.registrationStatus=registrationStatus;self.physicalAddress=registrationStatus.physicalAddress;if(registrationStatus.basicInfo)self.parent.companyFlag=registrationStatus.basicInfo.companyFlag}self.loadingStepThree=false;self.parent.showConfirmOnExit=true;smoothScroll.targetElement("registration")};self.init()}]);
app.controller("registrationPaymentController",["$scope","$routeParams","dataServiceG2","appConfigService","$cookies","constants","copartUser","registrationConstants","errorHandler",function($scope,$routeParams,dataServiceG2,appConfigService,$cookies,constants,copartUser,registrationConstants,errorHandler){var log=new Logger({name:"registrationPaymentController"});var self=$scope;self.parent=$scope.$parent;self.appConfig=appConfigService.getAppConfig();self.selectedClass="";self.locale=$scope.$parent.locale;
self.skipMembership=constants.NO;self.selectedPaymentType={};self.parent.showConfirmOnExit=true;self.autoPaySubscription=true;self.paymentFormValidFn=function(data){console.log("paymentFormValidFn:: ",data);if(data)self.isPaymentFormValid=data.valid};self.reviewPayment=false;self.physicalAddressSameAsBillingAddr=false;self.selectedProduct={};self.showPhysicalAndBillingAddressOption=true;self.secondaryPhoneVO=new PhoneVO(self.defaultPhoneNumberObj);self.physicalAddress=new AddressVO;self.additionalPaymentVO=
{"email":undefined,"secondaryPhoneVO":self.secondaryPhoneVO,"physicalAddress":self.physicalAddress,"productPaymentVO":self.selectedProduct,"referenceId":self.parent.referenceId||undefined,"physicalAddrSameAsBillingAddr":true};self.membershipPurchaseFuncs={};self.errors={phoneNumber:false,specialChars:{addressLine1:false,addressLine2:false,billingAddressLine1:false,billingAddressLine2:false},zipCode:false};self.referenceId=self.parent.referenceId;self.paymentTypes=self.appConfig.getPaymentMethods()||
{};self.skipPayment=false;self.membershipPurchaseSuccessHandler=function(response){if(self["registrationPaymentForm"])self["registrationPaymentForm"].$setPristine();self.parent.showThankYouPage()};self.membershipPurchaseFailureHandler=function(errorObjects){console.log("Payment failure::membershipPurchaseFailureHandler::",errorObjects)};self.submitStep3=function(){self.paymentErrors=[];self.submitted=true;if(self.skipPayment)self.parent.showThankYouPage();else if(_.isFunction(self.membershipPurchaseFuncs.submitPayment))self.membershipPurchaseFuncs.submitPayment();
else console.log("ERROR submitStep3 ")};self.validatePaymentForm=function(){return true};self.init=function(){var registrationStatus=self.parent.registrationStatus;if(registrationStatus)if(registrationStatus.basicInfo)self.parent.companyFlag=registrationStatus.basicInfo.companyFlag};self.init()}]);
app.controller("accountInfoCompleteRegistrationStepsController",["$scope","$route","$window","dataServiceG2","$location","copartUser","appConfigService","copartUtils","registrationConstants","accountAlertsService","constants","openAccordionService",function($scope,$route,$window,dataServiceG2,$location,copartUser,appConfigService,copartUtils,registrationConstants,accountAlertsService,constants,openAccordionService){var self=$scope;self.skipMembership="N";self.locale=$scope.$parent.locale;self.errors=
false;self.showMemberAccountInfoAccordion=false;self.showMemberShipPayment=false;self.userActions=[];self.accountInfoData={};self.membershipRenewalInProgress=false;self.membershipUpgradeInProgress=false;self.buyerPhysicalCountry="";self.additionalPaymentInfo={};self.physicalAddress=new AddressVO;self.moveToPurchaseMembership=function(){self.getContactInfo();jQuery("#saveAddressPopUp").modal("hide");$("body").removeClass("modal-open");$(".modal-backdrop").remove();self.showMemberAccountInfoAccordion=
false;openAccordionService.targetAccordion("completeRegUpgradeMem");accountAlertsService.getAccountAlerts()};self.ALERT_TYPE_STATUS=constants.ALERT_TYPE_STATUS;$scope.$watch(function(){return accountAlertsService.getAlerts()},function(newAlerts){if(newAlerts){self.userActions=accountAlertsService.getPendingActionsFromUserActivity(newAlerts);if(self.userActions&&self.userActions.length>0)self.auditPendingActions(self.userActions)}});self.auditPendingActions=function(userActions){if(userActions){self.showMemberAccountInfoAccordion=
!accountAlertsService.verifyUserActionCompleted(userActions,self.ALERT_TYPE_STATUS.missingAccInfo)||!accountAlertsService.verifyUserActionCompleted(userActions,self.ALERT_TYPE_STATUS.pendingMemPayment);self.showMemberShipPayment=self.showMemberAccountInfoAccordion?false:!accountAlertsService.verifyUserActionCompleted(userActions,self.ALERT_TYPE_STATUS.pendingMemPayment);self.showMemberAccountInfoAccordion?openAccordionService.targetAccordion("completeRegDocSubmission"):openAccordionService.targetAccordion("completeRegUpgradeMem");
if(self.showMemberShipPayment)self.getContactInfo()}else{console.log("accountInfoCompleteRegistrationStepsController :: Got Error while fetching the Account Alert info");self.errors=true;self.errorMsg=self.locale.getMessage("app.accountinformation.error.errorcode.default")}};self.openAccordion=function(id){openAccordionService.targetAccordion(id)};self.getContactInfo=function(){dataServiceG2.getContactInfo(function(response){if(response&&response.data&&response.data.contactInfoList){self.accountInfoData=
response.data.contactInfoList;if(self.accountInfoData){self.membershipUpgradeInProgress=self.accountInfoData.membershipUpgradeInProgress;self.membershipRenewalInProgress=self.accountInfoData.membershipRenewalInProgress;self.additionalPaymentInfo.physicalAddress=self.accountInfoData.physicalAddress;self.physicalAddress=self.accountInfoData.physicalAddress}}})};self.init=function(){self.getContactInfo()};self.init()}]);
app.controller("accountInfoCompletePaymentStepController",["$scope","$routeParams","$controller","dataServiceG2","appConfigService","$cookies","constants","copartUser","registrationConstants","accountAlertsService","$location",function($scope,$routeParams,$controller,dataServiceG2,appConfigService,$cookies,constants,copartUser,registrationConstants,accountAlertsService,$location){$controller("registrationPaymentController",{$scope:$scope});var log=new Logger({name:"accountInfoCompletePaymentStepController"});
var self=$scope;self.parent=$scope.$parent;self.selectedProduct={};self.membershipPurchaseFuncs={};self.autoPaySubscription=true;self.submitPayment=function(isPaymentFormValid){self.submitted=true;if(self.selectedProduct.totalPrice>0&&_.isFunction(self.paymentFuncs.paymentSubmit))if(self.selectedPaymentType!==constants.CARD_PAYMENT_METHOD_CODE)self.paymentFuncs.paymentSubmit(self.selectedProduct);else if(self.validatePaymentForm(self.isPaymentFormValid))self.paymentFuncs.paymentSubmit(self.selectedProduct);
else console.log("Cyber source form validation failed ..Show error messages")};self.paymentSuccessHandler=function(response){$("#membershipPaymentPopUp").modal("show")};self.paymentFailureHandler=function(response){console.log("Payment failure::",response);self.isError=true};self.membershipPurchaseSuccessHandler=function(response){jQuery("#successMembershipPayment").modal()};self.membershipPurchaseFailureHandler=function(errorObjects){console.log("Payment failure::membershipPurchaseFailureHandler::",
errorObjects);jQuery("#errorMembershipPayment").modal()};self.submitMembershipPayment=function(){self.submitted=true;if(_.isFunction(self.membershipPurchaseFuncs.submitPayment))self.membershipPurchaseFuncs.submitPayment().then(function(){});else console.log("ERROR submitMembershipPayment")}}]);
app.controller("accountInfoUpgradeMembershipPaymentController",["$scope","$routeParams","$location","dataServiceG2","appConfigService","$cookies","constants","copartUser","registrationConstants","openAccordionService","$controller","accountAlertsService","userService",function($scope,$routeParams,$location,dataServiceG2,appConfigService,$cookies,constants,copartUser,registrationConstants,openAccordionService,$controller,accountAlertsService,userService){$controller("registrationPaymentController",
{$scope:$scope});var log=new Logger({name:"accountInfoUpgradeMembershipPaymentController"});var self=$scope;console.log("accountInfoUpgradeMembershipPaymentController is:::",$scope);self.appConfig=appConfigService.getAppConfig();self.selectedClass="";self.locale=$scope.$parent.locale;self.skipMembership=constants.NO;self.paymentFormValidFn=function(data){if(data)self.isPaymentFormValid=data.valid};self.physicalAddressSameAsBillingAddr=false;self.selectedProduct={};self.membershipPurchaseFuncs={};
self.showPhysicalAndBillingAddressOption=false;self.primaryPhoneVO=new PhoneVO(self.defaultPhoneNumberObj);self.physicalAddress=new AddressVO;self.additionalPaymentVO={"email":undefined,"productPaymentVO":self.selectedProduct,"physicalAddrSameAsBillingAddr":false};self.paymentFuncs={};self.additionalPaymentInfo={};self.collapseUpgradeTab=$location.search().accSettingUpgradeMem||false;self.errors={emailAlreadyExist:false,cityStateZipConbinationInvalid:false,phoneNumber:false,specialChars:{addressLine1:false,
addressLine2:false,billingAddressLine1:false,billingAddressLine2:false},zipCode:false};self.paymentTypes=self.appConfig.getPaymentMethods()||{};self.selectedPaymentMethod={"checked":"Credit Card"};self.accountInfoData={};self.membershipRenewalInProgress=false;self.membershipUpgradeInProgress=false;self.userConfig=userService.userConfig;self.membershipType=self.userConfig.membershipType;self.autoPaySubscription=true;self.changeProduct=function(version,productCode,autoPaySubscription,price){self.selectedProduct.version=
version;self.selectedProduct.productCode=productCode;self.selectedProduct.autoPaySubscription=autoPaySubscription;self.selectedProduct.totalPrice=price};self.processingPayment=false;self.submitPayment=function(isPaymentFormValid){console.log("isPhiscialAddressFormValid is::",isPaymentFormValid);self.submitted=true;if(self.validatePaymentForm(isPaymentFormValid))if(self.selectedProduct.totalPrice>0&&_.isFunction(self.paymentFuncs.paymentSubmit))self.paymentFuncs.paymentSubmit(self.selectedProduct);
else self.showThankYou()};self.validatePaymentForm=function(){return true};self.collapseUpgradeTab?openAccordionService.targetAccordion("accSettingUpgradeMem"):"";self.membershipPurchaseSuccessHandler=function(response){console.log("Payment success::membershipPurchaseSuccessHandler:: ",response);jQuery("#successMembershipPayment").modal();self.processingPayment=false};self.membershipPurchaseFailureHandler=function(errorObjects){console.log("Payment failure::membershipPurchaseFailureHandler::",errorObjects);
jQuery("#errorMembershipPayment").modal();self.processingPayment=false};self.submitMembershipPayment=function(){console.log("submitMembershipPayment::called::");self.submitted=true;if(_.isFunction(self.membershipPurchaseFuncs.submitPayment))self.membershipPurchaseFuncs.submitPayment().then(function(){});else console.log("ERROR ")};self.submitPaymentMembershipUpgrade=function(){if(_.isFunction(self.membershipPurchaseFuncs.submitWithOutReview)){self.processingPayment=true;self.membershipPurchaseFuncs.submitWithOutReview().then(function(response){self.processingPayment=
false},function(error){self.processingPayment=false})}};self.init=function(){if(!accountAlertsService.verifyUserActionCompletedFromActivities(constants.ALERT_TYPE_STATUS.missingAccInfo))self.showMembershipAccordian=false;else{self.showMembershipAccordian=true;dataServiceG2.getContactInfo(function(response){console.log("Response from contact Info: ",response);if(response&&response.data&&response.data.contactInfoList){self.accountInfoData=response.data.contactInfoList;if(self.accountInfoData){self.membershipUpgradeInProgress=
self.accountInfoData.membershipUpgradeInProgress;self.membershipRenewalInProgress=self.accountInfoData.membershipRenewalInProgress;self.additionalPaymentInfo.physicalAddress=self.accountInfoData.physicalAddress}}})}};self.init()}]);
app.controller("memberAccountUpdateController",["$scope","accountAlertsService",function($scope,accountAlertsService){var log=new Logger({name:"memberAccountUpdateController"});var self=$scope;self.parent=$scope.$parent;self.additionalInfo={};self.updateAccountInfoFuncs={};self.physicalAddress=new AddressVO;self.accountInfoSuccessHandler=function(response){console.log("Account info success:: ",response);self.updateAccountInformationUserAction()};self.accountInfoFailureHandler=function(response){console.log("Account Info failure:: ",
response)};self.docUploadSuccessHandler=function(response){console.log("Document upload successfully:",response);self.parent.showMemberAccountInfoAccordion=false;self.parent.showMembershipUpgradeInProcess=false};self.docUploadFailureHandler=function(response){console.log("Document upload Failed:",response)};self.updateAccountInformationUserAction=function(){jQuery("#successMembershipPayment").modal()}}]);
app.controller("completeRegistrationController",["$scope","$window","$location","registrationConstants","accountAlertsService","constants",function($scope,$window,$location,registrationConstants,accountAlertsService,constants){var self=$scope;self.locale=$scope.$parent.locale;var pendingRegistrationSteps=[];var registrationOrder=registrationConstants.REGISTRATION_ORDER;var registrationUserActivity=registrationConstants.REGISTRATION_USER_ACTIVITY;self.loadingSpinner=true;self.pendingStepsFuncs={};
var initializeVariables=function(){self.errors=false;self.activeStep="";pendingRegistrationSteps=[]};var postRegistrationCompletionAction=function(){$window.location.href="/dashboard"};var computeActivePendingStep=function(pendingRegistration){if(pendingRegistration&&pendingRegistration.accountAlerts&&pendingRegistration.accountAlerts.length>0){angular.forEach(registrationOrder,function(step){if(_.find(pendingRegistration.accountAlerts,{"userActionCode":step}))pendingRegistrationSteps.push(_.find(pendingRegistration.accountAlerts,
{"userActionCode":step}))});if(pendingRegistrationSteps&&pendingRegistrationSteps.length>0)self.activeStep=pendingRegistrationSteps[0].userActionCode;else postRegistrationCompletionAction()}else postRegistrationCompletionAction();self.loadingSpinner=false};var initializePendingSteps=function(){var pendingRegistrationActivity=[];accountAlertsService.getAccountAlerts().then(function(alerts){pendingRegistrationActivity=alerts.find(function(alert){return registrationUserActivity===alert.userActivity});
computeActivePendingStep(pendingRegistrationActivity)})};self.init=function(){initializeVariables();initializePendingSteps()};self.computePendingSteps=function(){self.loadingSpinner=false;self.init()};self.init()}]);
app.controller("completePaymentController",["$scope","accountInfoService","dataServiceG2",function($scope,accountInfoService,dataServiceG2){var log=new Logger({name:"completePaymentController"});var self=$scope;self.parent=$scope.$parent;self.membershipPurchaseFuncs={};self.processingPayment=false;self.membershipUpgradeInProgress=false;self.membershipRenewalInProgress=false;var initialize=function(){dataServiceG2.getContactInfo(function(response){if(response&&response.data&&response.data.contactInfoList){var contactInfo=
response.data.contactInfoList;self.membershipUpgradeInProgress=Boolean(contactInfo.membershipUpgradeInProgress);self.membershipRenewalInProgress=Boolean(contactInfo.membershipRenewalInProgress)}else log.error(" complete registration payment ctrl - getContactInfo -\x3e Failed "+response)},function(error){log.error("complete registration payment ctrl  -\x3e Failed "+error)})};self.paymentFailureHandler=function(error){self.processingPayment=false};self.paymentSuccessHandler=function(response){if(response&&
response.returnCode!==-1){if(response.data&&response.data.contactPreferences)accountInfoService.saveContactInfo(response.data.contactPreferences);self.parent.computePendingSteps();self.processingPayment=false}};self.submitPayment=function(){self.parent.loadingSpinner=true;if(_.isFunction(self.membershipPurchaseFuncs.submitWithOutReview)){self.processingPayment=true;self.membershipPurchaseFuncs.submitWithOutReview().then(function(response){self.processingPayment=false},function(error){self.processingPayment=
false})}};self.init=function(){initialize()};self.init()}]);
app.controller("completeAccountInfoController",["$scope","accountInfoService",function($scope,accountInfoService){var log=new Logger({name:"completeAccountInfoController"});var self=$scope;self.parent=$scope.$parent;self.additionalInfo={};self.physicalAddress=new AddressVO;self.updateAccountInfoFuncs={};self.accountInfoProcessing=false;var initialize=function(){accountInfoService.getAccountInformation(true).then(function(contactInfo){if(contactInfo&&contactInfo.physicalAddress)self.physicalAddress=
contactInfo.physicalAddress})};self.accountInfoSuccessHandler=function(response){console.log("Account info success:: ",response);self.parent.computePendingSteps();self.accountInfoProcessing=false};self.accountInfoFailureHandler=function(response){console.log("Account Info failure:: ",response);self.accountInfoProcessing=false};self.updateAccountInfoFuncs.updateAccountInfoSubmit=function(){if(_.isFunction(self.updateAccountInfoFuncs.updateAccountInfo)){self.accountInfoProcessing=true;self.updateAccountInfoFuncs.updateAccountInfo().then(function(response){self.accountInfoProcessing=
false},function(error){self.accountInfoProcessing=false})}};self.init=function(){initialize()};self.init()}]);
app.service("accountInfoService",["$q","dataServiceG2",function($q,dataServiceG2){var log=new Logger({name:"accountInfoService"});var self=this;self.globalPromise=null;self.contactInfo={};self.saveContactInfo=function(contactInfo){self.contactInfo=contactInfo};self.getAccountInformation=function(refresh){if(self.globalPromise)return self.globalPromise;var deferred=$q.defer();if(Boolean(refresh)||_.isEmpty(self.contactInfo))dataServiceG2.getAccountInformation(function(response){if(response&&response.data&&
response.data.contactInfoList){self.contactInfo=response.data.contactInfoList;deferred.resolve(self.contactInfo)}else{log.error("accountInfoService.getContactInfo -\x3e Failed "+response);deferred.reject({})}self.globalPromise=null},function(error){log.error("accountInfoService.getContactInfo -\x3e Failed "+error);self.globalPromise=null;deferred.reject({})});else deferred.resolve(self.contactInfo);self.globalPromise=deferred.promise;return self.globalPromise}}]);
app.controller("completeDocumentUploadController",["$scope","accountInfoService",function($scope,accountInfoService){var log=new Logger({name:"completeDocumentUploadController"});var self=$scope;self.parent=$scope.$parent}]);